*** Settings ***
Library				RoboGalaxyLibrary
Library				FusionLibrary
Library				OperatingSystem
Library				BuiltIn
Library				Collections
Library				XML
Library		        SSHLibrary
Library				String
Library				Dialogs

Resource         	../fusion_api_resource.txt
Resource         	../../../tests/clrm/support_files/clrm_common.txt

*** Keywords ***

Get Infrastructure Vm 
	[Documentation]	Get Infrastructure Vm by name
	[Arguments]		${iv}
	${iv_details}= 	Create Dictionary
	#Get the Infrastructure Vm filtered on it's name
	${resp} = 	Fusion Api Get Infrastructure Vms		param=?filter="'name'=='${iv}'"
	:FOR	${m}	IN	@{resp['members']}
	\	Log to console	${m['name']}
	\	${iv_details}=	Run keyword if	'${m['name']}'=='${iv}'		copy dictionary		${m}
	[Return]	${iv_details}
	
Get Infra VM Uri by Name
	[Documentation]	Get Infra VM Uri by Name 
	[Arguments]		${infra_vm}
	${resp}= 	Fusion Api Get Infrastructure Vms		param=?filter="'name'=='${infra_vm}'"
	run keyword if	${resp['count']}==0		FAIL	Infra VM ${infra_vm} not found
	${uri}=	Run keyword if	${resp} is not None	Get From Dictionary		${resp['members'][0]}	uri
	...						ELSE	Log to console		Could not find cluster profile ${cpname}
	[Return]	${uri}
	
Create Infrastructure Vms
	[Documentation]	Creates infrastructure vm's with the input passed as argument
    [Arguments]		${Infrastructure Vms}		${STATUS_CODE}=202
	${add_iv} =  	Create list
	Log    Adding Infrastructure Vms    console=true
	:FOR	${iv}	IN	@{Infrastructure Vms}
	\	${network} = 	Get From Dictionary	${iv}	networks
	\	${network_status}		Run keyword and return status	Dictionary Should Contain Key	${network}	VM Network
	\	${network_name} = 	Run Keyword If	${network_status}==True		Get from Dictionary	${network}	VM Network	
	\	${network_uri} = 	Common URI Lookup by name	${network_name}
	\   Set to Dictionary   ${network}  VM Network     ${network_uri}
	\	Log    ${iv}    console=true
	\	${rest_resp}=		Fusion Api Create Infrastructure Vms		${iv}
	\	${status}=      Run Keyword And Return Status	should be equal as integers  ${rest_resp['status_code']}  ${STATUS_CODE}
	\	${task_status}	${task_resp}=	Run Keyword If		'${status}'=='True'		Clrm Wait For Task	${rest_resp}
	\	Log    ${task_resp}	    console=true
 	[Return]    ${task_status}
 	
 Delete Infra VMs
 	[Documentation]	Delete Infra VMs by name
 	[Arguments]		${infra_vm}	${force}=False
	${uri}= 		Get Infra VM Uri by Name		${infra_vm}
 	${rest_resp}= 	Fusion Api Delete Infrastructure Vms	uri=${uri}?force=${force}
 	${status}= 	Run Keyword And Return Status	should be equal as integers  ${rest_resp['status_code']}	202
 	${task_status}	${task_resp}=	Run Keyword If	${status}==True		Clrm Wait For Task	${rest_resp}	900s	50s
 	[Return]	${task_status}
