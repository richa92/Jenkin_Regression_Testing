*** Settings ***
Library				FusionLibrary

*** Keywords ***
Add Racks from variable
	[Documentation]	Adds racks to an appliance from a variable which contains a list of dicts with the entire payload
	[Arguments]		${racks}
	Log  	\nAdding Racks     console=True
    ${resplist} =    Create List
	:FOR	${rack}	IN	@{racks}
	\       ${rack} =    Get Mount Uri    ${rack}
	\       Log    rack:${rack}
	\		${resp} = 	Fusion Api Add Rack		body=${rack}
	\       ${resplist} =    Append to list   ${resplist}   ${resp}
	[Return]    ${resplist}


Get Mount Uri
    [Documentation]    data file can specify "mountUri": "ENC:CN754404R6"  or "mountUri": "/rest/encloures/000000CN754404R6"
    ...                For the former, this does a lookup of the enclosure to get the uri.
    ...                Currently only supports ENC:.  Need to add DL or similar for Rack Servers when needed.
    [Arguments]    ${rack}
    ${newrack} =    get variable value    ${rack}
    ${newrackMounts} =    Create List
    :For    ${rackMount}    IN    @{rack['rackMounts']}
    \     ${newrackMount} =    Get Variable Value    ${rackmount}
    \     ${mountUri} =    Get Variable Value    ${rackMount['mountUri']}
    \     ${status}    Run Keyword and Return Status    Should Match Regexp    ${mountUri}    rest
    \     Continue For Loop If    ${status}
    \     ${prefix}    ${name} =    Split String    ${mountUri}    :
    \     ${uri} =    Get Enclosure URI    ${name}
    \     Set To Dictionary    ${newrackMount}    mountUri    ${uri}
    \     Log    nrm: ${newrackmount}
    \     Append To List    ${newrackMounts}    ${newrackMount}

    ${newrack['rackMounts']} =    Set Variable    ${newRackMounts}
    [Return]   ${newrack}