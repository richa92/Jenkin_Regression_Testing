*** Settings ***
Documentation        After On-Site Setup simulate a compliance failure (due to some HW/FW change)
Resource             ../resources/resources.txt
Suite Teardown       Logout and Close All Browsers
Suite Setup    PreTest Open Browser and perform Login

*** Variables ***
${FanBayStatusError}    OP_STATUS_NON_RECOVERABLE_ERROR
${FanBayStatusOK}    OP_STATUS_OK
${ComplianceTask}    Refresh ConvergedSystem compliance results
${FanBayNumber}    3
${EnclosureID}    Enclosure-271

*** Test Cases ***
Test 1: Verify that System Profiles is not in Critical state
    # TODO: Change this validation to expect OK as initial status.
    # Today an issue on storage status is not allowing to get an OK status on System Profile
    ${InitialSPStatus}=    Get System Profile Status    ${TestData.ConvergedSystemCS700V2.SystemProfile.name}
    Set Suite Variable    ${InitialSPStatus}
    Check System Profiles Dashboard Status    ${InitialSPStatus}
    Should Not be Equal    ${InitialSPStatus}    'error'    Initial System Profile status cannot be "ERROR"

Test 2: Simulate a failure on one Enclosure Fan
    # Works for C7000 only
    DCS Change Fan Status    ${TestData.envconfigs[0].appliance_ip}    ${FanBayNumber}    ${EnclosureID}    ${FanBayStatusError}

Test 3: Wait for Compliance Task to Run
    Wait For System Profile Task    ${ComplianceTask}

Test 4: Verify that System Profiles Health is in Critical state
    Check System Profile Status    ${TestData.ConvergedSystemCS700V2.SystemProfile.name}    error
    Check System Profiles Dashboard Status    critical

Test 5: Return Fan to its original state
    # Works for C7000 only
    DCS Change Fan Status    ${TestData.envconfigs[0].appliance_ip}    ${FanBayNumber}    ${EnclosureID}    ${FanBayStatusOK}

Test 6: Wait for Compliance Task to Run
    Wait For System Profile Task    ${ComplianceTask}

Test 7: Verify that System Profiles returned to its original state
    Check System Profile Status    ${TestData.ConvergedSystemCS700V2.SystemProfile.name}    ${InitialSPStatus}
    Check System Profiles Dashboard Status    ${InitialSPStatus}
    # TODO: Rollback the system profile to the initial status in case of failure