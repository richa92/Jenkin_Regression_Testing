*** Settings ***
Documentation     xorsyst
...    = Usage =
...    pybot -L TRACE
...
...    = Variables =
...	| IPs | IPs address of machine to run xorsyst on 
...	| LANTEST_IP | IP to ping for lantest
...	| TIME_2_RUN | Time to run xorsyst
...	| MEM_PERCENT | Target memory percentage
...    = Preconditions =
...    None

Library  	  json
Library           RoboGalaxyLibrary
Library		  OperatingSystem
Library		  Collections
Library		  String
Library		  SSHLibrary	prompt=\#
Library           robot.api.logger

*** Variables ***
${TIME_2_RUN}=	7200
${MEM_PERCENT}=	75

*** Test Case ***
Parse IPs
	@{list}=	Split String	${IPs}	,

#Get xorsyst tar, login to SUT and copy xorsyst and license
	:FOR	${IP}	IN	@{list}
	\	@{files}=	OperatingSystem.List Files In Directory	.	xor*.tar.gz
	\	Console	${files[0]}

	\	Open Connection	${IP}
	\	Login	root	password
	
	\	Put File	${files[0]}
	\	Put File	xorsyst.license

	\	SSHLibrary.Write	tar xzvf ${files[0]}
	\	${output}=	Read Until Prompt
	\	Console	${output}
	\	SSHLibrary.Write	mv xorsyst.license ~/xorsyst/xorsyst.license

#Install xorsyst
	\	SSHLibrary.Write	cd xorsyst	
	\	${output}=	Read Until Prompt
	\	SSHLibrary.Write	pwd
	\	${output}=	Read Until Prompt
	\	Console	${output}

	\	SSHLibrary.Write	./xorsyst_install
	\	${output}=	Read Until Prompt
	\	Console	${output}
	
#Configure xorsyst user
	\	SSHLibrary.Write	echo password | passwd xorsyst --stdin
	\	${output}= 	Read Until Prompt
	\	Console	${output}
	\	SSHLibrary.Write	echo password | passwd xo --stdin
	\	${output}= 	Read Until Prompt
	\	Console	${output}
	\	Close Connection

#Login and run xorsyst
	\	Open Connection	${IP}	prompt=\-\>
	\	Login	xorsyst	password
	
	\	SSHLibrary.Write	scan_conf > xorsystsetup
	\	${output}=	Read Until Prompt
	\	Console		${output}
	\	SSHLibrary.Write	sed -i 's/TIME_2_RUN=7200/TIME_2_RUN=${TIME_2_RUN}/g' xorsystsetup
	\	SSHLibrary.Write	sed -i '/LANTEST\=\$IPADDR/ c\LANTEST\=${LANTEST_IP}' xorsystsetup
	\	SSHLibrary.Write	sed -i '/TARGET_MEM_PERCENT_USED=75/ c\TARGET_MEM_PERCENT_USED=${MEM_PERCENT}' xorsystsetup
	\	${output}=	Read Until Prompt
	\	Console		${output}
	\	SSHLibrary.Write	xstart --nohup &
	\	${output}=	Read Until Prompt
	\	Console		${output}
	\	Close Connection
