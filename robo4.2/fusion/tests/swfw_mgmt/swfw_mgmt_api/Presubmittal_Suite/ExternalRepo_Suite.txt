*** Settings ***
Resource            ../../../../Resources/api/fusion_api_resource.txt
Variables           DATA_VARIABLES.py
Library             FusionLibrary
Suite Setup         Fusion Api Login Appliance          ${FUSION_IP}        ${admin_credentials}
Suite Teardown      Fusion Api Logout Appliance


*** Test Cases ***

Remove External repo only if it Exists
    [Documentation]     Remove external repository if it exists
    [Tags]              add_repo
    ${repositories}=    Fusion Api Get Repository
    Log                 ${repositories}         console= True
    ${count}=           Get From Dictionary     ${repositories}         count
    Log                 ${count}                console= True
    :FOR                ${repo}                 IN                      @{repositories['members']}
    \                   Log                     ${repo}                 console= True
    \                   ${uri} =                Get From Dictionary     ${repo}                 uri
    \                   ${repo_name} =          Get From Dictionary     ${repo}                 name
    \                   Log                     ${repo_name}            console= True
    \                   ${repositoryType} =     Get From Dictionary     ${repo}                 repositoryType
    \                   ${response} =           run Keyword If          '${repositoryType}'=='FirmwareExternalRepo'
    \                   ...                     Remove Repository By Name
    \                   ...                     ${repo_name}
    \                   run Keyword If          '${repositoryType}'=='FirmwareExternalRepo'     Wait For Task2      ${response}
    \                   ...                     200
    \                   ...                     5

Remove Internal Repository attempt
    [Documentation]     Remove Internal Repository attempt
    [Tags]              remove_repo
    ${repositories}=    Fusion Api Get Repository
    Log                 ${repositories}         console= True
    ${count}=           Get From Dictionary     ${repositories}         count
    Log                 ${count}                console= True
    :FOR                ${repo}                 IN                      @{repositories['members']}
    \                   Log                     ${repo}                 console= True
    \                   ${uri} =                Get From Dictionary     ${repo}                 uri
    \                   ${repo_name} =          Get From Dictionary     ${repo}                 name
    \                   Log                     ${repo_name}            console= True
    \                   ${repositoryType} =     Get From Dictionary     ${repo}                 repositoryType
    \                   Run Keyword If          '${repositoryType}'=='FirmwareInternalRepo'     Run Keyword and Ignore Error
    \                   ...                     Remove Repository By Name
    \                   ...                     ${repo_name}

Add External Repository to OneView
    [Documentation]     Add External Repo
    [Tags]              add_repo
    Sleep               1 minutes 0 seconds
    ${resp} =           Add Repository      ${http_repo_with_password}
    ${task} =           Wait For Task2      ${resp}     100     5
    Sleep               15 minutes 0 seconds

Edit External Repository
    [Documentation]     Edit External Repo
    [Tags]              add_repo
    Run Keyword and Ignore Error    Edit Repository     ${http_repo_with_password1}     ${repository_new_name}
    Sleep               2 minutes 0 seconds

Refresh External and Internal Repository
    [Documentation]     Refresh External and Internal Repo
    [Tags]              add_repo
    ${repositories}=    Fusion Api Get Repository
    Log                 ${repositories}         console= True
    ${count}=           Get From Dictionary     ${repositories}     count
    Log                 ${repositories}         console= True
    :FOR                ${repo}                 IN                  @{repositories['members']}
    \                   Log                     ${repo}             console= True

    \   ${uri} =                Get From Dictionary             ${repo}     uri
    \   ${repo_name} =          Get From Dictionary             ${repo}     name
    \   Log                     ${repo_name}                    console= True
    \   ${repositoryType} =     Get From Dictionary             ${repo}     repositoryType
    \   ${resp} =               Refresh Repository By Name      ${repo_name}
    \   Wait For Task2          ${resp}                         50          5

Remove External Repository
    [Documentation]     Remove External Repo
    [Tags]              remove_repo
    ${repositories}=    Fusion Api Get Repository
    Log                 ${repositories}         console= True
    ${count}=           Get From Dictionary     ${repositories}     count
    Log                 ${count}                console= True

    :FOR    ${repo}                 IN                      @{repositories['members']}
    \       Log                     ${repo}                 console= True
    \       ${uri} =                Get From Dictionary     ${repo}                 uri
    \       ${repo_name} =          Get From Dictionary     ${repo}                 name
    \       Log                     ${repo_name}            console= True
    \       ${repositoryType} =     Get From Dictionary     ${repo}                 repositoryType
    \       ${response} =           run Keyword If          '${repositoryType}'=='FirmwareExternalRepo'
    \       ...                     Remove Repository By Name
    \       ...                     ${repo_name}
    \       run Keyword If          '${repositoryType}'=='FirmwareExternalRepo'     Wait For Task2      ${response}     200
    \       ...                     5

Add External Repository after remove
    [Documentation]     Add External Repo
    [Tags]              add_repo
    ${resp} =           Add Repository      ${http_repo_with_password}
    ${task} =           Wait For Task2      ${resp}     50      5
    Sleep               15 minutes 0 seconds

