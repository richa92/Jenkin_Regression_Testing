*** Settings ***
Documentation     Test suite to verify HBA Programming Profiles
Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/dea_variables.py
Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/data_variables.py
Variables         ${GIT_REPO_ROOT}/mgmtfw/tests/thunderbird/variables/tBird_variables.py
Resource          ${GIT_REPO_ROOT}${RESOURCE_ROOT}/resource_all.txt
Resource          ${GIT_REPO_ROOT}${EM_RESOURCE_ROOT}/thunderbird_all.txt
Library           RoboGalaxyLibrary
Library           FusionLibrary
Library           MgmtFWLibrary
Library           Selenium2Library
Library           Collections
Suite Setup       Run Keywords    Login to Fusion Via REST    AND    Clean UP Environment    AND    Setup FC Appliance
Suite Teardown    Run Keywords    Clean UP Environment    AND    Logout of Fusion Via REST

*** Test Cases ***
TC 01: Verify FC profiles can not be saved and applied with connections immediately in Power on mode
    [Documentation]    Verify FC profiles can not be saved and applied with connections immediately in Power on mode
    [Tags]    PE    API    Automated    HBA
    Power off ALL Servers
    Remove All Server Profiles
    ${bay_list}=    Get HBA Mezz Server Bay List
    :FOR    ${x}    IN    @{bay_list}
    \    Power ON Server Blade Bay    ${x}
    \    ${server_profile_body}=    Build FC Server Profile body    ${x}    ${server_profiles[0]}
    \    ${resp}=    Fusion Api Create Server Profile    body=${server_profile_body}
    \    ${task} =    Wait For Task    ${resp}    timeout=2 mins    interval=10s
    \    ${task_state} =    Get From dictionary    ${task}    taskState
    \    Should Match Regexp    ${task_state}    ((?i)Error)
    
TC 02: Verify FC profiles can be saved and applied with connections immediately in Aux mode
    [Documentation]    Verify FC profiles can be saved and applied with connections immediately in Aux mode.
    [Tags]    PE    API    Automated    HBA
    Power off ALL Servers
    Remove All Server Profiles
    ${bay_list}=    Get HBA Mezz Server Bay List
    :FOR    ${x}    IN    @{bay_list}
    \    ${server_profile_body}=    Build FC Server Profile body    ${x}    ${server_profiles[0]}
    \    Create Server Profile    ${server_profile_body}
    \    ${server_state}=    Get Server State    ${x}
    \    Should Be Equal    ${server_state}    ProfileApplied
    \    ${server_status}=    Get Server Status    ${x}
    \    Should Be Equal    ${server_status}    OK
    \    ${profile_status}=    Get Server Profile Status    ${x}
    \    Should Be Equal    ${server_status}    OK
    
TC 03: Verify FC profiles can be saved and applied without connections immediately in Power on mode
    [Documentation]    Verify FC profiles can be saved and applied without connections immediately in Power on mode.
    [Tags]    PE    API    Automated    HBA
    Power off ALL Servers
    Remove All Server Profiles
    ${bay_list}=    Get HBA Mezz Server Bay List
    ${enet_connection}=    Create List
    ${enet_connection}=    Set Test Variable    ${fc_connection}
    :FOR    ${x}    IN    @{bay_list}
    \    ${server_profile_body}=    Build FC Server Profile body    ${x}    ${server_profiles[0]}
    \    Create Server Profile    ${server_profile_body}
    \    ${server_state}=    Get Server State    ${x}
    \    Should Be Equal    ${server_state}    ProfileApplied
    \    ${server_status}=    Get Server Status    ${x}
    \    Should Be Equal    ${server_status}    OK
    \    ${profile_status}=    Get Server Profile Status    ${x}
    \    Should Be Equal    ${server_status}    OK
    \    Power ON Server Blade Bay    ${x}
    \    ${profile_status}=    Get Server Profile Status    ${x}
    \    Should Be Equal    ${server_status}    OK
    
TC 04: Verify FC profiles can be saved and applied without connections immediately in Aux mode
    [Documentation]    Verify FC profiles can be saved and applied without connections immediately in Aux mode.
    [Tags]    PE    API    Automated    HBA
    Power off ALL Servers
    Remove All Server Profiles
    ${bay_list}=    Get HBA Mezz Server Bay List
    ${enet_connection}=    Create List
    ${enet_connection}=    Set Test Variable    ${fc_connection}
    :FOR    ${x}    IN    @{bay_list}
    \    ${server_profile_body}=    Build FC Server Profile body     ${x}    ${server_profiles[0]}
    \    Create Server Profile    ${server_profile_body}
    \    ${server_state}=    Get Server State    ${x}
    \    Should Be Equal    ${server_state}    ProfileApplied
    \    ${server_status}=    Get Server Status    ${x}
    \    Should Be Equal    ${server_status}    OK
    \    ${profile_status}=    Get Server Profile Status    ${x}
    \    Should Be Equal    ${server_status}    OK
    
TC 05: Verify you can not apply a profile to a server already having one in Power on mode
    [Documentation]    Verify you can not apply a profile to a server already having one in Power on mode
    [Tags]    PE    API    Automated    HBA
    Power off ALL servers
    Remove All Server Profiles
    ${bay_list}=    Get HBA Mezz Server Bay List
    :FOR    ${x}    IN    @{bay_list}
    \    ${server_profile_body}=    Build FC Server Profile body     ${x}    ${server_profiles[0]}
    \    Create Server Profile    ${server_profile_body}
    \    Power ON Server Blade Bay    ${x}
    \    ${y}=    Evaluate    ${x}+1
    \    ${name}=    Catenate  Bay  ${y}
    \    Set to Dictionary   ${server_profile_body}  name    ${name}
    \    ${resp}=    Fusion Api Create Server Profile       body=${server_profile_body}
    \    ${task} =   Wait For Task   ${resp}     timeout=2 mins      interval=10s
    \    ${task_state} =    Get From dictionary    ${task}    taskState
    \    Should Match Regexp    ${task_state}    ((?i)Error)
    
TC 06: Verify you can not apply a profile to a server already having one in Aux mode
    [Documentation]    Verify you can not apply a profile to a server already having one in Aux mode
    [Tags]    PE    API    Automated    HBA
    Power off ALL servers
    Remove All Server Profiles
    ${bay_list}=    Get HBA Mezz Server Bay List
    :FOR    ${x}    IN    @{bay_list}
    \    ${server_profile_body}=    Build FC Server Profile body     ${x}    ${server_profiles[0]}
    \    Create Server Profile    ${server_profile_body}
    \    Power OFF Server Blade Bay    ${x}
    \    ${y}=    Evaluate    ${x}+1
    \    ${name}=    Catenate  Bay  ${y}
    \    Set to Dictionary   ${server_profile_body}  name    ${name}
    \    ${resp}=    Fusion Api Create Server Profile       body=${server_profile_body}
    \    ${task} =   Wait For Task   ${resp}     timeout=2 mins      interval=10s
    \    ${task_state} =    Get From dictionary    ${task}    taskState
    \    Should Match Regexp    ${task_state}    ((?i)Error)
    
TC 07: Verify you can remove a profile
    [Documentation]    Verify you can remove a profile
    [Tags]    PE    API    Automated    HBA
    Power off ALL servers
    Remove All Server Profiles
    ${bay_list}=    Get HBA Mezz Server Bay List
    :FOR    ${x}    IN    @{bay_list}
    \    ${server_profile_body}=    Build FC Server Profile body     ${x}    ${server_profiles[0]}
    \    Create Server Profile    ${server_profile_body}
    \    Power OFF Server Blade Bay    ${x}
    \    ${profile_uri}=    Get Server Hardware Profile URI    ${x}
    \    ${resp} =   Fusion Api Delete Server Profile        uri=${profile_uri}
    \    ${task} =   Wait For Task   ${resp}     240s    10s
    \    ${profile_uri}=    Get Server Hardware Profile URI    ${x}
    \    Should Be Equal As Strings    ${profile_uri}    None
    
TC 08: Verify profile to a server is not lost with server refresh in poweron mode
    [Documentation]    This test will Verify profile to a server is not lost with server refresh in poweron mode
    [Tags]    PE    API    Automated    HBA
    ${bay_list}=    Get HBA Mezz Server Bay List
    Should Not Be Empty    ${bay_list}    msg=No server with HBA adapter present in the enlcosure
    Power off ALL servers
    Remove All Server Profiles
    :FOR    ${x}    IN    @{bay_list}
    \    ${server_profile_body}=    Build FC Server Profile body     ${x}    ${server_profiles[0]}
    \    Create Server Profile    ${server_profile_body}
    \    Power ON Server Blade Bay    ${x}
    \    ${profile_status}=    Get Server Profile Status    ${x}
    \    Should Be Equal    ${profile_status}    OK
    \    ${server_info}=    Get Server Info    ${x}
    \    ${profile_info_pre_refresh}=    Get Server Profile Info    ${server_info}
    \    Refresh Server Hardware Bay    ${x}
    \    ${profile_info_post_refresh}=    Get Server Profile Info    ${server_info}
    \    Should Be Equal    ${profile_info_pre_refresh}    ${profile_info_post_refresh}
    
TC 09: Verify profiles are not lost during power cycles or Enclosure Refresh
    [Documentation]    Verify profiles are not lost during power cycles or Enclosure Refresh
    [Tags]    PE    API    Automated    HBA
    Power off ALL servers
    Remove All Server Profiles
    ${bay_list}=    Get HBA Mezz Server Bay List
    Should Not Be Empty    ${bay_list}    msg=No server with HBA adapter present in the enlcosure
    Login to Fusion via SSH
    ${encl_list}=    Get EM Enclosures
    ${encl_name}=    Set Variable    ${encl_list[0]}
    Logout of Fusion Via SSH
    :FOR    ${x}    IN    @{bay_list}
    \    ${server_profile_body}=    Build FC Server Profile body     ${x}    ${server_profiles[0]}
    \    ${resp}=    Fusion Api Create Server Profile       body=${server_profile_body}
    \    ${task} =   Wait For Task   ${resp}     timeout=5 mins      interval=10s
    \    ${task_state} =     Get From dictionary     ${task}     taskState
    \    Should Match Regexp    ${task_state}   ((?i)Warning|Completed)
    \    Power ON Server Blade Bay    ${x}
    \    ${server_info}=    Get Server Info    ${x}
    \    ${profile_info_pre_refresh}=    Get Server Profile Info    ${server_info}
    \    Log    ${profile_info_pre_refresh}
    \    Refresh Enclosure    ${encl_name}
    \    ${server_info}=    Get Server Info    ${x}
    \    ${profile_info_post_refresh}=    Get Server Profile Info    ${server_info}
    \    Should Be Equal    ${profile_info_pre_refresh}    ${profile_info_post_refresh}
    
TC 10: Verify profiles are not lost after server Efuse
    [Documentation]    Verify profiles are not lost after server Efuse
    [Tags]    PE    API    Automated    HBA
    Power off ALL Servers
    Remove All Server Profiles
    ${bay_list}=    Get HBA Mezz Server Bay List
    #Login to CIM SSH and Get EM Sessions
    Login to Fusion via SSH
    Login to EM And Create Session
    :FOR    ${x}    IN    @{bay_list}
    \    ${server_profile_body}=    Build FC Server Profile body     ${x}    ${server_profiles[0]}
    \    Create Server Profile    ${server_profile_body}
    \    ${server_info}=    Get Server Info    ${x}
    \    EFuse Blade    EFuseOn    ${x}
    \    Sleep    20
    \    EFuse Blade    EFuseOff    ${x}
    \    Sleep    150
    \    fusion_api_appliance_setup.Log to console and logfile      \t Waiting for Server in Bay:${x} to reach state:ProfileApplied after Efuse
    \    Wait Until Keyword Succeeds     12 min   20s      Device reached state    ${server_info['uri']}    ProfileApplied
    Logout of Fusion Via SSH
    [Teardown]    Run Keyword If Test Failed    Run Keywords    EFuse Blade    EFuseOff    ${x}    AND    Sleep    600