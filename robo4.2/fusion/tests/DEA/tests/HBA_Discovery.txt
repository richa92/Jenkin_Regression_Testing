*** Settings ***
Documentation     HBA Adapter Discovery Smoke Test Suite 
...    = Usage =
...    | pybot | -L DEBUG | GIT_REPO_ROOT:<path> | APPLIANCE_IP:<fusion_ipv4> | HBA_Discovery.txt | 
...    = Variables =
...    | GIT_REPO_ROOT | Required; Repo root path if NOT defined in environment variable|
...    | APPLIANCE IP     | Required; OneView IP address under test |

Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/dea_variables.py
Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/data_variables.py
Variables         ${GIT_REPO_ROOT}/mgmtfw/tests/thunderbird/variables/tBird_variables.py
Resource          ${GIT_REPO_ROOT}${RESOURCE_ROOT}/resource_all.txt
Resource          ${GIT_REPO_ROOT}${EM_RESOURCE_ROOT}/thunderbird_all.txt

Library           RoboGalaxyLibrary
Library           FusionLibrary
Library           MgmtFWLibrary
Library           Selenium2Library
Library           Collections

Suite Setup       Run Keywords    Login to Fusion Via REST    AND    Clean UP Environment
Suite Teardown    Logout of Fusion Via REST

*** Test Cases ***
    
TC 01: Verify the correct SH and SHT - including model ports portmap and WWPN info - are created in Power On mode
    [Documentation]    Verify the correct SH and SHT - including model ports portmap and WWPN info - are created in Power On mode
    [Tags]    PE    API    Automated    HBA
    ${bay_list}=    Get Test Tag Server Bay List
    Should Not Be Empty    ${bay_list}    msg=No server with ${Test_Tag.upper()} adapter present in the enlcosure
    Power off ALL Servers
    :FOR    ${x}    IN    @{bay_list}
    \    Power on server bay    ${x}
    \    ${server_info}=    Get Server Info    ${x}
    \    ${mezz_list}=    Get Test Tag Mezz Bay List    ${x}
    \    ${ilo_ip}=    Get Server iLO Address    ${server_info}
    \    ${status}=    Login to iLO ipv4     ${ilo_ip}    ${iLO_UserName}    ${iLO_Password}
    \    fusion_api_appliance_setup.Log to console and logfile    Verifying Server Hardware Information for bay:${x}
    \    Verify Server Harware Information    ${server_info}    On    Monitored
    \    Verify Mezz Port Information    ${server_info}    ${mezz_list}
    \    Logout of iLO
    
TC 02: Verify the correct SH and SHT - including model ports portmap and WWPN info - are created in Aux mode(Power Off)
    [Documentation]    This test will verify the correct SH and SHT - including model ports portmap and WWPN info - are created in Aux mode(Power Off)
    [Tags]    PE    API    Automated    HBA
    ${bay_list}=    Get Test Tag Server Bay List
    Should Not Be Empty    ${bay_list}    msg=No server with ${Test_Tag.upper()} adapter present in the enlcosure
    Power on ALL servers
    :FOR    ${x}    IN    @{bay_list}
    \    Power off server bay    ${x}
    \    ${server_info}=    Get Server Info    ${x}
    \    ${mezz_list}=     Get Test Tag Mezz Bay List    ${x}
    \    ${ilo_ip}=    Get Server iLO Address    ${server_info}
    \    ${status}=    Login to iLO ipv4     ${ilo_ip}    ${iLO_UserName}    ${iLO_Password}
    \    fusion_api_appliance_setup.Log to console and logfile    Verifying Server Hardware Information for bay:${x}
    \    Verify Server Harware Information    ${server_info}    Off    Monitored
    \    Verify Mezz Port Information    ${server_info}    ${mezz_list}
    \    Logout of iLO
    
TC 03: Verify blade - adapter discovers on initial blade insert in Power on mode
    [Documentation]    This test will Verify blade - adapter discovers on initial blade insert in Power on mode
    [Tags]    PE    API    Automated    HBA
    ${bay_list}=   Get Test Tag Server Bay List
    Should Not Be Empty    ${bay_list}    msg=No server with ${Test_Tag.upper()} adapter present in the enlcosure
    #Login to CIM SSH and Get EM Sessions
    Login to Fusion via SSH
    Login to EM And Create Session
    :FOR    ${x}    IN    @{bay_list}
    \    Power off server bay    ${x}
    \    ${server_info}=    Get Server Info    ${x}
    \    EFuse Blade    EFuseOn    ${x}
    \    Sleep    20
    \    EFuse Blade    EFuseOff    ${x}
    \    Sleep    150
    \    fusion_api_appliance_setup.Log to console and logfile      \t Waiting for Server in Bay:${x} to reach state:Monitored
    \    Wait Until Keyword Succeeds     12 min   20s      Device reached state    ${server_info['uri']}    Monitored
    \    ${server_info}=    Get Server Info    ${x}
    \    ${mezz_list}=     Get Test Tag Mezz Bay List    ${x}
    \    ${ilo_ip}=    Get Server iLO Address    ${server_info}
    \    ${status}=    Login to iLO ipv4     ${ilo_ip}    ${iLO_UserName}    ${iLO_Password}
    \    Power on server bay    ${x}
    \    Wait for Server Power On    ${x}
    \    ${server_info}=    Get Server Info    ${x}
    \    Verify Server Harware Information    ${server_info}    On    Monitored
    \    Verify Mezz Port Information    ${server_info}    ${mezz_list}
    \    Logout of iLO
    Logout of Fusion Via SSH
    [Teardown]    Run Keyword If Test Failed    Run Keywords    EFuse Blade    EFuseOff    ${x}    AND    Sleep    600
    
TC 04: Verify blade - adapter discovers on initial blade insert in Power off mode
    [Documentation]    This test will Verify blade - adapter discovers on initial blade insert in Power off mode
    [Tags]    PE    API    Automated    HBA
    ${bay_list}=    Get Test Tag Server Bay List
    Should Not Be Empty    ${bay_list}    msg=No server with ${Test_Tag.upper()} adapter present in the enlcosure
    #Login to CIM SSH and Get EM Sessions
    Login to Fusion via SSH
    Login to EM And Create Session
    :FOR    ${x}    IN    @{bay_list}
    \    Power off server bay    ${x}
    \    ${server_info}=    Get Server Info    ${x}
    \    EFuse Blade    EFuseOn    ${x}
    \    Sleep    20
    \    EFuse Blade    EFuseOff    ${x}
    \    Sleep    150
    \    fusion_api_appliance_setup.Log to console and logfile      \t Waiting for Server in Bay:${x} to reach state:Monitored
    \    Wait Until Keyword Succeeds     12 min   20s      Device reached state    ${server_info['uri']}    Monitored
    \    ${server_info}=    Get Server Info    ${x}
    \    ${mezz_list}=    Get Test Tag Mezz Bay List    ${x}
    \    ${ilo_ip}=    Get Server iLO Address    ${server_info}
    \    ${status}=    Login to iLO ipv4     ${ilo_ip}    ${iLO_UserName}    ${iLO_Password}
    \    Power off server bay    ${x}
    \    Wait for Server Power Off    ${x}
    \    ${server_info}=    Get Server Info    ${x}
    \    Verify Server Harware Information    ${server_info}    Off    Monitored
    \    Verify Mezz Port Information    ${server_info}    ${mezz_list}
    \    Logout of iLO
    Logout of Fusion Via SSH
    [Teardown]    Run Keyword If Test Failed    Run Keywords    EFuse Blade    EFuseOff    ${x}    AND    Sleep    600
    
TC 05: Verify blade - adapter shows back up after factory reset of enclosure in Power on mode
    [Documentation]    This test will verify blade - adapter shows back up after factory reset of enclosure in Power on mode
    [Tags]    PE    API    Automated    HBA
    ${bay_list}=    Get Test Tag Server Bay List
    Should Not Be Empty    ${bay_list}    msg=No server with ${Test_Tag.upper()} adapter present in the enlcosure
    #Login to CIM SSH and Get EM Sessions
    Login to Fusion via SSH
    Login to EM And Create Session
    ${em_bay}=    Get EM Active Bay
    EM Reset To Factory    ${em_bay}
    Sleep    ${EM_SET_FACTORY_WAIT}
    ${bay_list}=    Get HBA Mezz Server Bay List
    :FOR    ${x}    IN    @{bay_list}
    \    Power on server bay    ${x}
    \    ${server_info}=    Get Server Info    ${x}
    \    ${mezz_list}=     Get Test Tag Mezz Bay List    ${x}
    \    ${ilo_ip}=    Get Server iLO Address    ${server_info}
    \    ${status}=    Login to iLO ipv4     ${ilo_ip}    ${iLO_UserName}    ${iLO_Password}
    \    fusion_api_appliance_setup.Log to console and logfile    Verifying Server Hardware Information for bay:${x}
    \    Verify Server Harware Information    ${server_info}    On    Monitored
    \    Verify Mezz Port Information    ${server_info}    ${mezz_list}
    \    Logout of iLO
    Logout of Fusion Via SSH
    
TC 06: Verify blade - adapter shows back up after factory reset of enclosure in Aux mode
    [Documentation]    This test will verify blade - adapter shows back up after factory reset of enclosure in Aux mode
    [Tags]    PE    API    Automated    HBA
    ${bay_list}=    Get Test Tag Server Bay List
    Should Not Be Empty    ${bay_list}    msg=No server with ${Test_Tag.upper()} adapter present in the enlcosure
    #Login to CIM SSH and Get EM Sessions
    Login to Fusion via SSH
    Login to EM And Create Session
    ${em_bay}=    Get EM Active Bay
    EM Reset To Factory    ${em_bay}
    Sleep    ${EM_SET_FACTORY_WAIT}
    ${bay_list}=    Get HBA Mezz Server Bay List
    :FOR    ${x}    IN    @{bay_list}
    \    Power off server bay    ${x}
    \    ${server_info}=    Get Server Info    ${x}
    \    ${mezz_list}=     Get Test Tag Mezz Bay List    ${x}
    \    ${ilo_ip}=    Get Server iLO Address    ${server_info}
    \    ${status}=    Login to iLO ipv4     ${ilo_ip}    ${iLO_UserName}    ${iLO_Password}
    \    fusion_api_appliance_setup.Log to console and logfile    Verifying Server Hardware Information for bay:${x}
    \    Verify Server Harware Information    ${server_info}    Off    Monitored
    \    Verify Mezz Port Information    ${server_info}    ${mezz_list}
    \    Logout of iLO
    Logout of Fusion Via SSH
    
TC 07: Verify a blade refresh does not remove discovery - portmap info or create a second SHT in Power on mode
    [Documentation]    This test will verify blade refresh does not remove discovery - portmap info or create a second SHT in Power on mode
    [Tags]    PE    API    Automated    HBA
    ${bay_list}=    Get Test Tag Server Bay List
    Should Not Be Empty    ${bay_list}    msg=No server with ${Test_Tag.upper()} adapter present in the enlcosure
    Power off ALL servers
    :FOR    ${x}    IN    @{bay_list}
    \    Power on server bay    ${x}
    \    ${server_info}=    Get Server Info    ${x}
    \    ${mezz_list}=    Get Test Tag Mezz Bay List    ${x}
    \    fusion_api_appliance_setup.Log to console and logfile    Verify SHT information for server:${x} with power on mode before server refresh
    \    Verify SHT Adapter Info    ${server_info}    ${mezz_list}
    \    Refresh Server Hardware Bay    ${x}
    \    ${server_info}=    Get Server Info    ${x}
    \    fusion_api_appliance_setup.Log to console and logfile    Verify SHT information for server:${x} with power on mode after server refresh
    \    Verify SHT Adapter Info    ${server_info}    ${mezz_list}
    
TC 08: Verify a blade refresh does not remove discovery - portmap info or create a second SHT in Aux mode
    [Documentation]    This test will verify blade refresh does not remove discovery - portmap info or create a second SHT in Aux mode
    [Tags]    PE    API    Automated    HBA
    ${bay_list}=    Get Test Tag Server Bay List
    Should Not Be Empty    ${bay_list}    msg=No server with ${Test_Tag.upper()} adapter present in the enlcosure
    Power on ALL servers
    :FOR    ${x}    IN    @{bay_list}
    \    Power off server bay    ${x}
    \    ${server_info}=    Get Server Info    ${x}
    \    ${mezz_list}=    Get Test Tag Mezz Bay List    ${x}
    \    fusion_api_appliance_setup.Log to console and logfile    Verify SHT information for server:${x} with power off mode before server refresh
    \    Verify SHT Adapter Info    ${server_info}    ${mezz_list}
    \    Refresh Server Hardware Bay    ${x}
    \    ${server_info}=    Get Server Info    ${x}
    \    fusion_api_appliance_setup.Log to console and logfile    Verify SHT information for server:${x} with power off mode after server refresh
    \    Verify SHT Adapter Info    ${server_info}    ${mezz_list}
    
TC 09: Verify that an enclosure refresh does not remove discovery - portmap info or create a second SHT in Power on mode
    [Documentation]    This test will verify that an enclosure refresh does not remove discovery - portmap info or create a second SHT in Power on mode
    [Tags]    PE    API    Automated    HBA
    ${bay_list}=    Get Test Tag Server Bay List
    Should Not Be Empty    ${bay_list}    msg=No server with ${Test_Tag.upper()} adapter present in the enlcosure
    Power off ALL servers
    ${encl}=    Get Enclosure Names
    ${encl_name}=    Set Variable    ${encl[0]}
    :FOR    ${x}    IN    @{bay_list}
    \    Power on server bay    ${x}
    \    ${server_info}=    Get Server Info    ${x}
    \    ${mezz_list}=    Get Test Tag Mezz Bay List    ${x}
    \    fusion_api_appliance_setup.Log to console and logfile    Verify SHT information for server:${x} with power on mode before enclosure refresh
    \    Verify SHT Adapter Info    ${server_info}    ${mezz_list}
    Refresh Enclosure    ${encl_name}
    :FOR    ${x}    IN    @{bay_list}
    \    ${server_info}=    Get Server Info    ${x}
    \    ${mezz_list}=     Get Test Tag Mezz Bay List    ${x}
    \    fusion_api_appliance_setup.Log to console and logfile    Verify SHT information for server:${x} with power on mode after enclosure refresh
    \    Verify SHT Adapter Info    ${server_info}    ${mezz_list}
    
TC 10: Verify that an enclosure refresh does not remove discovery - portmap info or create a second SHT in Aux mode
    [Documentation]    This test will verify that an enclosure refresh does not remove discovery - portmap info or create a second SHT in Aux mode
    [Tags]    PE    API    Automated    HBA
    ${bay_list}=    Get Test Tag Server Bay List
    Should Not Be Empty    ${bay_list}    msg=No server with ${Test_Tag.upper()} adapter present in the enlcosure
    ${encl}=    Get Enclosure Names
    ${encl_name}=    Set Variable    ${encl[0]}
    Power on ALL servers
    :FOR    ${x}    IN    @{bay_list}
    \    Power off server bay    ${x}
    \    ${server_info}=    Get Server Info    ${x}
    \    ${mezz_list}=     Get Test Tag Mezz Bay List    ${x}
    \    fusion_api_appliance_setup.Log to console and logfile    Verify SHT information for server:${x} with power off mode before enclosure refresh
    \    Verify SHT Adapter Info    ${server_info}    ${mezz_list}
    Refresh Enclosure    ${encl_name}
    :FOR    ${x}    IN    @{bay_list}
    \    ${server_info}=    Get Server Info    ${x}
    \    ${mezz_list}=     Get Test Tag Mezz Bay List    ${x}
    \    fusion_api_appliance_setup.Log to console and logfile    Verify SHT information for server:${x} with power off mode after enclosure refresh
    \    Verify SHT Adapter Info    ${server_info}    ${mezz_list}
    
TC 11: Verify blade disappears from enclosure on blade removal
    [Documentation]    This test will Verify blade disappears from enclosure on blade removal
    [Tags]    PE    API    Automated    HBA
    ${bay_list}=    Get Test Tag Server Bay List
    Should Not Be Empty    ${bay_list}    msg=No server with ${Test_Tag.upper()} adapter present in the enlcosure
    #Login to CIM SSH and Get EM Sessions
    Login to Fusion via SSH
    ${encl_list}=    Get EM Enclosures
    ${encl_name}=    Set Variable    ${encl_list[0]}
    Login to EM And Create Session
    :FOR    ${x}    IN    @{bay_list}
    \    Power off server bay    ${x}
    \    ${server_info}=    Get Server Info    ${x}
    \    ${mezz_list}=     Get Test Tag Mezz Bay List    ${x}
    \    ${ilo_ip}=    Get Server iLO Address    ${server_info}
    \    ${status}=    Login to iLO ipv4     ${ilo_ip}    ${iLO_UserName}    ${iLO_Password}
    \    Verify Server Harware Information    ${server_info}    Off    Monitored
    \    Verify SHT Adapter Info    ${server_info}    ${mezz_list}
    \    EFuse Blade    EFuseOn    ${x}
    \    Sleep    20
    \    Refresh Enclosure    ${encl_name}
    \    ${server_info_empty}=    Get Server Info    ${x}
    \    Should Not Be True    ${server_info_empty}
    \    EFuse Blade    EFuseOff    ${x}
    \    Sleep    150
    \    fusion_api_appliance_setup.Log to console and logfile      \t Waiting for Server in Bay:${x} to reach state:Monitored
    \    Wait Until Keyword Succeeds     12 min   20s      Device reached state    ${server_info['uri']}    Monitored
    #\    Logout of iLO
    Logout of Fusion Via SSH
    [Teardown]    Run Keyword If Test Failed    Run Keywords    EFuse Blade    EFuseOff    ${x}    AND    Sleep    600
    
TC 12: Verify blade - adapter shows back up on blade re-insertion
    [Documentation]    This test will Verify blade - adapter shows back up on blade re-insertion
    [Tags]    PE    API    Automated    HBA
    ${bay_list}=    Get Test Tag Server Bay List
    Should Not Be Empty    ${bay_list}    msg=No server with ${Test_Tag.upper()} adapter present in the enlcosure
    #Login to CIM SSH and Get EM Sessions
    Login to Fusion via SSH
    Login to EM And Create Session
    :FOR    ${x}    IN    @{bay_list}
    \    Power off server bay    ${x}
    \    ${server_info}=    Get Server Info    ${x}
    \    ${mezz_list}=     Get Test Tag Mezz Bay List    ${x}
    \    ${ilo_ip}=    Get Server iLO Address    ${server_info}
    \    ${status}=    Login to iLO ipv4     ${ilo_ip}    ${iLO_UserName}    ${iLO_Password}
    \    Verify Server Harware Information    ${server_info}    Off    Monitored
    \    Verify SHT Adapter Info    ${server_info}    ${mezz_list}
    \    EFuse Blade    EFuseOn    ${x}
    \    Sleep    20
    \    ${server_info_empty}=    Get Server Info    ${x}
    \    Should Not Be True    ${server_info_empty}
    \    EFuse Blade    EFuseOff    ${x}
    \    Sleep    150
    \    fusion_api_appliance_setup.Log to console and logfile      \t Waiting for Server in Bay:${x} to reach state:Monitored
    \    Wait Until Keyword Succeeds     12 min   20s      Device reached state    ${server_info['uri']}    Monitored
    \    ${server_info}=    Get Server Info    ${x}
    \    ${mezz_list}=     Get Test Tag Mezz Bay List    ${x}
    \    ${ilo_ip}=    Get Server iLO Address    ${server_info}
    \    ${status}=    Login to iLO ipv4     ${ilo_ip}    ${iLO_UserName}    ${iLO_Password}
    \    Power off server bay    ${x}
    \    Wait for Server Power Off    ${x}
    \    ${server_info}=    Get Server Info    ${x}
    \    Verify Server Harware Information    ${server_info}    Off    Monitored
    \    Verify SHT Adapter Info    ${server_info}    ${mezz_list}
    \    Logout of iLO
    Logout of Fusion Via SSH
    [Teardown]    Run Keyword If Test Failed    Run Keywords    EFuse Blade    EFuseOff    ${x}    AND    Sleep    600
