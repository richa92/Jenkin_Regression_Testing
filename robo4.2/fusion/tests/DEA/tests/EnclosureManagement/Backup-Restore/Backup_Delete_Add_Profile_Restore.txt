*** Settings ***
Documentation    Test suite executes Backup and Restore process from OneView OR using local file

...    = GENERIC USAGE =
...    pybot -L Trace -v APPLIANCE_IP:<APP_IPv4-IPv6> -v Server_Bay:<server bay>    Backup_Delete_Add_Profile_Restore.txt
...    = Variables =
...    | GIT_REPO_ROOT |      Required: Repo root path if NOT defined in environment variable this is mgmtfw root location|
...    | APPLIANCE_IP |       Required: OneView IPv4 address |


Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/dea_variables.py
Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/data_variables.py
Variables         ${GIT_REPO_ROOT}/mgmtfw/tests/thunderbird/variables/tBird_variables.py
Resource          ${GIT_REPO_ROOT}/fusion/Resources/api/settings/backups.txt
Resource          ${GIT_REPO_ROOT}/fusion/Resources/api/settings/restores.txt
Resource          ${GIT_REPO_ROOT}${RESOURCE_ROOT}/resource_all.txt
Resource          ${GIT_REPO_ROOT}${EM_RESOURCE_ROOT}/thunderbird_all.txt
Resource          ${GIT_REPO_ROOT}/fusion/Resources/api/activity/tasks.txt
Library           ${GIT_REPO_ROOT}/fusion/Resources/api/Uris.py
Library           RoboGalaxyLibrary
Library           MgmtFWLibrary
Library           FusionLibrary
Library           Collections
Library           Selenium2Library

Suite Setup       Run Keywords    Login to Fusion Via REST    AND    Clean UP Environment    AND    Cleanup Backup Restore Environment
Suite Teardown    Run Keywords    Clean UP Environment    AND    Cleanup Backup Restore Environment    AND    Logout of Fusion Via REST

*** Test Cases ***

TC 01: Test Case Executes Backup Process And Restores From OneView and Validates The Data 
    [Documentation]    This test executes backup process,Adds an additional profile,
    ...    Restores backup from oneview and Validates the data.
    [Tags]    Backup    Restore    Automated
    [Setup]   Set Library Search Order    fusion_api_appliance_setup    tasks    fusion_api_validation    common
    ${last_eventID}=    Get Last Fusion Event Id
    Setup Ethernet FCoE Appliance
    ${bay_list}=    Create List    ${Server_Bay}
    ${server_profile_body}=    Update Ethernet Server Profile body    ${Server_Bay}    ${server_profiles[0]}
    Create Server Profile    ${server_profile_body}
    ${server_state}=    Get Server State    ${Server_Bay}
    Should Be Equal    ${server_state}    ProfileApplied
    Power ON Server Blade Bay    ${Server_Bay}
    Sleep    180
    ${pre_ENC_DETAILS} =    Fusion Api Get Enclosures
    Validate Health Status    ${pre_ENC_DETAILS}    OK    Configured
    ${pre_LE_DETAILS} =    Fusion Api Get Logical Enclosure
    Validate Health Status    ${pre_LE_DETAILS}    OK    Consistent
    ${pre_HW_DETAILS} =    Fusion Api Get Server Hardware
    Validate Health Status    ${pre_HW_DETAILS}    OK
    ${pre_EG_DETAILS} =    Fusion Api Get Enclosure Groups
    Validate Health Status    ${pre_EG_DETAILS}    OK    Normal
    ${pre_SP_DETAILS} =    Fusion Api Get Server Profiles
    Validate Health Status    ${pre_SP_DETAILS}    OK    Normal
    ${pre_LIG_DETAILS} =    Fusion Api Get LIG
    Validate Health Status    ${pre_LIG_DETAILS}    None    Active
    ${pre_IC_DETAILS} =    Fusion Api Get Interconnect
    ${pre_ETH_DETAILS} =    Fusion Api Get Ethernet Networks
    Validate Health Status    ${pre_ETH_DETAILS}    OK    Active
    ${pre_FCOE_DETAILS} =    Fusion Api Get FCoE Networks
    Validate Health Status    ${pre_FCOE_DETAILS}    OK    Active
    #   Get server details before backup
    ${pre_backup_server_details}=  Get server Information    ${Server_Bay}
    Should Be Equal    ${pre_backup_server_details["status"]}    OK
    #   Get profile details before backup
    ${pre_backup_profile_details}=    Fusion Api Get Server Profiles     ${pre_backup_server_details['serverProfileUri']}
    Should Be Equal    ${pre_backup_profile_details["status"]}    OK
    # Create a backup
    Create Backup
    ${backup_uri}=    Get Backup URI
    Delete Server Profile    ${bay_list}
    Create Server Profile    ${server_profile_body}
    ${server_state}=    Get Server State    ${Server_Bay}
    Should Be Equal    ${server_state}    ProfileApplied
    Initiate Restore    ${backup_uri}
    #default wait is 90m
    Wait Until Keyword Succeeds    90m    30s    OneView Restore Complete
    Run Keywords    Login to Fusion Via REST
    ${resp} =    Fusion Api Get Server Profiles
    ${profile_list} =    Get From Dictionary    ${resp}    members
    ${status}=    Validate alertID in fusion events    ${last_eventID}    ${Server_Virtual_MACfault_AlertID}
    ${server_state}=    Run Keyword If    '${status}'=='PASS'
    ...    Run Keywords    Power OFF Server Blade Bay    ${Server_Bay}
    ...    AND    Sleep    120
    ...    AND    Unassign Profiles From Servers    ${profile_list}
    ...    AND    Assign Profiles To Servers    ${profile_list}
    ...    AND    Set Variable    Get Server State    ${Server_Bay}
    ...    AND    Should Be Equal    ${server_state}    ProfileApplied
    ...    AND    Power ON Server Blade Bay    ${Server_Bay}
    fusion_api_resource.Login to Fusion via SSH
    ${encl_list}=    fusion_api_em_ris.Get EM Enclosures
    fusion_api_resource.Refresh Enclosure    ${encl_list[0]}
    Logout of Fusion Via SSH
    #   Get server details post restore
    ${post_restore_server_details}=    Get server Information    ${Server_Bay}
    #   Get profile details post restore
    ${post_restore_profile_details}=    Fusion Api Get Server Profiles     ${post_restore_server_details['serverProfileUri']}
    #   post restore device details
    ${post_ENC_DETAILS} =    Fusion Api Get Enclosures
    ${post_LE_DETAILS} =    Fusion Api Get Logical Enclosure
    ${post_HW_DETAILS} =    Fusion Api Get Server Hardware
    ${post_EG_DETAILS} =    Fusion Api Get Enclosure Groups
    ${post_SP_DETAILS} =    Fusion Api Get Server Profiles
    ${post_LIG_DETAILS} =    Fusion Api Get LIG
    ${post_IC_DETAILS} =    Fusion Api Get Interconnect
    ${post_ETH_DETAILS} =    Fusion Api Get Ethernet Networks
    ${post_FCOE_DETAILS} =    Fusion Api Get FCoE Networks
    #  Compare the pre and post details
    Should be Equal    ${pre_ENC_DETAILS['count']}  ${post_ENC_DETAILS['count']}
    Should be Equal    ${pre_LE_DETAILS['count']}  ${post_LE_DETAILS['count']}
    Should be Equal    ${pre_HW_DETAILS['count']}  ${post_HW_DETAILS['count']}
    Should be Equal    ${pre_EG_DETAILS['count']}  ${post_EG_DETAILS['count']}
    Should be Equal    ${pre_SP_DETAILS['count']}  ${post_SP_DETAILS['count']}
    Should be Equal    ${pre_LIG_DETAILS['count']}  ${post_LIG_DETAILS['count']}
    Should be Equal    ${pre_IC_DETAILS['count']}  ${post_IC_DETAILS['count']}
    Should be Equal    ${pre_FCOE_DETAILS['count']}  ${post_FCOE_DETAILS['count']}
    #  Compare the server details before and after restore
    Should be Equal    ${pre_backup_server_details['model']}  ${post_restore_server_details['model']}
    Should be Equal    ${pre_backup_server_details['mpHostInfo']}  ${post_restore_server_details['mpHostInfo']}
    Should be Equal    ${pre_backup_server_details['mpState']}  ${post_restore_server_details['mpState']}
    Should be Equal    ${pre_backup_server_details['name']}  ${post_restore_server_details['name']}
    Should be Equal    ${pre_backup_server_details['position']}  ${post_restore_server_details['position']}
    Should be Equal    ${pre_backup_server_details['remoteSupportUri']}  ${post_restore_server_details['remoteSupportUri']}
    Should be Equal    ${pre_backup_server_details['serverHardwareTypeUri']}  ${post_restore_server_details['serverHardwareTypeUri']}
    Should be Equal    ${pre_backup_server_details['state']}  ${post_restore_server_details['state']}
    Should be Equal    ${pre_backup_server_details['uidState']}  ${post_restore_server_details['uidState']}
    Should be Equal    ${pre_backup_server_details['portMap']}  ${post_restore_server_details['portMap']}
    Should be Equal    ${pre_backup_server_details['powerState']}  ${post_restore_server_details['powerState']}
    #  Compare the server profile details before and after restore
    Should be Equal    ${pre_backup_profile_details['boot']}  ${post_restore_profile_details['boot']}
    Should be Equal    ${pre_backup_profile_details['bootMode']}  ${post_restore_profile_details['bootMode']}
    Should be Equal    ${pre_backup_profile_details['state']}  ${post_restore_profile_details['state']}
    Should be Equal    ${pre_backup_profile_details['serialNumber']}  ${post_restore_profile_details['serialNumber']}
    Should be Equal    ${pre_backup_profile_details['enclosureBay']}  ${post_restore_profile_details['enclosureBay']}
    Should be Equal    ${pre_backup_profile_details['connectionSettings']['connections']}  ${post_restore_profile_details['connectionSettings']['connections']}
    Should be Equal    ${pre_backup_profile_details['status']}  ${post_restore_profile_details['status']}
    [Teardown]    Clean Up Environment

TC 02: Test Case Executes Backup Process And Restores Using A Local Backup File and Validates The Data
    [Documentation]    This test executes backup process,Adds an additional profile,
    ...    Restores backup from local backup file and Validates the data
    [Tags]    Backup    Restore    Automated
    [Setup]    Set Library Search Order    fusion_api_appliance_setup    tasks    fusion_api_validation    common
    ${last_eventID}=    Get Last Fusion Event Id
    Clean UP Environment
    Set To Dictionary    ${encl_group['interconnectBayMappings'][0]}    logicalInterconnectGroupUri    LIG:${LIG_Name}
    Setup Ethernet FCoE Appliance
    ${bay_list}=    Create List    ${Server_Bay}
    Set To Dictionary    ${enet_connection['connections'][0]}    networkUri    ETH:${Ethernet_Name}
    ${server_profile_body}=    Update Ethernet Server Profile body    ${Server_Bay}    ${server_profiles[0]}
    Create Server Profile    ${server_profile_body}
    ${server_state}=    Get Server State    ${Server_Bay}
    Should Be Equal    ${server_state}    ProfileApplied
    Power ON Server Blade Bay    ${Server_Bay}
    Sleep    180
    ${pre_ENC_DETAILS} =    Fusion Api Get Enclosures
    Validate Health Status    ${pre_ENC_DETAILS}    OK    Configured
    ${pre_LE_DETAILS} =    Fusion Api Get Logical Enclosure
    Validate Health Status    ${pre_LE_DETAILS}    OK    Consistent
    ${pre_HW_DETAILS} =    Fusion Api Get Server Hardware
    Validate Health Status    ${pre_HW_DETAILS}    OK
    ${pre_EG_DETAILS} =    Fusion Api Get Enclosure Groups
    Validate Health Status    ${pre_EG_DETAILS}    OK    Normal
    ${pre_SP_DETAILS} =    Fusion Api Get Server Profiles
    Validate Health Status    ${pre_SP_DETAILS}    OK    Normal
    ${pre_LIG_DETAILS} =    Fusion Api Get LIG
    Validate Health Status    ${pre_LIG_DETAILS}    None    Active
    ${pre_IC_DETAILS} =    Fusion Api Get Interconnect
    ${pre_ETH_DETAILS} =    Fusion Api Get Ethernet Networks
    Validate Health Status    ${pre_ETH_DETAILS}    OK    Active
    ${pre_FCOE_DETAILS} =    Fusion Api Get FCoE Networks
    Validate Health Status    ${pre_FCOE_DETAILS}    OK    Active
    #   Get server details before backup
    ${pre_backup_server_details}=  Get server Information    ${Server_Bay}
    Should Be Equal    ${pre_backup_server_details["status"]}    OK
    #   Get server details post restore
    ${pre_backup_profile_details}=    Fusion Api Get Server Profiles     ${pre_backup_server_details['serverProfileUri']}
    Should Be Equal    ${pre_backup_profile_details["status"]}    OK
    ${Backup_file}=    Build OV Back up File Name
    # Create a backup and download to a local file
    Create Backup
    ${backup_uri}=    Get Backup URI
    Download Backup    ${backup_uri}    ${Backup_file}
    Delete Server Profile    ${bay_list}
    Sleep    120
    ${server_profile_body}=    Update FCOE Server Profile body     ${Server_Bay}    ${server_profiles[0]}
    Create Server Profile    ${server_profile_body}
    ${server_state}=    Get Server State    ${Server_Bay}
    Should Be Equal    ${server_state}    ProfileApplied
    # Upload the local backup file and initiate restore process
    Upload Backup    ${Backup_file}
    ${backup_uri}=    Get Backup URI
    Initiate Restore    ${backup_uri}
    #default wait is 90m
    Wait Until Keyword Succeeds    90m    30s    OneView Restore Complete
    Run Keywords    Login to Fusion Via REST
    ${resp} =    Fusion Api Get Server Profiles
    ${profile_list} =    Get From Dictionary    ${resp}    members
    ${status}=    Validate alertID in fusion events    ${last_eventID}    ${Server_Virtual_MACfault_AlertID}
    ${server_state}=    Run Keyword If    '${status}'=='PASS'
    ...    Run Keywords    Power OFF Server Blade Bay    ${Server_Bay}
    ...    AND    Sleep    120
    ...    AND    Unassign Profiles From Servers    ${profile_list}
    ...    AND    Assign Profiles To Servers    ${profile_list}
    ...    AND    Set Variable    Get Server State    ${Server_Bay}
    ...    AND    Should Be Equal    ${server_state}    ProfileApplied
    ...    AND    Power ON Server Blade Bay    ${Server_Bay}
    fusion_api_resource.Login to Fusion via SSH
    ${encl_list}=    fusion_api_em_ris.Get EM Enclosures
    fusion_api_resource.Refresh Enclosure    ${encl_list[0]}
    Logout of Fusion Via SSH
    #   Get server details post restore
    ${post_restore_server_details}=    Get server Information    ${Server_Bay}
    #   Get profile details post restore
    ${post_restore_profile_details}=    Fusion Api Get Server Profiles     ${post_restore_server_details['serverProfileUri']}
    #   post restore device details
    ${post_ENC_DETAILS} =    Fusion Api Get Enclosures
    ${post_LE_DETAILS} =    Fusion Api Get Logical Enclosure
    ${post_HW_DETAILS} =    Fusion Api Get Server Hardware
    ${post_EG_DETAILS} =    Fusion Api Get Enclosure Groups
    ${post_SP_DETAILS} =    Fusion Api Get Server Profiles
    ${post_LIG_DETAILS} =    Fusion Api Get LIG
    ${post_IC_DETAILS} =    Fusion Api Get Interconnect
    ${post_ETH_DETAILS} =    Fusion Api Get Ethernet Networks
    ${post_FCOE_DETAILS} =    Fusion Api Get FCoE Networks
    #  Compare the pre and post details
    Should be Equal    ${pre_ENC_DETAILS['count']}  ${post_ENC_DETAILS['count']}
    Should be Equal    ${pre_LE_DETAILS['count']}  ${post_LE_DETAILS['count']}
    Should be Equal    ${pre_HW_DETAILS['count']}  ${post_HW_DETAILS['count']}
    Should be Equal    ${pre_EG_DETAILS['count']}  ${post_EG_DETAILS['count']}
    Should be Equal    ${pre_SP_DETAILS['count']}  ${post_SP_DETAILS['count']}
    Should be Equal    ${pre_LIG_DETAILS['count']}  ${post_LIG_DETAILS['count']}
    Should be Equal    ${pre_IC_DETAILS['count']}  ${post_IC_DETAILS['count']}
    Should be Equal    ${pre_FCOE_DETAILS['count']}  ${post_FCOE_DETAILS['count']}
    #  Compare the server details before and after restore
    Should be Equal    ${pre_backup_server_details['model']}  ${post_restore_server_details['model']}
    Should be Equal    ${pre_backup_server_details['mpHostInfo']}  ${post_restore_server_details['mpHostInfo']}
    Should be Equal    ${pre_backup_server_details['mpState']}  ${post_restore_server_details['mpState']}
    Should be Equal    ${pre_backup_server_details['name']}  ${post_restore_server_details['name']}
    Should be Equal    ${pre_backup_server_details['position']}  ${post_restore_server_details['position']}
    Should be Equal    ${pre_backup_server_details['remoteSupportUri']}  ${post_restore_server_details['remoteSupportUri']}
    Should be Equal    ${pre_backup_server_details['serverHardwareTypeUri']}  ${post_restore_server_details['serverHardwareTypeUri']}
    Should be Equal    ${pre_backup_server_details['state']}  ${post_restore_server_details['state']}
    Should be Equal    ${pre_backup_server_details['uidState']}  ${post_restore_server_details['uidState']}
    Should be Equal    ${pre_backup_server_details['portMap']}  ${post_restore_server_details['portMap']}
    Should be Equal    ${pre_backup_server_details['powerState']}  ${post_restore_server_details['powerState']}
    #  Compare the server profile details before and after restore
    Should be Equal    ${pre_backup_profile_details['boot']}  ${post_restore_profile_details['boot']}
    Should be Equal    ${pre_backup_profile_details['bootMode']}  ${post_restore_profile_details['bootMode']}
    Should be Equal    ${pre_backup_profile_details['state']}  ${post_restore_profile_details['state']}
    Should be Equal    ${pre_backup_profile_details['serialNumber']}  ${post_restore_profile_details['serialNumber']}
    Should be Equal    ${pre_backup_profile_details['enclosureBay']}  ${post_restore_profile_details['enclosureBay']}
    Should be Equal    ${pre_backup_profile_details['connectionSettings']['connections']}  ${post_restore_profile_details['connectionSettings']['connections']}
    Should be Equal    ${pre_backup_profile_details['status']}  ${post_restore_profile_details['status']}
    [Teardown]    Clean Up Environment