*** Settings ***
Documentation     Test suite to verify the CNA profile and blade status after Server Efuse 
Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/dea_variables.py
Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/data_variables.py
Variables         ${GIT_REPO_ROOT}/mgmtfw/tests/thunderbird/variables/tBird_variables.py
Resource          ${GIT_REPO_ROOT}${RESOURCE_ROOT}/resource_all.txt
Resource          ${GIT_REPO_ROOT}${EM_RESOURCE_ROOT}/thunderbird_all.txt
Library           RoboGalaxyLibrary
Library           FusionLibrary
Library           MgmtFWLibrary
Library           Selenium2Library
Library           Collections

Suite Setup       Run Keywords    Login to Fusion Via REST    AND    Clean UP Environment    AND    Setup Ethernet FCoE Appliance
Suite Teardown    Logout of Fusion Via REST
 
*** Test Cases ***

TC 01: Verify Enet profiles status after efuse the blade
    [Documentation]    Verify Enet profiles status after efuse the blade
    [Tags]    PE    API    Automated    CNA    Ethernet
    [Setup]    Set Library Search Order    fusion_api_resource    ssh    em_ris    fusion_api_em_ris    fusion_api_validation    common
    Power off ALL Servers
    Sleep    120
    Remove All Server Profiles
    Sleep    60
    Login to Fusion via SSH
    Login And Create EM Session
    ${bay_list}=    Get CNA Mezz Server Bay List
    :FOR    ${blade_bay}    IN    @{bay_list}
    \    ${blade_bay}=    Convert To Integer    ${blade_bay}
    \    Set To Dictionary    ${enet_connection['connections'][0]}    networkUri    ETH:${Ethernet_Name}
    \    ${server_profile_body}=    Update Ethernet Server Profile body     ${blade_bay}    ${server_profiles[0]}    
    \    ${resp}=    Fusion Api Create Server Profile    body=${server_profile_body}
    \    ${task} =    Wait For TaskType Success State    ${resp}     timeout=20 mins    interval=20s
    \    ${task_state} =     Get From dictionary     ${task}     taskState
    \    Should Match Regexp    ${task_state}   ((?i)Warning|Completed)
    \    ${server_state}=    Get Server State    ${blade_bay}
    \    Should Be Equal    ${server_state}    ProfileApplied
    \    ${server_status}=    Get Fusion Device Health Status    ${BladeDevice_EM}    ${blade_bay}
    \    Should Be Equal    ${server_status}    OK
    \    ${profile_status}=    Get Server Profile Status    ${blade_bay}
    \    Should Be Equal    ${profile_status}    OK
    \    ${server_info}=    Get Server Information    ${blade_bay}
    \    ${serverProfileUri}=    Get From Dictionary    ${server_info}    serverProfileUri
    \    Efuse Server Device    EFuseOn   ${blade_bay}
    \    Wait For Device Status    ${BladeDevice_EM}    ${blade_bay}    Absent
    \    ${taskResp}=    Fusion Api Get Resource     ${serverProfileUri}
    \    ${profile_status}=    Get from Dictionary    ${taskResp}    status
    \    Should Be Equal    ${profile_status}   Critical        
    \    ${taskUri}=    Get from Dictionary    ${taskResp}  taskUri
    \    ${taskData}=    Fusion Api Get Resource    ${taskUri}
    \    ${bladeProgress}=   Get From Dictionary  ${taskData}  progressUpdates
    \    ${bladeStatus}=  Get from Dictionary   @{bladeProgress}[0]   statusUpdate
    \    Should Be Equal    ${bladeStatus}  Server hardware removed
    \    Efuse Server Device    EFuseOff    ${blade_bay}
    \    Wait For Device Status   ${BladeDevice_EM}    ${blade_bay}    OK
    \    Sleep    120
    \    Wait For Device State    ${BladeDevice_EM}    ${blade_bay}    ProfileApplied
    \    ${server_status}=    Get Fusion Device Health Status    ${BladeDevice_EM}    ${blade_bay}
    \    Should Be Equal    ${server_status}    OK
    \    ${profile_status}=    Get Server Profile Status    ${blade_bay}
    \    Should Be Equal    ${server_status}    OK
    \    ${ICM_Bay}=    Convert To Integer    ${ICM_Bay}
    \    ${icm_status}=    Get Fusion Device Health Status    ${ICMDevice_EM}    ${ICM_Bay}
    \    Should Be Equal    ${icm_status}    OK
    \    Power OFF Server Blade Bay    ${blade_bay}
    \    Sleep    120
    \    Remove Server Profile Blade Bay    ${blade_bay}
    \    Sleep    120
    [Teardown]    Run Keyword If Test Failed    Run Keywords      Efuse Server Device    EFuseOff    ${blade_bay}   AND    
    ...    Wait For Device Status    ${BladeDevice_EM}    ${blade_bay}    OK

TC 02: Verify FCoE profiles status after efuse the blade
    [Documentation]    Verify FCoE profiles status after efuse the blade
    [Tags]    PE    API    Automated    CNA    FCOE
    [Setup]    Set Library Search Order    fusion_api_resource    ssh    em_ris    fusion_api_em_ris    fusion_api_validation    common
    Power off ALL Servers
    Sleep    180
    Remove All Server Profiles
    Sleep    60
    Login to Fusion via SSH
    Login And Create EM Session
    ${bay_list}=    Get CNA Mezz Server Bay List
    :FOR    ${blade_bay}    IN    @{bay_list}
    \    ${blade_bay}=    Convert To Integer    ${blade_bay}
    \    Set To Dictionary    ${fcoe_connection['connections'][0]}    networkUri    FCOE:${FCOE_Name}
    \    ${server_profile_body}=    Update FCOE Server Profile body     ${blade_bay}    ${server_profiles[0]}    
    \    ${resp}=    Fusion Api Create Server Profile    body=${server_profile_body}
    \    ${task} =    Wait For TaskType Success State    ${resp}     timeout=20 mins    interval=20s
    \    ${task_state} =     Get From dictionary     ${task}     taskState
    \    Should Match Regexp    ${task_state}   ((?i)Warning|Completed)
    \    ${server_state}=    Get Server State    ${blade_bay}
    \    Should Be Equal    ${server_state}    ProfileApplied
    \    ${server_status}=    Get Fusion Device Health Status    ${BladeDevice_EM}    ${blade_bay}
    \    Should Be Equal    ${server_status}    OK
    \    ${profile_status}=    Get Server Profile Status    ${blade_bay}
    \    Should Be Equal    ${profile_status}    OK
    \    ${server_info}=    Get Server Information    ${blade_bay}
    \    ${serverProfileUri}=    Get From Dictionary    ${server_info}    serverProfileUri
    \    Efuse Server Device    EFuseOn   ${blade_bay}
    \    Wait For Device Status    ${BladeDevice_EM}    ${blade_bay}    Absent
    \    ${taskResp}=    Fusion Api Get Resource     ${serverProfileUri}
    \    ${profile_status}=    Get from Dictionary    ${taskResp}    status
    \    Should Be Equal    ${profile_status}   Critical        
    \    ${taskUri}=    Get from Dictionary    ${taskResp}  taskUri
    \    ${taskData}=    Fusion Api Get Resource    ${taskUri}
    \    ${bladeProgress}=   Get From Dictionary  ${taskData}  progressUpdates
    \    ${bladeStatus}=  Get from Dictionary   @{bladeProgress}[0]   statusUpdate
    \    Should Be Equal    ${bladeStatus}  Server hardware removed
    \    Efuse Server Device    EFuseOff    ${blade_bay}
    \    Wait For Device Status   ${BladeDevice_EM}    ${blade_bay}    OK
    \    Sleep    120
    \    Wait For Device State    ${BladeDevice_EM}    ${blade_bay}    ProfileApplied
    \    ${server_status}=    Get Fusion Device Health Status    ${BladeDevice_EM}    ${blade_bay}
    \    Should Be Equal    ${server_status}    OK
    \    ${profile_status}=    Get Server Profile Status    ${blade_bay}
    \    Should Be Equal    ${server_status}    OK
    \    ${ICM_Bay}=    Convert To Integer    ${ICM_Bay}    
    \    ${icm_status}=    Get Fusion Device Health Status    ${ICMDevice_EM}    ${ICM_Bay}
    \    Should Be Equal    ${icm_status}    OK
    \    Power OFF Server Blade Bay    ${blade_bay}
    \    Sleep    120
    \    Remove Server Profile Blade Bay    ${blade_bay}
    \    Sleep    120
    [Teardown]    Run Keyword If Test Failed    Run Keywords      Efuse Server Device    EFuseOff    ${blade_bay}   AND    
    ...    Wait For Device Status    ${BladeDevice_EM}    ${blade_bay}    OK
