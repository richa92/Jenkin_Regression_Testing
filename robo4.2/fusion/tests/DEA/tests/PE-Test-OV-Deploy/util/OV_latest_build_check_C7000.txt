*** Settings ***
Documentation     Test Suite To Check For The Availability Of Latest OV Build In Fusion Depot
...               pybot -L Trace -v APPLIANCE_IP:<APP_IPv4-IPv6> -v SSH_HOST:<IPv4-IPv6>    OV_latest_build_check.txt

Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/dea_variables.py
Resource          ${GIT_REPO_ROOT}${RESOURCE_ROOT}/resource_all.txt
Resource          ${GIT_REPO_ROOT}/fusion/tests/DEA/tests/PE-Test-C7000-Deploy/00_OVA_deployment/resource.txt
Library           RoboGalaxyLibrary
Library           FusionLibrary
Library           MgmtFWLibrary
Library           Selenium2Library
Library           Collections
Library           download_ov_image
Suite Setup       Run Keywords    Login to Fusion Via REST    AND    fusion_api_resource.Login to Fusion via SSH
#Suite Teardown    Run Keywords    Logout of Fusion Via REST

***variables***

${Fusion_Repo}                 http://ci-artifacts02.vse.rdlabs.hpecorp.net/Fusion/rel/4.20/DDImage/SSH/


*** Test Cases ***

TC 01: Checking Latest OV Build For Continuous Testing
    [Documentation]    This Test Case Checks For The Availability Of Latest OV Build In Fusion Repo And Remove the Old VM
    [Tags]    Continuous    OVbuild    Check    Automated
    Connect To VI Server    ${vSphere_IP}    ${vSphere_Username}    ${vSphere_Password}
    ${version}=    Get OneView Version
    ${result}=    Fetch From Left    ${version}     ,
    ${result_1}=    Fetch From Right    ${result}     -
    ${current_build}=    Convert To Integer    ${result_1}
    Set Global Variable    ${VM_NAME}    ${Fusion_Name}${current_build}
    :FOR    ${index}    IN RANGE    0    200
    \    ${dd_image}=     Get File URL    ${Fusion_Repo}
    \    ${result1}=    Fetch From Left    ${dd_image}    -withsig
    \    ${result2}=    Fetch From Right    ${result1}    SSH-
    \    ${result3}=    Fetch From Right    ${result2}    -
    \    ${latest_build}=    Convert To Integer    ${result3}
    \    Run Keyword If    ${latest_build} > ${current_build}    Run Keywords
    \    ...    RoboGalaxyLibrary.power_off_vm    ${VM_NAME}    AND    RoboGalaxyLibrary.destroy_vm    ${VM_NAME}    AND
    \    ...    Exit For Loop
    \    ...    ELSE    Sleep    3600

***keywords***

Get OneView Version
    [Documentation]    To get the OV version
    ${Command}=    Set Variable    cat /ci/etc/version
    ${stdout}    ${stderr}    ${rc}=    Execute Command    ${Command}    return_stderr=True    return_rc=True}
    Should Be Equal As Integers    ${rc}    0    msg=Failed to get Fusion Version.
    Log To Console    \nFusion Version: ${stdout}
    [Return]     ${stdout}
