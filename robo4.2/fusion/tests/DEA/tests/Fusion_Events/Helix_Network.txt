*** Settings ***
Documentation    Test suite to validate Helix alerts
...    It covers testing of:
...        EmFuseFault
...    = GENERIC USAGE =
...    | pybot | -v ENC_SERIAL_NO:[enclosure serial #] | -v APPLIANCE_IP:<ipv4> |-v GIT_REPO_ROOT: | Helix_Network.txt |
...    = Variables =
...    | GIT_REPO_ROOT |      Required: Repo root path if NOT defined in environment variable this is mgmtfw root location|
...    | ENC_SERIAL_NO |      Optional: If omitted, will use the 1st enclosure detected in OV |
...    | APPLIANCE_IP |       Required: OneView IPv4 address |

Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/dea_variables.py
Variables         ${GIT_REPO_ROOT}/mgmtfw/tests/thunderbird/variables/tBird_variables.py
Resource          ${GIT_REPO_ROOT}${RESOURCE_ROOT}/resource_all.txt
Resource          ${GIT_REPO_ROOT}${EM_RESOURCE_ROOT}/thunderbird_all.txt
Library           RoboGalaxyLibrary
Library           MgmtFWLibrary
Library           json

Suite Setup       Configure Events Test Environment
Suite Teardown    Run Keywords  Logout of EM RIS   AND    Logout of Fusion Via REST

*** Test Case ***
TC 01: Verify Events For EmFuseFault 
    [Documentation]    Verify EM EmFuseFault alert
    [Tags]    EM    FLM3.00    Automated
    Run Keyword and Ignore Error    Wait for Node Consistent
    Wait for Device OK    ${EM_Device}    1
    Wait for Device OK    ${EM_Device}    2
    ${standby_em_bay}=    Get Diags EmClusterStatus Standby Node
    ${active_em_bay}=    Get Diags EmClusterStatus Active Node
    ${last_fusion_event_id}=    get last fusion event ID
    ${EM_Fault}=    Set EM RIS Faults    EmFaultInjection  ${standby_em_bay}  TVSFuse  True
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Fusion Event Sent By EM    ${EL_Em_FuseFault}    ${last_fusion_event_id}    ${Enclosure_category}
    Log To Console    Removing the EM from the bay:${standby_em_bay} and verify event
    ${enabled_switch_port}=    Get List of Enabled Switchports
    RIS EM Efuse On OTHER EM    ${standby_em_bay}
    Log To Console    Sleeping 60 seconds
    Sleep    60
    Log To Console    Inserting the EM to the bay:${standby_em_bay} and verify event
    RIS EM Efuse Off OTHER EM Without Healthcheck    ${standby_em_bay}
    Log To Console    Sleeping 2 minutes
    Sleep    120
    # Additional time needed for the active EM to determine that the standby is operational.Confirmed with dev on the wait time
    Log to Console    Sleeping 5 minutes
    Sleep    ${EM_REBOOT_TIME}
    Wait for Device OK    ${EM_Device}    ${standby_em_bay}
    [Teardown]    Run Keyword If Test Failed    Run Keywords    RIS EM Efuse On OTHER EM    ${standby_em_bay}    AND    Sleep    60    AND    RIS EM Efuse Off OTHER EM Without Healthcheck    ${standby_em_bay}
    ...    AND    Wait for Device OK    ${EM_Device}    ${standby_em_bay}


TC: 02 : Test External port 1GbFault BAY1
    [Documentation]    Test Appliance port 1 1GbFault BAY1
    [Tags]    EM    FLM3.00    Automated
    # Get enclsoureManager External Port Status and Health
    ${em1_status}=    Get AppliancePorts MAU Health  123  MAU
    Should Be Equal As Strings  ${em1_status}  OK
    ${em1_health}=    Get EnclosureManager Health  1
    Should Be Equal As Strings  ${em1_health}  OK
    ${em1_fault}=    Get AppliancePorts MAU Fault Status  123  Mau1GbTransceiverElinkPort  MAU
    Should Be Equal As Strings  ${em1_fault}  OK
    ${status}=    Get SwitchPorts Fault Status   123  FaultMediumAttachmentUnit
    Should Be Equal As Strings  ${status}  OK
    ${last_fusion_event_id}=    get last fusion event ID
    #Set Fault ON
    Set EM MAU Faults    1  External  1GbFault    on
    Sleep    20
    #${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log All
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    #Verify Audit Log Alert Event    ${EM_EmMau1GbTransceiverElinkPort}    ${EM_MAU}    123    600
    Verify Fusion Event Sent By EM    ${EM_EmMau1GbTransceiverElinkPort}    ${last_fusion_event_id}    ${Enclosure_category}
    # Get enclsoureManager External Port Status and Health
    ${em1_status}=    Get AppliancePorts MAU Health  123  MAU
    Should Be Equal As Strings  ${em1_status}  Warning
    ${em1_health}=    Get EnclosureManager Health  1
    Should Be Equal As Strings  ${em1_health}  Warning
    ${em1_fault}=    Get AppliancePorts MAU Fault Status  123  Mau1GbTransceiverElinkPort  MAU
    Should Be Equal As Strings  ${em1_fault}  Warning
    ${status}=    Get SwitchPorts Fault Status   123  FaultMediumAttachmentUnit
    Should Be Equal As Strings  ${status}  Warning
    ${em2_status}=    Get AppliancePorts MAU Health  223  MAU
    Should Be Equal As Strings  ${em2_status}  OK
    ${em2_health}=    Get EnclosureManager Health  2
    Should Be Equal As Strings  ${em2_health}  OK
    ${em2_fault}=    Get AppliancePorts MAU Fault Status  223  Mau1GbTransceiverElinkPort  MAU
    Should Be Equal As Strings  ${em2_fault}  OK
    ${status}=    Get SwitchPorts Fault Status   223  FaultMediumAttachmentUnit
    Should Be Equal As Strings  ${status}  OK
    # Set Fault OFF
    Set EM MAU Faults    1  External  1GbFault    off
    Sleep    20
    # Audit Log
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Fusion Event Sent By EM    ${EM_EmMau1GbTransceiverElinkPortCleared}    ${last_fusion_event_id}    ${Enclosure_category}
    # Get enclsoureManager Management Port Status and Health
    ${em1_status}=    Get AppliancePorts MAU Health  123  MAU
    Should Be Equal As Strings  ${em1_status}  OK
    ${em1_health}=    Get EnclosureManager Health  1
    Should Be Equal As Strings  ${em1_health}  OK
    ${em1_fault}=    Get AppliancePorts MAU Fault Status  123  Mau1GbTransceiverElinkPort  MAU
    Should Be Equal As Strings  ${em1_fault}  OK
    ${status}=    Get SwitchPorts Fault Status   123  FaultMediumAttachmentUnit
    Should Be Equal As Strings  ${status}  OK
    [Teardown]    Run Keyword If Test Failed    Set EM MAU Faults    1  External  1GbFault    off
    
        
TC: 03 : Test External port 1GbFault BAY2
    [Documentation]    Test External port 1GbFault BAY2
   [Tags]    EM    FLM3.00    Automated   
    # Get enclsoureManager External Port Status and Health
    ${em1_status}=    Get AppliancePorts MAU Health  223  MAU
    Should Be Equal As Strings  ${em1_status}  OK
    ${em1_health}=    Get EnclosureManager Health  2
    Should Be Equal As Strings  ${em1_health}  OK
    ${em1_fault}=    Get AppliancePorts MAU Fault Status  223  Mau1GbTransceiverElinkPort  MAU
    Should Be Equal As Strings  ${em1_fault}  OK
    ${status}=    Get SwitchPorts Fault Status   223  FaultMediumAttachmentUnit
    Should Be Equal As Strings  ${status}  OK
    ${last_fusion_event_id}=    get last fusion event ID
    #Set Fault ON
    Set EM MAU Faults    2  External  1GbFault    on
    Sleep    20
    # Audit Log
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    #Verify Audit Log Alert Event    ${EM_EmMau1GbTransceiverElinkPort}    ${EM_MAU}    223    200
    Verify Fusion Event Sent By EM    ${EM_EmMau1GbTransceiverElinkPort}    ${last_fusion_event_id}    ${Enclosure_category}
    # Get enclsoureManager External Port Status and Health
    ${em1_status}=    Get AppliancePorts MAU Health  223  MAU
    Should Be Equal As Strings  ${em1_status}  Warning
    ${em1_health}=    Get EnclosureManager Health  2
    Should Be Equal As Strings  ${em1_health}  Warning
    ${em1_fault}=    Get AppliancePorts MAU Fault Status  223  Mau1GbTransceiverElinkPort  MAU
    Should Be Equal As Strings  ${em1_fault}  Warning
    ${status}=    Get SwitchPorts Fault Status   223  FaultMediumAttachmentUnit
    Should Be Equal As Strings  ${status}  Warning
    ${em2_status}=    Get AppliancePorts MAU Health  123  MAU
    Should Be Equal As Strings  ${em2_status}  OK
    ${em2_health}=    Get EnclosureManager Health  1
    Should Be Equal As Strings  ${em2_health}  OK
    ${em2_fault}=    Get AppliancePorts MAU Fault Status  123  Mau1GbTransceiverElinkPort  MAU
    Should Be Equal As Strings  ${em2_fault}  OK
    ${status}=    Get SwitchPorts Fault Status   123  FaultMediumAttachmentUnit
    Should Be Equal As Strings  ${status}  OK
    ${last_fusion_event_id}=    get last fusion event ID
    # Set Fault OFF
    Set EM MAU Faults    2  External  1GbFault    off
    Sleep    20
    # Audit Log
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Fusion Event Sent By EM    ${EM_EmMau1GbTransceiverElinkPortCleared}    ${last_fusion_event_id}    ${Enclosure_category}
    # Get enclsoureManager Management Port Status and Health
    ${em1_status}=    Get AppliancePorts MAU Health  223  MAU
    Should Be Equal As Strings  ${em1_status}  OK
    ${em1_health}=    Get EnclosureManager Health  2
    Should Be Equal As Strings  ${em1_health}  OK
    ${em1_fault}=    Get AppliancePorts MAU Fault Status  223  Mau1GbTransceiverElinkPort  MAU
    Should Be Equal As Strings  ${em1_fault}  OK
    ${status}=    Get SwitchPorts Fault Status   223  FaultMediumAttachmentUnit
    Should Be Equal As Strings  ${status}  OK
    [Teardown]    Run Keyword If Test Failed    Set EM MAU Faults    2  External  1GbFault    off

TC: 04 : Test Helix EM Management Network port TransceiverFault on BAY1
    [Documentation]    Test Helix EM Management Network port TransceiverFault- MauTransceiverFailureMgmtPort and EmMauTransceiverFailureMgmtPortCleared  on BAY1
    [Tags]    EM    FLM3.00    Automated
    # Get enclsoureManager  Management Port Status and Health
    ${em1_status}=    Get AppliancePorts MAU Health  122  MAU
    Should Be Equal As Strings  ${em1_status}  OK
    ${em1_health}=    Get EnclosureManager Health  1
    Should Be Equal As Strings  ${em1_health}  OK
    ${em1_fault}=    Get AppliancePorts MAU Fault Status  122  MauTransceiverFailureMgmtPort  MAU
    Should Be Equal As Strings  ${em1_fault}  OK
    ${status}=    Get SwitchPorts Fault Status   122  FaultMediumAttachmentUnit
    Should Be Equal As Strings  ${status}  OK
    #Set Fault ON
    ${last_fusion_event_id}=    get last fusion event ID
    Set EM MAU Faults    1  Management  TransceiverFault    on
    # Audit Log
    Sleep    20
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    #Verify Audit Log Alert Event    ${EM_EmMauTransceiverFailureMgmtPort}    ${EM_MAU}    122    200
    Verify Fusion Event Sent By EM    ${EM_EmMauTransceiverFailureMgmtPort}    ${last_fusion_event_id}    ${Enclosure_category}
    Set EM MAU Faults    1  Management  TransceiverFault    off
    Sleep   20
    # Audit Log
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    #Verify Audit Log Alert Event    ${EM_EmMauTransceiverFailureMgmtPortCleared}    ${EM_MAU}    122    200
    Verify Fusion Event Sent By EM    ${EM_EmMauTransceiverFailureMgmtPortCleared}    ${last_fusion_event_id}    ${Enclosure_category}
    [Teardown]    Run Keyword If Test Failed    Set EM MAU Faults    1  Management  TransceiverFault    off

TC: 05 : Test Helix EM Management Network port TransceiverFault on BAY2
    [Documentation]    Test Helix EM Management Network port TransceiverFault- MauTransceiverFailureMgmtPort and EmMauTransceiverFailureMgmtPortCleared  on BAY2
    [Tags]    EM    FLM3.00    Automated
    # Get enclsoureManager Management Port Status and Health
    ${em1_status}=    Get AppliancePorts MAU Health  222  MAU
    Should Be Equal As Strings  ${em1_status}  OK
    ${em1_health}=    Get EnclosureManager Health  2
    Should Be Equal As Strings  ${em1_health}  OK
    ${em1_fault}=    Get AppliancePorts MAU Fault Status  222  MauTransceiverFailureMgmtPort  MAU
    Should Be Equal As Strings  ${em1_fault}  OK
    ${status}=    Get SwitchPorts Fault Status   222  FaultMediumAttachmentUnit
    Should Be Equal As Strings  ${status}  OK
    ${last_fusion_event_id}=    get last fusion event ID
    #Set Fault ON
    Set EM MAU Faults    2  Management  TransceiverFault    on
    Sleep   20
    # Audit Log
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    #Verify Audit Log Alert Event    ${EM_EmMauTransceiverFailureMgmtPort}    ${EM_MAU}    222    200
    Verify Fusion Event Sent By EM    ${EM_EmMauTransceiverFailureMgmtPort}    ${last_fusion_event_id}    ${Enclosure_category}
    # Set Fault OFF
    Set EM MAU Faults    2  Management  TransceiverFault    off
    Sleep   20
    # Audit Log
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    #Verify Audit Log Alert Event    ${EM_EmMauTransceiverFailureMgmtPortCleared}    ${EM_MAU}    222    200
    Verify Fusion Event Sent By EM    ${EM_EmMauTransceiverFailureMgmtPortCleared}    ${last_fusion_event_id}    ${Enclosure_category}
    [Teardown]    Run Keyword If Test Failed    Set EM MAU Faults    2  Management  TransceiverFault    off