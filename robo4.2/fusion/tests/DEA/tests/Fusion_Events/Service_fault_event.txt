*** Settings ***
Documentation     Checking OneView service events  alerts
...    = GENERIC USAGE =
...    | pybot | -v ENC_SERIAL_NO:[enclosure serial #] | -v APPLIANCE_IP:<ipv4> | -v CIM_Linux_IP:<ipv4> |-v GIT_REPO_ROOT: | Service_fault_event.txt |
...    = Variables =
...    | GIT_REPO_ROOT |      Required: Repo root path if NOT defined in environment variable this is mgmtfw root location|
...    | ENC_SERIAL_NO |      Optional: If omitted, will use the 1st enclosure detected in OV |
...    | APPLIANCE_IP |       Required: OneView IPv4 address |
...    | CIM_Linux_IP |       Required:CI Manager ipv4 under test |

Library           RoboGalaxyLibrary
Library           MgmtFWLibrary
Library           Dialogs
Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/dea_variables.py
Resource          ${GIT_REPO_ROOT}${RESOURCE_ROOT}/resource_all.txt
Variables         ${GIT_REPO_ROOT}/mgmtfw/tests/thunderbird/variables/tBird_variables.py
Resource          ${GIT_REPO_ROOT}/mgmtfw/tests/thunderbird/resources/thunderbird_all.txt
Suite Setup       Configure Events Test Environment
Suite Teardown    Run Keywords  Logout of EM RIS   AND    Logout of Fusion Via REST

*** Test Cases ***

TC 01: Validate Service Event Alerts By Triggering Service Events Fault
    [Documentation]    Validate Service Event Alerts By Triggering Service Events Fault
    [Tags]    OneViewService    FLM2.02    Automated
    ${last_fusion_event_id}=    Get Last Fusion Event Id
    Set the Fake Backend ERS    true
    Set IRS operation    Register   ${IRS_IP}    ${IRS_Port}
    Validate the ERS IPAddress and port   ${IRS_IP}    ${IRS_Port}
    Validate ServiceEvents Health Status   ${HEALTH_OK}
    EM API Get Diags    /ErsFakeBackend/True/Success/Success/ReceiverError
    Set IRS operation   send_test_event
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Alert Event    ${OneView_Service_Events_CommFault}    ServiceEvents    None    240
    Verify Fusion Event Sent By EM    ${OneView_Service_Events_CommFault}    ${last_fusion_event_id}    ${Enclosure_category}
    Set the Fake Backend ERS    true
    Sleep    60
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Alert Event    ${OneView_Service_Events_CommFault_Cleared}    ServiceEvents    None   240
    Verify Fusion Event Sent By EM    ${OneView_Service_Events_CommFault_Cleared}    ${last_fusion_event_id}    ${Enclosure_category}
    Set IRS operation    UnRegister
    Validate the ERS IPAddress and port   ${None}   ${None}
    Validate ServiceEvents Health Status   ${HEALTH_OK}
    [Teardown]   Run Keyword If Test Failed    Run Keywords    Set the Fake Backend ERS    true    AND    Set IRS operation    UnRegister    AND    Validate ServiceEvents Health Status   ${HEALTH_OK}