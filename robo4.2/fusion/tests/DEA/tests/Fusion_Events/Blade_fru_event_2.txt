*** Settings ***
Documentation    Test suite to validate blade related events on OneView and FLM
...    It covers testing of:
...        BladeFruContentFault
...        BladeFruFault
...        BladeMezzFruContentFault 
...        BladeMezzFruFault
...        BladeMezzFruManufacturedForInvalidFault
...        BladeMezzFruManufacturedForMismatchFault
...        BladeFruManufacturedForInvalidFault
...        BladeFruManufacturedForMismatchFault
...    = GENERIC USAGE =
...    | pybot | -v ENC_SERIAL_NO:[enclosure serial #] | -v APPLIANCE_IP:<ipv4> | -v CIM_Linux_IP:<ipv4> |-v GIT_REPO_ROOT: | Blade_fru_event_2.txt |
...    = Variables =
...    | GIT_REPO_ROOT |      Required: Repo root path if NOT defined in environment variable this is mgmtfw root location|
...    | ENC_SERIAL_NO |      Optional: If omitted, will use the 1st enclosure detected in OV |
...    | APPLIANCE_IP |       Required: OneView IPv4 address |
...    | CIM_Linux_IP |       Required:CI Manager ipv4 under test |

Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/dea_variables.py
Variables         ${GIT_REPO_ROOT}/mgmtfw/tests/thunderbird/variables/tBird_variables.py
Resource          ${GIT_REPO_ROOT}${RESOURCE_ROOT}/resource_all.txt
Resource          ${GIT_REPO_ROOT}${EM_RESOURCE_ROOT}/thunderbird_all.txt
Library           RoboGalaxyLibrary
Library           MgmtFWLibrary
Library           json

Suite Setup       Configure Events Test Environment
Suite Teardown    Run Keywords  Logout of EM RIS   AND    Logout of Fusion Via REST

*** Test Case ***

TC 01: Verify BladeMezzFruContentFault Event For Mezz Device
    [Documentation]     Verify BladeMezzFruContentFault event for Mezz device
    [Tags]    Blade     FLM1.01    FRU    Automated    Disabled
    ${occupied_blade_list}=    Get List of Occupied ILO Blade Bays
    Should Not Be Empty    ${occupied_blade_list}    msg=No Blades present in the enclosure
    ${blade_bay}=    Get Random Item From List    ${occupied_blade_list}
    ${mezzSlotDict}     ${mezzSlotlist}=    Get iLO Mezz list    ${blade_bay}
    Log To Console    ${mezzSlotlist}
    : FOR    ${mezz_slot}    IN    @{mezzSlotlist}
    \    ${last_fusion_event_id}=    get last fusion event ID
    \    FRU_Init_File Cleanup
    \    Fru_File Cleanup
    \    Replace Text in Mezz Update Config Data File    compaq    ${iLO_Admin_Password}
    \    ${ilo_ip}=    Get iLO IPv6 LL Address from EM RIS    ${blade_bay}
    \    Flash Mezz FRU Update For content fault    ${mezz_slot}    ${blade_bay}    ${ilo_ip}
    \    ${efuse_status_code}=    RIS EM Efuse Blade    ${blade_bay}    10
    \    Sleep    ${EM_EFUSE_Duration}
    \    ${status}=    Wait for Device Critical    ${Blade_Device}    ${blade_bay}
    \    Should Be True      ${status}   ${Blade_Device} Critical Status not detected
    \    Sleep    30    # Wait for BladeMezzFruContentFault to log to audit log after encountering blade critical status
    \    #Verifying resource updated event in diags audit log with 50 recent entries
    \    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    \    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    \    Verify Audit Log Alert Event    ${EL_Blade_MezzFruContentFault}    ${Blade_Device}    ${blade_bay}    250
    \    Verify Fusion Event Sent By EM    ${EL_Blade_MezzFruContentFault}    ${last_fusion_event_id}    ${Server_Category}
    \    FRU_Init_File Cleanup
    \    Fru_File Cleanup
    \    Replace Text in Mezz Update Config Data File    compaq    ${iLO_Admin_Password}
    \    Perform Mezz FRU Update on Blade in Bay    ${blade_bay}
    \    ${efuse_status_code}=    RIS EM Efuse Blade    ${blade_bay}    10
    \    Sleep    10
    \    Wait for Device OK    ${Blade_Device}    ${blade_bay}
    FRU_Init_File Cleanup
    Fru_File Cleanup
    [Teardown]    Run Keyword If Test Failed    Run Keywords    Fru_File Cleanup    AND    FRU_Init_File Cleanup    AND    Replace Text in Mezz Update Config Data File    compaq    ${iLO_Admin_Password}    AND    Perform Mezz FRU Update on Blade in Bay    ${blade_bay}    AND     Fru_File Cleanup    AND    FRU_Init_File Cleanup    AND    RIS EM Efuse Blade    ${blade_bay}    10    AND    sleep    10    AND    Wait for Device OK    ${Blade_Device}    ${blade_bay}

TC 02: Verify BladeMezzFruManufacturedForInvalidFault Event
    [Documentation]    This test will validate Compatability check when ManufacturedFor field in Midplane is HPE and in Mezz is Foo
    [Tags]    Blade     FLM1.01    FRU    Automated
    ${ManufacturedFor}=    Get ManufacturedFor From Midplane FRU
    Should Be Equal As Strings    ${ManufacturedFor}    HPE
    ${occupied_blade_list}=    Get List of Occupied ILO Blade Bays
    Should Not Be Empty    ${occupied_blade_list}    msg=No Blades present in the enclosure
    ${blade_bay}=    Get Random Item From List    ${occupied_blade_list}
    ${mezzSlotDict}     ${mezzSlotlist}=    Get iLO Mezz list    ${blade_bay}
    Log To Console    ${mezzSlotlist}
    : FOR    ${mezz_slot}    IN    @{mezzSlotlist}
    \    ${last_fusion_event_id}=    get last fusion event ID
    \    FRU_Init_File Cleanup
    \    Fru_File Cleanup
    \    Replace Text in Mezz Update Config Data File    compaq    ${iLO_Admin_Password}
    \    ${ilo_ip}=    Get iLO IPv6 LL Address from EM RIS    ${blade_bay}
    \    Flash Mezz FRU Update For Card Type    ${mezz_slot}    ${blade_bay}    ${ilo_ip}    Foo
    \    ${efuse_status_code}=    RIS EM Efuse Blade    ${blade_bay}    10
    \    Sleep    ${EM_EFUSE_Duration}
    \    ${status}=    Wait for Device Critical    ${Blade_Device}    ${blade_bay}
    \    Should Be True      ${status}   ${Blade_Device} Critical Status not detected
    \    Sleep    30    # Wait for BladeMezzFruManufacturedForInvalidFault to log to audit log after encountering blade critical status
    \    #Verifying resource updated event in diags audit log with 50 recent entries
    \    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    \    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    \    Verify Audit Log Alert Event    ${EL_Blade_MezzFruManufacturedForInvalidFault}    ${Blade_Device}    ${blade_bay}    250
    \    Verify Fusion Event Sent By EM    ${EL_Blade_MezzFruManufacturedForInvalidFault}    ${last_fusion_event_id}    ${Server_Category}
    \    FRU_Init_File Cleanup
    \    Fru_File Cleanup
    \    Replace Text in Mezz Update Config Data File    compaq    ${iLO_Admin_Password}
    \    Perform Mezz FRU Update on Blade in Bay    ${blade_bay}
    \    ${efuse_status_code}=    RIS EM Efuse Blade    ${blade_bay}    10
    \    Sleep    ${EM_EFUSE_Duration}
    \    Wait for Device OK    ${Blade_Device}    ${blade_bay}
    FRU_Init_File Cleanup
    Fru_File Cleanup
    [Teardown]    Run Keyword If Test Failed    Run Keywords    FRU_Init_File Cleanup    AND    Fru_File Cleanup    AND    Replace Text in Mezz Update Config Data File    compaq    ${iLO_Admin_Password}    AND    Perform Mezz FRU Update on Blade in Bay    ${blade_bay}    AND    FRU_Init_File Cleanup    AND    Fru_File Cleanup    AND    RIS EM Efuse Blade    ${blade_bay}    10    AND    Sleep    10    AND    Wait for Device OK    ${Blade_Device}    ${blade_bay} 

TC 03: Verify BladeMezzFruManufacturedForMismatchFault Event
    [Documentation]    This test will validate Compatability check when ManufacturedFor field in Midplane is HPE and in Mezz is Foo
    [Tags]    Blade     FLM1.01    FRU    Automated    Disabled
    ${ManufacturedFor}=    Get ManufacturedFor From Midplane FRU
    Should Be Equal As Strings    ${ManufacturedFor}    HPE
    ${occupied_blade_list}=    Get List of Occupied ILO Blade Bays
    Should Not Be Empty    ${occupied_blade_list}    msg=No Blades present in the enclosure
    ${blade_bay}=    Get Random Item From List    ${occupied_blade_list}
    ${mezzSlotDict}     ${mezzSlotlist}=    Get iLO Mezz list    ${blade_bay}
    Log To Console    ${mezzSlotlist}
    : FOR    ${mezz_slot}    IN    @{mezzSlotlist}
    \    ${last_fusion_event_id}=    get last fusion event ID
    \    FRU_Init_File Cleanup
    \    Fru_File Cleanup
    \    Replace Text in Mezz Update Config Data File    compaq    ${iLO_Admin_Password}
    \    ${ilo_ip}=    Get iLO IPv6 LL Address from EM RIS    ${blade_bay}
    \    Flash Mezz FRU Update For Card Type    ${mezz_slot}    ${blade_bay}    ${ilo_ip}    NEC
    \    ${efuse_status_code}=    RIS EM Efuse Blade    ${blade_bay}    10
    \    Sleep    10
    \    ${status}=    Wait for Device Critical    ${Blade_Device}    ${blade_bay}
    \    Should Be True      ${status}   ${Blade_Device} Critical Status not detected
    \    Sleep    30    # Wait for BladeMezzFruManufacturedForMismatchFault to log to audit log after encountering blade critical status
    \    #Verifying resource updated event in diags audit log with 50 recent entries
    \    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    \    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    \    Verify Audit Log Alert Event    ${EL_Blade_MezzFruManufacturedForMismatchFault}    ${Blade_Device}    ${blade_bay}    250
    \    Verify Fusion Event Sent By EM    ${EL_Blade_MezzFruManufacturedForMismatchFault}    ${last_fusion_event_id}    ${Server_Category}
    \    FRU_Init_File Cleanup
    \    Fru_File Cleanup
    \    Replace Text in Mezz Update Config Data File    compaq    ${iLO_Admin_Password}
    \    Perform Mezz FRU Update on Blade in Bay    ${blade_bay}
    \    ${efuse_status_code}=    RIS EM Efuse Blade    ${blade_bay}    10
    \    Sleep    10
    \    Wait for Device OK    ${Blade_Device}    ${blade_bay}
    FRU_Init_File Cleanup
    Fru_File Cleanup
    [Teardown]    Run Keyword If Test Failed    Run Keywords    FRU_Init_File Cleanup    AND    Fru_File Cleanup    AND    Replace Text in Mezz Update Config Data File    compaq    ${iLO_Admin_Password}    AND    Perform Mezz FRU Update on Blade in Bay    ${blade_bay}    AND    FRU_Init_File Cleanup    AND    Fru_File Cleanup    AND    RIS EM Efuse Blade    ${blade_bay}    10    AND    Sleep    10  AND    Wait for Device OK    ${Blade_Device}    ${blade_bay}

TC 04: Verify BladeMezzFruFault Event For Mezz Device
    [Documentation]     Verify BladeMezzFruFault event for Mezz device
    [Tags]    Blade     FLM1.01    FRU    Automated    Disabled
    Fru_File Cleanup
    FRU_Init_File Cleanup
    ${occupied_blade_list}=    Get List of Occupied ILO Blade Bays
    Should Not Be Empty    ${occupied_blade_list}    msg=No Blades present in the enclosure
    ${blade_bay}=    Get Random Item From List    ${occupied_blade_list}
    ${ilo_ip}=    Get iLO IPv6 LL Address from EM RIS    ${blade_bay}
    ${mezzSlotDict}     ${mezzSlotlist}=    Get iLO Mezz list    ${blade_bay}
    Log To Console    ${mezzSlotlist}
    Replace Text in Mezz Update Config Data File    compaq    ${iLO_Admin_Password}
    #Perform Mezz FRU Update on Blade in Bay    ${blade_bay}
    ${GIT_REPO_ROOT_dummy}=   Set Variable   Repo
    : FOR    ${mezz_slot}    IN    @{mezzSlotlist}
    \    ${last_fusion_event_id}=    get last fusion event ID
    \    ${mezz_slotid}=    Get From Dictionary    ${mezzSlotDict}    ${mezz_slot}
    \    ${mezzs}=   em api get mezz details   ${ilo_ip}    ${mezz_slot}    ${mezzSlotlist}
    \    ${mezzcardtype}=    em api get mezz card in slot   ${mezzs}    ${mezz_slotid}
    \    ${mezz_type}=    Get Mezz Type By ModelName    ${mezzs['Name']}
    \    ${partnumber} =    Get mezz partnumber    ${blade_bay}    ${mezz_slotid}
    \    ${fru_inst}=    ilo ris fru inst    ${partnumber}     ${mezz_slot}
#    \    ${hphdbind_cmd}=    ilo ris hphdbind    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\Bronco\\Mezz_bad.bin    ${fru_inst}
    \    ${hphdbind_cmd}=    ilo ris hphdbind    ${GIT_REPO_ROOT}\\${Customized_FRU_Path}\\Bronco\\Mezz_bad.bin    ${fru_inst}
    \    Log To Console    ${hphdbind_cmd}
    \    ${return_code}    ${output}=    Run and Return RC and Output    ${hphdbind_cmd}
    \    ${hpqlocfg_cmd}=    ilo ris hpqlocfg    ${GIT_REPO_ROOT}${FRU_UPDATE_ROOT}/golden.bin    ${ilo_ip}    Administrator    ${iLO_Admin_Password}
    \    Log To Console    ${hpqlocfg_cmd}
    \    ${return_code}    ${output}=    Run and Return RC and Output    ${hpqlocfg_cmd}
    \    Should Be Equal As Integers    ${return_code}    0    Expected return result {return_code} equal to 1 (failure) found ${return_code}. Check Check ${Mezz_Update_Output_File} file for reason.
    \    Log to Console    ${output}
    \    Remove File     ${GIT_REPO_ROOT}${FRU_UPDATE_ROOT}/golden.bin
    \    ${efuse_status_code}=    RIS EM Efuse Blade    ${blade_bay}    ${10}
    \    Sleep    10
    \    Wait for Device Degraded    ${Blade_Device}    ${blade_bay}
    \    Sleep    300    # Wait for BladeMezzFruFault to log to audit log after encountering blade critical status
    \    #Verifying resource updated event in diags audit log with 50 recent entries
    \    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    \    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    \    Verify Audit Log Alert Event    ${EL_Blade_MezzFruFault}    ${Blade_Device}    ${blade_bay}    450
    \    Verify Fusion Event Sent By EM    ${EL_Blade_MezzFruFault}    ${last_fusion_event_id}
    \    ${filename}=     ilo ris get mezz bin    ${mezz_type}
    \    ${hpqlocfg_cmd}=    ilo ris hpqlocfg    ${GIT_REPO_ROOT}${FRU_UPDATE_ROOT}/golden.bin    ${ilo_ip}    Administrator    ${iLO_Admin_Password}
    \    Log To Console    ${hpqlocfg_cmd}
    \    ${return_code}    ${output}=    Run and Return RC and Output    ${hpqlocfg_cmd}
    \    Should Be Equal As Integers    ${return_code}    0    Expected return result {return_code} equal to 1 (failure) found ${return_code}. Check Check ${Mezz_Update_Output_File} file for reason.
    \    Log to Console    ${output}
    \    ${efuse_status_code}=    RIS EM Efuse Blade    ${blade_bay}    ${10}
    \    Sleep    10
    \    Wait for Device OK    ${Blade_Device}    ${blade_bay}
    Delete files in fru_bin
    Fru_File Cleanup
    FRU_Init_File Cleanup 
    [Teardown]    Run Keyword If Test Failed    Run Keywords    FRU_Init_File Cleanup    AND    Fru_File Cleanup    AND    Replace Text in Mezz Update Config Data File    compaq    ${iLO_Admin_Password}    AND    Perform Mezz FRU Update on Blade in Bay    ${blade_bay}    AND    FRU_Init_File Cleanup    AND    Fru_File Cleanup    AND    RIS EM Efuse Blade    ${blade_bay}    10    AND    Sleep    10     AND    Wait for Device OK    ${Blade_Device}    ${blade_bay}    AND    Remove File     ${GIT_REPO_ROOT}${FRU_UPDATE_ROOT}/golden.bin   # Cleanup files

