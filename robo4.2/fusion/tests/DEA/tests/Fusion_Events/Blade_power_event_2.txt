*** Settings ***
Documentation    Test suite to validate blade related events on OneView and FLM
...    It covers testing of:
...        BladeInsufficientPower
...        BladeInsufficientPowerCleared
...        BladePowerDeniedDueToFru
...        BladePowerDeniedDueToMating
...        BladePowerDeniedDueToMatingCleared
...        BladePowerDeniedDueToMidplane
...        BladeMateDetectFault
...        BladeMateDetectFaultCleared
...    = GENERIC USAGE =
...    | pybot | -v ENC_SERIAL_NO:[enclosure serial #] | -v APPLIANCE_IP:<ipv4> | -v CIM_Linux_IP:<ipv4> |-v GIT_REPO_ROOT: | Blade_power_event_2.txt |
...    = Variables =
...    | GIT_REPO_ROOT |      Required: Repo root path if NOT defined in environment variable this is mgmtfw root location|
...    | ENC_SERIAL_NO |      Optional: If omitted, will use the 1st enclosure detected in OV |
...    | APPLIANCE_IP |       Required: OneView IPv4 address |
...    | CIM_Linux_IP |       Required:CI Manager ipv4 under test |

Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/dea_variables.py
Variables         ${GIT_REPO_ROOT}/mgmtfw/tests/thunderbird/variables/tBird_variables.py
Resource          ${GIT_REPO_ROOT}${RESOURCE_ROOT}/resource_all.txt
Resource          ${GIT_REPO_ROOT}${EM_RESOURCE_ROOT}/thunderbird_all.txt
Library           RoboGalaxyLibrary
Library           MgmtFWLibrary
Library           json

Suite Setup       Configure Events Test Environment
Suite Teardown    Run Keywords  Logout of EM RIS   AND    Logout of Fusion Via REST

*** Test Case ***

TC 01: Verify BladePowerDeniedDueToMidplane Event
    [Documentation]    This test will validate BigBird blade's fault BladePowerDeniedDueToMidplane when zero FRU files are flashed
    [Tags]    Blade    FLM1.01    FRU    Automated    OVD22712
    ${occupied_blade_bays}=    Get List of Occupied iLO Blade Bays 
    Should Not Be Empty    ${occupied_blade_bays}    msg=No iLO blades present in the enclosure
    Flash Midplane Fru    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${midplanefru_zerotype}
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    RIS EM Reboot    ${active_bay}
    Sleep    ${EM_REBOOT_TIME}
    ${ov_claim_pwd}=    Get Claim Password From OneView    ${Enclosures}
    Login to EM Via RIS    ip=${FLOATING_IP}    password=${ov_claim_pwd}
    Sleep    3
    : FOR    ${blade_bay}    IN    @{occupied_blade_bays}
    \    ${last_fusion_event_id}=    get last fusion event ID
    \    RIS EM Efuse On Blade    ${blade_bay}
    \    sleep   8
    \    RIS EM Efuse Off Blade Without HealthCheck    ${blade_bay}
    \    Wait for Device Degraded    ${Blade_Device}    ${blade_bay}
    \    Sleep    30    # Wait for event to show up in audit log
    \    #Verifying resource updated event in diags audit log with 50 recent entries
    \    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    \    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    \    Verify Audit Log Alert Event    ${EL_Blade_PowerDeniedDueToMidplane}    ${Blade_Device}    ${blade_bay}    ${Healthalerts_timediff}
    \    Verify Fusion Event Sent By EM    ${EL_Blade_PowerDeniedDueToMidplane}    ${last_fusion_event_id}    ${Enclosure_Category}
    \    Validate Blade Power Status    ${blade_bay}    ${iLO_Username}    ${iLO_Password}    Off
    Flash Midplane Fru    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\Fru_Files\\${CAT}\\Good_Fru\\MIDPLANE\\${Midplane_Bay_No}\\fru.bin
    ${ip}=    Get Diags Active EM IPv6 LL Address
    ${ping_response_code}=    Ping EM    ${ip}
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    RIS EM Reboot    ${active_bay}
    Sleep    ${EM_REBOOT_TIME}
    Login to EM Via RIS    ip=${FLOATING_IP}    password=${ov_claim_pwd}
    Sleep    3
    : FOR    ${blade_bay}    IN    @{occupied_blade_bays}
    \    ${ilo_ip}=    Get iLO IPv6 LL Address from EM RIS      ${blade_bay}
    \    RIS EM Efuse On Blade    ${blade_bay}
    \    sleep   8
    \    RIS EM Efuse Off Blade     ${blade_bay}
    \    Wait for Device Ok    ${Blade_Device}    ${blade_bay}
    \    Login to iLO   ${ilo_ip}    ${iLO_Username}    ${iLO_Password}
    \    Wait for iLO Blade PowerOn
    \    Logout of iLO
    \    Validate Blade Power Status    ${blade_bay}    ${iLO_Username}    ${iLO_Password}    On
    [Teardown]    Run Keyword If Test Failed    Run Keywords    Login to EM RIS    ip=${FLOATING_IP}    password=${ov_claim_pwd}   AND   Flash Midplane Fru    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\Fru_Files\\${CAT}\\Good_Fru\\MIDPLANE\\${Midplane_Bay_No}\\fru.bin