*** Settings ***
Documentation     This Test Suite to validate EMNTPTimesync and EMNTPTimesyncCleared events on OneView
Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/dea_variables.py
Variables         ${GIT_REPO_ROOT}/mgmtfw/tests/thunderbird/variables/tBird_variables.py
Resource          ${GIT_REPO_ROOT}${RESOURCE_ROOT}/resource_all.txt
Resource          ${GIT_REPO_ROOT}${EM_RESOURCE_ROOT}/thunderbird_all.txt
Library           RoboGalaxyLibrary
Library           Dialogs
Library           MgmtFWLibrary
Library           DateTime
Library           Selenium2Library
Library           Collections

Suite Setup       Configure Events Test Environment
Suite Teardown    Run Keywords  Logout of EM RIS   AND    Logout of Fusion Via REST

*** Test cases ***

TC01: Verify EMNTPTimesync Events
    [Documentation]    Verify EMNTPTimesync And EMNTPTimesyncCleared
    [Tags]    EM    FLM2.04
    ${last_fusion_event_id}=    get last fusion event ID
    Run Keyword    Set NTP Variables
    ${active_em_bay}=    Get Diags EmClusterStatus Active Node
    ${disable_ntp}=    Disable NTP    ${active_em_bay}
    ${Failures_Before_Alert}=    Convert To Integer    10
    ${enable_ntp}=    Enable NTP    ${active_em_bay}    ${NTP_invalid_IP}    ${None}    ${Failures_Before_Alert}
    Run keyword if    ${enable_ntp} <> ${Test_Event_Status_Code}    Fail    Failed to Enable NTP
    ${validate_status}=    Validate NTP Information    ${active_em_bay}    ${true}    10    ${NTP_invalid_IP}    ${None}
    Should Be True    ${validate_status}
    Sleep    530
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Alert Event    ${EM_NTP_Time_sync}    ${EM_Device_Name}    ${EM_Bay}    250
    Verify Fusion Event Sent By EM    ${EM_NTP_Time_sync}    ${last_fusion_event_id}    ${Enclosure_category}
    ${enable_ntp}=    Enable NTP    ${active_em_bay}    ${APPLIANCE_IPV6}
    Run keyword if    ${enable_ntp} <> ${Test_Event_Status_Code}    Fail    Failed to Enable NTP
    ${validate_status}=    Validate NTP Information    ${active_em_bay}    ${true}    30     ${APPLIANCE_IPV6}    ${None}
    Should Be True    ${validate_status}
    Sleep    60
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Alert Event    ${EM_NTP_Time_sync_Cleared}    ${EM_Device_Name}    ${EM_Bay}    250
    Verify Fusion Event Sent By EM    ${EM_NTP_Time_sync_Cleared}    ${last_fusion_event_id}    ${Enclosure_category}
    [Teardown]    Run Keyword If Test Failed    Enable NTP    ${active_em_bay}    ${APPLIANCE_IPV6}