*** Settings ***
Documentation    Test suite to validate Interconnect Fru related events on OneView and FLM
...    = GENERIC USAGE =
...    | pybot | -v ENC_SERIAL_NO:[enclosure serial #] | -v APPLIANCE_IP:<ipv4> | -v CIM_Linux_IP:<ipv4> |-v GIT_REPO_ROOT: | ICM_Frufault_event.txt |
...    = Variables =
...    | GIT_REPO_ROOT |      Required: Repo root path if NOT defined in environment variable this is mgmtfw root location|
...    | ENC_SERIAL_NO |      Optional: If omitted, will use the 1st enclosure detected in OV |
...    | APPLIANCE_IP |       Required: OneView IPv4 address |
...    | CIM_Linux_IP |       Required:CI Manager ipv4 under test |

Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/dea_variables.py
Variables         ${GIT_REPO_ROOT}/mgmtfw/tests/thunderbird/variables/tBird_variables.py
Resource          ${GIT_REPO_ROOT}${RESOURCE_ROOT}/resource_all.txt
Resource          ${GIT_REPO_ROOT}${EM_RESOURCE_ROOT}/thunderbird_all.txt
Library           RoboGalaxyLibrary
Library           MgmtFWLibrary
Library           json

Suite Setup       Configure Events Test Environment
Suite Teardown    Run Keywords  Logout of EM RIS   AND    Logout of Fusion Via REST


*** Test Case *** 
TC 01: Interconnect Insert/Remove events show up in OV UI
    [Documentation]    This test is to verify events while interconnect removed and inserted
    ...                InterconnectInserted
    ...                InterconnectRemoved
    [Tags]    ICM    FLM1.01    Automated
    ${icm_list}=    Get ICM Bay List
    Should Not Be Empty    ${icm_list}    msg=No Interconnect present in the enlcosure
    :FOR    ${bay}   IN   @{icm_list}
    \    Log    message=Removing Interconnect from bay:${bay} and verify resource removed event in diags audit log    console=True
    \    ${last_fusion_event_id}=    get last fusion event ID
    \    RIS EM Efuse On Interconnect    ${bay}
    \    Sleep    10
    \    #Verifying resource removed event in diags audit log with 50 recent entries
    \    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    \    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    \    Verify Audit Log Resource Removed Event    ${ICM_Device}    ${EL_Interconnect_Removed}    ${bay}    90
    \    # Verify Fusion Event including event description and resolution
    \    Verify Fusion Event Sent By EM    ${EL_Interconnect_Removed}    ${last_fusion_event_id}    ${Enclosure_category}
    \    Log    message=Inserting Interconnect at bay:${bay} and verify resource added event in diags audit log    console=True
    \    RIS EM Efuse Off Interconnect    ${bay}
    \    Sleep   20
    \    #Verifying resource added event in diags audit log with 50 recent entries
    \    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    \    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    \    Verify Audit Log Resource Added Event    ${ICM_Device}    ${EL_Interconnect_Inserted}    ${bay}    250
    \    Verify Fusion Event Sent By EM    ${EL_Interconnect_Inserted}    ${last_fusion_event_id}    ${Enclosure_category}
    \    Validate Interconnect Availability in Fusion    ${bay}
    [Teardown]    Run Keyword If Test Failed    Run Keywords    RIS EM Efuse Off Interconnect    ${bay}    AND   Validate Interconnect Availability in Fusion    ${bay}

TC 02: Manufactured for Invalid/Power Denied Due to FRU event
    [Documentation]    This test is to verify  Manufactured for Invalid/Power Denied event for Interconnect Using Flashing up FRU
    ...                InterconnectFruManufacturedForInvalidFault
    [Tags]    ICM    FLM1.01    FRU    Automated    Disabled
    ${occupied_icm_list}=    Get List of Occupied Interconnect Bays
    Should Not Be Empty    ${occupied_icm_list}    msg=No Interconnects present in the enclosure
    : FOR    ${bay}    IN    @{occupied_icm_list}
    \    ${last_fusion_event_id}=    get last fusion event ID
    \    #Flash InCompatible Fru
    \    ${icm_type}=    Get ICM Type By ModelNo    ${bay}    
    \    Run Keyword If    '${icm_type}' == 'Chloride10'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${chloride10fru_foo}
    \    ...   ELSE IF    '${icm_type}' == 'Chloride20'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${chloride20fru_foo}
    \    ...   ELSE IF    '${icm_type}' == 'Chloride40'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${chloride40fru_foo}
    \    ...   ELSE IF    '${icm_type}' == 'Potassium'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${potassiumfru_foo}
    \    ...   ELSE IF    '${icm_type}' == 'Potash'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${potashfru_foo}
    \    ...   ELSE IF    '${icm_type}' == 'Natasha'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${natashafru_foo}
    \    ...   ELSE IF    '${icm_type}' == 'Sylvite'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${sylvitefru_foo}
    \    ...   ELSE IF    '${icm_type}' == 'Carbon'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${carbonfru_foo}
    \    ...   ELSE    Log To Console    'Flashing not supported for Device'
    \    RIS EM Efuse Interconnect    ${bay}    10
    \    ${status}=    Wait for Device Critical    ${ICM_Device}    ${bay}
    \    Should Be True      ${status}   ${ICM_Device} Critical Status not detected
    \    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    \    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    \    Verify Audit Log Status Change MessageID Event    ${EL_ICM_Critical}    ${ICM_Device}    ${bay}    250
    \    Verify Audit Log Alert Event    ${EL_ICM_FruManufacturedForInvalidFault}    ${ICM_Device}    ${bay}    250
    \    Verify Audit Log Alert Event    ${EL_ICM_PowerDeniedDueToFru}    ${ICM_Device}    ${bay}    250
    \    Sleep    600
    \    Verify Fusion Event Sent By EM    ${EL_ICM_FruManufacturedForInvalidFault}    ${last_fusion_event_id}    ${ICM_Category}
    \    Verify Fusion Event Sent By EM    ${EL_ICM_PowerDeniedDueToFru}    ${last_fusion_event_id}    ${ICM_Category}
    \    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\Fru_Files\\${CAT}\\Good_Fru\\INTERCONNECT\\${bay}\\fru.bin
    \    RIS EM Efuse On Interconnect    ${bay}
    \    Sleep    10
    \    RIS EM Efuse Off Interconnect    ${bay}
    \    Validate Interconnect Availability in Fusion    ${bay}
    [Teardown]    Run Keyword If Test Failed    Run Keywords    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\Fru_Files\\${CAT}\\Good_Fru\\INTERCONNECT\\${bay}\\fru.bin
    ...    AND   RIS EM Efuse On Interconnect    ${bay}   AND     RIS EM Efuse Off Interconnect    ${bay}   AND   Validate Interconnect Availability in Fusion    ${bay}

TC 03: Manufactured for Invalid/Power Denied Due to FRU event
    [Documentation]    This test is to verify  Manufactured for Invalid/Power Denied event for Interconnect Using Flashing up FRU
    ...                InterconnectPowerDeniedDueToFru    
    [Tags]    ICM    FLM1.01    FRU    Automated    Disabled
    ${occupied_icm_list}=    Get List of Occupied Interconnect Bays
    Should Not Be Empty    ${occupied_icm_list}    msg=No Interconnects present in the enclosure
    : FOR    ${bay}    IN    @{occupied_icm_list}
    \    ${last_fusion_event_id}=    get last fusion event ID
    \    #Flash InCompatible Fru
    \    ${icm_type}=    Get ICM Type By ModelNo    ${bay}    
    \    Run Keyword If    '${icm_type}' == 'Chloride10'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${chloride10fru_foo}
    \    ...   ELSE IF    '${icm_type}' == 'Chloride20'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${chloride20fru_foo}
    \    ...   ELSE IF    '${icm_type}' == 'Chloride40'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${chloride40fru_foo}
    \    ...   ELSE IF    '${icm_type}' == 'Potassium'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${potassiumfru_foo}
    \    ...   ELSE IF    '${icm_type}' == 'Potash'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${potashfru_foo}
    \    ...   ELSE IF    '${icm_type}' == 'Natasha'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${natashafru_foo}
    \    ...   ELSE IF    '${icm_type}' == 'Sylvite'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${sylvitefru_foo}
    \    ...   ELSE IF    '${icm_type}' == 'Carbon'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${carbonfru_foo}
    \    ...   ELSE    Log To Console    'Flashing not supported for Device'
    \    RIS EM Efuse Interconnect    ${bay}    10
    \    ${status}=    Wait for Device Critical    ${ICM_Device}    ${bay}
    \    Should Be True      ${status}   ${ICM_Device} Critical Status not detected
    \    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    \    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    \    Verify Audit Log Status Change MessageID Event    ${EL_ICM_Critical}    ${ICM_Device}    ${bay}    250
    \    Verify Audit Log Alert Event    ${EL_ICM_PowerDeniedDueToFru}    ${ICM_Device}    ${bay}    250
    \    Sleep    600
    \    Verify Fusion Event Sent By EM    ${EL_ICM_PowerDeniedDueToFru}    ${last_fusion_event_id}    ${ICM_Category}
    \    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\Fru_Files\\${CAT}\\Good_Fru\\INTERCONNECT\\${bay}\\fru.bin
    \    RIS EM Efuse On Interconnect    ${bay}
    \    Sleep    10
    \    RIS EM Efuse Off Interconnect    ${bay}
    \    Validate Interconnect Availability in Fusion    ${bay}
    [Teardown]    Run Keyword If Test Failed    Run Keywords    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\Fru_Files\\${CAT}\\Good_Fru\\INTERCONNECT\\${bay}\\fru.bin
    ...    AND   RIS EM Efuse On Interconnect    ${bay}   AND     RIS EM Efuse Off Interconnect    ${bay}   AND   Validate Interconnect Availability in Fusion    ${bay}


TC 04: Manufactured for Mismatach/Power Denied Due to FRU event
    [Documentation]    This test is to verify  Manufactured for Mismatch/Power Denied event for Interconnect Using Flashing up FRU
    ...                InterconnectFruManufacturedForMismatchFault
    ...                InterconnectPowerDeniedDueToFru
    [Tags]    ICM    FLM1.01    FRU    Automated    Disabled
    ${occupied_icm_list}=    Get List of Occupied Interconnect Bays
    Should Not Be Empty    ${occupied_icm_list}    msg=No Interconnects present in the enclosure
    : FOR    ${bay}    IN    @{occupied_icm_list}
    \    ${last_fusion_event_id}=    get last fusion event ID
    \    #Flash InCompatible Fru
    \    ${icm_type}=    Get ICM Type By ModelNo    ${bay}    
    \    Run Keyword If    '${icm_type}' == 'Chloride10'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${chloride10fru_nec}
    \    ...   ELSE IF    '${icm_type}' == 'Chloride20'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${chloride20fru_nec}
    \    ...   ELSE IF    '${icm_type}' == 'Chloride40'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${chloride40fru_nec}
    \    ...   ELSE IF    '${icm_type}' == 'Potassium'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${potassiumfru_nec}
    \    ...   ELSE IF    '${icm_type}' == 'Potash'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${potashfru_nec}
    \    ...   ELSE IF    '${icm_type}' == 'Natasha'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${natashafru_nec}
    \    ...   ELSE IF    '${icm_type}' == 'Sylvite'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${sylvitefru_nec}
    \    ...   ELSE IF    '${icm_type}' == 'Carbon'    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${carbonfru_nec}
    \    ...   ELSE    Log To Console    'Flashing not supported for Device'
    \    RIS EM Efuse Interconnect    ${bay}    10
    \    ${status}=    Wait for Device Critical    ${ICM_Device}    ${bay}
    \    Should Be True      ${status}   ${ICM_Device} Critical Status not detected
    \    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    \    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    \    Verify Audit Log Status Change MessageID Event    ${EL_ICM_Critical}    ${ICM_Device}    ${bay}    250
    \    Verify Audit Log Alert Event    ${EL_ICM_FruManufacturedForMismatchFault}    ${ICM_Device}    ${bay}    250
    \    Verify Audit Log Alert Event    ${EL_ICM_PowerDeniedDueToFru}    ${ICM_Device}    ${bay}    250
    \    Sleep    600
    \    Verify Fusion Event Sent By EM    ${EL_ICM_FruManufacturedForMismatchFault}    ${last_fusion_event_id}    ${ICM_Category}
    \    Verify Fusion Event Sent By EM    ${EL_ICM_PowerDeniedDueToFru}    ${last_fusion_event_id}    ${ICM_Category}
    \    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\Fru_Files\\${CAT}\\Good_Fru\\INTERCONNECT\\${bay}\\fru.bin
    \    RIS EM Efuse On Interconnect    ${bay}
    \    Sleep    10
    \    RIS EM Efuse Off Interconnect    ${bay}
    \    Validate Interconnect Availability in Fusion    ${bay}
    [Teardown]    Run Keyword If Test Failed    Run Keywords    Flash Interconnect Fru    ${bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\Fru_Files\\${CAT}\\Good_Fru\\INTERCONNECT\\${bay}\\fru.bin
    ...    AND   RIS EM Efuse On Interconnect    ${bay}   AND     RIS EM Efuse Off Interconnect    ${bay}   AND   Validate Interconnect Availability in Fusion    ${bay}
                       