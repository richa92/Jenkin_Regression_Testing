*** Settings ***
Documentation    Test Script to verify EmDiskEncryptionFault asserted when encryption failed on FLM Helix module
...    It covers testing of:
...        EmDiskEncryptionFault
...    = GENERIC USAGE =
...    | pybot | -v ENC_SERIAL_NO:[enclosure serial #] | -v APPLIANCE_IP:<ipv4> |-v GIT_REPO_ROOT: | Helix_Tpmodule.txt |
...    = Variables =
...    | GIT_REPO_ROOT |      Required: Repo root path if NOT defined in environment variable this is mgmtfw root location|
...    | ENC_SERIAL_NO |      Optional: If omitted, will use the 1st enclosure detected in OV |
...    | APPLIANCE_IP |       Required: OneView IPv4 address |

Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/dea_variables.py
Variables         ${GIT_REPO_ROOT}/mgmtfw/tests/thunderbird/variables/tBird_variables.py
Resource          ${GIT_REPO_ROOT}${RESOURCE_ROOT}/resource_all.txt
Resource          ${GIT_REPO_ROOT}${EM_RESOURCE_ROOT}/thunderbird_all.txt
Library           RoboGalaxyLibrary
Library           MgmtFWLibrary
Library           json
Library           Collections
Library           String

Suite Setup       Configure Events Test Environment
Suite Teardown     Run Keywords  Logout of EM RIS   AND    Logout of Fusion Via REST

*** Test Cases ***
TC: TPM 01 Validate EmDiskEncryptionFault asserted when encryption failed on FLM Helix module
    [Documentation]    Validate EmDiskEncryptionFault asserted when encryption failed on FLM Helix module
    [Tags]    EM    FLM3.00    Automated
    ${last_fusion_event_id}=    get last fusion event ID
    ${list_helix} =   Get List of Occupied Helix EnclosureManager Bays
    Should Not Be Empty    ${list_helix}    msg=No helix present in the enclosure
    ${active_em_bay}=    Get Active EM Bay Number
    ${fw_before_mismatch}=    Get FLM version from RedundancySummary
    ${ACTIVE EM IP}=    Get Diags Active EM IPv6 LL Address
    ${ov_claim_pwd}=    Get Claim Password From OneView
    Flash Transition Image to FLM Bay   ${ACTIVE EM IP}    ${ov_claim_pwd}
    # start to inject fault via root
    Write SSH cmd to EM   ${ACTIVE EM IP}   touch /tmp/encryption_failed
    Sleep    180
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Fusion Event Sent By EM    ${Em_DiskEncryptionFault}    ${last_fusion_event_id}    ${Enclosure_category}
    # Validate critical status on FLM tpm status
    Validate TPM Health on Both FLMs   Critical   ${None}   OK   OK
    # clear fault by remove file via root
    Write SSH cmd to EM   ${ACTIVE EM IP}   rm /tmp/encryption_failed
    Sleep    180
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Fusion Event Sent By EM    ${Em_DiskEncryptionFaultCleared}    ${last_fusion_event_id}    ${Enclosure_category}
    Validate TPM Health on Both FLMs
    [Teardown]    Run Keyword If Test Failed    Write SSH cmd to EM    ${ACTIVE EM IP}   rm /tmp/encryption_failed

TC: TPM 02 Validate EmTpmFwUpdateFault asserted when TPM fw failed to update on FLM Helix module
    [Documentation]    Validate EmTpmFwUpdateFault asserted when TPM fw failed to update on FLM Helix module
    [Tags]    EM    FLM3.00    Automated
    ${last_fusion_event_id}=    get last fusion event ID
    ${list_helix} =   Get List of Occupied Helix EnclosureManager Bays
    Should Not Be Empty    ${list_helix}    msg=No helix present in the enclosure
    ${standby_em_bay}=    Get Standby EM Bay Number
    ${fw_before_mismatch}=   Get FLM version from RedundancySummary
    ${STANDBY EM IP}=    Get Diags Standby EM IPv6 LL Address
    ${ov_claim_pwd}=    Get Claim Password From OneView
    Flash Transition Image to FLM Bay   ${STANDBY EM IP}    ${ov_claim_pwd}
    # start to inject the fault through FLM root
    Write SSH cmd to EM   ${STANDBY EM IP}    em_tpm_platform error set 3
    Sleep    180
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Fusion Event Sent By EM    ${Em_TpmFwUpdateFault}    ${last_fusion_event_id}    ${Enclosure_category}
    Validate TPM Health on Both FLMs   OK   ${None}   OK   Critical
    # start to clear the fault
    Write SSH cmd to EM   ${STANDBY EM IP}   em_tpm_platform error set 0
    #wait for event
    Sleep    180
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Fusion Event Sent By EM    ${Em_TpmFwUpdateFaultCleared}    ${last_fusion_event_id}    ${Enclosure_category}
    Validate TPM Health on Both FLMs
    [Teardown]    Run Keyword If Test Failed    Write SSH cmd to EM   ${STANDBY EM IP}   em_tpm_platform error set 0