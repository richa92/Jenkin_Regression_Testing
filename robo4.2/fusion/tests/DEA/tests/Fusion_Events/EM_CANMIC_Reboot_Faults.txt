*** Settings ***
Documentation     Tests to validate Injected faults after CANMIC reboot

Test Teardown     Run Keyword If    ${Log_After_Each_TC} == True    Get EM Resources Info and log to file after TC
Library           RoboGalaxyLibrary
Library           OperatingSystem
Library           String
Library           Collections
Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/dea_variables.py
Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/data_variables.py
Variables         ${GIT_REPO_ROOT}/mgmtfw/tests/thunderbird/variables/tBird_variables.py
Resource          ${GIT_REPO_ROOT}${RESOURCE_ROOT}/resource_all.txt
Resource          ${GIT_REPO_ROOT}${EM_RESOURCE_ROOT}/thunderbird_all.txt

Suite Setup       Configure Events Test Environment
Suite Teardown    Run Keywords  Logout of EM RIS   AND    Logout of Fusion Via REST

*** Test Cases ***
TC EM Canmic Reboot 01: Verify UnsupportedDeviceFault for Blade
     [Documentation]    This test will validate UnsupportedDeviceFault for Blade
    [Tags]    Blade    FLM2.04
    ${last_fusion_event_id}=    get last fusion event ID
    EM API Get Diags    SimUnsupportedCanmics/true
    # In order to see its effects, you have to restart canopen service which can be accomplished by failing over the current FLM twice
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    ${active_bay} =    Get Diags EmClusterStatus Active Node
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    Sleep    240
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log All
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Alert Event    ${El_Blade_UnsupportedDeviceFault}    ${Blade_Device}    ${Blade_Bays}    600
    Verify Fusion Event Sent By EM    ${El_Blade_UnsupportedDeviceFault}    ${last_fusion_event_id}
    EM API Get Diags    SimUnsupportedCanmics/false
    Sleep    240    
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    [Teardown]    Run Keyword If Test Failed    Run Keywords    EM API Get Diags    SimUnsupportedCanmics/false    AND
    ...    RIS EM Force Failover    ${standby_bay}    AND    RIS EM Force Failover    ${active_bay}    AND    Sleep    ${EM_ForceFailover_Wait}    AND   Login To EM Via RIS

TC EM Canmic Reboot 02: Verify UnsupportedDeviceFault for FrontPanel
    [Documentation]    This test will validate UnsupportedDeviceFault for FrontPanel
    [Tags]    FrontPanel    FLM2.04
    ${last_fusion_event_id}=    get last fusion event ID
    EM API Get Diags    SimUnsupportedCanmics/true
    # In order to see its effects, you have to restart canopen service which can be accomplished by failing over the current FLM twice
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    ${active_bay} =    Get Diags EmClusterStatus Active Node
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    Sleep    240
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log All
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Alert Event    ${El_FrontPanel_UnsupportedDeviceFault}    ${FrontPanel_Device}    ${FrontPanel_Bays}    600
    Verify Fusion Event Sent By EM    ${El_FrontPanel_UnsupportedDeviceFault}    ${last_fusion_event_id}
    EM API Get Diags    SimUnsupportedCanmics/false
    Sleep    240
    # In order to see its effects, you have to restart canopen service which can be accomplished by failing over the current FLM twice    
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    [Teardown]    Run Keyword If Test Failed    Run Keywords    EM API Get Diags    SimUnsupportedCanmics/false    AND
    ...    RIS EM Force Failover    ${standby_bay}    AND    RIS EM Force Failover    ${active_bay}    AND    Sleep    ${EM_ForceFailover_Wait}    AND   Login To EM Via RIS

TC EM Canmic Reboot 03: Verify UnsupportedDeviceFault for Fan
    [Documentation]    This test will validate UnsupportedDeviceFault for  Fan
    [Tags]    Fan    FLM2.04
    ${last_fusion_event_id}=    get last fusion event ID
    EM API Get Diags    SimUnsupportedCanmics/true
    # In order to see its effects, you have to restart canopen service which can be accomplished by failing over the current FLM twice
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    ${active_bay} =    Get Diags EmClusterStatus Active Node
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    Sleep    240
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log All
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Alert Event    ${El_Fan_UnsupportedDeviceFault}    ${Fan_Device}    ${Fan_Bays}    600
    Verify Fusion Event Sent By EM    ${El_Fan_UnsupportedDeviceFault}    ${last_fusion_event_id}
    EM API Get Diags    SimUnsupportedCanmics/false
    Sleep    240
    # In order to see its effects, you have to restart canopen service which can be accomplished by failing over the current FLM twice    
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    [Teardown]    Run Keyword If Test Failed    Run Keywords    EM API Get Diags    SimUnsupportedCanmics/false    AND
    ...    RIS EM Force Failover    ${standby_bay}    AND    RIS EM Force Failover    ${active_bay}    AND    Sleep    ${EM_ForceFailover_Wait}    AND   Login To EM Via RIS

TC EM Canmic Reboot 04: Verify UnsupportedDeviceFault for CIM
    [Documentation]    This test will validate UnsupportedDeviceFault for CIM
    [Tags]    CIM    FLM2.04
    ${last_fusion_event_id}=    get last fusion event ID
    EM API Get Diags    SimUnsupportedCanmics/true
    # In order to see its effects, you have to restart canopen service which can be accomplished by failing over the current FLM twice
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    ${active_bay} =    Get Diags EmClusterStatus Active Node
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    Sleep    240
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log All
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Alert Event    ${El_CIM_UnsupportedDeviceFault}    ${CIM_Device}    ${CIManager_Bays}    600
    Verify Fusion Event Sent By EM    ${El_CIM_UnsupportedDeviceFault}    ${last_fusion_event_id}
    EM API Get Diags    SimUnsupportedCanmics/false
    Sleep    240
    # In order to see its effects, you have to restart canopen service which can be accomplished by failing over the current FLM twice    
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
   [Teardown]    Run Keyword If Test Failed    Run Keywords    EM API Get Diags    SimUnsupportedCanmics/false    AND
  ...    RIS EM Force Failover    ${standby_bay}    AND    RIS EM Force Failover    ${active_bay}    AND    Sleep    ${EM_ForceFailover_Wait}    AND   Login To EM Via RIS
 
TC EM Canmic Reboot 05: Verify UnsupportedDeviceFault for PowerSupply
     [Documentation]    This test will validate UnsupportedDeviceFault for  PowerSupply
    [Tags]   PowerSupply    FLM2.04
    ${last_fusion_event_id}=    get last fusion event ID
    EM API Get Diags    SimUnsupportedCanmics/true
    # In order to see its effects, you have to restart canopen service which can be accomplished by failing over the current FLM twice
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    ${active_bay} =    Get Diags EmClusterStatus Active Node
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    Sleep    240
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log All
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Alert Event    ${El_PS_UnsupportedDeviceFault}    ${PowerSupply_Device}    ${PowerSupply_Bays}    600
    Verify Fusion Event Sent By EM    ${El_PS_UnsupportedDeviceFault}    ${last_fusion_event_id}
    EM API Get Diags    SimUnsupportedCanmics/false
    Sleep    240
    # In order to see its effects, you have to restart canopen service which can be accomplished by failing over the current FLM twice    
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    [Teardown]    Run Keyword If Test Failed    Run Keywords    EM API Get Diags    SimUnsupportedCanmics/false    AND
    ...    RIS EM Force Failover    ${standby_bay}    AND    RIS EM Force Failover    ${active_bay}    AND    Sleep    ${EM_ForceFailover_Wait}    AND   Login To EM Via RIS

TC EM Canmic Reboot 06: Verify UnsupportedDeviceFault for Interconnect
    [Documentation]    This test will validate UnsupportedDeviceFault for Interconnect
    [Tags]    Interconnect    FLM2.04
    ${last_fusion_event_id}=    get last fusion event ID
    EM API Get Diags    SimUnsupportedCanmics/true
    # In order to see its effects, you have to restart canopen service which can be accomplished by failing over the current FLM twice
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    ${active_bay} =    Get Diags EmClusterStatus Active Node
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    Sleep    240
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log All
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Alert Event    ${El_Interconnect_UnsupportedDeviceFault}    ${ICM_Device}    ${Interconnect_Bays}    600
    Verify Fusion Event Sent By EM    ${El_Interconnect_UnsupportedDeviceFault}    ${last_fusion_event_id}
    EM API Get Diags    SimUnsupportedCanmics/false
    Sleep    240
    # In order to see its effects, you have to restart canopen service which can be accomplished by failing over the current FLM twice    
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    ${standby_bay} =    Get Diags EmClusterStatus Standby Node
    RIS EM Force Failover    ${standby_bay}
    Sleep    ${EM_ForceFailover_Wait}
    Login To EM Via RIS
    [Teardown]    Run Keyword If Test Failed    Run Keywords    EM API Get Diags    SimUnsupportedCanmics/false    AND
    ...    RIS EM Force Failover    ${standby_bay}    AND    RIS EM Force Failover    ${active_bay}    AND    Sleep    ${EM_ForceFailover_Wait}    AND   Login To EM Via RIS