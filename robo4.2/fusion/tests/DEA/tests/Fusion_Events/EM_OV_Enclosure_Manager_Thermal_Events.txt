*** Settings ***
Documentation     Validate EM Enclosure Manager events on OneView
...               = GENERIC USAGE =
...               | pybot | -v GIT_REPO_ROOT:<repo root path> | -v APPLIANCE_IP:<ipv4> |EM_OV_Enclosure_Manager_Thermal_Events.txt |
...               = Variables =
...               | GIT_REPO_ROOT | Required: Repo root path if NOT defined in environment variable|
...               | APPLIANCE_IP | Required: OneView IPv4 address |
Suite Setup       Configure Events Test Environment
Suite Teardown    Run Keywords    Restore Good FLM FRU Duplex mode    AND    Sleep    600    AND    Logout of EM RIS    AND    Logout of Fusion Via REST
Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/dea_variables.py
Variables         ${GIT_REPO_ROOT}/mgmtfw/tests/thunderbird/variables/tBird_variables.py
Resource          ${GIT_REPO_ROOT}${RESOURCE_ROOT}/resource_all.txt
Resource          ${GIT_REPO_ROOT}${EM_RESOURCE_ROOT}/thunderbird_all.txt
Library           RoboGalaxyLibrary
Library           MgmtFWLibrary
Library           json

*** Test Cases ***

TC01: Verify EM Thermal Warning and Em Thermal Sensor Read Warning Events 
    [Documentation]    Verifies Thermal Warning, Thermal Sensor warning and EM OK events
    [Tags]    EM     FLM1.01    Automated    Disabled    FRU
    Log To Console    Make sure Enclosure in OK state for further verification to avoid any false verification
    Wait for Device OK    ${EM_Device}    1
    Wait for Device OK    ${EM_Device}    2
    ${last_fusion_event_id}=    get last fusion event ID
    Comment    Change EM In Bay 1 as Active
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    RunKeyword If    ${active_bay}<>1    Run Keywords    RIS EM Force Failover    1
    ...    AND    Sleep    ${EM_ForceFailover_Wait}
    ...    AND    Login to EM Via RIS
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    Log To Console    Failing the EM for bay:${active_bay} and verify event
    Flash Enclosure Manager Fru    ${active_bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${Custom_Em_Degrade_Fru_Path}
    RIS EM Reboot    ${active_bay}
    Log To Console    Sleeping 3 minutes
    Sleep    180
    Login to EM Via RIS
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Alert Event    ${EM_Thermal_Warnng}    ${EM_Device_Name}    ${active_bay}    300
    Run Keyword And Ignore Error    Verify Fusion Event Sent By EM    ${EM_Thermal_Warnng}    ${last_fusion_event_id}    ${Enclosure_category}
    ${encl_status}=    Get Enclosure Health
    Should Be Equal    ${encl_status}    ${HEALTH_WARNING}
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    RunKeyword If    ${active_bay}<>1    Run Keywords    RIS EM Force Failover    1
    ...    AND    Sleep    ${EM_ForceFailover_Wait}
    ...    AND    Login to EM Via RIS
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    Log To Console    Flashing good FRU
    Flash Enclosure Manager Fru    ${active_bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\Fru_Files\\${CAT}\\Good_Fru\\EM\\${active_bay}\\fru.bin
    RIS EM Reboot    ${active_bay}
    Log to Console    Sleeping 5 minutes
    Sleep    ${EM_REBOOT_TIME}
    Login to EM Via RIS
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Status Change MessageID Event    ${EM_Ok}    ${EM_Device_Name}    ${active_bay}    300
    #Verifying that EM_OK event is not seen in OV
    ${passed}=    Run Keyword And Return Status    Verify Fusion Event Sent By EM    ${EM_Ok}    ${last_fusion_event_id}    ${Enclosure_category}
    Should Not Be True    ${passed}    msg=Found event ${EM_Ok} in Oneview. ${EM_Ok} is Not a OneView communicated event.
    [Teardown]    Run Keyword If Test Failed    Run Keywords    Flash Enclosure Manager Fru    ${active_bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\Fru_Files\\${CAT}\\Good_Fru\\EM\\${active_bay}\\fru.bin
    ...    AND    RIS EM Reboot    ${active_bay}    AND    Sleep    ${EM_REBOOT_TIME}    AND    Login to EM Via RIS


TC02: Verify EM Thermal Critical Events
    [Documentation]    Verifies Thermal Critical
    [Tags]    EM     FLM1.01    Automated    Disabled    FRU
    Wait for Device OK    ${EM_Device}    1
    Wait for Device OK    ${EM_Device}    2
    Log To Console    Make sure Enclosure in OK state for further verification to avoid any false verification
    ${last_fusion_event_id}=    get last fusion event ID
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    RunKeyword If    ${active_bay}<>1    Run Keywords    RIS EM Force Failover    1
    ...    AND    Sleep    ${EM_ForceFailover_Wait}
    ...    AND    Login to EM Via RIS
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    Log To Console    Failing the EM for bay:${active_bay} and verify event
    Flash Enclosure Manager Fru    ${active_bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${Custom_Em_Thermal_Sensor_Critical_Fru_Path}
    RIS EM Reboot    ${active_bay}
    Log To Console    Sleeping 3 minutes
    Sleep    240
    Login to EM Via RIS
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Alert Event    ${EM_ThermalCritical}    ${EM_Device_Name}    ${active_bay}    300
    Verify Fusion Event Sent By EM    ${EM_ThermalCritical}    ${last_fusion_event_id}    ${Enclosure_category}
    ${encl_status}=    Get Enclosure Health
    Should Be Equal    ${encl_status}    ${HEALTH_WARNING}
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    RunKeyword If    ${active_bay}<>1    Run Keywords    RIS EM Force Failover    1
    ...    AND    Sleep    ${EM_ForceFailover_Wait}
    ...    AND    Login to EM Via RIS
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    Log To Console    Flashing good FRU
    Flash Enclosure Manager Fru    ${active_bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\Fru_Files\\${CAT}\\Good_Fru\\EM\\${active_bay}\\fru.bin
    RIS EM Reboot    ${active_bay}
    Log to Console    Sleeping 5 minutes
    Sleep    ${EM_REBOOT_TIME}
    Login to EM Via RIS
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Status Change MessageID Event    ${EM_Ok}    ${EM_Device_Name}    ${active_bay}    300
    [Teardown]    Run Keyword If Test Failed    Run Keywords    Flash Enclosure Manager Fru    ${active_bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\Fru_Files\\${CAT}\\Good_Fru\\EM\\${active_bay}\\fru.bin
    ...    AND    RIS EM Reboot    ${active_bay}    AND    Sleep    ${EM_REBOOT_TIME}    AND    Login to EM Via RIS

TC03: Verify Em Thermal Sensor Read Warning Events
    [Documentation]    Verifies Thermal Sensor warning events
    [Tags]    EM     FLM1.01    Automated    Disabled    FRU
    Wait for Device OK    ${EM_Device}    1
    Wait for Device OK    ${EM_Device}    2
    Log To Console    Make sure Enclosure in OK state for further verification to avoid any false verification
    ${last_fusion_event_id}=    get last fusion event ID
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    RunKeyword If    ${active_bay}<>1    Run Keywords    RIS EM Force Failover    1
    ...    AND    Sleep    ${EM_ForceFailover_Wait}
    ...    AND    Login to EM Via RIS
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    Log To Console    Failing the EM for bay:${active_bay} and verify event
    Flash Enclosure Manager Fru    ${active_bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\${Custom_Em_Thermal_Sensor_Critical_Fru_Path}
    RIS EM Reboot    ${active_bay}
    Log To Console    Sleeping 3 minutes
    Sleep    240
    Login to EM Via RIS
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Alert Event    ${EM_ThermalSensorReadWarning}    ${EM_Device_Name}    ${active_bay}    300
    Verify Fusion Event Sent By EM    ${EM_ThermalSensorReadWarning}    ${last_fusion_event_id}    ${Enclosure_category}
    ${encl_status}=    Get Enclosure Health
    Should Be Equal    ${encl_status}    ${HEALTH_WARNING}
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    RunKeyword If    ${active_bay}<>1    Run Keywords    RIS EM Force Failover    1
    ...    AND    Sleep    ${EM_ForceFailover_Wait}
    ...    AND    Login to EM Via RIS
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    Log To Console    Flashing good FRU
    Flash Enclosure Manager Fru    ${active_bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\Fru_Files\\${CAT}\\Good_Fru\\EM\\${active_bay}\\fru.bin
    RIS EM Reboot    ${active_bay}
    Log to Console    Sleeping 5 minutes
    Sleep    ${EM_REBOOT_TIME}
    Login to EM Via RIS
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Status Change MessageID Event    ${EM_Ok}    ${EM_Device_Name}    ${active_bay}    300
    [Teardown]    Run Keyword If Test Failed    Run Keywords    Flash Enclosure Manager Fru    ${active_bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\Fru_Files\\${CAT}\\Good_Fru\\EM\\${active_bay}\\fru.bin
    ...    AND    RIS EM Reboot    ${active_bay}    AND    Sleep    ${EM_REBOOT_TIME}    AND    Login to EM Via RIS
