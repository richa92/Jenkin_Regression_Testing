*** Settings ***
Documentation     Efuse Reset Various Bays with the HAL Webapp
...    = USAGE =
...    | pybot | -v ENCLOSURE:dcs          | FUSION_IP:my_fusion_ip | efuse_reset_bays.txt |
...    | pybot | -v ENCLOSURE:dcs          | efuse_reset_bays.txt |
...    = Variables =
...    | ENCLOSURE | Optional. Dictionary key from variables.py representing the desired enclosure.  Default value is dcs. |
...    | FUSION_IP | Required if ENCLOSURE is dcs.
...    Pre-requisite:  CLI for ICM if testing ICM bays

# AM-DVT US35834
# David Gray
# 2014, December

Library           RoboGalaxyLibrary                            # DVTs Robot Framework extensions
Library           FusionLibrary                                   # DVTs Robot Framework extensions
Variables         ${CURDIR}/../resources/variables.py    #${ENCLOSURE}    # Variables file
Resource          ${CURDIR}/../resources/defaults.txt          # AM-DVT default variables
Resource          ${CURDIR}/../resources/fusion_api.txt            # AM-DVT Fusion API extensions
Resource          ${CURDIR}/../resources/hal_webapp.txt            # AM-DVT HAL Webapp extensions
Resource          ${CURDIR}/../resources/system_info.txt           # AM-DVT fusion API extensions
Resource          ${CURDIR}/../resources/fusion_ssh.txt           # AM-DVT fusion ssh extensions
Variables         ../../../DEA/variables/dea_variables.py
Resource          ../../../DEA/resource/fusion_api_resource.txt    # AM-DVT PERM webapp extensions
Resource          ../../../resource/fusion_api_em_ris.txt
Resource          ../resources/hal_resource.txt    # AM-DVT PERM webapp extensions 

Suite Setup       Login to Fusion via SSH
Suite Teardown    Run Keywords    Login to Fusion via REST    AND    Logout of Fusion via REST    AND    Logout of Fusion via SSH


*** Variables ***
#Not doing blade bays until the iLO situation is sorted and ICM's are supported (F110)
#@{bays-actions}  InterconnectBays  IcmBayEfuse  FanBays  FanBayEfuse  PowerSupplyBays  PowerSupplyBayEfuse  BladeBays  ladeBayEfuse
@{bays-actions}    FanBays  FanBayEfuse  PowerSupplyBays  PowerSupplyBayEfuse


*** Testcases ***

Efuse Reset Device Bays
    [Tags]    DCS    HW    HAL    Automated
    ${auth}=    Get Trusted Token
    ${session_id}=    Fusion Api Login Pem    ${FUSION_IP}    ${creds}    ${auth}
    :For    ${bay}    ${action}    in    @{bays-actions}
    \    ${bayurl}=    Set Variable If    ${DCS}==True    /rest/v1/chassis/1/${bay}    /rest/v1/${bay}
    \    ${filled}    ${unfilled}=    Find Filled Bays    ${bayurl}
    \    ${bayno}=    Select Random ELement From List    ${filled}
    \    ${bayno}=    Convert to Integer    ${bayno}
    \    Run Keyword If    ${DCS}!=True and '${bay}'=='InterconnectBays'
    \    ...    Verify ICM Reset    ${action}    ${bayno}
    \    Run Keyword If    ${DCS}!=True and '${bay}'!='InterconnectBays'
    \    ...    Verify Reset via EM Log    ${action}    ${bayno}
    #    Negative:  try empty bay if any
    \    ${length}=    Get Length    ${unfilled}
    \    ${status}    ${emptyno}=   Run Keyword and Ignore Error
    \    ...    Select Random Element From List    ${unfilled}
    \    Run Keyword If    ${length}>0
    \    ...    HAL Action    ${action}    ${emptyno}    invalid
    #    Negative:  try invalid bay
    \    ${invalid}=    Set Variable    ${-1}
    \    HAL Action    ${action}    ${invalid}    invalid
    \    ${invalid}=    Set Variable    ${99}
    \    HAL Action    ${action}    ${invalid}    invalid
