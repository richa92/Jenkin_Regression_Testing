*** Settings ***
Documentation     Validate EM Enclosure Manager events on OneView
...               EmFruManufacturedForInvalidFault
...               EmFruManufacturedForMismatch
...               = GENERIC USAGE =
...               | pybot | -v GIT_REPO_ROOT:<repo root path> | -v APPLIANCE_IP:<ipv4> |EM_OV_Enclosure_Manager_FRU_Fault_Events.txt |
...               = Variables =
...               | GIT_REPO_ROOT | Required: Repo root path if NOT defined in environment variable|
...               | APPLIANCE_IP | Required: OneView IPv4 address |
Suite Setup       Configure Events Test Environment
Suite Teardown    Run Keywords    Restore Good FLM FRU Duplex mode    AND    Sleep    600    AND    Logout of EM RIS    AND    Logout of Fusion Via REST
Variables         ${GIT_REPO_ROOT}/fusion/tests/DEA/variables/dea_variables.py
Variables         ${GIT_REPO_ROOT}/mgmtfw/tests/thunderbird/variables/tBird_variables.py
Resource          ${GIT_REPO_ROOT}${RESOURCE_ROOT}/resource_all.txt
Resource          ${GIT_REPO_ROOT}${EM_RESOURCE_ROOT}/thunderbird_all.txt
Library           RoboGalaxyLibrary
Library           MgmtFWLibrary
Library           json

*** Test Cases ***

TC01: Verify EM FruFault event
    [Documentation]    Verify EM FruFault event
    [Tags]    EM    Alert    Events    FLM2.00    OV3.10    Automated
    Run Keyword and Ignore Error    Wait for Node Consistent
    ${Standby_EM_Bay}=    Get Diags EmClusterStatus Standby Node
    Should Not Be Empty    ${Standby_EM_Bay}    msg=No standby EM found; please run this test on a redundant environment
    ${last_fusion_event_id}=    get last fusion event ID
    Set EM RIS FRU Faults    ${EM_Device_Name}    True
    RIS EM Efuse On OTHER EM    ${Standby_EM_Bay}
    Sleep    8
    RIS EM Efuse Off OTHER Failed EM    ${Standby_EM_Bay}
    #Validate EM Health    ${Standby_EM_Bay}    ${HEALTH_CRITICAL}
    Sleep    30
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log All Alerts
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Alert Event    ${EL_Em_FruFault}    ${EM_Device_Name}    ${Standby_EM_Bay}    600
    Verify Fusion Event Sent By EM    ${EL_Em_FruFault}    ${last_fusion_event_id}
    Set EM RIS FRU Faults    ${EM_Device_Name}    False
    RIS EM Efuse On OTHER EM    ${Standby_EM_Bay}
    Sleep    8
    RIS EM Efuse Off OTHER EM    ${Standby_EM_Bay}
    Sleep    10
    Wait for Device OK    ${EM_Device}    ${Standby_EM_Bay}
    [Teardown]    Run Keyword If Test Failed    Run Keywords    Set EM RIS FRU Faults    ${EM_Device_Name}    False    AND
    ...    RIS EM Efuse On OTHER EM    ${Standby_EM_Bay}    AND    Sleep    8    AND    RIS EM Efuse Off OTHER EM    ${Standby_EM_Bay}
    ...    AND    Sleep    10    AND    Wait for Device OK    ${EM_Device}    ${Standby_EM_Bay}

TC02: Verify Em FruManufacturedFor InvalidFault
    [Documentation]    Verify Em FruManufacturedFor InvalidFault
    [Tags]    EM    Alert    Events    FLM2.00    OV3.10    Automated
    Wait for Device OK    ${EM_Device}    1
    Wait for Device OK    ${EM_Device}    2
    Run Keyword and Ignore Error    Wait for Node Consistent
    ${standby_em_bay}=    Get Diags EmClusterStatus Standby Node
    ${active_em_bay}=    Get Diags EmClusterStatus Active Node
    ${last_fusion_event_id}=    get last fusion event ID
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    ${em_bay}=    Get Diags EmClusterStatus Active Node
    RunKeyword If    ${active_bay}<>1    Run Keywords    RIS EM Force Failover    1
    ...    AND    Sleep    ${EM_ForceFailover_Wait}
    ...    AND    Login to EM Via RIS
    ...    AND    Run Keyword and Ignore Error    Wait for Node Consistent
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    ${ManufacturedFor}=    Get ManufacturedFor From Midplane FRU
    Should Be Equal As Strings    ${ManufacturedFor}    HPE
    #Flash bad Fru
    ${em_bay}=    Get Diags EmClusterStatus Active Node
    Log To Console    Flash bad Fru to bay ${em_bay}
    Flash Enclosure Manager Fru    ${em_bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\EM\\em_fru_foo.bin
    RIS EM Reboot    ${em_bay}
    Log To Console    Sleeping 5 minutes
    Sleep    ${EM_REBOOT_TIME}
    Login to EM Via RIS
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Alert Event    ${EM_FruManufacturedForInvalidFault}    ${EM_Device_Name}    ${standby_em_bay}    480
    Verify Fusion Event Sent By EM    ${EM_FruManufacturedForInvalidFault}    ${last_fusion_event_id}
    Comment    Change EM In Bay 1 as Active
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    RunKeyword If    ${active_bay}<>1    Run Keywords    RIS EM Force Failover    1
    ...    AND    Sleep    ${EM_ForceFailover_Wait}
    ...    AND    Login to EM Via RIS
    ...    AND    Run Keyword and Ignore Error    Wait for Node Consistent
    ${em_bay}=    Get Diags EmClusterStatus Active Node
    # Flash the Good Fru
    Log To Console    Flash Good Fru to bay ${em_bay}
    Flash Enclosure Manager Fru    ${em_bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\Fru_Files\\${CAT}\\Good_Fru\\EM\\${em_bay}\\fru.bin
    RIS EM Reboot    ${em_bay}
    Log To Console    Sleeping 5 minutes
    Sleep    ${EM_REBOOT_TIME}
    Login to EM Via RIS
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Status Change MessageID Event    ${EM_Ok}    ${EM_Device_Name}    ${em_bay}    250
    [Teardown]    Run Keyword If Test Failed    Run Keywords    Flash Enclosure Manager Fru    ${em_bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\Fru_Files\\${CAT}\\Good_Fru\\EM\\${em_bay}\\fru.bin
    ...    AND    RIS EM Reboot    ${em_bay}    AND    Sleep    ${EM_REBOOT_TIME}    AND    Login to EM Via RIS

TC03: Verify Em FruManufacturedFor Mismatch
    [Documentation]    Verify Em FruManufacturedFor Mismatch
    [Tags]    EM    Alert    Events    FLM2.00    OV3.10    Automated
    Run Keyword and Ignore Error    Wait for Node Consistent
    ${standby_em_bay}=    Get Diags EmClusterStatus Standby Node
    ${active_em_bay}=    Get Diags EmClusterStatus Active Node
    ${last_fusion_event_id}=    get last fusion event ID
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    RunKeyword If    ${active_bay}<>1    Run Keywords    RIS EM Force Failover    1
    ...    AND    Sleep    ${EM_ForceFailover_Wait}
    ...    AND    Login to EM Via RIS
    ...    AND    Run Keyword and Ignore Error    Wait for Node Consistent
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    ${ManufacturedFor}=    Get ManufacturedFor From Midplane FRU
    Should Be Equal As Strings    ${ManufacturedFor}    HPE
    #Flash bad Fru
    ${em_bay}=    Get Diags EmClusterStatus Active Node
    Log To Console    Flash bad Fru to bay ${em_bay}
    Flash Enclosure Manager Fru    ${em_bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\${Customized_FRU_Path}\\EM\\em_fru_nec.bin
    RIS EM Reboot    ${em_bay}
    Log To Console    Sleeping 5 minutes
    Sleep    ${EM_REBOOT_TIME}
    Login to EM Via RIS
    ${diags_50}    ${diags_auditlog_file_path}=    Get Diags Audit Log 50 Recent Entries
    Set Test Variable    ${EM_Event_Logger}    ${diags_auditlog_file_path}
    Verify Audit Log Alert Event    ${EM_FruManufacturedForMismatchFault}    ${EM_Device_Name}    ${standby_em_bay}    240
    Verify Fusion Event Sent By EM    ${EM_FruManufacturedForMismatchFault}    ${last_fusion_event_id}
    Comment    Change EM In Bay 1 as Active
    ${active_bay}=    Get Diags EmClusterStatus Active Node
    RunKeyword If    ${active_bay}<>1    Run Keywords    RIS EM Force Failover    1
    ...    AND    Sleep    ${EM_ForceFailover_Wait}
    ...    AND    Login to EM Via RIS
    ...    AND    Run Keyword and Ignore Error    Wait for Node Consistent
    ${em_bay}=    Get Diags EmClusterStatus Active Node
    # Flash the Good Fru
    Log To Console    Flash Good Fru to bay ${em_bay}
    Flash Enclosure Manager Fru    ${em_bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\Fru_Files\\${CAT}\\Good_Fru\\EM\\${em_bay}\\fru.bin
    RIS EM Reboot    ${em_bay}
    Log To Console    Sleeping 5 minutes
    Sleep    ${EM_REBOOT_TIME}
    Login to EM Via RIS
    Wait for Device OK    ${EM_Device}    ${em_bay}
    [Teardown]    Run Keyword If Test Failed    Run Keywords    Flash Enclosure Manager Fru    ${em_bay}    ${GIT_REPO_ROOT}${TESTDATA_ROOT}\\Fru_Files\\${CAT}\\Good_Fru\\EM\\${em_bay}\\fru.bin
    ...    AND    RIS EM Reboot    ${em_bay}
    ...    AND    Sleep    ${EM_REBOOT_TIME}
    ...    AND    Login to EM Via RIS
    ...    AND    Run Keyword and Ignore Error    Wait for Node Consistent
    ...    AND    Wait for Device OK    ${EM_Device}    ${em_bay}
