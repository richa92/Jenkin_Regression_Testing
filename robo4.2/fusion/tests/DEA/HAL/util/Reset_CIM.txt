*** Settings ***
Documentation     Factory Reset CI Manager
...    = Usage =
...    pybot -L TRACE
...    -v FUSION_FQDN:<Fully-Qualified Domain Name> -v FUSION_IP:<Static IPv4 Address>
...    -v GATEWAY_IP:<Gateway IP Address> -v NETMASK_IP:<Netmask IP Address>
...
...    = Variables =
...    | FUSION FQDN | Required; Fully-Qualified Domain Name To Set CIM To |
...    | FUSION IP | Required; Static IPv4 Address To Set CIM To |
...    | GATEWAY IP | Required; Gateway IPv4 Address To Set CIM To |
...    | NETMASK IP | Required; Netmask IPv4 Address To Set CIM To |
...    |
...    = Preconditions =
...    None

Library           RoboGalaxyLibrary
Library           FusionLibrary
Library           robot.api.logger
Variables         ../resources/variables.py    ${ENCLOSURE}
Resource          ../resources/fusion_cli.txt
Resource          ../resources/defaults.txt

Force Tags        # All test cases get these tags

*** Keywords ***
Relogin CIM
    Close Browser
    Open Browser To Login Page After Startup

Open Browser To Login Page After Startup
    Console    Opening Browser to https://${FUSION_IPV6}/#/login
    Open Browser    https://${FUSION_IPV6}/#/login    firefox

*** Test Cases ***

Fusion Factory Reset
    Log Variables
    Reset Fusion Appliance to Factory Default

Open Browser To Login Page After Startup
    Console    Opening Browser to https://${FUSION_IP}/#/login
    Open Browser    https://${FUSION_IP}/#/login    firefox
    # Click 'Continue to this website' link allowing test case to continue (for IE only).
    # Run Keyword If  "${BROWSER}" == "IE"   Go To  javascript:document.getElementById('overridelink').click()
    sleep    5
    Capture Page Screenshot

First Time Login
    [Tags]    FirstTimeLogin
    Open Browser To Login Page After Startup
    Wait Until Element Is Visible      id=hp-login-user
    ...                                timeout=300
    ...                                error=Not at Login page
    Input Text    hp-login-user        ${FUSION_USERNAME}
    Input Text    hp-login-password    ${FUSION_FACTORY_PASSWORD}
    Click Button    hp-login-button
    sleep    5
    Capture Page Screenshot

Assign Administrator Password
    [Tags]    AssignAdminPassword
    Wait Until Element Is Visible    id=hp-initial-password-new1
    ...                              timeout=300
    ...                              error=Not at Initial Password page
    Input Text    id=hp-initial-password-new1    ${FUSION_PASSWORD}
    Input Text    id=hp-initial-password-new2    ${FUSION_PASSWORD}
    Click Button    id=hp-initial-password-button-element
    sleep    5
    Capture Page Screenshot

Assign Networking
    Wait Until Element Is Visible    id=cic-appliance-nics-table-row-1
    ...                              timeout=300
    ...                              error=Not at Initial-network page

    # Select First NIC for Primary Networking.  Unassign Second NIC
    Click Element    xpath=//tr[@id='cic-appliance-nics-table-row-1']/td[@class='hp-icon']/div[@class='hp-collapser']

    # Wait until all NIC entries expanded
    Wait Until Element Is Visible    id=cic-network-ipv6-unassign-100
    ...                              timeout=300
    ...                              error=Do not see IPv6 radio button

    Maximize Browser Window
    Sleep    1
    Capture Page Screenshot

    # Add Hostname
    Input Text    id=cic-network-hostname-100    ${FUSION_FQDN}
    Capture Page Screenshot

    # Set IPv4 Networking For NIC 1
    Input Text    id=cic-network-ip-ipv4-100          ${FUSION_IP}
    Input Text    id=cic-network-gateway-ipv4-100     ${GATEWAY_IP}
    Input Text    id=cic-network-mask-ipv4-100        ${NETMASK_IP}
    Input Text    id=cic-network-preferred-dns-100    ${PRIMARY_DNS}
    Input Text    id=cic-network-alternate-dns-100    ${ALTERNATE_DNS}
    Capture Page Screenshot

    # IPv6 networking for NIC1 to DHCP
    Select Radio Button    addressAssignmentforv6-100    cic-network-ipv6-dhcp-100

    Capture Page Screenshot

    # OK the changes
    Click Button    id=cic-network-ok

    Sleep    5
    Capture Page Screenshot
    Wait Until Page Contains    Applying network settings.    timeout=300
    Sleep    60

Relogin CIM
    Close Browser
    Open Browser To Login Page After Startup

First Time Login After Network Init
    [Tags]    FirstTimeLoginAfterNetworkInit
    ${status}    ${msg}=    Run Keyword and Ignore Error    Page Should not contain    Errors Occurred. Unable to apply all the network settings correctly
    Run Keyword If    '${status}'=='FAIL'    Relogin CIM

    Wait Until Keyword Succeeds    1 min    30 sec    Page Should not contain    Applying network settings.

    Wait Until Element Is Visible        id=hp-login-user
    ...                                  timeout=300
    ...                                  error=Not at Login page
    Input Text      hp-login-user        ${FUSION_USERNAME}
    Input Text      hp-login-password    ${FUSION_PASSWORD}
    Click Button    hp-login-button
    sleep    5
    Capture Page Screenshot

Wait for Fusion Ready
    Wait Until Element Is Visible    id=hp-main-menu-control
    ...                              timeout=300
    ...                              error=Not at Dashboard page (cant find main-menu)
    ${Location}=    Get Location
    ${Page}=    Fetch From Right    ${Location}    https://${FUSION_IP}
    Pass Execution If    '${Page}'=='/#/dashboard'    msg=Found dashboard
    Capture Page Screenshot
    Fail    msg=Failed to apply network settings

Cleanup
    Close Browser
