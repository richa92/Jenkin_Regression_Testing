*** Settings ***
Documentation     Testing VLAN functionality with PEM COMMANDS that are applicable to EM Switch Module
...    = Usage =
...    | pybot | -L DEBUG | APPLIANCE_IP:<fusion_ipv4> | PEM_Vlan.txt | 
...    = Variables =
...    | GIT_REPO_ROOT | Required; Repo root path if NOT defined in environment variable|
...    | RESOURCE_ROOT | Optional: Resource files path if NOT defined in environment variable|
...    | VARIABLE_ROOT | Optional: Variable files path if NOT defined in environment variable|
...    | APPLIANCE IP     | Required; OneView IP address under test | 

Library           RoboGalaxyLibrary            # DVTs Robot Framework extensions
Library           FusionLibrary                # DVTs Robot Framework extensions
Library           OperatingSystem
Library           MgmtFWLibrary
Library           loginPEMClass 
Library           json
Library           String
Library           Collections

Variables         ${GIT_REPO_ROOT}${VARIABLE_ROOT}/dea_variables.py
Variables         ${GIT_REPO_ROOT}${VARIABLE_ROOT}/data_variables.py
Variables         ${GIT_REPO_ROOT}/mgmtfw/tests/thunderbird/variables/tBird_variables.py
Resource          ${GIT_REPO_ROOT}${RESOURCE_ROOT}/resource_all.txt

Suite Setup       Run Keywords    Login to Fusion via REST    AND    Login to Fusion via SSH    AND    Login to EM And Create Session
Suite Teardown    Run Keywords    Logout of Fusion Via REST

*** Variables ***
${bad_bay_num}    99

*** Test Cases ***
TC 01: PEM EM Switch Port Resource Get: Test PEM Action EM Switch Port Resource Get For Management Processor
    [Documentation]    Test Case on PEM Action EmSwitchPortsResourceGet for Management Processor 
    [Tags]    Automated   VLAN    DEA    API    PEM    OV3.10
    # Get PEM's token and establish session and fusion uuid
    ${auth}=    Get Trusted PEM Token
    set_header_to_pem_token    ${APPLIANCE_IP}    ${pem_cred}    ${auth}
    ${fusion_uuid}=    Check For Single Enclosure and Get UUID
    ${enc_serial_number}=    Fetch From Right    ${fusion_uuid}    000

    # get active and standby em from the enclosure
    ${em_active}=    Get EM Active Bay
    ${em_standby}=    Get EM Standby Bay
    ${em_list}=    Create List    ${em_active}    ${em_standby}
    # execute pem command EmSwitchPortsResourceGet on EM Bay list
    :FOR    ${bay_number}    IN    @{em_list}
    \    ${pem_response}=    PEM Action To Get EM Switch Port Resource    ${auth}    ${APPLIANCE_IP}    ${enc_serial_number}    ${bay_number}    Mgmt    1
    \    Should Be Equal As Strings    ${pem_response["CallStatus"]}    SUCCESS
    # read port type and port mode from pem response and validate the data
    \    ${port_type_pem}=    Read Mgmt Port value    ${pem_response}
    \    ${get_port_from_pem}=    Set Variable    ${pem_response["OperationResult"]["EmSwitchPorts"][0]["links"]["LLDPReceive"]["href"]}
    \    ${pem_port_mode}=    Set Variable    ${pem_response["OperationResult"]["EmSwitchPorts"][0]["MgmtPortMode"]}
    \    ${vport}=    Fetch From Right    ${get_port_from_pem}    /
    \    ${device_id}=    Convert To String    EnclosureManagerSwitchPorts/${vport}
    # validate the pem response with info obtained through EM using SSH command via rest
    \    ${ssh_resp}=    Run SSH Command Using EM    ${device_id}
    \    ${get_port_type}=    Fetch From Right    ${ssh_resp}    "PortType": "
    \    ${port_type}=    Fetch From Left    ${get_port_type}    "
    \    Should Be Equal As Strings    ${port_type_pem}    ${port_type}
    \    ${get_port_mode}=    Fetch From Right    ${ssh_resp}    PortMode": "
    \    ${port_mode}=    Fetch From Left    ${get_port_mode}    "
    \    Should Be Equal As Strings    ${pem_port_mode}    ${port_mode}

TC 02: PEM EM Switch Port Resource Get: Test PEM Action EM Switch Port Resource Get For CIManager
    [Documentation]    Test Case on PEM Action EmSwitchPortsResourceGet for CIManager
    [Tags]    Automated   VLAN    DEA    API    PEM    OV3.10
    # Get PEM's token and establish session and fusion uuid
    ${auth}=    Get Trusted PEM Token
    set_header_to_pem_token    ${APPLIANCE_IP}    ${pem_cred}    ${auth}
    ${fusion_uuid}=    Check For Single Enclosure and Get UUID
    ${enc_serial_number}=    Fetch From Right    ${fusion_uuid}    000

    # get active and standby em from the enclosure
    ${em_active}=    Get EM Active Bay
    ${em_standby}=    Get EM Standby Bay
    ${em_list}=    Create List    ${em_active}    ${em_standby}
    # execute pem command EmSwitchPortsResourceGet on EM Bay list
    :FOR    ${bay_number}    IN    @{em_list}
    \    PEM Command EmSwitchPorts Resource Get On Ports    ${auth}    ${APPLIANCE_IP}    ${enc_serial_number}    ${bay_number}

TC 03: PEM EM Switch Port LLDP Receive Read: Test PEM Action EM Switch Ports LLDP Receive Read For Management Processor
    [Documentation]    Test Case on PEM Action EmSwitchPortsLldpReveiveRead for Management Processor
    [Tags]    Automated   VLAN    DEA    API    PEM    OV3.10
    # Get PEM's token and establish session and fusion uuid
    ${auth}=    Get Trusted PEM Token
    set_header_to_pem_token    ${APPLIANCE_IP}    ${pem_cred}    ${auth}
    ${fusion_uuid}=    Check For Single Enclosure and Get UUID
    ${enc_serial_number}=    Fetch From Right    ${fusion_uuid}    000

    # get active and standby em from the enclosure
    ${em_active}=    Get EM Active Bay
    ${em_standby}=    Get EM Standby Bay
    ${em_list}=    Create List    ${em_active}    ${em_standby}
    # execute pem command EmSwitchPortsLldpReveiveRead on EM Bay list
    :FOR    ${bay_number}    IN    @{em_list}
    \    ${response_lldp_receive}=    PEM Action To Get EM Switch Port LLDP Receive    ${auth}    ${APPLIANCE_IP}    ${enc_serial_number}    ${Bay_Number}    Mgmt    1
    \    Should Be Equal As Strings    ${response_lldp_receive["CallStatus"]}    SUCCESS
    # read mac address from pem response
    \    ${mac_address_pem}=    Read Lldp Receive MAC Address    ${response_lldp_receive}
    # obtain communication port for EM Switch LLDP Send as per bay, port type and port number
    \    ${vport}=    Get Port ID For EM Switch Ports    ${bay_number}    Mgmt    1
    \    ${device_id}=    Convert To String    EnclosureManagerSwitchPortsLLDPReceive/${vport}
    # validate the pem response with info obtained through EM using SSH command via rest
    \    ${ssh_resp}=    Run SSH Command Using EM    ${device_id}
    \    ${get_mac_id}=    Fetch From Right    ${ssh_resp}    "MacAddress": "
    \    ${mac_id}=    Fetch From Left    ${get_mac_id}    "
    \    Should Be Equal As Strings    ${mac_address_pem}    ${mac_id}

TC 04: PEM Em Switch Port LLDP Receive Read: Test PEM Action EM Switch Ports LLDP Receive Read For CIManager
    [Documentation]    Test Case on PEM Action EmSwitchPortsLldpReveiveRead for CIManager
    [Tags]    Automated   VLAN    DEA    API    PEM    OV3.10
    # Get PEM's token and establish session and fusion uuid
    ${auth}=    Get Trusted PEM Token
    set_header_to_pem_token    ${APPLIANCE_IP}    ${pem_cred}    ${auth}
    ${fusion_uuid}=    Check For Single Enclosure and Get UUID
    ${enc_serial_number}=    Fetch From Right    ${fusion_uuid}    000

    # get active and standby em from the enclosure
    ${em_active}=    Get EM Active Bay
    ${em_standby}=    Get EM Standby Bay
    ${em_list}=    Create List    ${em_active}    ${em_standby}
    # execute pem command EmSwitchPortsLldpReveiveRead on EM Bay list
    :FOR    ${bay_number}    IN    @{em_list}
    \    PEM Command EmSwitchPorts LLDP Receive On Ports    ${auth}    ${APPLIANCE_IP}    ${enc_serial_number}    ${bay_number}

TC 05: PEM EM Switch Port LLDP Send Read: Test PEM Action EM Switch Ports LLDP Send Read For Management Processor
    [Documentation]    Test Case on PEM Action EmSwitchPortsLldpSendRead for Management Processor
    [Tags]    Automated   VLAN    DEA    API    PEM    OV3.10
    # Get PEM's token and establish session and fusion uuid
    ${auth}=    Get Trusted PEM Token
    set_header_to_pem_token    ${APPLIANCE_IP}    ${pem_cred}    ${auth}
    ${fusion_uuid}=    Check For Single Enclosure and Get UUID
    ${enc_serial_number}=    Fetch From Right    ${fusion_uuid}    000

    # get active and standby em from the enclosure
    ${em_active}=    Get EM Active Bay
    ${em_standby}=    Get EM Standby Bay
    ${em_list}=    Create List    ${em_active}    ${em_standby}
    # execute pem command EmSwitchPortsLldpReveiveRead on EM Bay list
    :FOR    ${bay_number}    IN    @{em_list}
    \    ${response_lldp_send}=    PEM Action To Get EM Switch Port LLDP Send    ${auth}    ${APPLIANCE_IP}    ${enc_serial_number}    1    Mgmt    1
    \    Should Be Equal As Strings    ${response_lldp_send["CallStatus"]}    SUCCESS
    # read network address from pem response
    \    ${network_address_pem}=    Read Lldp Send Network Address        ${response_lldp_send}
    # obtain communication port for EM Switch LLDP Send as per bay, port type and port number
    \    ${vport}=    Get Port ID For EM Switch Ports    ${bay_number}    Mgmt    1
    \    ${device_id}=    Convert To String    EnclosureManagerSwitchPortsLLDPSend/${vport}
    # validate the pem response with info obtained through EM using SSH command via rest
    \    ${ssh_resp}=    Run SSH Command Using EM    ${device_id}
    \    ${get_nw_ip}=    Fetch From Right    ${ssh_resp}    IPv6Addresses": [ "
    \    ${nw_ip}=    Fetch From Left    ${get_nw_ip}    "
    \    Should Be Equal As Strings    ${network_address_pem}    ${nw_ip}

TC 06: PEM EM Switch Port LLDP Send Read: Test PEM Action EM Switch Ports LLDP Send Read For CIManager
    [Documentation]    Test Case on PEM Action EmSwitchPortsLldpSendRead for CIManager
    [Tags]    Automated   VLAN    DEA    API    PEM    OV3.10
    # Get PEM's token and establish session and fusion uuid
    ${auth}=    Get Trusted PEM Token
    set_header_to_pem_token    ${APPLIANCE_IP}    ${pem_cred}    ${auth}
    ${fusion_uuid}=    Check For Single Enclosure and Get UUID
    ${enc_serial_number}=    Fetch From Right    ${fusion_uuid}    000

    # get active and standby em from the enclosure
    ${em_active}=    Get EM Active Bay
    ${em_standby}=    Get EM Standby Bay
    ${em_list}=    Create List    ${em_active}    ${em_standby}
    # execute pem command EmSwitchPortsLldpReveiveRead on EM Bay list
    :FOR    ${bay_number}    IN    @{em_list}
    \    PEM Command EmSwitchPorts LLDP Send On Ports    ${auth}    ${APPLIANCE_IP}    ${enc_serial_number}    ${bay_number}

TC 07: PEM EM Switch Port Resource Get Negative: Test PEM Action EM Switch Port Resource Get On Invalid Bay And Port
    [Documentation]    Negative Test case for pem Action EmSwitchPortsResourceGet On Invalid Bay and Port
    [Tags]    Automated   VLAN    DEA    API    PEM    OV3.10
    # Get PEM's token and establish session and fusion uuid
    ${auth}=    Get Trusted PEM Token
    set_header_to_pem_token    ${APPLIANCE_IP}    ${pem_cred}    ${auth}
    ${fusion_uuid}=    Check For Single Enclosure and Get UUID
    ${enc_serial_number}=    Fetch From Right    ${fusion_uuid}    000

    # run pem action EmSwitchPortsResourceGet on bad bay number with valid ports and validate for ERROR status
    ${port_numbers}=    Create List    ${1}    ${2}
    :FOR    ${port}    IN    @{port_numbers}
    \    ${pem_response_mgmt}=    PEM Action To Get EM Switch Port Resource    ${auth}    ${APPLIANCE_IP}    ${enc_serial_number}    ${bad_bay_num}    Mgmt    ${port}
    \    Should Be Equal As Strings    ${pem_response_mgmt["CallStatus"]}    ERROR
    \    ${pem_response_cim}=    PEM Action To Get EM Switch Port Resource    ${auth}    ${APPLIANCE_IP}    ${enc_serial_number}    ${bad_bay_num}    CIManager    ${port}
    \    Should Be Equal As Strings    ${pem_response_cim["CallStatus"]}    ERROR

    # run pem action EmSwitchPortsResourceGet on valid port types with bad port number and validate for ERROR status
    ${em_active}=    Get EM Active Bay
    ${em_standby}=    Get EM Standby Bay
    ${em_list}=    Create List    ${em_active}    ${em_standby}
    :FOR    ${bay_number}    IN    @{em_list}
    \    ${pem_response_mgmt}=    PEM Action To Get EM Switch Port Resource    ${auth}    ${APPLIANCE_IP}    ${enc_serial_number}    ${bay_number}    Mgmt    ${bad_bay_num}
    \    Should Be Equal As Strings    ${pem_response_mgmt["CallStatus"]}    ERROR
    \    ${pem_response_cim}=    PEM Action To Get EM Switch Port Resource    ${auth}    ${APPLIANCE_IP}    ${enc_serial_number}    ${bay_number}    CIManager    ${bad_bay_num}
    \    Should Be Equal As Strings    ${pem_response_cim["CallStatus"]}    ERROR

TC 08: PEM EM Switch Port LLDP Receive Read Negative: Test PEM Action EM Switch Port LLDP Receive Read On Invalid Bay And Port
    [Documentation]    Negative Test case for pem Action EmSwitchPortsLldpReveiveRead On Invalid Bay and Port
    [Tags]    Automated   VLAN    DEA    API    PEM    OV3.10
    # Get PEM's token and establish session and fusion uuid
    ${auth}=    Get Trusted PEM Token
    set_header_to_pem_token    ${APPLIANCE_IP}    ${pem_cred}    ${auth}
    ${fusion_uuid}=    Check For Single Enclosure and Get UUID
    ${enc_serial_number}=    Fetch From Right    ${fusion_uuid}    000

    # run pem action EmSwitchPortsLldpReveiveRead on bad bay number with valid ports and validate for ERROR status
    ${port_numbers}=    Create List    ${1}    ${2}
    :FOR    ${port}    IN    @{port_numbers}
    \    ${pem_response_mgmt}=    PEM Action To Get EM Switch Port LLDP Receive    ${auth}    ${APPLIANCE_IP}    ${enc_serial_number}    ${bad_bay_num}    Mgmt    ${port}
    \    Should Be Equal As Strings    ${pem_response_mgmt["CallStatus"]}    ERROR
    \    ${pem_response_cim}=    PEM Action To Get EM Switch Port LLDP Receive    ${auth}    ${APPLIANCE_IP}    ${enc_serial_number}    ${bad_bay_num}    CIManager    ${port}
    \    Should Be Equal As Strings    ${pem_response_cim["CallStatus"]}    ERROR

    # run pem action EmSwitchPortsLldpReveiveRead on valid port types with bad port number and validate for ERROR status
    ${em_active}=    Get EM Active Bay
    ${em_standby}=    Get EM Standby Bay
    ${em_list}=    Create List    ${em_active}    ${em_standby}
    :FOR    ${bay_number}    IN    @{em_list}
    \    ${pem_response_mgmt}=    PEM Action To Get EM Switch Port LLDP Receive    ${auth}    ${APPLIANCE_IP}    ${enc_serial_number}    ${bay_number}    Mgmt    ${bad_bay_num}
    \    Should Be Equal As Strings    ${pem_response_mgmt["CallStatus"]}    ERROR
    \    ${pem_response_cim}=    PEM Action To Get EM Switch Port LLDP Receive    ${auth}    ${APPLIANCE_IP}    ${enc_serial_number}    ${bay_number}    CIManager    ${bad_bay_num}
    \    Should Be Equal As Strings    ${pem_response_cim["CallStatus"]}    ERROR

TC 09: PEM EM Switch Port LLDP Send Read Negative: Test PEM Action EM Switch Port LLDP Send Read On Invalid Bay And Port
    [Documentation]    Negative Test case for pem Action EmSwitchPortsLldpSendRead On Invalid Bay and Port
    [Tags]    Automated   VLAN    DEA    API    PEM    OV3.10
    # Get PEM's token and establish session and fusion uuid
    ${auth}=    Get Trusted PEM Token
    set_header_to_pem_token    ${APPLIANCE_IP}    ${pem_cred}    ${auth}
    ${fusion_uuid}=    Check For Single Enclosure and Get UUID
    ${enc_serial_number}=    Fetch From Right    ${fusion_uuid}    000

    # run pem action EmSwitchPortsLldpSendRead on bad bay number with valid ports and validate for ERROR status
    ${port_numbers}=    Create List    ${1}    ${2}
    :FOR    ${port}    IN    @{port_numbers}
    \    ${pem_response_mgmt}=    PEM Action To Get EM Switch Port LLDP Send    ${auth}    ${APPLIANCE_IP}    ${enc_serial_number}    ${bad_bay_num}    Mgmt    ${port}
    \    Should Be Equal As Strings    ${pem_response_mgmt["CallStatus"]}    ERROR
    \    ${pem_response_cim}=    PEM Action To Get EM Switch Port LLDP Send    ${auth}    ${APPLIANCE_IP}    ${enc_serial_number}    ${bad_bay_num}    CIManager    ${port}
    \    Should Be Equal As Strings    ${pem_response_cim["CallStatus"]}    ERROR

    # run pem action EmSwitchPortsLldpSendRead on valid port types with bad port number and validate for ERROR status
    ${em_active}=    Get EM Active Bay
    ${em_standby}=    Get EM Standby Bay
    ${em_list}=    Create List    ${em_active}    ${em_standby}
    :FOR    ${bay_number}    IN    @{em_list}
    \    ${pem_response_mgmt}=    PEM Action To Get EM Switch Port LLDP Send    ${auth}    ${APPLIANCE_IP}    ${enc_serial_number}    ${bay_number}    Mgmt    ${bad_bay_num}
    \    Should Be Equal As Strings    ${pem_response_mgmt["CallStatus"]}    ERROR
    \    ${pem_response_cim}=    PEM Action To Get EM Switch Port LLDP Send    ${auth}    ${APPLIANCE_IP}    ${enc_serial_number}    ${bay_number}    CIManager    ${bad_bay_num}
    \    Should Be Equal As Strings    ${pem_response_cim["CallStatus"]}    ERROR
