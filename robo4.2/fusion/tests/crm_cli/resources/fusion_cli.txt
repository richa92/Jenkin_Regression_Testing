*** Settings ***
Documentation     Fusion CLI  keywords 
...               = Usage =
...               | Library | ../resources/fusion_cli.txt |
Library           Collections
Library           String
Library           SSHLibrary
Library           RoboGalaxyLibrary            # DVTs Robot Framework extensions
Library           FusionLibrary                # DVTs Robot Framework extensions

*** Variables ***


*** Keywords ***
Login to Fusion via SSH
    [Documentation]    Connect to Fusion VM via SSH
    [Documentation]    Example:\n| Login to Fusion Via SSH | 10.0.12.106 | Administrator | hpvse123 |
    [Arguments]    ${IP}=${FUSION IP}    ${USERNAME}=${FUSION_SSH_USERNAME}    ${PASSWORD}=${FUSION_SSH_PASSWORD}
    ...            ${PROMPT}=${FUSION_PROMPT}    ${TIMEOUT}=${FUSION_TIMEOUT}
    Log Many    ${IP}    ${USERNAME}    ${PASSWORD}    ${PROMPT}    ${TIMEOUT}
    Set Default Configuration    prompt=${PROMPT}    timeout=${TIMEOUT}
    ${Id}=    Open Connection    ${IP}
    ${Output}=    Login    ${USERNAME}    ${PASSWORD}
    [Return]    ${Id}

Logout of Fusion Via SSH
    [Documentation]    Exits the current SSH session
    [Documentation]    Example:\n| Logout Of Fusion Via SSH |
    Close Connection

# -----------------------------------------------------------------------------
#		FUSION RESET
# -----------------------------------------------------------------------------
Reset Fusion Appliance to Factory Default
    [Documentation]    Return the Fusion Appliance to the factory default state
    Login to Fusion via SSH
    Set Default Configuration    timeout=900    # Some commands (below) take a long time
    @{Commands}    Create List    /ci/bin/cic-factory-reset
    ...    /ci/bin/afterFactoryReset.sh         # ~12 minutes
    ...    [ -e /var/tmp/hydrogen-switch-config/switchConfig.cfg ] && rm /var/tmp/hydrogen-switch-config/switchConfig.cfg || echo 'No file to delete'
    ...    /ci/bin/cic-run-level database       # ~1 minute
    ...    [ -d /root/scripts ] && cd /root/scripts && ./invoke_li_auth.sh || echo 'No /root/scripts folder present'
    ...    [ -d /root/dbscripts ] && cd /root/dbscripts && ./invoke_li_auth.sh || echo 'No /root/dbscripts folder present'
    ...    /ci/bin/cic-run-level normal
    :FOR    ${Command}    IN    @{Commands}
    \    ${stdout}    ${stderr}    ${rc}=    Execute Command    ${Command}    return_stderr=True    return_rc=True
    \    Log    ${stdout}
    \    Should Be Empty    ${stderr}                 msg=Error returned: ${rc} ${stderr}
    \    Should Be Equal As Integers    ${rc}    0    msg=non-zero return code ${rc}
    Logout of Fusion Via SSH
