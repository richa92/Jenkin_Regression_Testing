*** Settings ***
Documentation		Capture and Deploy Windows OS
Resource			../resource.txt
Resource			../altair_keywords.txt
Test Setup			Load Test Data  ${DataFile}
Force Tags			altair	critical  deprecated
Variables			../../../../../altair/AltairLibrary/ui/objectrepo/altair_elements_servers_page.py
Library				AltairLibrary
Variables			../../../../../altair/AltairLibrary/ui/objectrepo/altair_elements_settings_page.py
Variables			../../../../../altair/AltairLibrary/ui/objectrepo/altair_elements_os_build_plans.py
#Variables			../../../../common/PerfConstants_File.py


*** Variables ***
${init_status1}		True


*** Test Cases ***
Make a copy of the Windows Capture Image build and Set the Custom Attribute WimFileNamekey
	Log into Altair appliance as Administrator
	maximize browser window 
	Sleep	5
	altair_ui_go_to_os_build_plans_page
	Sleep	3
	: FOR	${capture}	IN	@{TestData.osbp_capture_US2250}
	\	altair_ui_select_os_build_plan_from_list	${capture.captureOs}
	\	Sleep	2
	\	altair_ui_save_os_build_plan	${capture.captureOs}		${capture.newcaptureOs}
	Sleep	2
	altair_ui_os_build_plan_add_custom_attribute		${capture.newcaptureOs}		${capture.key}		${capture.value}
	Sleep	4

Run OSBP Capture Image of the First server
	: FOR	${capture}	IN	@{TestData.osbp_capture_US2250}
	\	Altair UI Go to Servers Page
	\	${capture_serial_no} =	Altair Get Serial Number	${capture}
	\	Log		${capture_serial_no}
	\	Set Global Variable		${capture_serial_no}
	\	Log		running OS build plan on ${capture_serial_no}
	\	Altair UI Go To OS Build Plans Page
	\	Altair UI Run OS Buildplan From OS Buildplans Page		${capture.newcaptureOs}		${capture_serial_no}
	\	Sleep	10
	\	Altair UI Go to Servers Page
	\	${ilo_ip} =		Set Variable	${capture.ip}
	\	${status} =		Select Server and get job status		${ilo_ip}
	\	Run keyword and Continue on failure		Should Be Equal As Strings		${status}		True
	\	${job_status} =		Set variable if		'${status}'=='${init_status1}'	Succeeded	Failed
	\	Log		job - deployment ${job_status} for ${capture.ip}		WARN
	Altair UI Logout Appliance Console
	Close all browsers

Make a copy of the Windows Deploy Image build and Set the Custom Attribute WimFileNamekey
	Log into Altair appliance as Administrator
	maximize browser window
	Sleep	2
	altair_ui_go_to_os_build_plans_page
	Sleep	2
	: FOR	${deploy}	IN	@{TestData.osbp_deploy_US2250}
	\	altair_ui_select_os_build_plan_from_list	${deploy.deployOs}
	\	Sleep	5
	\	altair_ui_save_os_build_plan	${deploy.deployOs}		${deploy.newdeployOs}
	Sleep	4
	altair_ui_os_build_plan_add_custom_attribute		${deploy.newdeployOs}		${deploy.key}		${deploy.value}
	Sleep 	2

Deploy the captured image on the second server
	: FOR	${deploy}	IN		@{TestData.osbp_deploy_US2250}
	\	Altair UI Go to Servers Page
	\	${deploy_serial_no} =	Altair Get Serial Number	${deploy}
	\	Log		${deploy_serial_no}
	\	Set Global Variable		${deploy_serial_no}
	\	Log		running OS build plan on ${deploy_serial_no}
	\	Altair UI Go To OS Build Plans Page
	\	Altair UI Run OS Buildplan From OS Buildplans Page		${deploy.newdeployOs}		${deploy_serial_no}
	\	Sleep	10
	\	Altair UI Go to Servers Page
	\	${ilo_ip} =		Set Variable	${deploy.ip}
	\	${status} =		Select Server and get job status		${ilo_ip}
	\	Run keyword and Continue on failure		Should Be Equal As Strings		${status}	True
	\	${job_status} =		Set variable if		'${status}'=='${init_status1}'	Succeeded	Failed
	\	Log		job - deployment ${job_status} for ${deploy.ip}		WARN
	Altair UI Logout Appliance Console
	Close all browsers


*** Keywords ***
Select Server and get job status
	[Arguments]		${ilo_ip}
	[return]	${status}
	${server_dict} =	Create Dictionary
	@{server_names} =	Create List
	${server_dict} =	altair_ui_get_complete_server_list	none
	${server_names} =	Get Dictionary Values		${server_dict}
	${server_list_length} =		Get Length		${server_names}
	: FOR	${i}	IN RANGE	1	${server_list_length+1}
	\	${locator} = 	Get UI Object	${AltairServersPage.ID_TABLE_SERVER_NAME}	${i}
	\	${ser_details} =	altair_ui_get_server_details		${locator}
	\	${server_details} =		Convert To List		${ser_details}
	\	Log		${server_details}
	\	${status} =		Run Keyword if		'${ilo_ip}'=='${server_details[5]}'		Altair trace job status
	\	Run Keyword if		'${ilo_ip}'=='${server_details[5]}'		Exit For Loop
