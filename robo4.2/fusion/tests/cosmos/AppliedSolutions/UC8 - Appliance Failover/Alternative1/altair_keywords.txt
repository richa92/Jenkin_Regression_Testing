*** Settings ***
Library			OperatingSystem
Library			AltairLibrary
Variables		../../../../../../altair/AltairLibrary/ui/objectrepo/altair_elements_hp_oneview_appliances_page.py

*** Keywords ***
Altair Navigate to OneView Appliances Page
    Open Main Menu
    Wait For Element And Click    ${AltairBasePage.ID_LINK_ONEVIEW_APPLIANCES}
    Wait Until Page Contains Element    ${AltairHPOneViewAppliancePage.ID_PAGE_LABEL}
    ${CountText} =    Catenate    ${AltairBasePage.ID_PAGE_ITEM_COUNT} [text()!='']
    Wait Until Page Contains Element    ${CountText}

Altair Add OneView Appliance
    [Arguments]    ${Hostname}    ${User}    ${Password}    ${Description}
    
    ${exists} =  Altair OneView Appliance Exists    ${Hostname}
    Run Keyword If  ${exists}==True  Log     ${Hostname} exists - skipping.    WARN
    Return From Keyword If  ${exists}==True  
    
    # click the add button
    Wait For Element and Click   ${AltairHPOneViewAppliancePage.ID_BTN_MASTER_ADD}
    
    # Enter the host name and validate message
    Wait Until Page Contains Element     ${AltairHPOneViewAppliancePage.ID_INPUT_ADD_APPLIANCE_HOST_NAME}
    Click Element    ${AltairHPOneViewAppliancePage.ID_INPUT_ADD_APPLIANCE_HOST_NAME}
    Input Text  ${AltairHPOneViewAppliancePage.ID_INPUT_ADD_APPLIANCE_HOST_NAME}    ${Hostname}
    Click Element    ${AltairHPOneViewAppliancePage.ID_INPUT_ADD_APPLIANCE_USER}
    Wait For Element Text    ${AltairHPOneViewAppliancePage.ID_ADD_APPLIANCE_FORM_MESSAGE_TEXT}    Changed: Host name to "${HostName}"
    
    # Enter the user name and validate message
    Input Text    ${AltairHPOneViewAppliancePage.ID_INPUT_ADD_APPLIANCE_USER}    ${User}
    Click Element    ${AltairHPOneViewAppliancePage.ID_INPUT_ADD_APPLIANCE_PASSWORD}
    Wait For Element Text   ${AltairHPOneViewAppliancePage.ID_ADD_APPLIANCE_FORM_MESSAGE_TEXT}    Changed: User to "${User}"
    
    # Enter the password and validate message
    Input Text    ${AltairHPOneViewAppliancePage.ID_INPUT_ADD_APPLIANCE_PASSWORD}    ${Password}
    Click Element    ${AltairHPOneViewAppliancePage.ID_INPUT_ADD_APPLIANCE_DESCRIPTION}
    Wait For Element Text    ${AltairHPOneViewAppliancePage.ID_ADD_APPLIANCE_FORM_MESSAGE_TEXT}    Changed: Password
    
    # Enter the password and validate message
    Input Text    ${AltairHPOneViewAppliancePage.ID_INPUT_ADD_APPLIANCE_DESCRIPTION}    ${Description}
    Press Key    ${AltairHPOneViewAppliancePage.ID_INPUT_ADD_APPLIANCE_ADD}    \9
    Wait For Element Text    ${AltairHPOneViewAppliancePage.ID_ADD_APPLIANCE_FORM_MESSAGE_TEXT}    Changed: description to "${Description}"
    
    # confirm appliance certificate if necessary
    Click Element   ${AltairHPOneViewAppliancePage.ID_INPUT_ADD_APPLIANCE_ADD_PLUS}
    Wait For Element Text    ${AltairHPOneViewAppliancePage.ID_ADD_APPLIANCE_FORM_MESSAGE_TEXT}    Acquiring the appliance certificate. This could take a few minutes...
    Wait for Element Text To Change  ${AltairHPOneViewAppliancePage.ID_ADD_APPLIANCE_FORM_MESSAGE_TEXT}  Acquiring the appliance certificate. This could take a few minutes...
    Page Should Not Contain     Unable to add Appliance
    ${match} =  Element Text Matches  ${AltairHPOneViewAppliancePage.ID_ADD_APPLIANCE_CONFIRM_NOTIFY_MESSAGE}  The certificate associated with the appliance is not trusted
    Run Keyword If     ${match}      Click Element   ${AltairHPOneViewAppliancePage.ID_BTN_CONFIRM}
    
    # add the appliance, select, and validate
    Wait For Element Text    ${AltairHPOneViewAppliancePage.ID_ADD_APPLIANCE_FORM_MESSAGE_TEXT}    Adding the appliance...
    Wait For Element Text    ${AltairHPOneViewAppliancePage.ID_ADD_APPLIANCE_FORM_MESSAGE_TEXT}    Add completed for Appliance ${Hostname}.
    Click Element       ${AltairHPOneViewAppliancePage.ID_INPUT_ADD_APPLIANCE_CANCEL}
    Wait For Element Text   ${AltairHPOneViewAppliancePage.ID_TABLE_APPLIANCES}  ${Hostname}
    Altair Select OneView Appliance     ${Hostname}
    Element Text Should Be     ${AltairHPOneViewAppliancePage.ID_PAGE_NOTIFICATIONS_MESSAGE}    Appliance access is authorized.

Altair OneView Appliance Exists
    [Arguments]     ${Hostname}
    Log     Verifying that OneView appliance '${Hostname}' appears in the list
    ${match} =  Table Contains    ${AltairHPOneViewAppliancePage.ID_TABLE_APPLIANCES}  ${Hostname}
    Run Keyword If  ${Match}    Return From Keyword    ${True}
    Run Keyword Unless  ${Match}    Return From Keyword    ${False}

Altair Select OneView Appliance
    [Arguments]     ${Hostname}
    Table Should Contain    ${AltairHPOneViewAppliancePage.ID_TABLE_APPLIANCES}     ${Hostname}
    Click Element   ${AltairHPOneViewAppliancePage.ID_LIST_APPLIANCES}
    Wait For Element Text    ${AltairHPOneViewAppliancePage.ID_DETAILS_HEADER}  Appliance  ${Hostname}

Altair Edit OneView Appliance
    Fail    Not Implemented

Altair Delete OneView Appliance
    [Arguments]    ${Hostname}
    ${exists} =  Altair OneView Appliance Exists    ${Hostname}
    Pass Execution If  ${exists} == False    ${Hostname} already exists. Continuing execution.
    Wait For Element and Click    ${AltairHPOneViewAppliancePage.ID_MENU_ACTION_MAIN_BTN}
    Wait For Element and Click   ${AltairHPOneViewAppliancePage.ID_MENU_ACTION_DELETE}
    Wait For Element and Click   ${AltairHPOneViewAppliancePage.ID_BTN_CONFIRM}
    Wait For Element Remove     xpath=//table[@id='${AltairHPOneViewAppliancePage.ID_TABLE_APPLIANCES}']/tbody/tr//td[2][text()='${Hostname}']

Open Main Menu
    Element Should Be Visible    ${AltairBasePage.ID_MAIN_MENU_CONTROL}
    Click Element    ${AltairBasePage.ID_MAIN_MENU_CONTROL}

Get Deployment IP
	[Arguments]		${ilo_ip}
	[return]		${deployment_ip}
	Altair UI Go to Servers Page
	${server_dict} =	Create Dictionary
	@{server_names} =	Create List
	${server_dict} =	altair_ui_get_complete_server_list	none
	${server_names} =	Get Dictionary Values	${server_dict}
	#${serial_no} =		Set Variable  None
	${server_list_length} =		Get Length		${server_names}
	: FOR	${i}	IN RANGE	0	${server_list_length}
	\	${ser_details} =	altair_ui_get_server_details	${server_names[${i}]}
	\	${server_details} = 	Convert To List		${ser_details}
	\	${deployment_ip} =	Set Variable	${server_details[4]} 
	\	Run Keyword if	'${ilo_ip}'=='${server_details[5]}'		Log		${deployment_ip}
	\	Run Keyword if	'${ilo_ip}'=='${server_details[5]}'		Exit For Loop

Ping OS Deployment IP
	[arguments]		${server}	${ip}
	Load Test Data and Open Browser
	Log into Fusion appliance as Administrator
	Fusion UI Power On Server		${server}
	${output} =    Run    ping ${ip} -4 -n 1
	Should Contain	${output}	time
	Log		OS is up and the machine is pinging

Deploy OS on Server
	[Arguments]		${altairOs}		${serial_no}	${date}		${DEPLOYMENT JOB WAIT TIME IN MINUTES}
	Altair UI Go To OS Build Plans Page
	Altair UI Run OS Buildplan From OS Buildplans Page		${deploy.altairOs}		${serial_no}
	Sleep	10
  	${osbp_job_status}=		Altair UI Get Job Status		None		${deploy.altairOs}			${date}		${DEPLOYMENT JOB WAIT TIME IN MINUTES}
	Log		${osbp_job_status}
	Run Keyword and Ignore Error	Should Be Equal As Strings		${osbp_job_status}		Success
	Log		${osbp_job_status}

Altair trace job status
	[return]	${status}
	${job_time}		get text	${AltairServersPage.ID_JOB_HISTORY}
	log		${job_time}
	Mouse over		${AltairServersPage.ID_MENU_ACTION}
	wait For Element and Click		${AltairServersPage.ID_JOB_HISTORY}
	Sleep	10
	${status} =		altair ui job should succeed
	log		${status}    
    
Altair Get Serial Number
    [Arguments]     ${server_name}
	[return]	${serial_no}
	Altair UI Go to Servers Page
	${server_dict} =	Create Dictionary
	${server_names} =	Create List
	${server_dict} =  altair_ui_get_complete_server_list		none
	${server_names} = 	Get Dictionary Values 	${server_dict}
	#${serial_no} =	Set Variable	None
	${server_list_length} = 	Get Length	${server_names}
	${server_details} =	Set Variable	${server_name}
	${ilo_ip} =	Set Variable	${server_details.ip}	
	: FOR	${i}	IN RANGE	1	${server_list_length+1}
	\	${locator} =	Get UI Object	${AltairServersPage.ID_TABLE_SERVER_NAME}	${i}
	\	${ser_details} =	altair_ui_get_server_details	${locator}
	\	${server_details} = 	Convert To List		${ser_details}
	\	${serial_no} =	Set Variable	${server_details[9]} 
	\	Run Keyword if	'${ilo_ip}'=='${server_details[5]}'		Log		${serial_no}
	\	Run Keyword if	'${ilo_ip}'=='${server_details[5]}'		Set Global Variable		${serial_no}
	\	Run Keyword if	'${ilo_ip}'=='${server_details[5]}'		Exit For Loop

Get Serial Number
	[Arguments]		${server_name}
	[return]		${serial_no}
	Log into Altair Appliance as Administrator
	Altair UI Go to Servers Page
	${server_dict} =	Create Dictionary
	${server_names} =	Create List
	${server_dict} =  altair_ui_get_complete_server_list		none
	${server_names} = 	Get Dictionary Values 	${server_dict}
	#${serial_no} =	Set Variable	None
	${server_list_length} = 	Get Length	${server_names}
	${server_details} =	Set Variable	${server_name}
	${ilo_ip} =	Set Variable	${server_details.ip}	
	: FOR 	${i}	IN RANGE	1	${server_list_length+1}
	\	${locator} =	Get UI Object	${AltairServersPage.ID_TABLE_SERVER_NAME}	${i}
	\	${ser_details} =	altair_ui_get_server_details	${locator}
	\	${server_details} = 	Convert To List		${ser_details}
	\	${serial_no} =	Set Variable	${server_details[9]} 
	\	Run Keyword if	'${ilo_ip}'=='${server_details[5]}'		Log		${serial_no}
	\	Run Keyword if	'${ilo_ip}'=='${server_details[5]}'		Set Global Variable		${serial_no}
	\	Run Keyword if	'${ilo_ip}'=='${server_details[5]}'		Exit For Loop
	Altair UI Logout Appliance Console
	Close All Browsers

Login as Infrastructure Administrator
	${logindata} =  Get data by property  ${TestData.altairappliances}  name  altair
	Open Browser         ${logindata[0].AltairApplianceUrl}       ${Browser}
	Altair UI login appliance domain user   ${TestData.users[0].name}	${TestData.users[0].password}	${TestData.users[0].domainName}
	Maximize Browser Window
	Wait For Element And Click		${AltairBasePage.ID_HELP_CONTROL}
