*** Settings ***
Documentation		VM Memory Stress
Resource			../resource.txt
Test Setup			Load Test Data	${DataFile}
Library				OperatingSystem
Library				SSHLibrary
Library				Process


*** Test Cases ***
Install Meat Grinder stress tool into VM
	Run		powershell Enable-PSRemoting -Force	
	Run		powershell Set-Item wsman:\\localhost\\client\\trustedhosts * -Force
	Run		powershell Restart-Service WinRM	
	${username} =	set variable	${TestData.copy_file[0].username}
	${password} =	set Variable	${TestData.copy_file[0].password}
	: For	${hostname}		in	@{list_ip}
	\	${install} =	Set Variable	$Username = '${username}'; $Password = '${password}'; $hostname = '${hostname}'; $pass = ConvertTo-SecureString -AsPlainText $Password -Force; $Cred = New-Object System.Management.Automation.PSCredential -ArgumentList $Username,$pass; Invoke-Command -ComputerName $hostname -ScriptBlock { msiexec /i C:\\Users\\Administrator\\Desktop\\ETD_x86-64_Windows_Meatgrinder_4410.msi /qb } -credential $Cred
	\	Log	${install}
	\	${install_status} =	Run		powershell "${install}"
	\	${install_status1} =	Run		powershell "${install}"

Move Meat Grinder stress tool VM
	Run		powershell Enable-PSRemoting -Force	
	Run		powershell Set-Item wsman:\\localhost\\client\\trustedhosts * -Force
	Run		powershell Restart-Service WinRM	
	${username} =	set variable	${TestData.copy_file[0].username}
	${password} =	set Variable	${TestData.copy_file[0].password}
	: For	${hostname}		in	@{list_ip}
	\	${move} =	Set Variable	$Username = '${username}'; $Password = '${password}'; $hostname = '${hostname}'; $pass = ConvertTo-SecureString -AsPlainText $Password -Force; $Cred = New-Object System.Management.Automation.PSCredential -ArgumentList $Username,$pass; Invoke-Command -ComputerName $hostname -ScriptBlock { Move-Item C:\\Program\\" \\"Files\\ETD\\" \\"x86-64\\" \\"Windows\\" \\"Meatgrinder\\" \\"4.410 C:\\Users\\Administrator\\Desktop\\ETD -force } -credential $Cred
	\	Log	${move}
	\	${move_status} =	Run		powershell "${move}"

VM Meat Grinder Stress
	Run		powershell Enable-PSRemoting -Force	
	Run		powershell Set-Item wsman:\\localhost\\client\\trustedhosts * -Force
	Run		powershell Restart-Service WinRM	
	${username} =	set variable	${TestData.copy_file[0].username}
	${password} =	set Variable	${TestData.copy_file[0].password}
	${inipath} =	set Variable	${TestData.copy_file[1].inipath}
	: For	${ip}		in	@{list_ip}
	\	${hostname} =	set variable	\\\\${ip}
	\	${run} =	Set Variable	$Username = '${username}'; $Password = '${password}'; $hostname = '${hostname}'; C:\\PsExec.exe -accepteula $hostname -u $Username -p $Password powershell -command 'C:\\Users\\Administrator\\Desktop\\ETD\\etdntmg.exe' -start -ini=${inipath}
	\	Log	${run}
	\	${run_status} =	Run		powershell ${run}
