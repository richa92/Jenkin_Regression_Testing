*** Settings ***
Documentation	Live migration of VM's from one node to another node
Resource		../resource.txt
Test Setup		Load Test Data  ${DataFile}
Library			OperatingSystem


*** Test Cases ***
Capture deployment IP2 of server
	Log into Altair Appliance as Administrator
	${server_data} =	Set Variable	${Testdata.test_server[1]}
	${ilo_ip} =		Set Variable	${server_data.ip}
	${dep_ip2}=	Get Deployment IP		${ilo_ip}
	Log		${dep_ip2}
	set global variable		${dep_ip2}

HyperV Live Migration of VM
	Run		powershell Enable-PSRemoting -Force
	${clusterip} =	Set Variable	${TestData.clusterNode[0].clusterip}
	${domainusername} =	Set Variable	${TestData.clusterNode[0].domainusername}
	${domainpassword} =	Set Variable	${TestData.clusterNode[0].domainpassword}
	${dnsname} =	Set Variable	${TestData.clusterNode[0].dnsname}
	#To get Hostname
	${hostname} =	Run		powershell $Username = '${domainusername}'; $Password ='${domainpassword}'; Set-Item -force wsman:\\localhost\\client\\trustedhosts *; Restart-Service WinRM; $pass = ConvertTo-SecureString -AsPlainText $Password -Force; $Cred = New-Object System.Management.Automation.PSCredential -ArgumentList $Username,$pass; Invoke-Command -ComputerName '${dep_ip2}' -ScriptBlock { hostname } -credential $Cred
	: FOR	${virtualname}	In	@{TestData.virtual}
	\	#Live Migration
	\	Run	powershell $Username = '${domainusername}'; $Password = '${domainpassword}'; Set-Item -force wsman:\\localhost\\client\\trustedhosts *; Restart-Service WinRM; $pass = ConvertTo-SecureString -AsPlainText $Password -Force; $Cred = New-Object System.Management.Automation.PSCredential -ArgumentList $Username,$pass; Invoke-Command -ComputerName ${clusterip} -ScriptBlock { Move-ClusterVirtualMachineRole ${virtualname.vmname} -Node ${hostname}.${dnsname} } -credential $Cred
