*** Settings ***
Library           RoboGalaxyLibrary
Library           BuiltIn

*** Keywords ***

Set Metadata
    Set Suite Metadata     DataFile    ${DataFile}
    ${user}=    Get Data By Property    ${TestData.users}    name    Administrator
    ${IP}=      Fetch From Right    ${ApplianceUrl}    /
    Set Fusion Version Metadata    ${IP}    ${user[0].name}    ${user[0].password}
    Set OS Version Metadata

Set Fusion Version Metadata
    [Documentation]    Get the version ident string from Fusion
    [Arguments]    ${IP}    ${USERNAME}    ${PASSWORD}
    Login to Fusion via REST    ${IP}    ${USERNAME}    ${PASSWORD}
    ${Response}=    Fusion Api Get Appliance Version
    Logout of Fusion Via REST
    Log    ${Response}
    ${softwareVersion}=    Get from Dictionary    ${Response}    softwareVersion
    ${date}=               Get from Dictionary    ${Response}    date
    Set Suite Metadata     Fusion Version    ${softwareVersion} : ${date}    top=True

Login to Fusion Via REST
    [Documentation]    Connects to the Appliance and creates a session using the Username and Password.
    ...   Example:\n| Login to Fusion Via REST | 10.0.12.106 | Administrator | hpvse123 |
    [Arguments]    ${IP}    ${USERNAME}    ${PASSWORD}
    ${admin_credentials} =      Create Dictionary   userName=${USERNAME}
    ...                                             password=${PASSWORD}
    ${Response}    ${SessionId}    Fusion Api Login Appliance    ${IP}    ${admin_credentials}
    ${Status}    Get From Dictionary    ${Response}    status_code
    Return From Keyword If    '${Status}' == '200'    ${Response}
    ${errorCode}    Get From Dictionary    ${Response}    errorCode
    ${message}      Get From Dictionary    ${Response}    message
    Fatal Error    msg=Invalid response returned ${Status} ${errorCode} ${message}

Logout of Fusion Via REST
    [Documentation]    Terminates a session with the REST API.
    ...    Example:\n| Logout Of Fusion Via REST |
    Fusion Api Logout Appliance

Load Test Data and Open Browser
    Set Log Level    TRACE
	Load Test Data  ${DataFile}
	Open And Configure Browser

Logout and close all browsers
	Fusion UI logout of appliance
	Close all browsers

Log into Fusion appliance as Administrator
	${user} =  Get data by property  ${TestData.users}  name  Administrator
	Fusion UI login to appliance   ${user[0].name}

Log out of Fusion appliance
	Fusion UI logout of appliance

Log into Appliance By Name
	[Arguments]    ${Username}
	${user} =  Get data by property  ${TestData.users}  name  ${Username}
	Fusion UI login to appliance   ${user[0].name}

Initialize, Load Test Data, Open Broswer
    Set Log Level    TRACE
    Log Variables
    Load Test Data    ${DataFile}
    Open and Configure Browser

Open And Configure Browser
    Open Browser    ${ApplianceUrl}    ${Browser}
    Maximize Browser Window
    Run Keyword If  "${Browser}" == "IE"   Go To  javascript:document.getElementById('overridelink').click()
    Set Selenium Speed    ${SeleniumSpeed}
    #Set Browser Version Metadata

Open Fusion Main Menu
    Element Should Be Visible    ${FusionBasePage.ID_MAIN_MENU_CONTROL}
    Click Element    ${FusionBasePage.ID_MAIN_MENU_CONTROL}
	wait for element visible    ${FusionBasePage.ID_MENU_LINK_ACTIVITY}

Open Browser for Email Verification
	Open Browser    ${EmailUrl}    ${Browser}
    Maximize Browser Window
    Run Keyword If  "${Browser}" == "IE"   Go To  javascript:document.getElementById('overridelink').click()
    Set Selenium Speed    ${SeleniumSpeed}
    Set Browser Version Metadata

check mailbox for email
	[Arguments]		${mail_details}
	[return]		${status}
	Open Browser for Email Verification
	Maximize Browser Window
	Log		${mail_details}
	Wait Until Page Contains Element    id=username
	Input Text	id=username		${mail_details.name}
	Input Text	id=password		${mail_details.password}
	Click Element	//input[@value='Sign in']

	Wait For Element	id=aLogOff	20
	${expected_mail_subject} =	Catenate	${mail_details.subject}		${mail_details.resource}	-	${mail_details.alert}
	Log		${expected_mail_subject}
	${subject_link} =	Set Variable	//div[@id='vr' and div[@id='divSubject' and text()='${expected_mail_subject}']]
	${status} =		Wait For Element and Click    ${subject_link}

Send Trap
    [Arguments]    @{trap_details}
    [return]       ${status}
    : FOR   ${trap}   IN    @{trap_details}
    \   ${command} =    Set Variable    ${trap.toolpath} -d ${trap.destnation_ip} -c public -o 1.3.6.1.4.1.232 -i ${trap.source_ip} -g 6 -s ${trap.trap_id} -t 12445
    \   Log    ${command}
    \	${return_code} =    Run And Return Rc    ${command}
    \   ${status} =    Set Variable if    ${return_code}==0    True    False