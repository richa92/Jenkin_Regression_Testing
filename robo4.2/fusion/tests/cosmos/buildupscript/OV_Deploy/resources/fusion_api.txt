*** Settings ***
Documentation     Fusion Rest API keywords
...               = Usage =
...               | Library | ../resources/fusion_api.txt |

Library           Collections
Library           String
Library           RoboGalaxyLibrary            # DVTs Robot Framework extensions
Library           FusionLibrary                # DVTs Robot Framework extensions


*** Keywords ***
Login to Fusion Via REST
    [Documentation]    Connects to the Appliance and creates a session using Username and Password.
    ...                Example:\n| Login to Fusion Via REST | 10.0.12.106 | Administrator | hpvse123 |
    [Arguments]    ${IP}=${FUSION_IP}    ${USERNAME}=${FUSION_USERNAME}    ${PASSWORD}=${FUSION_PASSWORD}
    Should Not Be Equal    ${IP}    'unknown'    msg=Please specify a valid Fusion IP address or hostname
    ${Creds}    Create Dictionary    userName    ${USERNAME}    password    ${PASSWORD}
    ${Response}    ${SessionID}=    Fusion Api Login Appliance    ${IP}    ${Creds}
    ${Status}    Get From Dictionary    ${Response}    status_code
    Return From Keyword If    '${Status}' == '200'    ${Response}    ${SessionID}
    ${errorCode}    Get From Dictionary    ${Response}    errorCode
    ${message}      Get From Dictionary    ${Response}    message
    Fail    msg=Invalid response returned ${Status} ${errorCode} ${message}

Logout of Fusion Via REST
    [Documentation]    Terminates a session with the REST API.
    ...                Example:\n| Logout Of Fusion Via REST |
    Fusion Api Logout Appliance

Set Fusion Version Metadata
    [Documentation]    Get the version ident string from Fusion
    [Arguments]    ${IP}    ${USERNAME}    ${PASSWORD}
    Login to Fusion via REST    ${IP}    ${USERNAME}    ${PASSWORD}
    ${Response}=    Fusion Api Get Appliance Version
    Logout of Fusion Via REST
    Log    ${Response}
    ${softwareVersion}=    Get from Dictionary    ${Response}    softwareVersion
    ${date}=               Get from Dictionary    ${Response}    date
    Set Suite Metadata     Fusion Version    ${softwareVersion} : ${date}    top=True

Create And Download Support Dump
    [Documentation]    Create and retrieve a support dump from the current running Fusion image
    [Arguments]    ${file}=fusion_dump.sdmp
    Set Log Level     TRACE
    ${body}=    Create Dictionary                   encrypt=${false}    errorCode=CI
    ${resp}=    Fusion Api Create Support Dump      ${body}
    ${uri}=     Get From Dictionary                 ${resp}             uri
    ${resp}=    Fusion Api Download Support Dump    uri=${uri}          localfile=${file}
