*** Settings ***
Documentation   SBAC tests for Hypervisor Host Profile
Library         FusionLibrary
Library         RoboGalaxyLibrary
Library         OperatingSystem
Library         BuiltIn
Library         Collections
Library         XML
Library         String
Library         json
Library         Process

Resource                        ../../../Resources/api/fusion_api_resource.txt
Resource                        ../support_files/clrm_common.txt
Variables                       ../data_variables_files/OVF204_OVF205_OVF206_SBAC_data_variables.py
Suite Setup                     Setup environment
#Suite Teardown                  Teardown environment

Test Template         Hypervisor Host Profile SBAC Operations

*** Variables ***

${Appliance_IP}    15.212.173.4

*** Test Cases ***              Role                                    Scope               Operation       Status          errorCode   Data_for_HHP                Data_for_HHP_update
OVTC75232                       Infrastructure administrator            None                Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75233                       Infrastructure administrator            None                Update          True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75234                       Infrastructure administrator            Scope1              Get             True            ${CFS}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75235                       Infrastructure administrator            Scope1              Update          False           ${CFS}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75236                       Read only                               None                Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75237                       Read only                               None                Update          False           ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75238                       Read only                               Scope1              Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75239                       Read only                               Scope1              Update          False           ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75240                       Backup administrator                    None                Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75241                       Backup administrator                    None                Update          False           ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75242                       Backup administrator                    Scope1              Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75243                       Backup administrator                    Scope1              Update          False           ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75244                       Network administrator                   None                Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75245                       Network administrator                   None                Update          False           ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75246                       Network administrator                   Scope1              Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75247                       Network administrator                   Scope1              Update          False           ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75248                       Scope administrator                     None                Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75249                       Scope administrator                     None                Update          False           ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75250                       Scope administrator                     Scope1              Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75251                       Scope administrator                     Scope1              Update          False           ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75252                       Scope operator                          None                Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75253                       Scope operator                          None                Update          False           ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75254                       Scope operator                          Scope1              Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75255                       Scope operator                          Scope1              Update          False           ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75256                       Server administrator                    None                Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75257                       Server administrator                    None                Update          True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75258                       Server administrator                    Scope1              Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75259                       Server administrator                    Scope1              Update          False           ${CFS}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75260                       Server firmware operator                None                Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75261                       Server firmware operator                None                Update          False           ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75262                       Server firmware operator                Scope1              Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75263                       Server firmware operator                Scope1              Update          False           ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75264                       Server profile administrator            None                Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75265                       Server profile administrator            None                Update          True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75266                       Server profile administrator            Scope1              Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75267                       Server profile administrator            Scope1              Update          False           ${CFS}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75268                       Server profile architect                None                Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75269                       Server profile architect                None                Update          True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75270                       Server profile architect                Scope1              Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75271                       Server profile architect                Scope1              Update          False           ${CFS}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75272                       Server profile operator                 None                Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75273                       Server profile operator                 None                Update          False           ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75274                       Server profile operator                 Scope1              Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75275                       Server profile operator                 Scope1              Update          False           ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75276                       Software administrator                  None                Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75277                       Software administrator                  None                Update          False           ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75278                       Software administrator                  Scope1              Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75279                       Software administrator                  Scope1              Update          False           ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75280                       Storage administrator                   None                Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75281                       Storage administrator                   None                Update          False           ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75282                       Storage administrator                   Scope1              Get             True            ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}
OVTC75283                       Storage administrator                   Scope1              Update          False           ${AFR}      ${SBAC_HHP_Cluster}         ${SBAC_HHP_Cluster_Update}


*** Keywords ***
Hypervisor Host Profile SBAC Operations
    [Documentation]     Hypervisor Host Profile SBAC Operations
    [Arguments]    ${Role}  ${Scope}    ${Operation}    ${Status}   ${errorCode}    ${Data_for_HHP} ${Data_for_HHP_update}
    Fusion Api Login Appliance      ${Appliance_IP}     ${admin_credentials}
    ${body}     Build body for user update  ${Role}     ${Scope}        ${User1_credentials['userName']}
    ${result}   ${task}=    Update Users    ${body}
    Fusion Api Logout Appliance
    Log to console      Test SBAC for user with role : ${Role} and scope : ${Scope}
    Run Keyword If      '${Operation}' == 'Get'         HHP Get     ${Data_for_HHP}     ${Status}   ${errorCode}
    ...     ELSE IF     '${Operation}' == 'Update'      HHP Update  ${Data_for_HHP_update}  ${Status}   ${errorCode}
    ...     ELSE        Log to console      "Operation is not specified"

HHP Get
    [Documentation]     GET hypervisor-host-profile
    [Arguments]     ${data} ${status}   ${errorCode}
    Fusion Api Login Appliance      ${Appliance_IP}     ${User1_credentials}
    ${cp}=      Get Cluster Profile     ${data[0]['name']}
    ${hpUris}   Set variable    ${cp[0]['hypervisorHostProfileUris']}
    :FOR    ${hp}   in  @{hpUris}
    \   ${s}=   Get Host Profile by Uri     ${hp}
    \   Run keyword if  '${s['status']}' != 'OK'    Run keyword if  '${s['status']}' != 'Warning'    FAIL   SBAC for HHP GET Failed for '${User1_credentials['userName']}'
    Log to Console and log file     SBAC for HHP GET is successful for '${User1_credentials['userName']}'
    Fusion Api Logout Appliance

HHP Update
    [Documentation]     PUT on hypervisor-host-profile
    [Arguments]     ${data}         ${status}   ${errorCode}
    Sleep   2 seconds
    Fusion Api Login Appliance      ${Appliance_IP}     ${User1_credentials}
    ${errorCode_status}     Set variable    True
    ${resp}=    Update host profile     ${data}
    Log to console  ${resp}
    ${length} =  Get Length  ${resp}
    ${errorCode_status} Run Keyword If  ${length} != 0  Run keyword if  ${resp[0]['status']} != ${status}   Set variable    False
    ${compare_status}   Run Keyword If  ${length} != 0  Run keyword if  ${resp[0]['status']} != ${status}   Compare Error Code Message  ${errorCode}    ${resp[0]['rest_resp']['errorCode']}
    Run Keyword If  ${length} != 0  Run keyword if  ${errorCode_status} == False and ${compare_status} == False     FAIL    HHP Update failed for ${User1_credentials['userName']}:(${resp[0]['rest_resp']['errorCode']}, ${resp[0]['rest_resp']['status_code']}) and it was expected to fail with ${errorCode} error code
    Run Keyword If  ${length} != 0  Run keyword if  ${errorCode_status} == False    FAIL    HHP Update failed for ${User1_credentials['userName']}:(${resp[0]['rest_resp']['errorCode']}, ${resp[0]['rest_resp']['status_code']})
    Log to Console and log file     SBAC for HHP Update is successful for '${User1_credentials['userName']}'
    Fusion Api Logout Appliance

Setup Environment
    [Documentation]     Setup Environment for Hypervisor Cluster Profile SBAC tests
    Fusion Api Login Appliance  ${Appliance_IP}     ${admin_credentials}
    Add Users from variable     ${users}
    :FOR    ${scope}    in  @{scopes}
    \   ${resp} =   Fusion Api Create Scope     ${scope}
    \   Run Keyword If  '${resp['status_code']}' != '202'   Fail    ${resp}    ELSE  log to console  \n-${scope['name']} : Scope Created successfully!
    Add Ethernet Networks from variable     ${ethernet_networks}
    Add LIG from variable       ${ligs}
    Add Enclosure Group from variable       ${enc_groups}
    Add Enclosures from variable        ${enclosures}
    Add Non Existing Server Profile Templates           ${server_profile_templates}
    Create ID Pools IPV4 Subnet         ${ipv4_subnet}
    :FOR    ${sub_assc} in  @{subnet_association}
    \   Edit network        ${sub_assc}
    ${result}   Add Hypervisor Manager  ${SBAC_HM_1}
    Run keyword if  '${result[0]['status']}' != 'True'  Run keyword if  '${result[0]['task_status']}' != 'True'     FAIL    Hypervisor Manager registration failed
    Add Deployment Manager  ${deployment_managers}  False
    Add Cluster Profile     ${SBAC_HHP_Cluster}
    Fusion Api Logout Appliance

Teardown environment
    [Documentation]     Teardown Environment for Hypervisor Cluster Profile SBAC tests
    Fusion Api Login Appliance  ${Appliance_IP}     ${admin_credentials}
    Remove All Users
    Fusion Api Logout Appliance
