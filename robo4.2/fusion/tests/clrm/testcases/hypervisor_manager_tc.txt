*** Settings ***
Library			FusionLibrary
Library			RoboGalaxyLibrary
Library			OperatingSystem
Library			BuiltIn
Library			Collections
Library			XML
Library			String
Library			json
Library			Process

Library 		    			../support_files/clrm_support_functions.py
Resource						../../../Resources/api/fusion_api_resource.txt
Variables 		    			../data_variables_files/data_variables.py


*** Variables ***

${Appliance}		15.212.173.20

*** Test Cases ***

vCenter_1
	${response}		${session_id}=			Fusion Api Login Appliance		${Appliance} 		${admin_credentials}
	${validation}=	Convert to boolean	true
	Create vcenter	${vcenter}		${validation}
	Fusion Api Logout Appliance

vCenter_8
	${response}		${session_id}=			Fusion Api Login Appliance		${Appliance} 		${admin_credentials}
	:FOR	${hm}	IN	@{vcenter}
	\	${resp}=	Get Hypervisor Manager	 ${hm['name']}
	\	Log to Console	hypervisor_managers:${resp}
	Fusion Api Logout Appliance

vCenter_18
	${response}		${session_id}=			Fusion Api Login Appliance		${Appliance} 		${admin_credentials}
	${validation}=	Convert to boolean	true
	Update vcenter		${update_vcenter}	${validation}
	Fusion Api Logout Appliance

vCenter_15
	${response}		${session_id}=			Fusion Api Login Appliance		${Appliance} 		${admin_credentials}
	Delete vcenter	${vcenter}
	Fusion Api Logout Appliance

**** Keywords ****
Create vcenter
	[Arguments]		${vcenter}		${valid}	${isNegative}=False		${msg}=${EMPTY}
	${valid}=	Set variable if	${isNegative}==True	False	${valid}
	${resp}=	Add Hypervisor Manager		${vcenter}		${valid}
	${name}		Set variable	${vcenter[0]['name']}
	${message}=		Set variable if	'${msg}'!='${EMPTY}'	${msg}
	...				'${msg}'=='${EMPTY}' and ${isNegative}==True	Successful Hypervisor Manager creation
	...				'${msg}'=='${EMPTY}' and ${isNegative}==False	Failed to create Hypervisor Manager ${name}
	Run keyword if	${resp[0]['status']}==False			Response error Message	${resp}
	Run keyword if	${resp[0]['task_status']}==False	Task Error Message	${resp}
	run keyword if	${isNegative}==False	run keywords
	...		Run keyword if	${resp[0]['status']}==False			Delete Hypervisor Manager	 ${name}	AND
	...		Run keyword if	${resp[0]['status']}==False			FAIL	${message}	AND
	...		Run keyword if	${resp[0]['task_status']}==False	Delete Hypervisor Manager	 ${name}	AND
	...		Run keyword if	${resp[0]['task_status']}==False	FAIL	${message}
	...		Run keyword if	${resp[0]['validation_status']}==False			Delete Hypervisor Manager	 ${name}	AND
	...		Run keyword if	${resp[0]['validation_status']}==False			FAIL	Validation Failed for create vcenter:${name}
	run keyword if	${isNegative}==True		run keywords
	...		Run keyword if	${resp[0]['status']}==False			return from keyword		AND
	...		Run keyword if	${resp[0]['task_status']}==False			return from keyword		AND
	...		Run keyword if	${resp[0]['status']}==True and ${resp[0]['task_status']}==True		Delete Hypervisor Manager	 ${name}	AND
	...		Run keyword if	${resp[0]['status']}==True and ${resp[0]['task_status']}==True		FAIL	Negative Test: ${message}

Update vcenter
	[Arguments]		${vcenter}		${valid}		${isNegative}=False		${msg}=${EMPTY}
	${valid}=	Set variable if	${isNegative}==True	False	${valid}
	${name}=	Update cluster name		${vcenter}
	${message}=		Set variable if	'${msg}'!='${EMPTY}'	${msg}
	...				'${msg}'=='${EMPTY}' and ${isNegative}==True	Successful Hypervisor Manager Update
	...				'${msg}'=='${EMPTY}' and ${isNegative}==False		Failed to Update Hypervisor Manager ${name}
	${resp}=	Update Hypervisor Manager		${vcenter}		${valid}
	Run keyword if	${resp[0]['status']}==False			Response error Message	${resp}
	Run keyword if	${resp[0]['task_status']}==False	Task Error Message	${resp}
	run keyword if	${isNegative}==False	run keywords
	...		Run keyword if	${resp[0]['status']}==False			Delete Hypervisor Manager	 ${name}	AND
	...		Run keyword if	${resp[0]['status']}==False			FAIL	${message}	AND
	...		Run keyword if	${resp[0]['task_status']}==False	Delete Hypervisor Manager	 ${name}	AND
	...		Run keyword if	${resp[0]['task_status']}==False	FAIL	${message}
	...		Run keyword if	${resp[0]['validation_status']}==False			Delete Hypervisor Manager	 ${name}	AND
	...		Run keyword if	${resp[0]['validation_status']}==False			FAIL	Validation Failed for update Hypervisor Manager:${name}
	run keyword if	${isNegative}==True		run keywords
	...		Run keyword if	${resp[0]['status']}==False	 return from keyword	AND
	...		Run keyword if	${resp[0]['task_status']}==False	return from keyword		AND
	...		Run keyword if	${resp[0]['status']}==True and ${resp[0]['task_status']}==True		Delete Hypervisor Manager	 ${name}	AND
	...		Run keyword if	${resp[0]['status']}==True and ${resp[0]['task_status']}==True		FAIL	Negative Test: ${message}

Delete vcenter 
	[Arguments]		${vcenter}	${force}=False		${isNegative}=False		${msg}=${EMPTY}
	${name}=	Update cluster name		${vcenter}
	${message}=		Set variable if	'${msg}'!='${EMPTY}'	${msg}
	...				'${msg}'=='${EMPTY}' and ${isNegative}==True	Successful Hypervisor Manager deletion
	...				'${msg}'=='${EMPTY}' and ${isNegative}==False	Failed to Delete Hypervisor Manager ${name}
	${resp}=	Delete Hypervisor Manager		${name}
	run keyword if	${isNegative}==False	run keywords
	...		Run keyword if	${resp[0]['status']}==False			Response error Message	${resp}		AND
	...		Run keyword if	${resp[0]['status']}==False			FAIL	${message}	AND
	...		Run keyword if	${resp[0]['task_status']}==False	Task Error Message	${resp}	AND
	...		Run keyword if	${resp[0]['task_status']}==False	FAIL	${message}
	run keyword if	${isNegative}==True		run keywords
	...		Run keyword if	${resp[0]['status']}==False			Response error Message	${resp}		AND
	...		Run keyword if	${resp[0]['status']}==False		Return from keyword		Failed to Delete Hypervisor Manager		AND
	...		Run keyword if	${resp[0]['status']}==False			Response error Message	${resp}		AND	
	...		Run keyword if	${resp[0]['task_status']}==False	Return from keyword 	Failed to Delete Hypervisor Manager		AND
	...		run keyword if	${isNegative}==True and ${resp[0]['status']}==True and ${resp[0]['task_status']}==True			FAIL	Negative Test: ${message}

Update cluster name
	[Arguments]		${cluster}
	${newName_status}=	Run keyword and return status	Dictionary should contain key	${cluster[0]}	new_name
	return from keyword if	${newName_status}== True	${cluster[0]['new_name']}
	return from keyword if	${newName_status}== False	${cluster[0]['name']}
	
Task Error Message
	[Arguments]		${resp}
	:FOR	${error}	in	@{resp[0]['task_resp']['taskErrors']}
	\	Exit for loop if	${resp[0]['task_status']}==True
	\	Log to logfile		\n ERROR:\t${error['message']}	WARN
	#\	Log to console and logfile		\n ERROR:\t${error['message']}	WARN

Response error Message
	[Arguments]	${resp}
	:FOR	${err}	in	@{resp}
	\	Exit for loop if	${resp[0]['status']}==True
	\	${msg_status}=	Run keyword and return status	Dictionary should contain key	${err['rest_resp']}		message
	#\	Run keyword if	${msg_status}==True	Log to console and logfile	\n ERROR:\t${err['rest_resp']['message']}	WARN
	\	Run keyword if	${msg_status}==True	Log to logfile	\n ERROR:\t${err['rest_resp']['message']}	WARN
