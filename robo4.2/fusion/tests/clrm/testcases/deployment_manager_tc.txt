*** Settings ***
Library			FusionLibrary
Library			RoboGalaxyLibrary
Library			OperatingSystem
Library			BuiltIn
Library			Collections
Library			XML
Library			String
Library			json
Library			Process

Library 		    			../support_files/clrm_support_functions.py
Resource						../../../Resources/api/fusion_api_resource.txt
Variables 		    			../data_variables_files/data_variables.py


*** Variables ***

${Appliance}		15.212.173.20


*** Test Cases ***

ICSPAltair_1
	[Documentation]	Register an ICSPAltair by specifying its parameters (restdeployment-managers)
	[Tags]	I305_F319	Positive
	${response}		${session_id}=			Fusion Api Login Appliance		${Appliance} 		${admin_credentials}
	${validation}=	Convert to boolean	true
	Create deployment manager		${deployment_managers}		${validation}
	:FOR	${dm}	IN	@{deployment_managers}
	\	${get_dm}=	Get Deployment Manager	 ${dm['name']}
	Fusion Api Logout Appliance

Update DeploymentManager
	${response}		${session_id}=			Fusion Api Login Appliance		${Appliance} 		${admin_credentials}
	${validation}=	Convert to boolean	true
	Put deployment manager	${update_deployment_managers}	${validation}
	:FOR	${dm}	IN	@{deployment_managers}
	\	${get_dm}=	Get Deployment Manager	 ${dm['name']}
	Log to console	DM:${get_dm}
	Fusion Api Logout Appliance

ICSPAltair_6
	[Documentation]	Retrieve particular deployment-manager by its deploment-manager id/name
	[Tags]	I305_F319		Positive
	${response}		${session_id}=			Fusion Api Login Appliance		${Appliance} 		${admin_credentials}
	:FOR	${dm}	IN	@{deployment_managers}
	\	${resp}=	Get Deployment Manager	 ${dm['name']}
	Log to Console	get_dm:${resp}
	Fusion Api Logout Appliance

ICSPAltair_12
	[Documentation]	Delete a deployment-manager from deployment-manager list by Passing its id/name
	[Tags]	I305_F319		Positive	Sanity
	${response}		${session_id}=			Fusion Api Login Appliance		${Appliance} 		${admin_credentials}
	Remove deployment manager	 ${deployment_managers}
	Fusion Api Logout Appliance


**** Keywords ****
Create deployment manager
	[Arguments]		${dm}		${valid}	${isNegative}=False		${msg}=${EMPTY}
	${valid}=	Set variable if	${isNegative}==True	False	${valid}
	${resp}=	Add Deployment Manager		${dm}		${valid}
	${name}		Set variable	${dm[0]['name']}
	${message}=		Set variable if	'${msg}'!='${EMPTY}'	${msg}
	...				'${msg}'=='${EMPTY}' and ${isNegative}==True	Successful Deployment Manager creation
	...				'${msg}'=='${EMPTY}' and ${isNegative}==False	Failed to create Deployment Manager ${name}
	Run keyword if	${resp[0]['status']}==False			Response error Message	${resp}
	Run keyword if	${resp[0]['task_status']}==False	Task Error Message	${resp}
	run keyword if	${isNegative}==False	run keywords
	...		Run keyword if	${resp[0]['status']}==False			Delete Deployment Manager	 ${name}	AND
	...		Run keyword if	${resp[0]['status']}==False			FAIL	${message}	AND
	...		Run keyword if	${resp[0]['task_status']}==False	Delete Deployment Manager	 ${name}	AND
	...		Run keyword if	${resp[0]['task_status']}==False	FAIL	${message}
	...		Run keyword if	${resp[0]['validation_status']}==False			Delete Deployment Manager	 ${name}	AND
	...		Run keyword if	${resp[0]['validation_status']}==False			FAIL	Validation Failed for create deployment manager:${name}
	run keyword if	${isNegative}==True		run keywords
	...		Run keyword if	${resp[0]['status']}==False			return from keyword		AND
	...		Run keyword if	${resp[0]['task_status']}==False		return from keyword		AND
	...		Run keyword if	${resp[0]['status']}==True and ${resp[0]['task_status']}==True		Delete Deployment Manager	 ${name}	AND
	...		Run keyword if	${resp[0]['status']}==True and ${resp[0]['task_status']}==True		FAIL	Negative Test: ${message}

Put deployment manager
	[Arguments]		${dm}		${valid}		${isNegative}=False		${msg}=${EMPTY}
	${valid}=	Set variable if	${isNegative}==True	False	${valid}
	${name}=	Update cluster name		${dm}
	${message}=		Set variable if	'${msg}'!='${EMPTY}'	${msg}
	...				'${msg}'=='${EMPTY}' and ${isNegative}==True	Successful Deployment Manager Update
	...				'${msg}'=='${EMPTY}' and ${isNegative}==False		Failed to Update Deployment Manager ${name}
	${resp}=	Update Deployment Manager		${dm}		${valid}
	Run keyword if	${resp[0]['status']}==False			Response error Message	${resp}
	Run keyword if	${resp[0]['task_status']}==False	Task Error Message	${resp}
	run keyword if	${isNegative}==False	run keywords
	...		Run keyword if	${resp[0]['status']}==False			Delete Deployment Manager	 ${name}	AND
	...		Run keyword if	${resp[0]['status']}==False			FAIL	${message}	AND
	...		Run keyword if	${resp[0]['task_status']}==False	Delete Deployment Manager	 ${name}	AND
	...		Run keyword if	${resp[0]['task_status']}==False	FAIL	${message}
	...		Run keyword if	${resp[0]['validation_status']}==False			Delete Deployment Manager	 ${name}	AND
	...		Run keyword if	${resp[0]['validation_status']}==False			FAIL	Validation Failed for update Deployment Manager:${name}
	run keyword if	${isNegative}==True		run keywords
	...		Run keyword if	${resp[0]['status']}==False	 return from keyword	AND
	...		Run keyword if	${resp[0]['task_status']}==False	return from keyword		AND
	...		Run keyword if	${resp[0]['status']}==True and ${resp[0]['task_status']}==True		Delete Deployment Manager	 ${name}	AND
	...		Run keyword if	${resp[0]['status']}==True and ${resp[0]['task_status']}==True		FAIL	Negative Test: ${message}

Remove deployment manager 
	[Arguments]		${deployment_managers}	${force}=False		${isNegative}=False		${msg}=${EMPTY}
	${name}=	Update cluster name		${deployment_managers}
	${message}=		Set variable if	'${msg}'!='${EMPTY}'	${msg}
	...				'${msg}'=='${EMPTY}' and ${isNegative}==True	Successful Hypervisor Manager deletion
	...				'${msg}'=='${EMPTY}' and ${isNegative}==False	Failed to Delete Hypervisor Manager ${name}
	${resp}=	Delete Deployment Manager		${name}
	run keyword if	${isNegative}==False	run keywords
	...		Run keyword if	${resp[0]['status']}==False			Response error Message	${resp}		AND
	...		Run keyword if	${resp[0]['status']}==False			FAIL	${message}	AND
	...		Run keyword if	${resp[0]['task_status']}==False	Task Error Message	${resp}	AND
	...		Run keyword if	${resp[0]['task_status']}==False	FAIL	${message}
	run keyword if	${isNegative}==True		run keywords
	...		Run keyword if	${resp[0]['status']}==False			Response error Message	${resp}		AND
	...		Run keyword if	${resp[0]['status']}==False		Return from keyword		Failed to Delete Deployment Manager		AND
	...		Run keyword if	${resp[0]['status']}==False			Response error Message	${resp}		AND	
	...		Run keyword if	${resp[0]['task_status']}==False	Return from keyword 	Failed to Delete Deployment Manager		AND
	...		run keyword if	${isNegative}==True and ${resp[0]['status']}==True and ${resp[0]['task_status']}==True			FAIL	Negative Test: ${message}

Update cluster name
	[Arguments]		${cluster}
	${newName_status}=	Run keyword and return status	Dictionary should contain key	${cluster[0]}	new_name
	return from keyword if	${newName_status}== True	${cluster[0]['new_name']}
	return from keyword if	${newName_status}== False	${cluster[0]['name']}

Task Error Message
	[Arguments]		${resp}
	:FOR	${error}	in	@{resp[0]['task_resp']['taskErrors']}
	\	Exit for loop if	${resp[0]['task_status']}==True
	\	Log to logfile		\n ERROR:\t${error['message']}	WARN
	#\	Log to console and logfile		\n ERROR:\t${error['message']}	WARN

Response error Message
	[Arguments]	${resp}
	:FOR	${err}	in	@{resp}
	\	Exit for loop if	${resp[0]['status']}==True
	\	${msg_status}=	Run keyword and return status	Dictionary should contain key	${err['rest_resp']}		message
	#\	Run keyword if	${msg_status}==True	Log to console and logfile	\n ERROR:\t${err['rest_resp']['message']}	WARN
	\	Run keyword if	${msg_status}==True	Log to logfile	\n ERROR:\t${err['rest_resp']['message']}	WARN
