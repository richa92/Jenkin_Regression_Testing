*** Settings ***
Documentation       This module for SSH Feature Testing in Potash
Resource           ../../../Resources/api/fusion_api_resource.txt
Resource           InternalKeywords.txt
Library            RoboGalaxyLibrary
Library            FusionLibrary

Library             BuiltIn
Library             Collections
Library             XML
Library             String
Library             Dialogs

Resource           FCoE.txt

*** Variables ***

*** keywords ***
#############################################################################
#   Verify SSH to Potash ICM is allowed through IPV4 and IPV6 IP
#############################################################################
Verify SSH is allowed through static IPv4 and IPv6
    [Documentation]    Keyword to Verify SSH is allowed through static IPv4 and IPv6
    [Arguments]       ${SSH}  ${PotashUserName}  ${Random_Password}  ${PotashIP}  ${PotashIPV6}  ${ICM_CLI_PROMPT}


    ${ipv4_login}=  ssh_icm   ${SSH}  ${PotashIP}  ${PotashUserName}  ${Random_Password}

    ${ipv6_login}=  ssh_icm  ${SSH}   ${PotashIPV6}  ${PotashUserName}  ${Random_Password}

    should contain     ${ipv4_login}   ${ICM_CLI_PROMPT}
    should contain     ${ipv6_login}   ${ICM_CLI_PROMPT}



#############################################################################
#   Verify SSH is allowed after ICM Reset
#############################################################################
Verify SSH is allowed after ICM Reset
    [Documentation]    Keyword to Verify SSH is allowed after ICM Reset
    [Arguments]       ${OneViewIP}  ${Random_Password}  ${PotashIP1}  ${PotashIP1_IPV6}   ${PotashIP2}  ${PotashIP2_IPV6}  ${MASTER_ICM_CLI_PROMPT}

    Open Connection And Log In      ${OneViewIP}
    ${output}=    ISS Reset with SNMP Command    OneView    ${Random_Password}    ${PotashIP1}

    Verify SSH is allowed through static IPv4 and IPv6    ${SSH}  ${PotashUserName}  ${Random_Password}  ${PotashIP2}  ${PotashIP2_IPV6}%bond0  OneView#
    Verify SSH is allowed through static IPv4 and IPv6    ${SSH}  ${PotashUserName}  ${Random_Password}  ${PotashIP1}  ${PotashIP1_IPV6}%bond0  OneView>

    Open Connection And Log In      ${OneViewIP}
    ${output}=    ISS Reset with SNMP Command    ${PotashUserName}    ${Random_Password}    ${PotashIP2}

    Verify SSH is allowed through static IPv4 and IPv6    ${SSH}  ${PotashUserName}  ${Random_Password}  ${PotashIP1}  ${PotashIP1_IPV6}%bond0  OneView#
    Verify SSH is allowed through static IPv4 and IPv6    ${SSH}  ${PotashUserName}  ${Random_Password}  ${PotashIP2}  ${PotashIP2_IPV6}%bond0  OneView>




#############################################################################
#   Verify SSH is allowed after Active/Standby force fail-over in ICM
#############################################################################
Verify SSH is allowed after Active/Standby force fail-over in ICM
    [Documentation]    Keyword to Verify SSH is allowed after Active/Standby force fail-over in ICM
    [Arguments]       ${OneViewIP}  ${Random_Password}  ${PotashIP1}  ${PotashIP1_IPV6}  ${PotashIP2}  ${PotashIP2_IPV6}  ${MASTER_ICM_CLI_PROMPT}

    Open Connection And Log In      ${OneViewIP}
    ${cmd}=    Get SNMPSET Command   OneView    ${Random_Password}     ${PotashIP1}
    ${cmd}=    catenate    ${cmd}    1.3.6.1.4.1.11.5.7.5.8.1.99.1.8.0 i 1
    ${output}=     Execute Command    ${cmd}
    sleep    30s

    Verify SSH is allowed through static IPv4 and IPv6    ${SSH}  ${PotashUserName}  ${Random_Password}  ${PotashIP2}  ${PotashIP2_IPV6}%bond0  OneView#
    Verify SSH is allowed through static IPv4 and IPv6    ${SSH}  ${PotashUserName}  ${Random_Password}  ${PotashIP1}  ${PotashIP1_IPV6}%bond0  OneView>


    Open Connection And Log In      ${OneViewIP}
    ${cmd}=    Get SNMPSET Command   OneView    ${Random_Password}     ${PotashIP2}
    ${cmd}=    catenate    ${cmd}    1.3.6.1.4.1.11.5.7.5.8.1.99.1.8.0 i 1
    ${output}=     Execute Command    ${cmd}

    Verify SSH is allowed through static IPv4 and IPv6    ${SSH}  ${PotashUserName}  ${Random_Password}  ${PotashIP1}  ${PotashIP1_IPV6}%bond0  OneView#
    Verify SSH is allowed through static IPv4 and IPv6    ${SSH}  ${PotashUserName}  ${Random_Password}  ${PotashIP2}  ${PotashIP2_IPV6}%bond0  OneView>

    sleep    30s


#############################################################################
#   VVerify the maximum SSH sessions are supported in ICM
#############################################################################
Verify the maximum SSH sessions are supported in ICM
    [Documentation]    Keyword to verify maximum SSH sessions supported in ICM
    [Arguments]       ${Random_Password}  ${PotashIP}

    :FOR    ${Index}    IN RANGE    8
    \  ${output}=   Open Connection And Log In     ${PotashIP}    OneView    ${Random_Password}
    \  sleep    10s

    ${output}=   Open Connection  ${PotashIP}
    ${Login_Details}=     Login               OneView     ${Random_Password}

    Should contain    ${Login_Details}   Exceeding max CLI sessions! Connection closed by foreign host

    close all connections

