*** Settings ***
Documentation        Configures an appliance with resources found in supplied data file. Pass in specific tags with pybot -i <tag(s)> to limit processing
Library                         FusionLibrary
Library                         RoboGalaxyLibrary
Library                         OperatingSystem
Library                         BuiltIn
Library                         Collections
Library                         XML
Library                         String
Library                         json
Library                         SSHLibrary

Resource                        ../../../../Resources/api/fusion_api_resource.txt

Variables                       ring8_hardware_data_comp2.py   # please do not commit with dcs_data.py as it breaks OVA Qual

*** Variables ***
${X-API-VERSION}                1200
${APPLIANCE_IP}                 16.114.208.201
${DATA}                         ring8_hardware_data_comp2.py   # please do not commit with dcs_data.py as it breaks OVA Qual
${VERIFY}                       ${TRUE}
${SUITE_LOG_LEVEL}              TRACE
${TIMEOUT}                      10s
${POLLING_INTERVAL}             2s
${REMOTE_SUPPORT_TIMEOUT}       600
${PauseWhenFailed}              False
# Mail notification related
${Email_when_paused}            False
${Sender}                       wpst-srm-jenkins@hp.com
${Receiver}                     ramon.cha.egan@hpe.com
${Subject}                      Failure encountered when running test in Qual Run
${Content}                      Failure encountered when running test in Qual Run. Please go to the test head and continue

# Download SPP Variables
${WEB_USERNAME}                 None   # YOU_MUST_SPECIFY_ON_COMMAND_LINE_IF_WEB_URL_REQUIRES_AUTHENTICATION
${WEB_PASSWORD}                 None   # YOU_MUST_SPECIFY_ON_COMMAND_LINE_IF_WEB_URL_REQUIRES_AUTHENTICATION
${SPP_LOCALPATH}                c:\\firmware
${WEB_URL}                      None   # YOU_MUST_SPECIFY_ON_COMMAND_LINE
${THREADNUM}                    3
${SPP_LOCAL_FILE}               None

*** Keywords ***
QUAL Suite Setup
    [Documentation]     Suite Setup Login to appliance
    [Arguments]     ${credentials}
    Set Log Level   ${SUITE_LOG_LEVEL}
    ${response}=   Create List
    ${resp}=   Fusion Api Login Appliance  ${appliance_ip}     ${credentials}
    ${response}=  Convert to List  ${resp}
    Run Keyword If   ${response[0]['status_code']} is not 400  Log  Appliance is logged in
    Run Keyword If   ${response[0]['status_code']} is 400   Fatal Error   Appliance Credentials are not correct
    ${LOGGED} =   Set Variable   True
    Set OneView Version Metadata    ${appliance_ip}   ${LOGGED}
    Set RoboGalaxyLibrary Version Metadata
    Set FusionLibrary Version Metadata
    Set Suite Metadata    Test API Version    ${X-API-VERSION}
    Log  \nTest API Version: ${X-API-VERSION}  console=True
    ${count} =    Get Critical Alert Count
    Run Keyword If   ${count} > 0   Log    msg=Appliance has ${count} Active Critical Alerts    WARN
    ...   ELSE   Log   Appliance is in good state    console=True


QUAL Suite Teardown
    [Documentation]     Suite Teardown to Logout from OV
    Fusion Api Logout Appliance

Verify TBird Resource
    [Documentation]  Verify Resource
    ...              **kwargs are used to add key value pair to the expected DTO
    ...              Example:
    ...                Verify Resource  ${expected_dto}
    ...                Verify Resource  ${expected_dto}  Status=OK
    ...              Data Required:
    ...                Expected Resource DTO
    [Arguments]  ${expected_dto}  &{kwargs}

    ${status}  ${name} =  Run Keyword and Ignore Error  Get From Dictionary  ${expected_dto}  name
    Return from keyword if    '${status}'=='FAIL'    ${expected_dto} doesn't contain the key $name
    ${status}  ${type} =  Run Keyword and Ignore Error  Get From Dictionary  ${expected_dto}  type
    Return from keyword if    '${status}'=='FAIL'    ${expected_dto} doesn't contain the key $type
    Log  ${\n}Verifying ${type} ${name}    console=True
    ${new_expected_dto} =  Add Key Value to DTO  ${expected_dto}  &{kwargs}
    ${dto} =  Get Resource  ${type}:${name}
    log  the dto is ${dto}
    log   the expected is ${expected_dto}    console=True
    ${validate_status} =  Fusion api validate response follow  ${new_expected_dto}  ${dto}  wordy=${False}
    ${dict} =  create dictionary
    set to dictionary   ${dict}  status=${validate_status}
    set to dictionary   ${dict}  name=${name}
    Return From Keyword    ${dict}