*** Settings ***
Resource    ../resource.txt
Library              FusionLibrary
Library              RoboGalaxyLibrary
Library              OperatingSystem
Library              BuiltIn
Library              copy
Library              Collections
Library              String
Resource             ../../../../Resources/api/fusion_api_resource.txt

*** Keywords ***

Load Test Data and Open Browser and Login
    Load Test Data and Open Browser
    Log into Fusion appliance as Administrator


Clean Uplink Sets In LIG
    [Arguments]   ${lig_name}
    [Documentation]    Clean named LIG all uplinks
    ${dict}=   Create Dictionary    userName=${TestData.users[0].name}     password=${TestData.users[0].password}
    Fusion Api Login Appliance    ${APPLIANCE_IP}    ${dict}
    ${lig_uri} =    Get LIG URI    ${lig_name}
    ${payload} =    Fusion Api Get Lig    ${lig_uri}
    ${uplinkSets} =    Create List
    Remove From Dictionary    ${payload}    status_code
    Remove From Dictionary    ${payload}    headers
    Remove From Dictionary    ${payload}    status
    ${resps} =    Update LIG With Payload    ${payload}    uplinkSets    ${uplinkSets}    ${lig_uri}
    Wait Until Keyword Succeeds    3min    2sec    Validate Lig Info    ${lig_uri}    uplinkSets    ${uplinkSets}


Update LIG With Payload
    [Arguments]    ${body}    ${value}    ${update_info}    ${uri}
    [Documentation]    Update LIG with updated payload
    Set To Dictionary    ${body}     ${value}    ${update_info}
    ${resp} =    Fusion Api Edit Lig    body=${body}    uri=${uri}
    ${task} =    Wait For Task    ${resp}    5min    2s
    ${taskState} =    Get From Dictionary    ${task}    taskState
    Should Match    ${taskState}    Completed
    [Return]    ${resp}


Validate Lig Info
    [Arguments]    ${uri}    ${check_section}    ${expected_info}
    [Documentation]    Validate Lig Info
    ${resp} = 	Fusion Api Get Lig		uri=${uri}
    ${check_info} =     Get From Dictionary    ${resp}    ${check_section}
    Convert To String    ${check_info}
    Should Be Equal    ${check_info}    ${expected_info}


CLear Environment
    [Arguments]    ${TestData}
    ${dict}=   Create Dictionary    userName=${TestData.users[0].name}     password=${TestData.users[0].password}
    Log To Console    ${TestData.license_type[0].type}
    Fusion Api Login Appliance    ${APPLIANCE_IP}    ${dict}
    ${getlicresp}=    Fusion Api Get Licenses
    :FOR    ${eachlic}     IN    @{getlicresp['members']}
    \       Log To Console    ${eachlic}
    \       Continue For Loop If   '${eachlic["product"]}' != '${TestData.license_type[0].type}'
    \       ${delResp}=    Fusion Api Remove License  uri=${eachlic['uri']}
    \       Log To Console    Status_code_is_${delResp["status_code"]}
    \       Should Be Equal As Integers    ${delResp["status_code"]}   204