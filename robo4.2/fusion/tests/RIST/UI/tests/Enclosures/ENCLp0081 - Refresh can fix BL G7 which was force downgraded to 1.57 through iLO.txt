*** Settings ***
Documentation   ENCLp0081 - Refresh can fix BL G7 which was force downgraded to 1.57 through iLO
Library         robot.api.logger
Resource        ../resource.txt
Test Teardown   Remove Monitored Enclosure
Suite Setup      Load Multi Test Data and Open Browser
Suite Teardown	  Pause And Close Browser For Suite

*** Variables ***
${ilo_firmware_version}     None
${ilo_version}          None
${user}         Administrator
${firmware_version}           None
${lower_firmware_version}     1.57
${higher_firmware_version}    1.80
${expected_iLo_version}                ilo3
${target_ilo_firmware_version}  None
${enclosure_obj}    None
${data_search_node}     ENCLp0081

*** Test Cases ***
As an Administrator I want to verify refresh can fix BL G7 which was force downgraded to 1.57 through iLO
    ${data}=    Get Data By Xpath   //${data_search_node}/enclosure[@addas='Monitored']
    set suite variable      ${enclosure_obj}       ${data}
    set suite variable      ${firmware_version}       ${lower_firmware_version}
    Fusion UI Login To Appliance    ${user}
    Get Firmware Version and Update Firmware for BL Server if Necessary
    Add Enclosure As Monitored
    Validata Server Hardware iLo Firmware Meet Target Version
    set suite variable      ${firmware_version}       ${higher_firmware_version}
    Get Firmware Version and Update Firmware for BL Server if Necessary
    Refresh Server Hardware
    Validata Server Hardware iLo Firmware Meet Target Version

*** Keyword ***
Add Enclosure As Monitored
    ${status}=  Fusion UI add enclosure     @{enclosure_obj.enclosure}
    should be true      ${status}       msg=Failed add enclosure as Monitored

Validata Server Hardware iLo Firmware Meet Target Version
    ${data}=    Get Data By Xpath   //${data_search_node}/enclosure[@addas='Monitored']//bay[@FwVersion='${firmware_version}']
    ${status}=  Fusion UI Validate Server Hardware Meet Minimum iLo Firmware Version    @{data.bay}
    should be true      ${status}       msg=Function "Fusion UI validate server hardware page hardware" return False

Get Firmware Version and Update Firmware for BL Server if Necessary
    ${data}=    Get Data By Xpath   //${data_search_node}/enclosure[@addas='Monitored']//bay[@FwVersion='${firmware_version}']
    ilo connect     ${data.bay[0].iloIP}    ${data.bay[0].iloUserName}   ${data.bay[0].iloPassword}
    ${firmware_infos}=     ilo get fw version
    set suite variable    ${ilo_firmware_version}  ${firmware_infos['firmware_version']}
    set suite variable    ${ilo_version}  ${firmware_infos['management_processor']}
    Should Be Equal As Strings      ${ilo_version.lower()}      ${expected_iLo_version}        msg=iLO version is not as expected
    convert to number   ${ilo_firmware_version}
    set suite variable    ${target_ilo_firmware_version}    ${firmware_version}
    convert to number   ${target_ilo_firmware_version}
    Console     ${ilo_firmware_version}
    Console     ${target_ilo_firmware_version}
    run keyword if  ${ilo_firmware_version} != ${target_ilo_firmware_version}     Upgrade Firmware for BL Server
    Sleep       120

Upgrade Firmware for BL Server
    Console     test update firmware
    ${data}=    Get Data By Xpath   //${data_search_node}/enclosure[@addas='Monitored']//bay[@FwVersion='${firmware_version}']
    Console     ${data.bay[0].FwBundleUrl}
    ilo connect     ${data.bay[0].iloIP}    ${data.bay[0].iloUserName}   ${data.bay[0].iloPassword}
    Console     ${data.bay[0].iloIP}${data.bay[0].iloUserName}${data.bay[0].iloPassword}
    ${status}=      ilo update firmware     ${data.bay[0].FwBundleUrl}
    Should Be True      ${status}       msg=ilo update firmware return False

Refresh Server Hardware
    ${data}=    Get Data By Xpath   //${data_search_node}/enclosure[@addas='Monitored']//bay[@FwVersion='${firmware_version}']
    ${status}=      Fusion UI Refresh Server By Name    ${data.bay[0].name}
    Should Be True      ${status}       msg=Failed to refresh server

Remove Monitored Enclosure
    ${status}=                      Fusion UI Remove Enclosure      @{enclosure_obj.enclosure}
    Should Be True                  ${status}                   msg=Failed to remove monitored enclosure