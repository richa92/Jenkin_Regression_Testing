*** Settings ***
Documentation   EGp0002 - Modify Enclosure Groups and Lig
...
Library         robot.api.logger
Resource        ../resource.txt
Test Setup      Load Multi Test Data and Open Browser
Test Teardown   Pause And Close Browser

*** Variables ***
${user}     Administrator


*** Test Cases ***
As an Administrator I want to create LIG and EG, then modify them
    Fusion UI Login To Appliance        ${user}
    # pre-condition, create an LIG for creating EGs
    Console     ${SPACE * 4}--1. create a LIG
    ${data}=                            Get Data By Xpath                                       //ligs/lig
    ${rc}=                              Fusion Ui Create Logical Interconnect Group             @{data.lig}
    # only print a log, not have to be True since some previous tests may have created this LIG.
    # so for both saving time and guaranting pre-condition, will not fail if Create LIG return False
    # but let following steps fail the test if the required LIG does not exist.
    Console                             <Result of Create LIG is: [ ${rc} ]>

    # Create another logical interconnect group for changing LIG when Edit Enclosure Group
    Console     ${SPACE * 4}--2. create second LIG
    ${data}=                            Get Data By Xpath       //EGp0002/lig
    ${rc}=                              Fusion UI Create Logical Interconnect Group             @{data.lig}
    Should Be True                      ${rc}                   msg=Failed to add logical interconnect group

    # Create enclosure group
    Console     ${SPACE * 4}--3. create EG
    ${data}=                            Get Data By Xpath       //EGp0002/CreateEG/encgroup
    ${rc}=                              Fusion Ui Create Enclosure Group                        @{data.encgroup}
    Should Be True                      ${rc}
    ...                                 msg=Failed to prepare the pre-condition - creating an enclosure group

    # Add enclosure for later validating
    Console     ${SPACE * 4}--4. add enclosure
    ${enc}=                             Get Data By Xpath       //EGp0002/enclosure
    ${rc}=                              Fusion UI Add Enclosure                                 @{enc.enclosure}
    Run Keyword If                      '${rc}'!='${True}'      Fusion UI Remove Enclosure      @{enc.enclosure}
    Should Be True                      ${rc}                   msg=Failed to add enclosures

    # Create a server profile
    Console     ${SPACE * 4}--5. create SP
    ${sp}=                              Get Data By Xpath       //EGp0002/CreateSP/profile
    ${rc}=                              Fusion UI Create Server Profile                         @{sp.profile}
    Run Keyword If                      '${rc}'!='${True}'
    ...                                 Fusion UI Delete Server Profile                         @{sp.profile}
    Run Keyword If                      '${rc}'!='${True}'      Fusion UI Remove Enclosure      @{enc.enclosure}
    Should be True                      ${rc}                   msg=Failed to create Server Profile

    # Modify Enclosure Group Name
    Console     ${SPACE * 4}--6. modify EG name, and check the blacklist command in Configuration Script
    ${data}=                            Get Data By Xpath       //EGp0002/ModifyEGName/encgroup
    ${rc}=                              Fusion UI Modify Enclosure Group Name                   @{data.encgroup}
    Run Keyword If                      '${rc}'!='${True}'
    ...                                 Fusion UI Delete Server Profile                         @{sp.profile}
    Run Keyword If                      '${rc}'!='${True}'      Fusion UI Remove Enclosure      @{enc.enclosure}
    Should Be True                      ${rc}                   msg=Failed to modify Enclosure Group name

    # Verify Logical Enclosure should be in WARN status since related EG's name has been changed
    Console     ${SPACE * 4}--7. verify LE status should be WARN
    ${data}=                            Get Data By Xpath       //EGp0002/logicalenclosure
    ${rc}=                              Fusion UI Verify Logical Enclosure Warn                 @{data.logicalenclosure}
    Run Keyword If                      '${rc}'!='${True}'
    ...                                 Fusion UI Delete Server Profile                         @{sp.profile}
    Run Keyword If                      '${rc}'!='${True}'      Fusion UI Remove Enclosure      @{enc.enclosure}
    Should Be True                      ${rc}                   msg=Failed to verify Logical Enclosure in WARN status

    # Edit Enclosure Group
    Console     ${SPACE * 4}--8. edit EG to use another LIG
    ${data}=                            Get Data By Xpath       //EGp0002/EditEG/encgroup
    ${Status}=                          Fusion UI Edit Enclosure Group                          @{data.encgroup}
    Run Keyword If                      '${rc}'!='${True}'
    ...                                 Fusion UI Delete Server Profile                         @{sp.profile}
    Run Keyword If                      '${rc}'!='${True}'      Fusion UI Remove Enclosure      @{enc.enclosure}
    Should Be True                      ${Status}               msg=Failed to edit eg

    # Verify server profile general info
    Console     ${SPACE * 4}--9. verify SP info to check if the EG's new name is displayed
    ${data}=                            Get Data By Xpath       //EGp0002/VerifySP/profile
    ${rc}=                              Fusion UI Verify Server Profile General Info            @{data.profile}
    Run Keyword If                      '${rc}'!='${True}'
    ...                                 Fusion UI Delete Server Profile                         @{sp.profile}
    Run Keyword If                      '${rc}'!='${True}'      Fusion UI Remove Enclosure      @{enc.enclosure}
    Should be True                      ${rc}   msg=Failed to Verify Server Profile General Info

    # remove enclosure for other tests to add it using different LIG/EG
    Console     ${SPACE * 4}--10. remove SP and Enclosure
    ${data}=                            Get Data By Xpath                                       //EGp0002/VerifySP/profile
    ${rc}=                              Fusion Ui Delete Server Profile                         @{data.profile}
    Console                             <Result of Delete SP is: [ ${rc} ]>

    ${rc}=                              Fusion UI Remove Enclosure                              @{enc.enclosure}
    Console                             <Result of Remove Enclosure is: [ ${rc} ]>

