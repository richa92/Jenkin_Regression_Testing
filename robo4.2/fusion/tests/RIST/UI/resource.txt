*** Settings ***
Library             RoboGalaxyLibrary
Library             FusionLibrary
Library             SSHLibrary
Library             OperatingSystem
Library             XML
Library             String
Library				Dialogs

*** Variables ***
${SELENIUM_TIMEOUT}         5.0
${SELENIUM_IMPLICIT_WAIT}   0.0
${DataFile}         dcs_data.xml
${ConfigFile}       config.xml
${ApplianceUrl}     https://16.125.69.228
${Browser}          firefox
${SeleniumSpeed}    0.1
${ILO_PROMPT}       </>hpiLO->
${CONSOLE_TIMEOUT}  10 min
${RIBCL_XML}        ilo_ribcl_request_embedded_health.xml
${PauseWhenFailed}	False
# Mail notification related
${SendMailWhenPaused}   False
${Sender}       wpst-jenkins@hp.com
#${Receiver}     lei.chen5@hp.com, qian.xie@hp.com, junshan.ma@hp.com
${Receiver}     lei.chen5@hp.com
${BUILD_URL}    Jenkins built-in variable
${NODE_NAME}    Jenkins slave node name
${Subject}      Error encounter when running test
#Put detail info here
${Content}
${iscsiBootNotFound}                        Failed to wait for element 'xpath=//select[@id='cic-profile-connection-boot']/..//ol/li[text()='iSCSI primary']'
${unableToAddProfileErrMessage}             Unable to add profile.
${unableToEditProfileErrMessage}            Unable to update profile.
${unableToAddProfileTemplateErrMessage}     Unable to add profile template.
${reviewIndicatedWarningsErrMsg}            Review the indicated warnings before proceeding.
${onlyIscsiSecondaryBootErrMsg}             \n[u"Secondary boot connection is not valid.\\nResolution Specify a 'Primary' boot connection before specifying a 'Secondary' boot connection within a given type and try again."]
${multipleIscsiPrimaryBootErrMsg}           \n[u'Primary boot on connection 2 is not valid.\\nResolution Only one connection can be set to primary boot within a given type. Verify your input parameters and try again.']
${multipleIscsiSecondaryBootErrMsg}         \n[u'Secondary boot on connection 2 is not valid.\\nResolution Only one connection can be set to secondary boot within a given type. Verify your input parameters and try again.']
${failedWaitInvisibleCopySpErrMsg}          Failed to wait for element invisible '//section[@class='hp-details-add-section']'
${invalidIscsiInitiatorNameErrMsgPart1}     <entry invalid>: entered value '
${invalidIscsiInitiatorNameErrMsgPart2}     ' for Connection's 'iSCSI Initiator name' is INVALID, error message from UI is: \n<The iSCSI initiator name must be between 1-255 characters and contain only lower-case alphanumeric characters, hyphens (-), colons (:), or dots (.)>
${networkConnectionNotVisibleErrMsg}        Failed to wait for element 'xpath=//*[@id='cic-profile-connection-flexnic-input']'
${nonUniqueIscsiInitiatorNameErrMsgPart1}   \n[u'The iSCSI initiator name,
${nonUniqueIscsiInitiatorNameErrMsgPart2}   , is already in use.\\nResolution Specify a unique initiator name and retry the operation.']
${nonManagedVolumeIsSelectedErrMsg}         \n[u'Connection 1 is configured to boot from a managed volume, but no managed volume is selected for boot.\\nResolution Select a managed volume as bootable and ensure it has an enabled storage path with the specified connection.']
${nonConnectionIsConfigurededErrMsgPart1}   \n[u'Volume
${nonConnectionIsConfigurededErrMsgPart2}   is marked bootable, but no connections have been configured to boot from a managed volume\\nResolution Ensure that there are connections specified as FC primary (and optionally, FC secondary) and that they are configured to boot from a managed volume']
${nonConnectionIsConfigurededErrMsgPart3}   is marked bootable, but no connections have been configured to boot from a managed volume.\\nResolution Ensure that there are connections specified as FC primary (and optionally, FC secondary) and that they are configured to boot from a managed volume.']
${nonStoragePathSpecifiedErrMsgPart1}       \n[u'There are no storage paths specified for
${nonStoragePathSpecifiedErrMsgPart2}       . Two storage paths should be specified to ensure redundant connectivity.\\nResolution Add storage paths to the volume or click Create/Create+ to continue without storage paths.']
${nonStoragePathIsEnabledErrMsgPart1}       \n[u'Connection 2 is configured to boot from managed volume
${nonStoragePathIsEnabledErrMsgPart2}       , but the volume attachment does not include an enabled storage path for the connection.\\nResolution Modify the managed volume attachment to include an enabled storage path with the specified connection.']
${StoragePathIsDisabledErrMsgPart1}         \n[u'The storage path is disabled or it does not exist for the volume
${StoragePathIsDisabledErrMsgPart2}         marked for boot.\\nResolution Ensure that the storage path is enabled for the volume marked for boot.']
${unableToResetIloBlockMessage}             Unable to reset the iLO because a profile is currently being applied.
${InconsistencyWarningMsgSummary}           Warning: One or more logical interconnects are using this logical interconnect group.
${InconsistencyWarningMsgDetailsPart1}      \n[u'Modifying this logical interconnect group will cause logical interconnect
${InconsistencyWarningMsgDetailsPart2}      to become inconsistent.']
${UnabletoUpdateFirmware}                   Unable to update firmware.
${ServersarePoweronErrMsgPart1}             \n[u'The following server(s):
${ServersarePoweronErrMsgPart2}             are currently powered on. Firmware update cannot be initiated when any of the servers within the logical enclosure has a server profile assigned and is powered on.
${UpdatefirmwareResolution}                 \\n\\nResolution: Power off the listed servers and retry the operation.']


*** Keywords ***

Load Test Data and Open Browser
    Set Log Level    TRACE
    Load Test Data  ${DataFile}
    Log Variables
    Open Browser  ${ApplianceUrl}  ${Browser}
    Maximize Browser Window
    Run Keyword If  "${Browser}" == "ie"   Go To  javascript:document.getElementById('overridelink').click()
    Set Selenium Speed  ${SeleniumSpeed}

Load Multi Test Data and Open Browser
    Set Log Level           TRACE
    Load Multi Test Data          ${ConfigFile}   True
    Log Variables
    Open Browser            ${ApplianceUrl}         ${Browser}
    Maximize Browser Window
    Run Keyword If          "${Browser}" == "ie"    Go To   javascript:document.getElementById('overridelink').click()
    Set Selenium Speed      ${SeleniumSpeed}

Logout and Close All Browsers
    # Fusion UI Logout of Appliance
    Set Global Variable     ${UiLoggedIn}    ${False}
    Close All Browsers

Log into Fusion appliance as Administrator
    ${user} =  Get Data By Property  ${TestData.users}  name  Administrator
    Set Global Variable             ${UiLoggedIn}    ${False}
    Fusion UI Login to Appliance    ${user[0].name}

Wait for Controller Init
    [Documentation]    Boots a server via iLO textcons and waits for Controller Init to complete
    [Arguments]    ${profiles}
    # Open serial console.  Then, make sure we reach POST
    ${index}=    Open Connection    ${profiles.ip}    prompt=${ILO_PROMPT}    timeout=${CONSOLE_TIMEOUT}
    ${output}=    Login    ${profiles.username}    ${profiles.password}
    Write    textcons
    ${output}=    Read Until    Controller Status: Init done
    Close Connection

iLO Check Local RAID Configuration
    [Documentation]    Use RIBCL to check the RAID level and drive counts
    [Arguments]    ${profiles}    ${RAID}    ${NUM_PHYSICAL_DRIVES}    ${NUM_LOGICAL_DRIVES}=1
    Ilo Connect    ${profiles.ip}    ${profiles.username}    ${profiles.password}
    ${Output}=    iLO Get Embedded Health
    # Parse out storage.
    ${Storage}=    Get From Dictionary    ${Output}    storage
    # Validate storage controller
    ${Controller}=    Get From Dictionary    ${Storage}    Controller on System Board
    # Number of Logical Drive (currently this can only be 0 or 1 for Fusion test cases)
    ${Logical_Drives}=    Get From Dictionary    ${Controller}    logical_drives
    Log    ${Logical_Drives}
    ${Count}=    Get Length    ${Logical_Drives}
    Pass Execution If    ${Count} == 0    No need to check RAID if logical drive count == 0
    Should Be Equal As Integers    ${Count}    ${NUM_LOGICAL_DRIVES}
    ${Logical_Drive0}=     Get From List    ${Logical_Drives}    0
    # RAID level
    ${Fault_Tolerance}=    Get From Dictionary    ${Logical_Drive0}    fault_tolerance
    Should Be Equal As Strings   ${Fault_Tolerance}    ${RAID}
    # Number of Physical Disks
    ${Physical_Drives}=    Get From Dictionary    ${Logical_Drive0}    physical_drives
    ${Count}=    Get Length    ${Physical_Drives}
    Should Be Equal As Integers    ${Count}    ${NUM_PHYSICAL_DRIVES}

Pause And Close Browser
	[Documentation]    Popup a dialog to pause the execution if \${PauseWhenFailed} is set to True. Finally close the browser
	Run Keyword If Test Failed		Pause Test Execution
	Logout and close all browsers

Pause And Close Browser For Suite
	[Documentation]    Popup a dialog to pause the execution if \${PauseWhenFailed} is set to True. Finally close the browser
	Run Keyword If Any Tests Failed		Pause Test Execution
	Logout and close all browsers

Pause Test Execution
	[Documentation]    Pause test execution
    Return From Keyword If   '${PauseWhenFailed.lower()}'=='false'

	LOG     Encounter failure, pausing test execution, if job is launch from jenkins, please log on jenkins slave server to get job continue       level=WARN
	Send Mail Notification
	Pause Execution

Send Mail Notification
    Return From Keyword If   '${SendMailWhenPaused.lower()}'=='false'    Skipped Send Mail Notification (\${SendMailWhenPaused}=${SendMailWhenPaused})

    LOG     Sending mail notification   level=WARN
    @{receiver_lst}=    Split String	${Receiver}     ,

    Run Keyword If  '${Content}' == ''  Set Suite Variable
    ...             ${Content}
    ...             Build URL: \n${BUILD_URL}\n\nSlave Node: \n${NODE_NAME}\n\nTest case file: \n${SUITE SOURCE}\n\nTest case name: \n${TEST NAME}\n

    Connect To SMTP Server          smtp.hp.com  True
    Send Email      ${Sender}    ${receiver_lst}      ${Subject}      ${Content}
    Disconnect From SMTP Server

Create Expected Error Message for Invalid iSCSI Primary/Secondary Boot Connections
    [Arguments]  ${errorMessagePart1}    ${profileName} 	${errorMessagePart2}
    ${partialExpectedErrorMessage}=  catenate  ${errorMessagePart1}	 ${profileName}
    ${completeErrorMessage}=  catenate  SEPARATOR=  ${partialExpectedErrorMessage}  ${errorMessagePart2}
    [Return]  ${completeErrorMessage}

Convert Data to List
    [Arguments]  ${inputData}
    ${listLikeData}=  create list  ${inputData}
    [Return]  ${listLikeData}
