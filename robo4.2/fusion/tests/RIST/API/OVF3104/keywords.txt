*** Settings ***
Library             RoboGalaxyLibrary
Library             FusionLibrary
Library             OperatingSystem
Library             BuiltIn
Library             String
Library             robot.libraries.String
Library             Dialogs
Library             SSHLibrary
Library             Collections
Resource            ../global_variables.robot
Variables           ${DATA_FILE}


*** Variables ***
${remote_ip}    16.114.210.116


*** Keywords ***
Update authentication body
    [Documentation]    edit security authentication settings
    [Arguments]     ${value_dictionary}
    ${resp} =  Fusion Api Get Login Domains Global Settings
    :For    ${key}    IN    @{value_dictionary.keys()}
    \    Set To Dictionary    ${resp}    ${key}    ${value_dictionary['${key}']}
    Set Global Variable    ${headers}    ${resp['headers']}
    Remove From Dictionary    ${resp}    headers    status_code
    [Return]    ${resp}

Setup 2FA login evn in linux
    [Documentation]   setup evn for 2FA login via running curl commands
    Open Connection    ${remote_ip}
    Login    ${ssh_cred['username']}    ${ssh_cred['password']}
    Execute Command    mkdir -p ${destination_path}
    Execute Command    chmod -R 777 ${destination_path}
    SSHLibrary.Put File    ${CURDIR}/OVF3104_auto_client-cert.pem    ${destination_path}
    SSHLibrary.Put File    ${CURDIR}/curl_tool.zip    ${destination_path}
    Sleep    10
    :For    ${key}    IN    @{setup_evn_commands.keys()}
    \    Execute command    ${setup_evn_commands['${key}']}
    \    Sleep    10
    Close Connection

2FA Login
    [Documentation]    2FA login appliance via running curl command and get its sessionID
    Open Connection    ${remote_ip}
    Login    ${ssh_cred['username']}    ${ssh_cred['password']}
    ${output} =  Execute command    ${curl_commands['part1']}${X-API-Version}${curl_commands['part2']}${APPLIANCE_IP}${curl_commands['part3']}
    ${sessionID1} =  robot.libraries.String.fetch from right    ${output}    "sessionID":"
    ${sessionID2} =  robot.libraries.String.fetch from left    ${sessionID1}    "
    [Return]    ${sessionID2}

Disable smart card only login via curl
    [Documentation]    disbale smart card only login using curl command and reset authentication settings to be that before test
    [Arguments]    ${sessionID}    ${authentication_body}
    Open Connection    ${remote_IP}
    Login    ${ssh_cred['username']}    ${ssh_cred['password']}
    Execute command    ${curl_commands['part4']}${X-API-Version}${curl_commands['part5']}${sessionID}${curl_commands['part6']}${authentication_body}${curl_commands['part7']}${APPLIANCE_IP}${curl_commands['part8']}
    Close Connection

Get current auth body
    [Documentation]    Get the authentication settings before test
    [Arguments]    ${sessionID}
    Open Connection    ${remote_IP}
    Login    ${ssh_cred['username']}    ${ssh_cred['password']}
    ${output} =  Execute command    ${curl_commands['part9']}${X-API-Version}${curl_commands['part5']}${sessionID}${curl_commands['part10']}${APPLIANCE_IP}${curl_commands['part8']}
    ${authenticaiton_body} =  robot.libraries.String.fetch from right    ${output}    chunked
    [Return]    ${authenticaiton_body}

Set directory server login domain as default
    [Documentation]    set directory server login domain as the default login domain
    [Arguments]     ${configure_item}    ${default_item}    ${domain_name}
    ${resp} =  Fusion Api Get Login Domains Global Settings
    ${index} =    Set Variable    ${0}
    :FOR    ${item}    IN    @{resp['${configure_item}']}
    \    Continue For Loop If    '${item["name"]}'!='${domain_name}'
    \    ${index} =  Get Index From List    ${resp['${configure_item}']}    ${item}
    Set To Dictionary    ${resp}    ${default_item}    ${resp['${configure_item}'][${index}]}
    Remove From Dictionary    ${resp}    headers    status_code
    Fusion Api Edit Login Domains Global Settings    ${resp}

Check authentication settings
    [Documentation]    Check whether the authentication settings updated successfully
    [Arguments]    ${authentication_item}    ${expected_result}
    ${resp} =  Fusion Api Get Login Domains Global Settings
    Should Be Equal    '${resp['${authentication_item}']}'    '${expected_result}'    msg=Fail to update authentication settings

Clear evn in linux
    [Documentation]   clear evn for 2FA login via running curl commands
    Open Connection    ${remote_ip}
    Login    ${ssh_cred['username']}    ${ssh_cred['password']}
    :For    ${key}    IN    @{clear_evn_commands.keys()}
    \    Execute command    ${clear_evn_commands['${key}']}
    Close Connection
