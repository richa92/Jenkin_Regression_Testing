*** Settings ***
Variables   ./Regression_Data.py
Resource    ./../../../../Resources/api/fusion_api_resource.txt
Resource    ../global_variables.robot

*** Keywords ***
Remove All Hardwares
    [Documentation]  Remove All Hardwares
    Run Keyword And Ignore Error    Wait For ALL Enclosures In OK Status
    Run Keyword And Ignore Error    Wait For ALL Enclosures Complete Refresh
    Run Keyword And Ignore Error    Remove All Enclosures
    Run Keyword And Ignore Error    Remove All DL Server Hardware Async     ServerTypes=DL

Validate Hardware Firmware Version
    [Arguments]    ${hadrwares}  ${inventory}
    [Documentation]    Validate if firmware update success
    :FOR    ${hadrware}    IN    @{hadrwares}
    \    ${iloIP} =   Get from Dictionary    ${hadrware}    hostname
    \    ${uri} =   Get Server Hardware URI By ILO IP     ${iloIP}
    \    Log    Prepare to validate server firmware and driver inventory for ${uri}    console=true
    \    Power On Server By Uri    ${uri}
    \    Wait Until Keyword Succeeds    600s    15s    Server Hardware Firmware Version Correct    ${uri}    ${inventory}
    \    Log    Firmware update success!    console=true

Server Hardware Firmware Version Correct
    [Documentation]  Server Hardware Firmware Version Correct
    [Arguments]    ${hardware}    ${expectedFirmware}
    Set Log Level    TRACE
    ${firmware} =   Fusion Api Get Server Hardware Firmware     ${hardware}
	${firmware} =   Get From Dictionary    ${firmware}  components
    Validate Firmware Version   ${firmware}     ${expectedFirmware}

Validate Firmware Version
    [Arguments]    ${firmware}  ${expectedFirmware}
    [Documentation]    Check if firmware version update to expected value
    Log    Check if firmware version update to expected value    console=true
    Log    Actual firmware:\n${firmware}    console=true
    Log    Expected firmware:\n${expectedFirmware}    console=true
    :FOR    ${checkFirmware}    IN    @{expectedFirmware}
    \    ${name} =   Get from Dictionary     ${checkFirmware}    componentName
    \    ${version} =   Get from Dictionary  ${checkFirmware}    componentVersion
    \    ${hardwareVersion} =    Search Firmware Version     ${firmware}     ${name}
    \    Should Contain     ${hardwareVersion}  ${version}  Firmware update failed,${name} should be ${version}, but actually ${hardwareVersion}
    \    Log    ${name} validate success    console=true

Search Firmware Version
    [Documentation]  Search Firmware Version
    [Arguments]    ${firmware}  ${name}
    :FOR    ${component}    IN    @{firmware}
    \    ${componentName} =   Get from Dictionary    ${component}    componentName
    \    ${version} =   Get from Dictionary  ${component}    componentVersion
    \    Return From Keyword If    "${name}"=="${componentName}"     ${version}
    [Return]    Firmware ${name} not found!

Verify Firmware Version As Expected After Refresh
    [Documentation]  Verify Firmware Version As Expected After Refresh
    [Arguments]    ${server}  ${firmware}
    ${server_name}=    Get Server Hardware Name from ILO IP  ${server[0]["hostname"]}
    Refresh Server Hardware   ${server_name}
    Validate Hardware Firmware Version   ${server}   ${firmware}