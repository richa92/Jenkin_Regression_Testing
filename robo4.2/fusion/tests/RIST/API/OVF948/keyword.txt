*** Settings ***
Variables   ./Regression_Data.py
Resource    ./../../../../Resources/api/fusion_api_resource.txt
Resource    ../global_variables.robot

*** Keywords ***
#    Run Keyword And Ignore Error    Remove All DL Server Hardware Async     ServerTypes=ML

Verify Search Server Hardware Status Till Complete
    [Arguments]    ${servername}    ${expectedstatus}
    [Documentation]    verify server hardware status changed to Monitored
     ${actualstatus} =  Get Server Hardware State   ${servername}
     should be equal    ${actualstatus}     ${expectedstatus}

Clear Test Environtment
    [Documentation]  Clear Test Environtment
    Log to console and logfile      Power Off Servers and remove all profiles
    Run Keyword And Ignore Error    Power off ALL servers   PressAndHold
    Run Keyword And Ignore Error    Wait For ALL Servers Complete Refresh
    Run Keyword And Ignore Error    Remove All Server Profiles

Generate profile body
    [Arguments]    ${profiles}    ${isForce}=${False}
    [Documentation]    Generate profile body
    ${profilelist} =    Create List
    :FOR    ${profile}    IN    @{profiles}
    \    ${iloIP} =   Get from Dictionary    ${profile}    serverHardwareUri
    \    ${uri} =   Get Server Hardware URI By ILO IP     ${iloIP}
    \    ${firmware} =     Get from Dictionary    ${profile}    firmware
    \    ${firmwareBaseline} =    Get from Dictionary  ${firmware}   firmwareBaselineUri
    \    ${firmwareURI} =    Get Firmware Bundle By Version  ${firmwareBaseline}
    \    Set to Dictionary    ${firmware}    firmwareBaselineUri    ${firmwareURI}
    \    Set to Dictionary    ${firmware}    forceInstallFirmware    ${isForce}
    \    Set to Dictionary    ${profile}    firmware    ${firmware}
    \    Set to Dictionary    ${profile}    serverHardwareUri    ${uri}
    \    append to list    ${profilelist}    ${profile}
    \    Log to console and logfile      Creat profile body for ${iloIP}
    [Return]    ${profilelist}

Update server firmware when create profile
    [Arguments]    ${payload}    ${isForce}=${False}
    [Documentation]    Create server profile with firmware baseline
    Log to console and logfile  Update server firmware when create profile
    Clear Test Environtment
    ${profilelist} =    Generate profile body   ${payload}  ${isForce}
    ${resps} =   Add Server Profiles from variable   ${profilelist}
    Wait Firmware Update Task   ${resps}

Update server firmware when edit profile
    [Arguments]    ${payload}    ${isForce}=${False}
    [Documentation]    Edit server profile with firmware baseline
    Log to console and logfile  Update server firmware when edit profile
    ${profilelist} =    Generate profile body   ${payload}  ${isForce}
    ${resps} =   Edit Server Profiles from variable   ${profilelist}
    Wait Firmware Update Task   ${resps}

Wait Firmware Update Task
    [Arguments]    ${resps}
    [Documentation]    Validate firmware task complete
    Log to console and logfile  Validate firmware task complete
    :FOR    ${resp}    IN    @{resps}
    \    Log to console and logfile  ${resp}
    \    ${task} =    Wait For Task     ${resp}     80min    5s
    \    ${taskStatus} =    Get From Dictionary        ${task}     taskStatus
    \    ${taskState} =    Get From Dictionary        ${task}     taskState
    \    Log to console and logfile  ${taskStatus}
    \    Log to console and logfile  ${taskState}
    \    Should Match    ${taskState}    Completed

