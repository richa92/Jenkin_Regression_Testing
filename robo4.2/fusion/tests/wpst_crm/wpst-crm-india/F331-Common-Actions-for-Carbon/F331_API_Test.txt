*** Settings ***
Documentation       Feature Test: These test cases belongs to\
...                 F331 - Carbon Common actions\
...
Variables           ./data_variables.py
#Suite Setup        Run FTS and test-specific setup
Resource            ../../resources/resource.txt
Library             Collections
Library             json
Library             OperatingSystem
Library             Selenium2Library
#Test Setup         KC Load Test Data
Library             RoboGalaxyLibrary
Library             FusionLibrary

*** Variables ***
${SSH_PASS}                      hpvse1
${DataFile}                      ./OVAData.xml
${APPLIANCE_IP}                  15.212.167.3
${ICM_MODEL}                     Virtual Connect SE 16Gb FC Module for Synergy
${ICM_NAME}                      EM1FFFF500, interconnect 1
${ICM_BAY}                       1
${partNumber_exp}                779227-B21
${model_exp}                     Virtual Connect SE 16Gb FC Module for Synergy
${firmwareVersion_exp}           1.01.04
${serialNumber_exp}              CN85430004
${USERNAME}                      Administrator
${PASSWORD}                      hpvse123
${SLEEP_TIME}                    30
${ALERTMSG_OFF}                  Interconnect ${ICM_NAME} has been powered off
${ALERTMSG_ON}                   Interconnect ${ICM_NAME} has been powered on

*** Keywords ***
Get IC Name
    [Arguments]     ${ICM_NAME}
    ${resp} =   fusion api get interconnect
    #Log to Console ${resp}
    ${ic_list} =    Create List
    #Log to Console ${ic_list}
    ${ics} =     Get From Dictionary     ${resp}    members
    ${l} =  Get Length  ${ics}
    :FOR    ${x}    IN RANGE    0   ${l}
    \   ${ic} =     Get From List   ${ics}    ${x}
    \   Run Keyword If  '${ic['name']}' != '${ICM_NAME}'        Continue For Loop
    \   Append to list      ${ic_list}  ${ic}
    [Return]    ${ic_list}

Power Off ICM
    [Arguments]     ${ICM_NAME}
    Set Test Message    ICM Power Off
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary     ${ic[0]}    uri
    ${body} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=Off
    ${body} =   Create list     ${body}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${powerState} =     Get From Dictionary     ${ic[0]}   powerState
    [Return]    ${powerState}

Power On ICM
    [Arguments]     ${ICM_NAME}
    Set Test Message    ICM Power On
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${body} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=On
    ${body} =   Create list     ${body}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    [Return]    ${powerState}

Reset ICM
    [Arguments]     ${ICM_NAME}
    Set Test Message    ICM Reset
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary     ${ic[0]}    uri
    ${body} =   Create Dictionary   op=replace
    ...                             path=/deviceResetState
    ...                             value=Reset
    ${body} =   Create list     ${body}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${deviceResetState} =       Get From Dictionary     ${ic[0]}   deviceResetState
    [Return]    ${deviceResetState}

UID on ICM
    [Arguments]     ${ICM_NAME}
    Set Test Message    ICM UID On
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary     ${ic[0]}    uri
    ${body} =   Create Dictionary   op=replace
    ...                             path=/uidState
    ...                             value=On
    ${body} =   Create list     ${body}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uidState} =     Get From Dictionary       ${ic[0]}   uidState
    [Return]    ${uidState}

UID Off ICM
    [Arguments]     ${ICM_NAME}
    Set Test Message    ICM UID Off
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${body} =   Create Dictionary   op=replace
    ...                             path=/uidState
    ...                             value=Off
    ${body} =   Create list     ${body}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uidState} =    Get From Dictionary    ${ic[0]}    uidState
    [Return]    ${uidState}

UID Flash ICM
    [Arguments]     ${ICM_NAME}
    Set Test Message    ICM UID Flash
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary     ${ic[0]}    uri
    ${body} =   Create Dictionary   op=replace
    ...                             path=/uidState
    ...                             value=Blinking
    ${body} =   Create list     ${body}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uidState} =     Get From Dictionary       ${ic[0]}   uidState
    [Return]    ${uidState}

Get Alert by Param
    [Documentation]  Get Alert by param
    ...    Examples:
    ...    Get Alert By Param   param=?filter=description like 'The logical enclosure is inconsistent with its enclosure group*'
    [Arguments]  ${param}
    Log to console and logfile  ${\n}Get Alert by Param ${param}
    ${resp}=  fusion api get alerts   param=${param}
    ${status} =  Run keyword and return status  Dictionary should contain key  ${resp}  'errorCode'
    Return from keyword if  ${status}==${True}  Fail: Get Alert By Param Error ${resp}
    log to console    ${resp}
    ${count} =  Get From Dictionary    ${resp}    count
    #Log to console and logfile    ${count}
    #Log to console and logfile  ${resp}
    run keyword if  '${count}'=='0'    Fail    '\nAlert is not found'
    Log to console and logfile    '\nAlert is found'
    #Return from keyword if  ${count}==0  Fail: Get Alert by Param not found match ${resp}
    #Log to console and logfile  ${\n}Pass: Get Alert by Param found match ${resp['members'][0]}
    #[return]  ${resp['members'][0]}
    #[return]  ${resp['members'][0]}

Remove All Alerts
    [Arguments]  ${timeout}=600  ${interval}=10
    Log to console and logfile      ${\n}Removing All Alerts
    ${resp} =   fusion api delete alert
    ${status}  ${task_uri} =  Run Keyword and Ignore Error  Get From Dictionary  ${resp['headers']}  location
    Return From Keyword If    '${status}'=='FAIL'  Fail: Location header not found in response ${resp['header']}
    Log to console and logfile  The task URI is ${task_uri}
    ${task} =  Fusion Api Get Task  uri=${task_uri}
    Wait For Task  ${task}  timeout=${timeout}  interval=${interval}

Verify Task and Get Error Message
    [Documentation]  Get Alert by param
    [Arguments]  ${resp}
    ${task} =   Wait For Task   ${resp}     1min    1min
    ${taskState} =    Get From dictionary    ${task}    taskState
    Should Be Equal As Strings    ${taskState}    Error
    ${taskErrors} =    Get From dictionary    ${task}    taskErrors
    ${message} =    Get From dictionary    ${taskErrors[0]}     message
    [return]  ${message}

Power Operation and check erros
    [Arguments]     ${ICM_NAME}     ${value}    ${expected}
    Log to console and logfile  -Issue powerControl change request
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${data} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=${value}
    ${body} =   combine lists   ${data}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    ${status_code} =    Get From dictionary    ${resp}    status_code
    Log To Console  ${status_code}
    Should Be Equal As Strings    ${status_code}    401
    ${message} =    Get From dictionary    ${resp}    message
    Log To Console  ${message}
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${powerState} =    Get From dictionary    ${ic[0]}    powerState
    #${powerState}=    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    Should Be Equal As Strings    ${powerState}    ${expected}

UID Operation and check erros
    [Arguments]     ${ICM_NAME}     ${value}    ${expected}
    Log to console and logfile  -Issue UID change request
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${data} =   Create Dictionary   op=replace
    ...                             path=/uidState
    ...                             value=${value}
    ${body} =   combine lists   ${data}
    ${uidState} =       Get From Dictionary     ${ic[0]}   uidState
    Log To Console  ${uidState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    ${status_code} =    Get From dictionary    ${resp}    status_code
    Log To Console  ${status_code}
    Should Be Equal As Strings    ${status_code}    401
    ${message} =    Get From dictionary    ${resp}    message
    Log To Console  ${message}
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uidState} =    Get From dictionary    ${ic[0]}    uidState
    Log To Console  ${uidState}
    Should Be Equal As Strings    ${uidState}    ${expected}

Add F331 Users from variable
    [Arguments]     ${users}
    Log to console and logfile      Adding USERS    
    :FOR    ${user}    IN    @{users}
    \       ${resp} =   Fusion Api Add User     body=${user}

Check All Alert
     [Arguments]     ${alert_msg}
     ${msg1}=    Set Variable    ${alert_msg}
     ${msg}=     Create List
     Append to List    ${msg}    ${msg1}
     ${alerts} =    fusion_api_get_alerts    /rest/alerts
     : FOR    ${message}    IN    @{msg}
     \          Run Keyword and Continue on Failure     Should Contain       '${alerts}'       ${message}     Expected Alert Message Not seen     
     # How to use this keyword
     # Check All Alert    ${alert_msg}
     #

*** Test Cases ***
00 Appliance LogIn
    #${Creds}    Create Dictionary   userName    ${USERNAME} password    ${PASSWORD}
    Fusion Api Login Appliance     ${APPLIANCE_IP}   ${login_details}
    #
    ${users} =  Get Variable Value  ${users}
    Run Keyword If  ${users} is not ${null}    Add F331 Users from variable              ${users}

F331_TC_API_1, F331_TC_API_2, F331_TC_API_24 Verify the ICM state, Power state, firmware version
    [Tags]      getIcDetails
    Set Log Level   TRACE
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${d1} =     Get From Dictionary     ${ic[0]}   serialNumber
    Log To Console  ${d1}
    Should Be Equal As Strings    ${d1}  ${serialNumber_exp}
    #
    ${d1} =     Get From Dictionary     ${ic[0]}   partNumber
    Log To Console  ${d1}
    Should Be Equal As Strings    ${d1}  ${partNumber_exp}
    #
    ${d1} =     Get From Dictionary     ${ic[0]}   uidState
    Log To Console  ${d1}
    Should Be Equal As Strings    ${d1}  Off
    #
    ${d1} =    Get From Dictionary    ${ic[0]}    state
    Log To Console  ${d1}
    Should Be Equal As Strings    ${d1}  Monitored
    #
    ${d1} =    Get From Dictionary    ${ic[0]}    powerState
    Should Be Equal As Strings    ${d1}  On
    #

F331_TC_API_3 Issue a powerControl Off and later power on ICM
    [Tags]  powerOff and PowerOn
    Log to console and logfile  '\n-Issue powerControl Off'
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${body} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=Off
    ${body} =   Create list     ${body}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    Log to console and logfile  -Verify it's OFF
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    Should Be Equal As Strings    ${powerState}    Off
    #
    Log to console and logfile  '\n-Issue powerControl On'
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${body} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=On
    ${body} =   Create list     ${body}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    Log to console and logfile  -Verify it's ON
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    Should Be Equal As Strings    ${powerState}    On

F331_TC_API_4 Issue a powerControl Off and later issue reset ICM
    [Tags]  powerOff
    Log to console and logfile  '\n-Issue powerControl Off'
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary     ${ic[0]}    uri
    ${body} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=Off
    ${body} =   Create list     ${body}
    ${powerState} =     Get From Dictionary     ${ic[0]}   powerState
    Log To Console  ${powerState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    Log to console and logfile  -Verify it's OFF
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${powerState} =     Get From Dictionary     ${ic[0]}   powerState
    Log To Console  ${powerState}
    Should Be Equal As Strings    ${powerState}    Off
    #
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary     ${ic[0]}    uri
    ${data} =   Create Dictionary   op=replace
    ...                             path=/deviceResetState
    ...                             value=Reset
    ${body} =   Create List     ${data}
    ${deviceResetState} =       Get From Dictionary     ${ic[0]}   deviceResetState
    Log To Console  ${deviceResetState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   20s
    Log to console and logfile  -Verify it's reset
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${deviceResetState} =       Get From Dictionary     ${ic[0]}   deviceResetState
    Log To Console  ${deviceResetState}
    Should Be Equal As Strings    ${deviceResetState}  Normal

F331_TC_API_5 Issue power ON + Reset + UID ON at the same time
    [Tags]  powerOff
    Log to console and logfile  -Issue powerControl On
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${data} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=On
    ${body1} =   Create List     ${data}
    ${data} =   Create Dictionary   op=replace
    ...                             path=/deviceResetState
    ...                             value=Reset
    ${body2} =   Create List     ${data}
    ${data} =   Create Dictionary   op=replace
    ...                             path=/uidState
    ...                             value=On
    ${body3} =   Create List     ${data}
    ${body} =   combine lists   ${body1}    ${body2}    ${body3}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    ${message} =    Verify Task and Get Error Message   ${resp}
    Log To Console  ${message}
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    Should Be Equal As Strings    ${powerState}    Off


F331_TC_API_6 Issue power ON + Reset, should fail
    [Tags]  powerOn+Reset
    Log to console and logfile  -Issue powerControl On
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${data} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=On
    ${body1} =   Create List     ${data}
    ${data} =   Create Dictionary   op=replace
    ...                             path=/deviceResetState
    ...                             value=Reset
    ${body2} =   Create List     ${data}
    ${body} =   combine lists   ${body1}    ${body2}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    ${message} =    Verify Task and Get Error Message   ${resp}
    Log To Console  ${message}  
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    Should Be Equal As Strings    ${powerState}    Off

#Issue power On request so that subsequent test can be executed
    #
    Power On ICM    ${ICM_NAME}

F331_TC_API_7 Issue power OFF + Reset, should fial
    [Tags]  powerOff
    Log to console and logfile  -Issue powerControl Off
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${data} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=Off
    ${body1} =   Create List     ${data}
    ${data} =   Create Dictionary   op=replace
    ...                             path=/deviceResetState
    ...                             value=Reset
    ${body2} =   Create List     ${data}
    ${body} =   combine lists   ${body1}    ${body2}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    ${message} =    Verify Task and Get Error Message   ${resp}
    Log To Console  ${message}
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    Should Be Equal As Strings    ${powerState}    On

F331_TC_API_8 Issue power OFF + UID Blinking, should pass
    [Tags]  powerOff
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${data} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=Off
    ${body1} =   Create List     ${data}
    ${data} =   Create Dictionary   op=replace
    ...                             path=/uidState
    ...                             value=Blinking
    ${body2} =   Create List     ${data}
    ${body} =   combine lists   ${body1}    ${body2}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    Log to console and logfile  -Verify it's OFF
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    Should Be Equal As Strings    ${powerState}    Off
    Log to console and logfile  -Verify UID Blinking
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uidState} =    Get From Dictionary    ${ic[0]}    uidState
    Log To Console  ${uidState}
    Should Be Equal As Strings    ${uidState}    Blinking

F331_TC_API_9 Issue UID ON request, should pass
    [Tags]  powerOn
    Log to console and logfile  -Issue UID On
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${body} =   Create Dictionary   op=replace
    ...                             path=/uidState
    ...                             value=On
    ${body} =   Create list     ${body}
    ${uidState} =       Get From Dictionary     ${ic[0]}   uidState
    Log To Console  ${uidState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    Log to console and logfile  -Verify UID is ON
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uidState} =    Get From Dictionary    ${ic[0]}    uidState
    Log To Console  ${uidState}
    Should Be Equal As Strings    ${uidState}    On

F331_TC_API_10 Issue UID Off request, should pass
    [Tags]  powerOn
    Log to console and logfile  -Issue UID Off
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${body} =   Create Dictionary   op=replace
    ...                             path=/uidState
    ...                             value=Off
    ${body} =   Create list     ${body}
    ${uidState} =    Get From Dictionary    ${ic[0]}    uidState
    Log To Console  ${uidState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    Log to console and logfile  -Verify UID is OFF
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uidState} =    Get From Dictionary    ${ic[0]}    uidState
    Log To Console  ${uidState}
    Should Be Equal As Strings    ${uidState}    Off

F331_TC_API_11 Issue UID Blinking request, should pass
    [Tags]  UIDFlash
    Log to console and logfile  -Issue UID flash
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${body} =   Create Dictionary   op=replace
    ...                             path=/uidState
    ...                             value=Blinking
    ${body} =   Create list     ${body}
    ${uidState} =    Get From Dictionary    ${ic[0]}    uidState
    Log To Console  ${uidState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    Log to console and logfile  -Verify UID is Blinking
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uidState} =    Get From Dictionary    ${ic[0]}    uidState
    Log To Console  ${uidState}
    Should Be Equal As Strings    ${uidState}    Blinking

F331_TC_API_12 Issue ICM reset
    [Tags]  powerOff
    Log to console and logfile  -Issue ICM Reset
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${data} =   Create Dictionary   op=replace
    ...                             path=/deviceResetState
    ...                             value=Reset
    ${body} =   Create List     ${data}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    Log to console and logfile  -Verify it's Reset
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${deviceResetState} =    Get From Dictionary    ${ic[0]}    deviceResetState
    Log To Console  ${deviceResetState}
    Should Be Equal As Strings    ${deviceResetState}    Normal
	
F331_TC_API_13 Issue Power ON + UID ON
    [Tags]  powerOn
    Log to console and logfile  -Issue powerControl On
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${data} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=On
    ${body1} =   Create List     ${data}
    ${data} =   Create Dictionary   op=replace
    ...                             path=/uidState
    ...                             value=On
    ${body2} =   Create List     ${data}         
    ${body} =   combine lists   ${body1}    ${body2}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    Log to console and logfile  -Verify it's ON
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    Should Be Equal As Strings    ${powerState}    On
    Log to console and logfile  -Verify UID is On
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uidState} =    Get From Dictionary    ${ic[0]}    uidState
    Log To Console  ${uidState}
    Should Be Equal As Strings    ${uidState}    On


F331_TC_API_14 Issue Power OFF + UID ON
    [Tags]  powerOff
    Log to console and logfile  -Issue powerControl Off
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${data} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=Off
    ${body1} =   Create List     ${data}
    ${data} =   Create Dictionary   op=replace
    ...                             path=/uidState
    ...                             value=On
    ${body2} =   Create List     ${data}         
    ${body} =   combine lists   ${body1}    ${body2}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    Log to console and logfile  -Verify it's OFF
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    Should Be Equal As Strings    ${powerState}    Off
    Log to console and logfile  -Verify UID is On
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uidState} =    Get From Dictionary    ${ic[0]}    uidState
    Log To Console  ${uidState}
    Should Be Equal As Strings    ${uidState}    On
    #
    #
    Power On ICM    ${ICM_NAME}

F331_TC_API_15 Issue Power OFF + UID FLASH
    [Tags]  powerOff
    Log to console and logfile  -Issue powerControl Off
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${data} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=Off
    ${body1} =   Create List     ${data}
    ${data} =   Create Dictionary   op=replace
    ...                             path=/uidState
    ...                             value=Blinking
    ${body2} =   Create List     ${data}
    ${body} =   combine lists   ${body1}    ${body2}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    Log to console and logfile  -Verify it's OFF
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    Should Be Equal As Strings    ${powerState}    Off
    Log to console and logfile  -Verify UID is Blinking
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uidState} =    Get From Dictionary    ${ic[0]}    uidState
    Log To Console  ${uidState}
    Should Be Equal As Strings    ${uidState}    Blinking
    #
F331_TC_API_25: Perform UID operations when the ICM is in OFF state
    #
    UID on ICM    ${ICM_NAME}
    UID off ICM    ${ICM_NAME}
    #
    # Restore the ICM power state for next tests
    #
    Power On ICM    ${ICM_NAME}
    #
F331_TC_API_16 Issue ICM Reset + UID ON
    [Tags]  reset
    Log to console and logfile  -Issue ICM Reset
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${data} =   Create Dictionary   op=replace
    ...                             path=/deviceResetState
    ...                             value=Reset
    ${body1} =   Create List     ${data}
    ${data} =   Create Dictionary   op=replace
    ...                             path=/uidState
    ...                             value=On
    ${body2} =   Create List     ${data}
    ${body} =   combine lists   ${body1}    ${body2}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    Log to console and logfile  -Verify it's Reset
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${deviceResetState} =    Get From Dictionary    ${ic[0]}    deviceResetState
    Log To Console  ${deviceResetState}
    Should Be Equal As Strings    ${deviceResetState}    Normal
    Log to console and logfile  -Verify UID is On
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uidState} =    Get From Dictionary    ${ic[0]}    uidState
    Log To Console  ${uidState}
    Should Be Equal As Strings    ${uidState}    On


    #
    Power Off ICM    ${ICM_NAME}
    UID Off ICM    ${ICM_NAME}
    #
F331_TC_API_17 Issue Power ON + UID ON
    [Tags]  powerOn
    Log to console and logfile  -Issue powerControl On
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${data} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=On
    ${body1} =   Create List     ${data}
    ${data} =   Create Dictionary   op=replace
    ...                             path=/uidState
    ...                             value=On
    ${body2} =   Create List     ${data}         
    ${body} =   combine lists   ${body1}    ${body2}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    Log to console and logfile  -Verify it's On
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    Should Be Equal As Strings    ${powerState}    On
    Log to console and logfile  -Verify UID is On
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uidState} =    Get From Dictionary    ${ic[0]}    uidState
    Log To Console  ${uidState}
    Should Be Equal As Strings    ${uidState}    On

F331_TC_API_18 Issue Power OFF + UID FLASH
    [Tags]  poweroff
    Log to console and logfile  -Issue powerControl off
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${data} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=Off
    ${body1} =   Create List     ${data}
    ${data} =   Create Dictionary   op=replace
    ...                             path=/uidState
    ...                             value=Blinking
    ${body2} =   Create List     ${data}
    ${body} =   combine lists   ${body1}    ${body2}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    Log to console and logfile  -Verify it's OFF
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    Should Be Equal As Strings    ${powerState}    Off
    Log to console and logfile  -Verify UID is Blinking
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uidState} =    Get From Dictionary    ${ic[0]}    uidState
    Log To Console  ${uidState}
    Should Be Equal As Strings    ${uidState}    Blinking

    Power On ICM    ${ICM_NAME}
    #UID Off ICM    ${ICM_NAME}
    #
F331_TC_API_19 Issue ICM Reset + UID On
    [Tags]  poweroff
    Log to console and logfile  -Issue ICM Reset
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${data} =   Create Dictionary   op=replace
    ...                             path=/deviceResetState
    ...                             value=Reset
    ${body1} =   Create List     ${data}
    ${data} =   Create Dictionary   op=replace
    ...                             path=/uidState
    ...                             value=On
    ${body2} =   Create List     ${data}
    ${body} =   combine lists   ${body1}    ${body2}
    ${deviceResetState} =    Get From Dictionary    ${ic[0]}    deviceResetState
    Log To Console  ${deviceResetState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    Log to console and logfile  -Verify Reset state
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${deviceResetState} =    Get From Dictionary    ${ic[0]}    deviceResetState
    Log To Console  ${deviceResetState}
    Should Be Equal As Strings    ${deviceResetState}    Normal
    Log to console and logfile  -Verify UID is Blinking
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uidState} =    Get From Dictionary    ${ic[0]}    uidState
    Log To Console  ${uidState}
    Should Be Equal As Strings    ${uidState}    On

F331_TC_API_21 Issue multiple ICM Reset request one after the other and check the power state of the ICM
    [Tags]  powerOff
    Log to console and logfile  -Issue Multiple ICM Reset
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${data} =   Create Dictionary   op=replace
    ...                             path=/deviceResetState
    ...                             value=Reset
    ${body} =   Create List     ${data}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    Log to console and logfile  -Verify it's OFF
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    Should Be Equal As Strings    ${powerState}    On
    #
    # Issue second ICM reset request
    #
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    Log to console and logfile  -Verify it's OFF
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    Should Be Equal As Strings    ${powerState}    On

F331_TC_API_22 Issue Power OFF + Power ON
    [Tags]  powerOff
    Log to console and logfile  -Issue powerControl Off and On
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${data} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=Off
    ${body1} =   Create List     ${data}
    ${data} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=On
    ${body2} =   Create List     ${data}
    ${body} =   combine lists   ${body1}    ${body2}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    sleep   ${SLEEP_TIME}
    Log to console and logfile  -Verify it's On
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    Should Be Equal As Strings    ${powerState}    On

F331_TC_API_23 Issue Power ON + Power OFF
    [Tags]  powerOff
    Log to console and logfile  -Issue powerControl On and Off
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${uri} =    Get From Dictionary    ${ic[0]}    uri
    ${data} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=On
    ${body1} =   Create List     ${data}
    ${data} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=Off
    ${body2} =   Create List     ${data}         
    ${body} =   combine lists   ${body1}    ${body2}
    ${powerState} =    Get From Dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    ${resp} =   fusion api patch interconnect   body=${body}    uri=${uri}
    ${status_code} =    Get From dictionary    ${resp}    status_code
    Log To Console  ${status_code}
    Should Be Equal As Strings    ${status_code}    400
    ${message} =    Get From dictionary    ${resp}    message
    Log To Console  ${message}
    ${ic} =    Get IC Name    ${ICM_NAME}
    ${powerState} =    Get From dictionary    ${ic[0]}    powerState
    Log To Console  ${powerState}
    Should Be Equal As Strings    ${powerState}    On

F331_TC_API_25-1 Login as network user and check the allowed operations
    # 
    Fusion Api Login Appliance     ${APPLIANCE_IP}   ${network_login_details}
    Log to console and logfile  "\nChecking Power Off operation"
    ${State} =  Power Off ICM   ${ICM_NAME}
    Should Be Equal As Strings    ${State}  Off
    Log To Console  "\nChecking Power On operation"
    Set Test Message    Power ON the ICM
    ${State} =  Power On ICM    ${ICM_NAME}
    Should Be Equal As Strings    ${State}  On
    Log To Console  "\nChecking UID On operation"
    ${State} =  UID On ICM      ${ICM_NAME}
    Should Be Equal As Strings    ${State}  On
    Log To Console  "\nChecking UID Off operation"
    ${State} =  UID Off ICM     ${ICM_NAME}
    Should Be Equal As Strings    ${State}  Off
    Log To Console  "\nChecking UID FLASH operation"
    ${State} =  UID Flash ICM   ${ICM_NAME}
    Should Be Equal As Strings    ${State}  Blinking
    Log To Console  "\nChecking Reset operation"
    ${State} =  Reset ICM       ${ICM_NAME}
    Should Be Equal As Strings    ${State}  Normal
    # Restore UID for next operation
    UID On ICM      ${ICM_NAME}

F331_TC_API_25-2 Login as server user and check the allowed operations
    Fusion Api Login Appliance     ${APPLIANCE_IP}   ${server_login_details}
    Log to console and logfile  "\nChecking Power Off operation"
    Power Operation and check erros     ${ICM_NAME}     Off     On
    Log to console and logfile  "\nChecking Power on operation"
    Power Operation and check erros     ${ICM_NAME}     On     On
    Log To Console  "\nChecking UID On operation"
    UID Operation and check erros    ${ICM_NAME}     On     On
    Log To Console  "\nChecking UID Off operation"
    UID Operation and check erros    ${ICM_NAME}     Off     On

F331_TC_API_25-3 Login as storage user and check the allowed operations
    Fusion Api Login Appliance     ${APPLIANCE_IP}   ${storage_login_details}
    Log to console and logfile  "\nChecking Power Off operation"
    Power Operation and check erros     ${ICM_NAME}     Off     On
    Log to console and logfile  "\nChecking Power on operation"
    Power Operation and check erros     ${ICM_NAME}     On     On
    Log To Console  "\nChecking UID On operation"
    UID Operation and check erros    ${ICM_NAME}     On     On
    Log To Console  "\nChecking UID Off operation"
    UID Operation and check erros    ${ICM_NAME}     Off     On

F331_TC_API_26 Check the alert message of power actions
    #
    Fusion Api Login Appliance     ${APPLIANCE_IP}   ${login_details}
    #
    Remove All Alerts
    sleep    30
    Power Off ICM    ${ICM_NAME}
    sleep    30
    Check All Alert    ${ALERTMSG_ON}
    Power On ICM    ${ICM_NAME}
    sleep    30
    Check All Alert    ${ALERTMSG_OFF}
