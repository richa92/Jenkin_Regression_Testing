*** Settings ***
Documentation        Feature Test: F1048
...                  Updated test to include all network type: Ethernet Tunnel networks
...
Variables              data_variables.py
#Suite Setup           Run FTS and test-specific setup
#Suite Teardown        Suite Teardown
#Resource                ../../resources/resource.txt
Resource            ../../../resource/fusion_api_all_resource_files.txt
Library                Collections
Library                json
Library                OperatingSystem
Library                Selenium2Library
Library                apic.py
Test Setup             KC Load Test Data

*** Variables ***
${SSH_PASS}                     hpvse1
${DataFile}            ./OVAData.xml
${APPLIANCE_IP}                    15.212.137.16
${APIC_APPLIANCE_IP}            10.10.3.71


${RTtrue}                    True
${TLtrue}                     True
${RTfalse}                     False
${TLfalse}                     False
${LLDPDisabledIP}

${APIC_HOST}                     10.10.3.71
${APIC_USER}                    admin
${APIC_PASS}                    password
${POWER_STATE_OFF}    Off
${POWER_STATE_ON}        On
${enc_serial}        IRTQI6MH9D
${bay_2}                        2
${FUSION_NIC}                bond0
${FUSION_IP}                15.212.137.16
${FUSION_SSH_USERNAME}        root
${FUSION_SSH_PASSWORD}        hpvse1
${FUSION_PROMPT}            #
${FUSION_TIMEOUT}            10
${State_Power_Off}             Maintenance
${State_Configured}             Configured
${State_Efuse_Off}            Absent
${Value}                    15.212.137.0
${APIC_TOPOLOGY_li_1}                comp/prov-VMware/ctrlr-[Tbird_DVS]-10.10.3.74/hv-host-314
${li_1}                          LE-LIG
${lig_1}                        LIG
${APIC_IPList_disabled_li_1}    15.212.137.19,15.212.137.18
${APIC_IPList_enabled_li_1}        15.212.137.18
${APIC_IPList_Bay1Off_li_1}        15.212.137.19
${bay_1}             3
${ICM_1}                     IRTQI6MH9D, interconnect 3
${ICM_2}                     IRTQI6MH9D, interconnect 6

*** Test Cases ***

00 Appliance LogIn

    Fusion Api Login Appliance    ${APPLIANCE_IP}        ${admin_credentials}


01 First LIG-Edit LIG -EnableTaggedLldp - Update from Group - Validate LLDP Ip Address
    ${LLDPEnabledIP_li_1} =     Get ICM IPV4    ${ICM_1}
    Edit LIG    ${edit_ligs_tbird_SE_LIG['ligT']}    ${li_1}    ${LLDPEnabledIP_li_1}    ${TLtrue}
    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds        600 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}
    Validate Interconnects            ${ICM_1}    ${TLtrue}    ${LLDPEnabledIP_li_1}
    Validate Interconnects            ${ICM_2}    ${TLtrue}    ${LLDPEnabledIP_li_1}
    ${LLDPEnabledIP_IPv6_li_1} =    Get ICM IPV6    ${ICM_1}
    Validate Interconnects Ipv6        ${ICM_1}    ${TLtrue}    ${LLDPEnabledIP_IPv6_li_1}
    Validate Interconnects Ipv6        ${ICM_2}    ${TLtrue}    ${LLDPEnabledIP_IPv6_li_1}
    #Validation-after Enabling both LLDP tagging and Rich TLV in LIG
    #Verifying APIC Level Changes
    ${status}=            APIC LogIn and Validate Topology                  ${APIC_APPLIANCE_IP}          ${apic_admin_credentials}     ${APIC_TOPOLOGY_li_1}      ${APIC_IPList_enabled_li_1}
    run keyword if  '${status}'=='False'    Fail    'Toplogy did not match'
    Log to Console    !!!Waiting time to perform the leaf validations!!!
    Sleep    120
    #Validation APIC and Leaf validation
    ${status}=    leaf_validate   @{Testdata.SE_switches_taggedenabled_li_1}
    run keyword if    '${status}' == 'False'    Fail    'Management Ip Address mismatch at Leaf switch"

    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds        600 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}

02 First LIG-Edit LIG -DisableTaggedLldp - Update from Group - Validate LLDP Ip Address
    Edit LIG    ${edit_ligs_tbird_SE_LIG['ligF']}    ${li_1}    ${LLDPDisabledIP}    ${TLfalse}
    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}
    Validate Interconnects            ${ICM_1}        ${TLfalse}    ${LLDPDisabledIP}
    Validate Interconnects            ${ICM_2}        ${TLfalse}    ${LLDPDisabledIP}
    #Validation-Validate lldp IP Address in LIG after Disabling LLDP tagging
    Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
    ValidateLI LLDP Ip Address        ${li_1}    ${LLDPDisabledIP}

    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds        600 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}

03 FirstLI-Edit LI-EnableTaggedLldp - Validate LLDP Ip Address
    ${LLDPEnabledIP_li_1} =     Get ICM IPV4    ${ICM_1}
    Edit LI        ${li_1}    ${li_set1}        ${LLDPEnabledIP_li_1}    ${TLtrue}
    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}
    Validate Interconnects            ${ICM_1}        ${TLtrue}    ${LLDPEnabledIP_li_1}
    Validate Interconnects            ${ICM_2}        ${TLtrue}    ${LLDPEnabledIP_li_1}
    #Validate Interconnects IPv6
    ${LLDPEnabledIP_IPv6_li_1} =    Get ICM IPV6    ${ICM_1}
    Validate Interconnects Ipv6            ${ICM_1}    ${TLtrue}    ${LLDPEnabledIP_IPv6_li_1}
    Validate Interconnects Ipv6            ${ICM_2}    ${TLtrue}    ${LLDPEnabledIP_IPv6_li_1}
    #Validation-Validate lldp IP Address in LI,after Enabling LLDP tagging
    Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
    ValidateLI LLDP Ip Address        ${li_1}    ${LLDPEnabledIP_li_1}
    ValidateLI LLDP Ipv6 Address    ${li_1}    ${LLDPEnabledIP_IPv6_li_1}
    #Verifying APIC Level Changes
    ${status}=            APIC LogIn and Validate Topology                  ${APIC_APPLIANCE_IP}          ${apic_admin_credentials}     ${APIC_TOPOLOGY_li_1}      ${APIC_IPList_enabled_li_1}
    run keyword if  '${status}'=='False'    Fail    'Toplogy did not match'
    Log to Console    !!!Waiting time to perform the leaf validations!!!
    Sleep    120
    #Validation APIC and Leaf validation
    ${status}=    leaf_validate   @{Testdata.SE_switches_taggedenabled_li_1}
    run keyword if    '${status}' == 'False'    Fail    'Management Ip Address mismatch at Leaf switch"

    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds        600 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}

04 FirstLI-Edit LI-DisableTaggedLldp - Validate LLDP Ip Address
    #Editing the First Logical Interconnect-LE-LIG for LLDP Disabled
    Edit LI        ${li_1}    ${li_set3}        ${LLDPDisabledIP}    ${TLfalse}
    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}
    Validate Interconnects            ${ICM_1}        ${TLfalse}    ${LLDPDisabledIP}
    Validate Interconnects            ${ICM_2}        ${TLfalse}    ${LLDPDisabledIP}
    # Validation-Validate lldp IP Address in LI,after Enabling LLDP tagging
    Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
    ValidateLI LLDP Ip Address        ${li_1}    ${LLDPDisabledIP}

    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds        600 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}

05 FirstBaySet-Power Off Interconnect and verify the IP being updated
    Log to Console    Enabling Tagged LLDP at LI before Power off Action
    ${LLDPEnabledIP_li_1} =     Get ICM IPV4    ${ICM_1}
    Edit LI        ${li_1}    ${li_set1}        ${LLDPEnabledIP_li_1}    ${TLtrue}
    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}
    #Verify Interconnect Power state
    Verify Interconnect Power State     ${ICM_1}        ${POWER_STATE_ON}
    Verify Interconnect Power State     ${ICM_2}        ${POWER_STATE_ON}
    #Validate Interconnect
    Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
    Validate Interconnects            ${ICM_1}    ${TLtrue}    ${LLDPEnabledIP_li_1}
    Validate Interconnects            ${ICM_2}    ${TLtrue}     ${LLDPEnabledIP_li_1}
    #Validate Interconnects IPv6
    ${LLDPEnabledIP_IPv6_li_1} =    Get ICM IPV6    ${ICM_1}
    Validate Interconnects Ipv6            ${ICM_1}    ${TLtrue}    ${LLDPEnabledIP_IPv6_li_1}
    Validate Interconnects Ipv6            ${ICM_2}    ${TLtrue}    ${LLDPEnabledIP_IPv6_li_1}
    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds        600 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}
    POWER OFF ICM    ${ICM_1}
    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Power_Off}
    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}
    Verify Interconnect Power State     ${ICM_1}        ${POWER_STATE_OFF}
    Verify Interconnect Power State     ${ICM_2}        ${POWER_STATE_ON}
    Sleep    1 minutes 30 seconds
    #Validation-Validate lldp IP Address in LI,after Enabling LLDP tagging
    Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
    ${RECALCIP_li_1} =    Get ICM IPV4    ${ICM_2}
    ${RECALCIP_IPv6_li_1} =    Get ICM IPV6    ${ICM_2}
    ValidateLI LLDP Ip Address        ${li_1}    ${RECALCIP_li_1}
    ValidateLI LLDP Ipv6 Address    ${li_1}    ${RECALCIP_IPv6_li_1}
    #Validate Interconnect
    Validate Interconnects            ${ICM_2}    ${TLtrue}    ${RECALCIP_li_1}
    Validate Interconnects Ipv6            ${ICM_2}    ${TLtrue}    ${RECALCIP_IPv6_li_1}
    #APIC Validations after enabled the LLDP&Leaf Validation after  Power On
    ${status}=            APIC LogIn and Validate Topology                  ${APIC_APPLIANCE_IP}          ${apic_admin_credentials}     ${APIC_TOPOLOGY_li_1}      ${APIC_IPList_Bay1Off_li_1}
    run keyword if  '${status}'=='False'    Fail    'Topology did not match'
    #${status}=            APIC LogIn and Validate Topology                  ${APIC_APPLIANCE_IP}          ${apic_admin_credentials}     ${APIC_TOPOLOGY_li_1}      ${APIC_IPList_enabled_li_1}
    #run keyword if  '${status}'=='True'    Fail    'Unwanted topology deducted'
    Log to Console    !!!Waiting time to perform the leaf validations!!!
    Sleep    120
    ${status}=                leaf_validate            @{Testdata.SE_switches_poweroffbay1_li_1}
    run keyword if  '${status}'=='False'    Fail    'Management Ip Address mismatch at Leaf switch"
    Log to Console    !!!APIC Validations are completed !!!
    Log to Console  Test Step - 9 Completed
    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Power_Off}
    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}


06 FirstBaySet-Power_On interconnect and verify the Ip being updated
    Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
    POWER ON ICM        ${ICM_1}
    Sleep    60
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}
    Sleep    120
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}
    #Verify Interconnect Power state
    Verify Interconnect Power State     ${ICM_1}        ${POWER_STATE_ON}
    Verify Interconnect Power State     ${ICM_2}        ${POWER_STATE_ON}
    Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
    Sleep    60
    ${LLDPEnabledIP_li_1} =     Get ICM IPV4    ${ICM_1}
    ${LLDPEnabledIP_IPv6_li_1} =     Get ICM IPV6    ${ICM_1}
    ValidateLI LLDP Ip Address    ${li_1}    ${LLDPEnabledIP_li_1}
    ValidateLI LLDP Ipv6 Address    ${li_1}    ${LLDPEnabledIP_IPv6_li_1}
    Validate Interconnects            ${ICM_1}    ${TLtrue}    ${LLDPEnabledIP_li_1}
    Validate Interconnects            ${ICM_2}    ${TLtrue}    ${LLDPEnabledIP_li_1}
    Validate Interconnects Ipv6            ${ICM_1}    ${TLtrue}    ${LLDPEnabledIP_IPv6_li_1}
    Validate Interconnects Ipv6            ${ICM_2}    ${TLtrue}    ${LLDPEnabledIP_IPv6_li_1}
    #Verifying APIC Level Changes
    ${status}=            APIC LogIn and Validate Topology                  ${APIC_APPLIANCE_IP}          ${apic_admin_credentials}     ${APIC_TOPOLOGY_li_1}      ${APIC_IPList_enabled_li_1}
    run keyword if  '${status}'=='False'    Fail    'Toplogy did not match'
    Log to Console    !!!Waiting time to perform the leaf validations!!!
    Sleep    120
    #APIC Validations after enabled the LLDP
    ${status}=                leaf_validate            @{Testdata.SE_switches_taggedenabled_li_1}
    run keyword if  '${status}'=='False'    Fail    'Management Ip Address mismatch at Leaf switch"
    Log to Console    !!!APIC Validations are completed !!!
    Log to Console  Test Step - 10 Completed
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}

07 Privileges validation NetworkAdmin
    Fusion Api Login Appliance      ${APPLIANCE_IP}     ${network_admin}
    Log to console and logfile      Trying to Edit LIGandLI as NetworkAdmin user Should be allowed
    ${LLDPEnabledIP_li_1} =     Get ICM IPV4    ${ICM_1}
    Edit LIG    ${edit_ligs_tbird_SE_LIG['ligT']}    ${li_1}    ${LLDPEnabledIP_li_1}    ${TLtrue}
    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds        600 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}
    Validate Interconnects            ${ICM_1}        ${TLtrue}    ${LLDPEnabledIP_li_1}
    Validate Interconnects            ${ICM_2}        ${TLtrue}    ${LLDPEnabledIP_li_1}
    ${LLDPEnabledIP_IPv6_li_1} =     Get ICM IPV6    ${ICM_1}
    Validate Interconnects Ipv6            ${ICM_1}    ${TLtrue}    ${LLDPEnabledIP_IPv6_li_1}
    Validate Interconnects Ipv6            ${ICM_2}    ${TLtrue}    ${LLDPEnabledIP_IPv6_li_1}
    #Validation-after Enabling both LLDP tagging in LIG
    #Verifying APIC Level Changes
    ${status}=            APIC LogIn and Validate Topology                  ${APIC_APPLIANCE_IP}          ${apic_admin_credentials}     ${APIC_TOPOLOGY_li_1}      ${APIC_IPList_enabled_li_1}
    run keyword if  '${status}'=='False'    Fail    'Toplogy did not match'
    Sleep    120
    #Validation APIC and Leaf validation
    ${status}=    leaf_validate    @{Testdata.SE_switches_taggedenabled_li_1}
    run keyword if    '${status}' == 'False'    Fail    'Management Ip Address mismatch at Leaf switch"
    Log to Console    !!!Privilges validated for Network Admin User!!!
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}

08 Privileges validation StorageAdmin
    Fusion Api Login Appliance      ${APPLIANCE_IP}     ${storage_admin}
    ${body} =    Build LIG body      ${edit_ligs_tbird_SE_LIG['ligT']}
    Log to Console      Trying to Edit LIG for storageAdmin user Should not be allowed
    ${lig} =    Get LIG Member    ${LIG1}
    ${lig_uri} =    Get LIG Uri    ${LIG1}
    ${resp} =    Fusion Api Edit LIG    body=${body}    uri=${lig_uri}
    ${valDict} =    Create Dictionary    status_code=${401}
    Validate Response    ${resp}    ${valDict}
    Log to console and logfile    \nSuccessfully StorageAdmin EditLIG with Taggedlldp User has no privilege
    Log to console and logfile       \nTrying to Edit LI for storageAdmin user Should not be allowed
    ${body} =    Build LI body    ${li_set1}
    ${li_uri} =    Get LI URI    ${li_1}
    ${resp} =    Fusion Api Get Li    ${li_uri}
    Log    ${resp}
    ${es} =     Get From Dictionary     ${resp}    ethernetSettings
    ${uri} =    Get From Dictionary     ${es}       uri
    ${id} =     Get From Dictionary     ${es}       id
    Log     ${id}
    Set to Dictionary    ${body}    id    ${id}
    Log    ${body}
    ${resp1} =    Fusion Api Update LI Ethernet Settings    body=${body}        uri=${li_uri}
    ${valDict} =    Create Dictionary    status_code=${401}
    Validate Response    ${resp1}    ${valDict}
    Fusion Api Logout Appliance
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}

09 Privileges validation ServerAdmin
    Fusion Api Login Appliance    ${APPLIANCE_IP}    ${server_admin}
    ${body} =    Build LIG body      ${edit_ligs_tbird_ME_LIG['ligT']}
    Log to Console      Trying to Edit LIG for ServerAdmin user Should not be allowed
    ${lig} =        Get LIG Member      ${LIG1}
    ${lig_uri} =    Get LIG Uri         ${LIG1}
    ${resp} =     Fusion Api Edit LIG    body=${body}        uri=${lig_uri}
    ${valDict} =    Create Dictionary    status_code=${401}
    Validate Response    ${resp}    ${valDict}
    Log to console and logfile    \nSuccessfully ServerAdmin EditLIG with Taggedlldp User has no privilege
    Log to console and logfile       \nTrying to Edit LI for ServerAdmin user Should not be allowed
    ${body} =    Build LI body    ${li_set1}
    ${li_uri} =     Get LI URI    ${li_1}
    ${resp} =    Fusion Api Get Li    ${li_uri}
    Log    ${resp}
    ${es} =     Get From Dictionary     ${resp}     ethernetSettings
    ${uri} =    Get From Dictionary     ${es}       uri
    ${id} =     Get From Dictionary     ${es}       id
    Log     ${id}
    Set to Dictionary    ${body}    id     ${id}
    Log    ${body}
    ${resp1} =    Fusion Api Update LI Ethernet Settings    body=${body}        uri=${li_uri}
    ${valDict} =    Create Dictionary    status_code=${401}
    Validate Response   ${resp1}    ${valDict}
    Fusion Api Logout Appliance
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}

10 Privileges validation ServerAdmin
    Fusion Api Login Appliance    ${APPLIANCE_IP}    ${server_admin}
    ${body} =    Build LIG body      ${edit_ligs_tbird_SE_LIG['ligT']}
    Log to Console      Trying to Edit LIG for ServerAdmin user Should not be allowed
    ${lig} =        Get LIG Member      ${LIG1}
    ${lig_uri} =    Get LIG Uri         ${LIG1}
    ${resp} =     Fusion Api Edit LIG    body=${body}        uri=${lig_uri}
    ${valDict} =    Create Dictionary    status_code=${401}
    Validate Response    ${resp}    ${valDict}
    Log to console and logfile    \nSuccessfully ServerAdmin EditLIG with Taggedlldp User has no privilege
    Log to console and logfile       \nTrying to Edit LI for ServerAdmin user Should not be allowed
    ${body} =    Build LI body    ${li_set1}
    ${li_uri} =     Get LI URI    ${li_1}
    ${resp} =    Fusion Api Get Li    ${li_uri}
    Log    ${resp}
    ${es} =     Get From Dictionary     ${resp}     ethernetSettings
    ${uri} =    Get From Dictionary     ${es}       uri
    ${id} =     Get From Dictionary     ${es}       id
    Log     ${id}
    Set to Dictionary    ${body}    id     ${id}
    Log    ${body}
    ${resp1} =    Fusion Api Update LI Ethernet Settings    body=${body}        uri=${li_uri}
    ${valDict} =    Create Dictionary    status_code=${401}
    Validate Response   ${resp1}    ${valDict}
    Fusion Api Logout Appliance
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}

11 Privileges validation backupAdmin
    Fusion Api Login Appliance      ${APPLIANCE_IP}     ${backup_admin}
    ${body} =    Build LIG body      ${edit_ligs_tbird_SE_LIG['ligT']}
    Log to Console      Trying to Edit LIG for backupAdmin user Should not be allowed
    ${lig} =        Get LIG Member      ${LIG1}
    ${lig_uri} =    Get LIG Uri         ${LIG1}
    ${resp} =     Fusion Api Edit LIG    body=${body}        uri=${lig_uri}
    ${valDict} =    Create Dictionary    status_code=${401}
    Validate Response    ${resp}     ${valDict}
    Log to console and logfile    \nSuccessfully backupAdmin EditLIG with Taggedlldp User has no privilege
    Log to console and logfile       \nTrying to Edit LI for backupAdmin user Should not be allowed
    ${body} =    Build LI body    ${li_set1}
    ${li_uri} =     Get LI URI    ${li_1}
    ${resp} =    Fusion Api Get Li    ${li_uri}
    Log    ${resp}
    ${es} =     Get From Dictionary     ${resp}     ethernetSettings
    ${uri} =    Get From Dictionary     ${es}       uri
    ${id} =     Get From Dictionary     ${es}       id
    Log     ${id}
    Set to Dictionary    ${body}    id     ${id}
    Log    ${body}
    ${resp1} =    Fusion Api Update LI Ethernet Settings    body=${body}        uri=${li_uri}
    ${valDict} =    Create Dictionary    status_code=${401}
    Validate Response    ${resp1}    ${valDict}
    Fusion Api Logout Appliance
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}

12 FirstBaySet-EFUSE_ON interconnect and verify the Ip being updated

    Log to Console    Enabling Tagged LLDP at LI before EfuseOn Action
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}
    ${LLDPEnabledIP_li_1} =     Get ICM IPV4    ${ICM_1}
    Edit LI        ${li_1}    ${li_set1}        ${LLDPEnabledIP_li_1}    ${TLtrue}
    Log to Console    !!!Test Step 5 successfully verified LLDP Tagging and  can be Enabled!!!
    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}
    #Validate Interconnect
    Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
    Validate Interconnects            ${ICM_1}    ${TLtrue}    ${LLDPEnabledIP_li_1}
    Validate Interconnects            ${ICM_2}    ${TLtrue}     ${LLDPEnabledIP_li_1}
    #Validate Interconnects IPv6
    ${LLDPEnabledIP_IPv6_li_1} =     Get ICM IPV6    ${ICM_1}
    Validate Interconnects Ipv6            ${ICM_1}    ${TLtrue}    ${LLDPEnabledIP_IPv6_li_1}
    Validate Interconnects Ipv6            ${ICM_2}    ${TLtrue}    ${LLDPEnabledIP_IPv6_li_1}
    Log to Console    !!!Test Step 5 is completed Successfully!!!
    EFUSE ON ICM        ${bay_1}   ${enc_serial}    ${ICM_1}
    Sleep    3 minutes 30 seconds
    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Efuse_Off}
    Wait Until Keyword Succeeds    600 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}
    #Validation-Validate lldp IP Address in LI,after Enabling LLDP tagging
    Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
    ${RECALCIP_li_1} =     Get ICM IPV4    ${ICM_2}
    ${RECALCIP_IPv6_li_1} =     Get ICM IPV6    ${ICM_2}
    ValidateLI LLDP Ip Address        ${li_1}    ${RECALCIP_li_1}
    ValidateLI LLDP Ipv6 Address    ${li_1}    ${RECALCIP_IPv6_li_1}
    #Validate Interconnect
    Validate Interconnects            ${ICM_2}    ${TLtrue}    ${RECALCIP_li_1}
    Validate Interconnects Ipv6            ${ICM_2}    ${TLtrue}    ${RECALCIP_IPv6_li_1}
    #Verifying APIC Level Changes
    ${status}=            APIC LogIn and Validate Topology                  ${APIC_APPLIANCE_IP}          ${apic_admin_credentials}     ${APIC_TOPOLOGY_li_1}      ${APIC_IPList_Bay1Off_li_1}
    run keyword if    '${status}'=='False'    Fail    'Topology did not match'
    #${status}=            APIC LogIn and Validate Topology                  ${APIC_APPLIANCE_IP}          ${apic_admin_credentials}     ${APIC_TOPOLOGY_li_1}      ${APIC_IPList_enabled_li_1}
    #run keyword if  '${status}'=='True'    Fail    'Unwanted topology deducted'
    Log to Console    !!!Waiting time to perform the leaf validations!!!
    Sleep    120
    #APIC Validations after enabled the LLDP&Leaf Validation after  Efuse On
    ${status}=                leaf_validate            @{Testdata.SE_switches_poweroffbay1_li_1}
    run keyword if    '${status}'=='False'    Fail    'Management Ip Address mismatch at Leaf switch"
    Sleep    120
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}


13 FirstBaySet-EFUSE_OFF interconnect and verify the Ip being updated
    Log to Console    Enabling Tagged LLDP at LI before EfuseON Action
    Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
    EFUSE OFF ICM       ${bay_1}    ${enc_serial}    ${ICM_1}
    Sleep   1 minutes 1 seconds
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}
    Sleep    120
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_1}    ${State_Configured}
    Wait Until Keyword Succeeds    2400 s    10 s    Verify Interconnect State    ${ICM_2}    ${State_Configured}
    Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
    ${LLDPEnabledIP_li_1} =     Get ICM IPV4    ${ICM_1}
    ${LLDPEnabledIP_IPv6_li_1} =     Get ICM IPV6    ${ICM_1}
    ValidateLI LLDP Ip Address    ${li_1}    ${LLDPEnabledIP_li_1}
    ValidateLI LLDP Ipv6 Address    ${li_1}    ${LLDPEnabledIP_IPv6_li_1}
    Validate Interconnects            ${ICM_1}    ${TLtrue}    ${LLDPEnabledIP_li_1}
    Validate Interconnects            ${ICM_2}    ${TLtrue}    ${LLDPEnabledIP_li_1}
    Validate Interconnects Ipv6            ${ICM_1}    ${TLtrue}    ${LLDPEnabledIP_IPv6_li_1}
    Validate Interconnects Ipv6            ${ICM_2}    ${TLtrue}    ${LLDPEnabledIP_IPv6_li_1}
    #Verifying APIC Level Changes
    ${status}=            APIC LogIn and Validate Topology                  ${APIC_APPLIANCE_IP}          ${apic_admin_credentials}     ${APIC_TOPOLOGY_li_1}      ${APIC_IPList_enabled_li_1}
    run keyword if    '${status}'=='False'    Fail    'Toplogy did not match'
    Log to Console    !!!Waiting time to perform the leaf validations!!!
    Sleep    120
    #APIC Validations after enabled the LLDP
    ${status}=                leaf_validate            @{Testdata.SE_switches_taggedenabled_li_1}
    run keyword if    '${status}'=='False'    Fail    'Management Ip Address mismatch at Leaf switch"



    Fusion Api Logout Appliance

*** Keywords ***
KC Load Test Data
    Set Log Level    TRACE
    Load Test Data  ${DataFile}


Get IC
    [Arguments]        ${ICM_NAME}
    ${resp} =   fusion api get interconnect
    Log        ${resp}
    ${ics} =     Get From Dictionary     ${resp}    members
    ${l} =     Get Length    ${ics}
    :FOR    ${x}    IN RANGE    0    ${l}
    \   ${ic} =     Get From List   ${ics}    ${x}
    \     Exit For Loop If     '${ic['name']}' == '${ICM_NAME}'
    [Return]    ${ic}


Get ICM IPV4
    [Arguments]        ${ICM_NAME}
    Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
    ${ic} =    Get IC        ${ICM_NAME}
    ${Ipv4_Address} =    Get Variable Value    ${ic['ipAddressList'][0]['ipAddress']}
    [Return]    ${Ipv4_Address}

Get ICM IPV6
    [Arguments]        ${ICM_NAME}
    Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
    ${ic} =    Get IC        ${ICM_NAME}
    ${Ipv6_Address} =    Get Variable Value    ${ic['ipAddressList'][1]['ipAddress']}
    [Return]    ${Ipv6_Address}

Validate Interconnects
    [Arguments]        ${ICM_NAME}        ${ltlv}        ${LLDPIP}
    Log to console and logfile    Validating Interconnects for lldpipV4 of ${ICM_NAME}
    ${ic} =     Get IC        ${ICM_NAME}
    ${enableTaggedLldp} =         Get From IC    ${ic}   enableTaggedLldp
    ${lldpip} =                Get from IC     ${ic}        lldpIpv4Address
    Should be Equal as Strings    ${enableTaggedLldp}        ${ltlv}
    Should be Equal as Strings    ${lldpip}        ${LLDPIP}
    Log to console and logfile    Actual lldpipV4 <${lldpip}> compared with Expected lldpipV4 <${LLDPIP}> for ${ICM_NAME}

Build SUBNET Body
      [Arguments]       ${subnet}       ${SUBNET_SELECT}
      Log                 "Deba ":${subnet}
      ${subnet_ret}=     Create Dictionary
      :For  ${subnetdetails}  IN   @{subnet}
      \        Log         ${subnetdetails}
      \     ${networkId} =   Get From Dictionary   ${subnetdetails}  networkId
      \        Log            ${networkId}
      \        Log            ${SUBNET_SELECT}
      \        Run Keyword If    '${networkId}'!='${SUBNET_SELECT}'        Continue For Loop
      \        Log             "Deba Matching ":${subnetdetails}
      \        ${subnet_ret}=        Copy Dictionary        ${subnetdetails}
      Log         "Deb Subnet_ret":${subnet_ret}
      [Return]    ${subnet_ret}

Build IPRange Body
      [Arguments]       ${ipv4ranges}       ${NETWORK_ID}        ${RANGE_NAME}
      ${subnets}=    Get Subnet        ${NETWORK_ID}
      ${uri}=         Get from Subnet         ${subnets}              uri
      ${ipv4_1}=  Create List
      :For  ${ipv4}  IN   @{ipv4ranges}
      \           ${name} =   Get From Dictionary   ${ipv4}  name
      \           #Log            ${name}
      \              #Log             ${RANGE_NAME}
      \           Run Keyword If    '${name}'!='${RANGE_NAME}'        Continue For Loop
      \              #Log            ${uri}
      \           Set to dictionary            ${ipv4}             subnetUri=${uri}
      \              #Log            ${ipv4}
      \           Append to List    ${ipv4_1}        ${ipv4}
      [Return]   ${ipv4_1}


Get Subnet
    [Arguments]             ${NETWORK_ID}
    ${resp} =   fusion api get ipv4 subnet
    ${subnetcounts} =     Get From Dictionary     ${resp}    members
    ${l} =     Get Length    ${subnetcounts}
    :FOR    ${x}    IN RANGE    0    ${l}
    \   ${subnet} =     Get From List   ${subnetcounts}    ${x}
    \    Exit For Loop If     '${subnet['networkId']}' == '${NETWORK_ID}'
    [Return]    ${subnet}


Get from Subnet
    [Arguments]     ${subnet_list}       ${element}
    ${return} =     Get From Dictionary     ${subnet_list}            ${element}
    [Return]    ${return}


Create EG Body with Associate Range
    [Documentation]    Adds Enclosure Group to an appliance from a variable which contains a list of dicts with the entire payload and also Associate a Range
    [Arguments]        ${enc_groups}        ${enc_group_name}    ${rangeuri}
    #[Arguments]        ${networks}        ${networkname}    ${NETWORK_ID}
    Log        ${enc_group_name}
    Log        ${enc_groups}
    Log        ${rangeuri}
    Log to console and logfile      Adding ENCLOSURE GROUP
    :FOR    ${enc_group1}    IN    @{enc_groups}
    \        ${enc_group_name1} =        Get From Dictionary        ${enc_group1}        name
    \        Log     ${enc_group_name1}
    \        Run Keyword If    '${enc_group_name1}'!='${enc_group_name}'        Continue For Loop
    \        Set to dictionary            ${enc_group1}             ipRangeUris=${rangeuri}
    \        ${enc_group_body}=    Copy Dictionary     ${enc_group1}
    \        Log        ${enc_group_body}
    Log to console and logfile      EDITING LIG GROUP
    ${l} =     Get Length    ${enc_group_body['interconnectBayMappings']}
    :FOR     ${x}    IN RANGE    0    ${l}
    \    ${liguri} =     Get From Dictionary    ${enc_group_body['interconnectBayMappings'][${x}]}    logicalInterconnectGroupUri
    \    Log to console and logfile      EDITING LIG GROUP:${liguri}
    \   Continue For Loop If    '${liguri}' == 'None'
    \    ${liguri} =     Common URI Lookup by name    ${liguri}
    \    Log to console and logfile      EDITING LIG GROUP1:${liguri}
    \    Set to dictionary    ${enc_group_body['interconnectBayMappings'][${x}]}    logicalInterconnectGroupUri        ${liguri}
    \    Log to console and logfile      EDITING LIG GROUP Body:${enc_group_body}
    [Return]    ${enc_group_body}




Build LI SPP body
    [Arguments]        ${li_spp}
    ${liedit} =     Copy Dictionary    ${li_spp}
    ${command} =                       Get Variable Value  ${li_spp['command']}
    ${sppUri} =           Get Variable Value  ${li_spp['sppUri']}
    ${force} =              Get Variable Value  ${li_spp['force']}


    ${body} =     Fusion Api Create LI spp Body    command=${command}
    ...                                         sppUri=${sppUri}
    ...                                         force=${force}
    ...
    [Return]    ${body}

APIC INVENTORY SYNC
    [Documentation]    issues a inventory synch at APIC
    [Arguments]           ${APIC_HOST}    ${APIC_USER}        ${APIC_PASS}
    Open Connection     ${APIC_HOST}     timeout=20s
    Login               ${APIC_USER}     ${APIC_PASS}
    Write    cd /aci/vm-networking/policies/vmware/vmm-domains/Tbird_DVS/controllers/10.10.3.74
    Write    bash
    Read Until    admin@apic1:10.10.3.74>
    Write    moset inventory-trigger-state triggered
    Sleep         10secs
    Log to console and logfile            Triggering inventory re-synch at APIC nodes
    Write    moconfig commit
    Sleep         15secs
    Close All Connections
    Sleep         40secs

APIC LogIn and Validate FabricNodes
    [Arguments]        ${APIC_APPLIANCE_IP}        ${apic_admin_credentials}        ${IPList}
    APIC INVENTORY SYNC                ${APIC_HOST}    ${APIC_USER}        ${APIC_PASS}
    Log to console        Wait time for APIC to reflect CRM changes
    ${token} =         Fusion Apic Api Login Appliance         ${APIC_APPLIANCE_IP}        ${apic_admin_credentials}
    ${apic_ip} =    Get Variable Value    ${apic_ip}
    ${status} =         Fusion Apic Get fabricNodes         ${APIC_APPLIANCE_IP}        ${token}    ${IPList}
    run keyword if  '${status}'=='False'    Fail    'fabricNodes information did not match'

APIC LogIn and Validate Topology
    [Arguments]     ${APIC_APPLIANCE_IP}        ${apic_admin_credentials}       ${APIC_TOPOLOGY}        ${NODE_IP}
    APIC INVENTORY SYNC             ${APIC_HOST}    ${APIC_USER}        ${APIC_PASS}
    Log to console      Wait time for APIC to reflect CRM changes
    ${token} =      loginApic       ${APIC_APPLIANCE_IP}        ${apic_admin_credentials}
    ${apic_ip} =    Get Variable Value  ${apic_ip}
    ${status} =         validate_Apic_topology     ${APIC_APPLIANCE_IP}        ${token}    ${APIC_TOPOLOGY}     ${NODE_IP}
    [Return]    ${status}

Edit LIG
    [Arguments]        ${lig}    ${li}    ${LLDPIP}    ${ltlv}
    Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
    ${body} =   Build LIG body      ${lig}
    ${lig} =         Get LIG Member      ${LIG1}
    ${lig_uri} =    Get LIG Uri         ${LIG1}
    ${resp} =     Fusion Api Edit LIG    body=${body}        uri=${lig_uri}
    Log to console and logfile    ${resp}
    ${task} =    Wait For Task     ${resp}     120s
    ${valDict} =     Create Dictionary    status_code=${200}
    ...                                 taskState=Completed
    Validate Response    ${task}    ${valDict}
    Perform an Update From Group    ${li}    120 min        1 min
    ValidateLI LLDP Ip Address    ${li}    ${LLDPIP}
    ValidateLI TaggedLLDP and RICH TLV        ${li}    ${ltlv}

Edit LIG1
    [Arguments]        ${lig}    ${li}    ${LLDPIP}    ${ltlv}
    Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
    ${body} =   Build LIG body      ${lig}
    ${lig} =         Get LIG Member      ${LIG2}
    ${lig_uri} =    Get LIG Uri         ${LIG2}
    ${resp} =     Fusion Api Edit LIG    body=${body}        uri=${lig_uri}
    Log to console and logfile    ${resp}
    ${task} =    Wait For Task     ${resp}     120s
    ${valDict} =     Create Dictionary    status_code=${200}
    ...                                 taskState=Completed
    Validate Response    ${task}    ${valDict}
    Perform an Update From Group    ${li}    120 min        1 min
    ValidateLI LLDP Ip Address    ${li}    ${LLDPIP}
    ValidateLI TaggedLLDP and RICH TLV        ${li}    ${ltlv}

Edit LI
    [Arguments]        ${li}    ${li_set1}    ${LLDPIP}    ${ltlv}
    Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
    ${body} =    Build LI body    ${li_set1}
    ${li_uri} =     Get LI URI   ${li}
    ${resp} =     Fusion Api Get Li    ${li_uri}
    Log   ${resp}
    ${es} =     Get From Dictionary        ${resp}    ethernetSettings
    ${uri} =     Get From Dictionary        ${es}        uri
    ${id} =     Get From Dictionary        ${es}        id
    Log        ${id}
    Set to Dictionary    ${body}    id    ${id}
    Log   ${body}
    ${resp1} =     Fusion Api Update LI Ethernet Settings    body=${body}        uri=${li_uri}
    Log   ${resp1}
    ${task} =    Wait For Task     ${resp1}     600s
    ${valDict} =     Create Dictionary    status_code=${200}
    ...                                 taskState=Completed
    Validate Response    ${task}    ${valDict}
    ValidateLI LLDP Ip Address    ${li}    ${LLDPIP}
    ValidateLI TaggedLLDP and RICH TLV    ${li}    ${ltlv}

ValidateLI TaggedLLDP and RICH TLV
    [Arguments]     ${li}   ${ltlv}
    ${li_uri} =     Get LI URI   ${li}
    ${getresp} =    Fusion Api Get Li   ${li_uri}
    Log     ${getresp}
    ${es} =     Get From Dictionary     ${getresp}  ethernetSettings
    ${LLDPTLV} =    Get From Dictionary     ${es}   enableTaggedLldp
    Should Be Equal As Strings    ${ltlv}    ${LLDPTLV}
    Log to console and logfile    Tagged LLDP <${ltlv}> compared with TaggedLldp <${LLDPTLV}>

Build LI body
    [Arguments]        ${liedit}
    ${liedit} =     Copy Dictionary    ${liedit}
    ${type} =                       Get Variable Value  ${liedit['type']}
    ${enableTaggedLldp} =              Get Variable Value  ${liedit['enableTaggedLldp']}
    ${body} =     Create Dictionary                type=${type}
    ...                                         enableTaggedLldp=${enableTaggedLldp}
    ...
    [Return]    ${body}

ValidateLI LLDP Ip Address
    [Arguments]        ${li}    ${LLDPIP}
    ${li_uri} =    Get LI URI    ${li}
    ${resp} =     Fusion Api Get Li    ${li_uri}
    ${es} =     Get From Dictionary        ${resp}    ethernetSettings
    ${ip} =     Get From Dictionary        ${es}    lldpIpv4Address
    ${status} =    Should Be Equal    ${ip}    ${LLDPIP}
    run keyword if    '${status}'=='False'    Fail    "LLDP Ip Address is not calculated in correct manner"
    Log to console and logfile    Actual lldpipV4 <${ip}> compared with Expected lldpipV4 <${LLDPIP}> for ${li}

ValidateLI LLDP Ipv6 Address
    [Arguments]        ${li}    ${LLDPIP}
    ${li_uri} =     Get LI URI   ${li}
    ${resp} =     Fusion Api Get Li    ${li_uri}
    ${es} =     Get From Dictionary        ${resp}    ethernetSettings
    ${ip} =     Get From Dictionary        ${es}    lldpIpv6Address
    ${status} =    Should Be Equal    ${ip}    ${LLDPIP}
    run keyword if    '${status}'=='False'    Fail    "LLDP Ip Address is not calculated in correct manner"
    Log to console and logfile    Actual lldpipV6 <${ip}> compared with Expected lldpipV6 <${LLDPIP}> for ${li}

Validate Interconnects1
    [Arguments]        ${ICM_NAME}        ${ltlv}        ${LLDPIP}
    Log to console and logfile    Validating Interconnects for lldpipV4 of ${ICM_NAME}
    ${ic} =     Get IC        ${ICM_NAME}
    ${enableTaggedLldp} =         Get From IC    ${ic}   enableTaggedLldp
    ${lldpip} =                Get from IC     ${ic}        lldpIpv4Address
    Should be Equal as Strings    ${enableTaggedLldp}        ${ltlv}
    Should be Equal as Strings    ${lldpip}        ${LLDPIP}
    Log to console and logfile    Actual lldpipV4 <${lldpip}> compared with Expected lldpipV4 <${LLDPIP}> for ${ICM_NAME}

Validate Interconnects Ipv6
    [Arguments]        ${ICM_NAME}        ${ltlv}        ${LLDPIP_IPv6}
    Log to console and logfile    Validating Interconnects for TaggedLLDP of ${ICM_NAME}
    ${ic} =     Get IC        ${ICM_NAME}
    ${enableTaggedLldp} =         Get From IC    ${ic}   enableTaggedLldp
    ${lldpip} =                Get from IC     ${ic}        lldpIpv6Address
    Should be Equal as Strings    ${enableTaggedLldp}        ${ltlv}
    Should be Equal as Strings    ${lldpip}        ${LLDPIP_IPv6}
    Log to console and logfile    Actual lldpipV6 <${lldpip}> compared with Expected lldpipV6 <${LLDPIP_IPv6}> for ${ICM_NAME}

Perform an Update From Group
    [Arguments]        ${li}=${LE}-${LIG1}    ${timeout}=10 min     ${interval}=15s
    ${li_uri} =     Get LI URI   ${li}
    ${resp} =         Fusion Api Update from group    ${li_uri}
    ${task} =        Wait For Task     ${resp}     ${timeout}        ${interval}
    ${valDict} =     Create Dictionary    status_code=${200}
    ...                                 taskState=Completed
    Validate Response    ${task}    ${valDict}


POWER OFF ICM
    [Arguments]        ${ICM_NAME}
    Log to console and logfile  -Issue powerControl Off
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =     Get IC                  ${ICM_NAME}
    ${uri} =    Get From IC     ${ic}   uri
    Log to console    \n${uri}
    ${body} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=Off
    ${body} =   Create list     ${body}
    ${resp}        fusion api patch interconnect    body=${body}    uri=${uri}
    Log to console    \n${resp}
    sleep   90s


POWER ON ICM
    [Arguments]        ${ICM_NAME}
    Log to console and logfile  -Issue powerControl On
    Run Keyword and Ignore Error    Write To ciDebug Log
    ${ic} =     Get IC                  ${ICM_NAME}
    ${uri} =    Get From IC     ${ic}   uri
    Log to console    \n${uri}
    ${body} =   Create Dictionary   op=replace
    ...                             path=/powerState
    ...                             value=On
    ${body} =   Create list     ${body}
    ${resp}        fusion api patch interconnect    body=${body}    uri=${uri}
    Log to console    \n${resp}
    sleep   90s

Verify Interconnect Power State
    [Arguments]        ${ICM_NAME}        ${POWER_STATE}
    Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
    Log to console and logfile  -Verify Power status
    ${ic} =     Get IC                  ${ICM_NAME}
    ${powerState} =     Get From IC    ${ic}   powerState
    Should Be Equal As Strings    ${powerState}    ${POWER_STATE}
    Log to console    \n\nPower State of the ICM is ${ICM_NAME}:${powerState}

Verify Interconnect State

    Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
    [Arguments]        ${ICM_1}        ${POWER_STATE}
    ${ic} =        Get IC        ${ICM_1}
    ${State} =    Get From IC        ${ic}    state
    Log to console and logfile        \tICM state is ${ICM_1}:${State}
    Should Be Equal As Strings    ${State}    ${POWER_STATE}


EFUSE ON ICM
        [Arguments]            ${bay}        ${enc_serial}      ${ICM_NAME}
        Open Connection And Log In      ${APPLIANCE_IP}
        ${EM_IP} =        Get EM IP
        Log to console    ${EM_IP}
        ${EM_TOKEN} =        Get EM Token    ${enc_serial}
        Log to console    ${EM_TOKEN}
        Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
        ${ic} =     Get IC                  ${ICM_NAME}
        ${uri} =    Get From IC     ${ic}   uri
        Log to console    ${uri}
        EFuse ICM   EFuseOn    ${bay}
        Log to console and logfile            \tWaiting for ICM in Bay:${bay} to reach state:Absent
        #Wait Until Keyword Succeeds     10 min   5s      IC reached state    ${ic['uri']}    Absent
        Wait Until Keyword Succeeds    600 s   10 s    Verify Interconnect State    ${ICM_NAME}    Absent


EFUSE OFF ICM
        [Arguments]            ${bay}        ${enc_serial}      ${ICM_NAME}
        Open Connection And Log In      ${APPLIANCE_IP}
        ${EM_IP} =        Get EM IP
        Log to console    ${EM_IP}
        ${EM_TOKEN} =        Get EM Token    ${enc_serial}
        Log to console    ${EM_TOKEN}
        ${ic} =     Get IC                  ${ICM_NAME}
        ${uri} =    Get From IC     ${ic}   uri
        Log to console    ${uri}
        EFuse ICM   EFuseOff    ${bay}
        Log to console and logfile            \tWaiting for ICM in Bay:${bay} to reach state:Configured|Monitored
        Wait Until Keyword Succeeds     30 min   5s      IC reached state    ${ic['uri']}    Configured|Monitored
        #EFuse ICM   EFuseOff    ${bay}    ${EM_IP}    ${EM_TOKEN}        ${FUSION_NIC}

Get EM IP
    Set Log Level    TRACE
    # Get EM IP
    # TODO:  going to need to see how this works with multiple EM's
    log to console    \n\nHELLO
    ${EM_IP} =        Execute Command        lldpcli show neighbor
    ${m}    ${EM_IP} =  Should Match Regexp     ${EM_IP}    (?im)MgmtIP:\\s*(\\S*:\\S*:\\S*:\\S*:\\S*:\\S*)
    #${m}    ${EM_IP} =  Should Match    ${EM_IP}    "fe80::377d:ba56:25b8:44d4"
    Set Suite Variable    ${EM_IP}
    log to console     EM IP: ${EM_IP}
    [Return]    ${EM_IP}

Get EM Token
    [Arguments]     ${enc_serial}
    # Get EM token
    ${EM_TOKEN} =  Execute Command     /ci/bin/tbird/appliance-hal.sh get-enclosure-credentials -s ${enc_serial} -o t
    ${EM_TOKEN}    Should Match Regexp    ${EM_TOKEN}    (?i)\\S*
    Set Suite Variable    ${EM_TOKEN}   ${EM_TOKEN}
    log to console     EM TOKEN: ${EM_TOKEN}
    [Return]    ${EM_TOKEN}

Login to Fusion via SSH
    [Documentation]             Connect to Fusion VM Bash via SSH
    ...                         Example:\n| Login to Fusion Via SSH | 10.0.12.106 | Administrator | hpvse123 |
    [Arguments]                 ${IP}=${FUSION_IP}      ${USERNAME}=${FUSION_SSH_USERNAME}
    ...                         ${PASSWORD}=${FUSION_SSH_PASSWORD}    ${PROMPT}=${FUSION_PROMPT}
    ...                         ${TIMEOUT}=${FUSION_TIMEOUT}    ${ALIAS}=Fusion_SSH
    Log Many                    ${IP}                   ${USERNAME}     ${PASSWORD}     ${PROMPT}   ${TIMEOUT}
    Set Default Configuration   prompt=${PROMPT}        timeout=${TIMEOUT}
    ${Id}=                      Open Connection         ${IP}    alias=${ALIAS}
    ${Output}=                  Login                   ${USERNAME}     ${PASSWORD}
    [Return]                    ${Id}

Logout of Fusion Via SSH
    [Documentation]     Exits the current Bash SSH session
    ...                 Example:\n| Logout Of Fusion Via SSH |
    Close Connection

Execute SSH Command
    [Documentation]     Executes given command on the Fusion SSH shell
    ...                 Example:\n| Execute CLI Command | show enclosure list |
    [Arguments]         ${Command}      ${PROMPT}=#
    log to console    \nComamnd is:${Command}
    Login to Fusion via SSH
    SSHLibrary.Write            ${Command1}
    SSHLibrary.Write            ${Command}
    ${Output}=          Read until      ${PROMPT}
    log to console    \nOUtput from SSH is :${Output}
    Logout of Fusion Via SSH
    [Return]            ${Output}

EFuse ICM
    [Documentation]    Perform an efuse action on a ICM bay. Action = EFuseOff | EFuseOn
    [Arguments]    ${Action}    ${BayNumber}
    ${Header}    Set Variable    "X-Auth-Token":"${EM_TOKEN}"
    ${Data}      Set Variable    {"Action":"${Action}"}
    Log to console and logfile      \t Issuing ${Action} for ICM:${BayNumber}
    ${Output}    Execute Command
    ...    curl -ikX POST -H ${Header} --data-ascii '${data}' https://${EM_IP}%${FUSION_NIC}/rest/v1/InterconnectBays/${BayNumber}
    Should Contain    ${Output}    { "Action": "${Action}" }
    ...    msg=EFuse action failed \n${Output}



SSH to host and ping x
    [Documentation]    SSH's to a given host, then pings an IP from that host
    [Arguments]           ${HOST}    ${HOST2}
    Open Connection And Log In      ${HOST}
    ${Output}=    Execute Command    ping -c 4 ${HOST2}    return_stdout=True    return_rc=False
    Log to console and logfile    ${Output}
    Should Contain    ${Output}    ttl=
    Close All Connections

Add LIG from variable
    [Documentation]    Adds an LIG to an appliance from a variable which contains a list of dicts with the entire payload
    [Arguments]        ${ligx}
    Log       Adding LIG ${ligx}
    ${ligx} =     Copy Dictionary    ${ligs['${ligx}']}

    ${name} =                       Get Variable Value  ${ligx['name']}
    ${enclosureIndexes} =           Get Variable Value  ${ligx['enclosureIndexes']}
    ${enclosureType} =              Get Variable Value  ${ligx['enclosureType']}
    ${ethernetSettings} =           Get Variable Value  ${ligx['ethernetSettings']}
    ${fcoeSettings} =               Get Variable Value  ${ligx['fcoeSettings']}
    ${internalNetworkUris} =        Get Variable Value  ${ligx['internalNetworkUris']}
    ${interconnectBaySet} =         Get Variable Value  ${ligx['interconnectBaySet']}
    ${interconnectMapTemplate} =    Get Variable Value  ${ligx['interconnectMapTemplate']}
    ${qosConfiguration} =           Get Variable Value  ${ligx['qosConfiguration']}
    ${redundancyType} =             Get Variable Value  ${ligx['redundancyType']}
    ${stackingMode} =               Get Variable Value  ${ligx['stackingMode']}
    ${telemetryConfiguration} =     Get Variable Value  ${ligx['telemetryConfiguration']}
    ${snmpConfiguration} =          Get Variable Value  ${ligx['snmpConfiguration']}
    ${uplinkSets} =                 Get Variable Value  ${ligx['uplinkSets']}
    #${uplinkSets} =     Copy List    ${ligx['uplinkSets']}
    ${l} =     Get Length    ${uplinkSets}


    :FOR    ${x}    IN RANGE    0    ${l}
    \    ${networkType} =     Get From Dictionary     ${uplinkSets[${x}]}    networkType
    \    ${networks} =         Get From Dictionary        ${uplinkSets[${x}]}    networkUris
    \   ${nativeNetworkUri} =   Get Variable Value     ${uplinkSets[${x}]['nativeNetworkUri']}
    \     Run Keyword If     '${networkType}' == 'FibreChannel'    Continue For Loop
    #\    ${networkUris} =     Get FCoE Uris    ${networks}
    #\   ${ethernetUris} =   Get Ethernet URIs   ${networks}
    #\   ${networkUris} =    combine lists   ${networkUris}  ${ethernetUris}
    \    ${networkUris} =     Get Ethernet URIs    ${networks}
    \    Set to dictionary    ${uplinkSets[${x}]}    networkUris        ${networkUris}
    \   ${nativeNetworkUri} =     Run Keyword If   '${nativeNetworkUri}' != 'None'    Get Ethernet Uri    ${nativeNetworkUri}
    \   Set to dictionary   ${uplinkSets[${x}]}    nativeNetworkUri     ${nativeNetworkUri}


    Log   ${uplinkSets}
    ${body} =     Fusion Api Create LIG Payload    name=${name}
    ...                                         enclosureType=${enclosureType}
    ...                                         ethernetSettings=${ethernetSettings}
    ...                                            interconnectMapTemplate=${interconnectMapTemplate}
    ...                                         stackingMode=${stackingMode}
    ...                                         telemetryConfiguration=${telemetryConfiguration}
    ...                                         snmpConfiguration=${snmpConfiguration}
    ...                                            uplinkSets=${uplinkSets}

    ${resp} =     Fusion Api Create LIG    ${body}
    ${task} =    Wait For Task    ${resp}     60s       2s
    ${liguri} =     Get From Dictionary    ${task['associatedResource']}    resourceUri
    [Return]    ${resp}

#FTS
    #Set Log Level    DEBUG
    #Get VM IP   ${VM}
    #First Time Setup                    password=hpvse123

Test Specific Setup
    Set Log Level    TRACE
    Run Keyword and Ignore Error    Write To ciDebug Log
    Log to console and logfile    [TEST-SPECIFIC SETUP]
    Fusion Api Login Appliance         ${APPLIANCE_IP}        ${admin_credentials}
    ${users} =    Get Variable Value    ${users}
    Run Keyword If    ${users} is not ${null}    Add Users from variable                ${users}
    ${ethernet_networks} =    Get Variable Value    ${ethernet_networks}
    Run Keyword If    ${ethernet_networks} is not ${null}    Add Ethernet Networks from variable    ${ethernet_networks}
    #${ethernet_ranges} =    Get Variable Value    ${ethernet_ranges}
    #Run Keyword If    ${ethernet_ranges} is not ${null}        Run Keyword for List    ${ethernet_ranges}    Create Ethernet Range
    #${fc_networks} =    Get Variable Value    ${fc_networks}
    #Run Keyword If    ${fc_networks} is not ${null}    Add FC Networks from variable        ${fc_networks}
    #${fcoe_networks} =    Get Variable Value    ${fcoe_networks}
    #Run Keyword If    ${fcoe_networks} is not ${null}    Add FCoE Networks from variable        ${fcoe_networks}
    #${licenses} =    Get Variable Value    ${licenses}
    #Run Keyword If    ${licenses} is not ${null}        Add Licenses from variable        ${licenses}
    #Login all users     ${users}

Run FTS and test-specific setup
    Set Log Level    TRACE
    #FTS
    Test Specific Setup
