*** Settings ***
Documentation          This set of test cases is to regression test/verify PVLAN Features.
Variables              data_rspan_demo.py
Library                data_rspan_demo.py
Resource               ../../../../Resources/api/fusion_api_resource.txt
Resource               RSPAN_resources.txt

Suite Setup            Fusion Api Login Appliance    ${APPLIANCE_IP}    ${admin_credentials}
Suite Teardown         Fusion Api Logout Appliance


*** Variables ***
${APPLIANCE_IP}                  192.168.145.73
${ICM_POTASH_1_BAY}              2
${ICM_POTASH_2_BAY}              5
${ICM_POTASH_1}                  ${ENC1}, interconnect 2
${ICM_POTASH_2}                  ${ENC2}, interconnect 5
@{ICM_LIST}                      ${ICM_POTASH_1}    ${ICM_POTASH_2}
@{LI_LIST}                       ${LI_NAME_POTASH}
${State_Configured}              Configured
${State_Power_Off}               Maintenance
${State_Efuse_Off}               Absent
${POWER_STATE_OFF}               Off
${POWER_STATE_ON}                On
${FUSION_SSH_USERNAME}           root
${FUSION_SSH_PASSWORD}           hpvse1
${FUSION_PROMPT}                 #
${FUSION_TIMEOUT}                10
${FUSION_NIC}                    bond0
${FUSION_IP}                     192.168.145.73

*** Test Cases ***
Setup
    [Tags]     Setup
    Cleanup
    Setup1

Setup-b: Create LIG
    [Tags]     Setup-b
    Log     \n CREATING LIG    console=True
    ${resp}=    Run Keyword If    ${lig_potash} is not ${null}   Add LIG from variable async   ${lig_potash}
    Wait For Task2    ${resp}    timeout=200    interval=10

Setup-c: Create EG and LI From LIG
    [Tags]    Setup-c
    Log     \n CREATING EG    console=True
    Run Keyword If    ${encl_group_potash} is not ${null}      Add Enclosure Group from variable async    ${encl_group_potash}
    Log     \n ADDING LE    console=True
    Run Keyword If    ${logical_encl} is not ${null}      Add Logical Enclosure from lists Async    ${logical_encl}

Setup-d: Create Server profile
    [Tags]    Setup-d
    Power off Servers in Profiles     ${server_profiles}
    ${resp}=    Add Server Profiles from variable    ${server_profiles}
    Wait For Task2  ${resp}    timeout=600    interval=10
    Power on Servers in Profiles      ${server_profiles}

TC01: Get List of Available Network And Port For Remote Port Monitor
    [Tags]    TC01
    ${list}=   Get List of Available Network And Port For Remote Port Monitor    ${LI_NAME_POTASH}
    Log    \n\nList of Available Ports for RSPAN Configuration: \n${list}\n    console=True

TC02: Configure RSPAN Session 1 on LI
    [Tags]    TC02
    ${dto}=    Copy Dictionary    ${rspan_session}
    ${resp}=   Create RSPAN Session    ${LI_NAME_POTASH}    ${dto}    ${ENC2}    ${ICM_POTASH_2_BAY}
    Wait For Task2    ${resp}    timeout=600    interval=10

TC02-2: Verify RSPAN1 Session 1 on Interconnect
    [Tags]    TC02-2
    ${status}=   Verify RSPAN Details In ICM    ${ENC2}    ${ICM_POTASH_2_BAY}    ${rspan_session}
    Run Keyword If     ${status}==${FALSE}    FAIL    msg=RSPAN Session Verification on Interconnect Failed.
    ...    ELSE    Log    RSPAN Session Verification on Interconnect successfull.

TC02-b: Configure RSPAN Session 2 on LI
    [Tags]    TC02-b
    ${dto}=    Copy Dictionary    ${rspan_session2}
    ${resp}=    Create RSPAN Session    ${LI_NAME_POTASH}    ${dto}    SGH751SLBL   ${ICM_POTASH_1_BAY}
    Wait For Task2    ${resp}    timeout=600    interval=10

TC02-b2: Verify RSPAN Session 2 on Interconnect
    [Tags]    TC02-b2
    ${status}=   Verify RSPAN Details In ICM    ${ENC1}   ${ICM_POTASH_1_BAY}   ${rspan_session2}
    Run Keyword If     ${status}==${FALSE}    FAIL    msg=RSPAN Session Verification on Interconnect Failed.
    ...    ELSE    Log    RSPAN Session Verification on Interconnect successfull.

TC02-c: Configure RSPAN Session 3 on LI
    [Tags]    TC02-c
    ${dto}=    Copy Dictionary    ${rspan_session3}
    ${resp}=    Create RSPAN Session    ${LI_NAME_POTASH}    ${dto}    ${ENC1}   ${ICM_POTASH_1_BAY}
    Wait For Task2    ${resp}    timeout=600    interval=10

TC02-c2: Verify RSPAN Session 3 on Interconnect
    [Tags]    TC02-c2
    ${status}=   Verify RSPAN Details In ICM    ${ENC1}   ${ICM_POTASH_1_BAY}   ${rspan_session3}
    Run Keyword If     ${status}==${FALSE}    FAIL    msg=RSPAN Session Verification on Interconnect Failed.
    ...    ELSE    Log    RSPAN Session Verification on Interconnect successfull.

TC02-d: Configure RSPAN Session 4 on LI
    [Tags]    TC02-d
    ${dto}=    Copy Dictionary    ${rspan_session4}
    ${resp}=    Create RSPAN Session    ${LI_NAME_POTASH}    ${dto}   ${ENC1}   ${ICM_POTASH_1_BAY}
    Wait For Task2    ${resp}    timeout=600    interval=10

TC02-d2: Verify RSPAN Session 4 on Interconnects
    [Tags]    TC02-d2
    ${status}=   Verify RSPAN Details In ICM    ${ENC1}   ${ICM_POTASH_1_BAY}   ${rspan_session4}
    Run Keyword If     ${status}==${FALSE}    FAIL    msg=RSPAN Session Verification on Interconnect Failed.
    ...    ELSE    Log    RSPAN Session Verification on Interconnect successfull.

TC03: Configure a RSPAN Session with Multiple Monitored Ports
    [Tags]    TC03
    ${dto}=    Copy Dictionary    ${rspan_session_multi_ports}
    ${resp}=    Create RSPAN Session    ${LI_NAME_POTASH}    ${dto}    ${ENC1}   ${ICM_POTASH_1_BAY}
    Wait For Task2    ${resp}    timeout=600    interval=10

TC03-b: Verify a RSPAN Session with Multiple Monitored Ports on Interconnect
    [Tags]    TC03-b
    ${status}=   Verify Multiple RSPAN Session Details In ICM    ${ENC1}   ${ICM_POTASH_1_BAY}   ${rspan_session_multi_ports}
    Run Keyword If     ${status}==${FALSE}    FAIL    msg=RSPAN Session Verification on Interconnect Failed.
    ...    ELSE    Log    RSPAN Session Verification on Interconnect successfull.

TC04: Configure Multiple RSPAN Sessions
    [Tags]    TC04
    ${dto}=    Copy Dictionary    ${rspan_multi_sessions2}
    ${resp}=    Create Multiple RSPAN Sessions    ${LI_NAME_POTASH}    ${dto}
    Wait For Task2    ${resp}    timeout=600    interval=10

TC04-b: Verify Multiple RSPAN Sessions on Interconnects
    [Tags]    TC04-b
    ${status}=   Verify Multiple RSPAN Session Details In ICM    ${ENC1}   ${ICM_POTASH_1_BAY}   ${rspan_multi_sessions2}
    Run Keyword If     ${status}==${FALSE}    FAIL    msg=RSPAN Session Verification on Interconnect: "SGH751SLBL,2" Failed.
    ...    ELSE    Log    RSPAN Session Verification on Interconnect successfull.

TC05: Configure RSPAN in DUS Configuration(Master and Subordinate)
    [Tags]    TC05
    ${dto}=    Copy Dictionary    ${rspan_session_dus}
    ${resp}=     Create RSPAN Session    ${LI_NAME_POTASH}    ${dto}    ${ENC2}    ${ICM_POTASH_2_BAY}
    Wait For Task2    ${resp}    timeout=600    interval=10

TC05-b: Verify DUS RSPAN Session on Interconnect
    [Tags]    TC05-b
    ${status}=   Verify RSPAN Details In ICM    ${ENC2}    ${ICM_POTASH_2_BAY}    ${rspan_session_dus}
    Run Keyword If     ${status}==${FALSE}    FAIL    msg=RSPAN Session Verification on Interconnect Failed.
    ...    ELSE    Log    RSPAN Session Verification on Interconnect successfull.

TC06: Verify whether RSPAN Session can be created with i3S ports as monitored ports
    [Tags]    TC06
    ${resp}=    Create RSPAN Session    ${LI_NAME_POTASH}    ${rspan_session5_error}    ${ENC2}    ${ICM_POTASH_2_BAY}
    Wait For Task2    ${resp}    timeout=600    interval=10
    ...    PASS=((?i)Error|Terminated)
    ...    VERBOSE=False
    ...    errorMessage=CRM_REMOTE_PORT_MONITOR_INVALID_MIRROR_TO_PORT

TC07: Disable RSPAN Session
    [Tags]    TC07
    Toggle LI Port Monitoring    ${LI_NAME_POTASH}    enable=${FALSE}
    ${Status}=   Get LI Port Monitoring Status    ${LI_NAME_POTASH}
    Run Keyword If     ${status}==${TRUE}    FAIL    msg=RSPAN Session Disable Failed.
    ...    ELSE    Log    RRSPAN Session Disable successfull.

TC07: Enable RSPAN Session
    [Tags]    TC07-b
    Toggle LI Port Monitoring    ${LI_NAME_POTASH}    enable=${TRUE}
    ${Status}=   Get LI Port Monitoring Status    ${LI_NAME_POTASH}
    Run Keyword If     ${status}==${FALSE}    FAIL    msg=RSPAN Session Disable Failed.
    ...    ELSE    Log    RRSPAN Session Disable successfull.

TC08: Configure RSPAN Session with Network which is already part of Server Profile Connection.
    [Tags]    TC08
    Power off Servers in Profiles    ${server_profile_error}
    ${resp2}=    Add Server Profiles from variable    ${server_profile_error}
    Wait For Task2  ${resp2}    timeout=600    interval=10
    Sleep  60
    ${resp}=    Create RSPAN Session    ${LI_NAME_POTASH}    ${rspan_session2}    SGH751SLBL   ${ICM_POTASH_1_BAY}
    Wait For Task2    ${resp}    timeout=600    interval=10
    ...    PASS=((?i)Error|Terminated)
    ...    VERBOSE=False
    ...    errorMessage=CRM_REMOTE_PORT_MONITOR_NETWORK_USED_IN_CONNECTION

TC09: Delete RSPAN Session
    [Tags]    TC10
    Clear All RSPAN Sessions    ${LI_NAME_POTASH}
