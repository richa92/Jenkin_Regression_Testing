*** Settings ***
Documentation       Feature Test:F669
Resource            OVAConfig.txt
Force Tags          Buildup
Library             Collections
Library             SSHLibrary
Library             json
Library             OperatingSystem
Library             RoboGalaxyLibrary
Library             FusionLibrary
Library             BuiltIn
Library             XML
Library             String
Suite Setup          Load Test Data and Open Browser
Variables           data_variables.py
Resource            ../../../../resource/fusion_api_all_resource_files.txt
*** Variables ***
${Browser}         FireFox
${file}                          fusion_dump.sdmp
${uname}                         root
${pwd}                           hpvse1
${LE}              LE
${APPLIANCE_IP}                 15.212.160.153        # Appliance IP
${ApplianceUrl}                 https://${APPLIANCE_IP}     # Appliance Url
${X-API-VERSION}                300                         # X-API-VERSION
${ICM_1}                 EM1FFFF500, interconnect 1
${ICM_2}                 EM1FFFF500, interconnect 4
#${Message_1_PowerOff}       The interconnect has been powered off
#${Message_1_PowerOn}        The interconnect has been powered on
${Message_1_PowerOff}       Interconnect  EM1FFFF500, interconnect 1 has been powered off
${Message_1_PowerOn}        Interconnect  EM1FFFF500, interconnect 1 has been powered on
${Message_1_Reset}      Reset
${storage}          Storage administrator
${infrastructure}           Infrastructure administrator
${server}           Server administrator
${storage}          Storage administrator
${Message_1_ICM1}           Activation success for the interconnect  EM1FFFF500, interconnect 1 with firmware version 1.04 from baseline
${Message_2_ICM1}           Activation started for the interconnect  EM1FFFF500, interconnect 1 with firmware version 1.04 from baseline
${Message_3_ICM1}           Staging started for the interconnect  EM1FFFF500, interconnect 1 with firmware version 1.04 from baseline
${Message_4_ICM1}           Staging success for the interconnect  EM1FFFF500, interconnect 1 with firmware version 1.04 from baseline
${Message_1_ICM2}           Activation success for the interconnect  EM1FFFF500, interconnect 4 with firmware version 1.04 from baseline
${Message_2_ICM2}           Activation started for the interconnect  EM1FFFF500, interconnect 4 with firmware version 1.04 from baseline
${Message_3_ICM2}           Staging started for the interconnect  EM1FFFF500, interconnect 4 with firmware version 1.04 from baseline
${Message_4_ICM2}           Staging success for the interconnect  EM1FFFF500, interconnect 4 with firmware version 1.04 from baseline
${Message_1_ICM1_Upgrade}           Activation success for the interconnect  EM1FFFF500, interconnect 1 with firmware version 1.08 from baseline
${Message_2_ICM1_Upgrade}           Activation started for the interconnect  EM1FFFF500, interconnect 1 with firmware version 1.08 from baseline
${Message_3_ICM1_Upgrade}           Staging started for the interconnect  EM1FFFF500, interconnect 1 with firmware version 1.08 from baseline
${Message_4_ICM1_Upgrade}           Staging success for the interconnect  EM1FFFF500, interconnect 1 with firmware version 1.08 from baseline
${Message_1_ICM2_Upgrade}           Activation success for the interconnect  EM1FFFF500, interconnect 4 with firmware version 1.08 from baseline
${Message_2_ICM2_Upgrade}           Activation started for the interconnect  EM1FFFF500, interconnect 4 with firmware version 1.08 from baseline
${Message_3_ICM2_Upgrade}           Staging started for the interconnect  EM1FFFF500, interconnect 4 with firmware version 1.08 from baseline
${Message_4_ICM2_Upgrade}           Staging success for the interconnect  EM1FFFF500, interconnect 4 with firmware version 1.08 from baseline
${Permissible_IC_STATES_AfterUpdate}=    ['monitored']
${ICM_1}                 EM1FFFF500, interconnect 1
${ICM_2}                 EM1FFFF500, interconnect 4
${upgrade_bundle}    C:\\upgrade.iso
${downgrade_bundle}    C:\\downgrade.iso


*** Test Cases ***
01.PreConditions-Create LIG,EG and LE
    Log To Console    ***********Create Enclosure Group*******************
    Log into Fusion appliance as Administrator
    ${Status}=    fusion_ui_create_tbird_enclosure_group        ${TestData.encgroups[0]}
    Run Keyword And Continue On Failure   Should Be Equal   '${Status}'   'True'   ${Status}
    Log To Console    ******CREATE EG operations completed**********
    Log To Console    ************Create LE**************************
    Fusion UI Logout of Appliance
    Log into Fusion appliance as Administrator
    ${Status}=    fusion_ui_create_tbird_logical_enclosure    ${TestData.les[0]}
    Run Keyword And Continue On Failure   Should Be Equal   '${Status}'   'False'   ${Status}
    Log To Console    ******CREATE LE operation completed**********
    Fusion UI Logout of Appliance


02.PreConditions Create ServerProfile
    Log To Console    ***********Create Enclosure Group*******************
    Log into Fusion appliance as Administrator
    ${Status}=    Fusion UI Power Off Server Hardware   ${TestData.serverhardware[0]}
    Run Keyword And Continue On Failure   Should Be Equal   '${Status}'   'True'   ${Status}
    ${Status}=    Fusion UI Create Server Profile         ${TestData.servers[0]}
    Run Keyword And Continue On Failure   Should Be Equal   '${Status}'   'True'   ${Status}
    Fusion UI Power On Server Profile    ${TestData.servers[0]}


03.PreConditions Upload Upgrade Firmware Bundles to appliance
    Fusion Api Login Appliance      ${APPLIANCE_IP}     ${admin_credentials}
    ${resp} =    Fusion Api Upload Firmware Bundle    ${upgrade_bundle}
    Log to console and logfile  -Firmware Upgrade Bundle uploaded successfully

04.PreConditions Upload Downgrade Firmware Bundles to appliance
    ${resp} =    Fusion Api Upload Firmware Bundle    ${downgrade_bundle}
    Log to console and logfile  -Firmware Downgrade Bundle uploaded successfully

UI-F669-Test1: Power OFF the interconnect
    ${status}=      fusion_ui_interconnect_power_off            @{TestData.TB_interconnect_FVT_1}
    run keyword if  '${status}'=='False'    Fail    'Power Off action failed on Interconnect'
    ${EMreturn}=        tbird_fetch_icm_data_from_em            @{TestData.TB_interconnect_FVT_1}
    ${powerstate} =     Get From Dictionary     ${EMreturn}     PowerState
    Run Keyword If    ${powerstate}=="Off"      Log To Console  IC Sates as desired   ELSE     Fail

F669_TC_UI_15_Alerts_PowerONOFF: Check Power_off Alert
    ${Message_List_PowerOff} =      Create list     ${Message_1_PowerOff}
    ${status}=  fusion_ui_verify_interconnect_recent_activity       ${ICM_1}    ${Message_List_PowerOff}
    Run keyword if  '${status}'=='False'    Fail    'Power Off alert not available'
    Fusion UI Logout of Appliance

UI-F669-Test2: Power ON the interconnect
    Log into Fusion appliance as Administrator
    ${status}=      fusion_ui_interconnect_power_on         @{TestData.TB_interconnect_FVT_1}
    run keyword if  '${status}'=='False'    Fail    'Power On action failed on Interconnect'
    ${EMreturn}=        tbird_fetch_icm_data_from_em            @{TestData.TB_interconnect_FVT_1}
    ${powerstate} =     Get From Dictionary     ${EMreturn}     PowerState
    Run Keyword If    ${powerstate}=="On"   Log To Console  IC Sates as desired   ELSE     Fail

F669_TC_UI_15_Alerts_PowerONOFF: Check Power_On Alert
    ${Message_List_PowerOn} =       Create list     ${Message_1_PowerOn}
    ${status}=  fusion_ui_verify_interconnect_recent_activity       ${ICM_1}    ${Message_List_PowerOn}
    run keyword if  '${status}'=='False'    Fail    'Power On alert not available'
    Fusion UI Logout of Appliance


UI-F669-Test4: UID OFF the interconnect
    Log into Fusion appliance as Administrator
    ${status}=      fusion_ui_turn_off_interconnect_uid         @{TestData.TB_interconnect_FVT_1}
    run keyword if  '${status}'=='False'    Fail    'UID OFF action failed on Interconnect'
    ${EMreturn}=        tbird_fetch_icm_data_from_em            @{TestData.TB_interconnect_FVT_1}
    ${uidstate} =   Get From Dictionary     ${EMreturn}     UidState
    Run Keyword If    ${uidstate}=="Off"    Log To Console  UID state as desired   ELSE     Fail

UI-F669-Test3: UID ON the Interconnect
    ${status}=      fusion_ui_turn_on_interconnect_uid          @{TestData.TB_interconnect_FVT_1}
    run keyword if  '${status}'=='False'    Fail    'UID ON action failed on Interconnect'
    ${EMreturn}=        tbird_fetch_icm_data_from_em            @{TestData.TB_interconnect_FVT_1}
    ${uidstate} =   Get From Dictionary     ${EMreturn}     UidState
    Run Keyword If    ${uidstate}=="Lit"    Log To Console  UID state as desired   ELSE     Fail

UI-F669-Test4: Reset The interconnect
    ${status}=      fusion_ui_interconnect_reset            @{TestData.TB_interconnect_FVT_1}
    run keyword if  '${status}'=='False'    Fail    'Reset Action failed on Interconnect'

F669_TC_UI_16_Alerts_Reset: Verify Reset Alert
    ${Message_List_Reset} =     Create list     ${Message_1_Reset}
    ${status}=  fusion_ui_verify_interconnect_recent_activity       ${ICM_1}    ${Message_List_Reset}
    run keyword if  '${status}'=='False'    Fail    'Alert not available'
    Fusion UI Logout of Appliance

F669_TC_UI_59:AdditionalTestCase_UserPrivilege
    Log into Fusion appliance as Administrator
    Fusion UI Navigate To Users and Groups Page
    Fusion UI Create User  ${TestData.users[1]}
    Fusion UI Create User  ${TestData.users[2]}
    Fusion UI Create User  ${TestData.users[3]}
    Fusion UI Create User  ${TestData.users[4]}
    Fusion UI Logout of Appliance
    Log into Fusion appliance as NetworkAdmin
    ${status}=          fusion_ui_validate_sylvite_interconnects_user_permissions       Network administrator   @{TestData.Sylvite_interconnects_disable}
    run keyword if  '${status}'=='Fail'    Pass    'Privileges check completed'
    Fusion UI Logout of Appliance
    Log into Fusion appliance as StorageAdmin
    ${status}=          fusion_ui_validate_sylvite_interconnects_user_permissions       Storage administrator   @{TestData.Sylvite_interconnects_disable}
    run keyword if  '${status}'=='False'    Fail    'Privileges check not successful for Storage user'
    Fusion UI Logout of Appliance
    Log into Fusion appliance as ServerAdmin
    ${status}=          fusion_ui_validate_sylvite_interconnects_user_permissions       Server administrator    @{TestData.Sylvite_interconnects_disable}
    run keyword if  '${status}'=='False'    Fail    'Privileges check not successful for Server Administrator user'
    Fusion UI Logout of Appliance
    Log into Fusion appliance as BackupAdmin
    ${status}=          fusion_ui_validate_sylvite_interconnects_user_permissions       Backup administrator    @{TestData.Sylvite_interconnects_disable}
    run keyword if  '${status}'=='False'    Fail    'Privileges check not successful for Backup Administrator user'
    Fusion UI Logout of Appliance

UI-F669-Test5,9,6: Verify Sylvite Interconnects represented in Interconnects view
    Log into Fusion appliance as Administrator
    ${status}=    fusion ui validate interconnect     @{TestData.Sylvite_interconnects}
    run keyword if  '${status}'=='False'    Fail    'Interconnect View validation not successful'

UI-F669-Test7: Validate Interconnect Uplink Port View For Sylvite
    ${status}=     fusion_ui_verify_interconnect_uplinkport_view            @{TestData.Sylvite_interconnects}
    run keyword if  '${status}'=='False'    Fail    'Interconnect Uplink View validation not successful'

UI-F669-Test8: Disable Interconnect Downlink Ports
    ${status}=    fusion_ui_sylvite_downlink_edit           @{TestData.Sylvite_interconnects_disable}
    run keyword if  '${status}'=='False'    Fail    'Interconnect Downlink Edit Disable not successful'

UI-F669-Test9: Validate Downlink Port status and View after Downlink Port Disable
    ${status}=    fusion_ui_verify_interconnect_downlinkport_view_tbird         @{TestData.Sylvite_interconnects_disable}
    run keyword if  '${status}'=='False'    Fail    'Interconnect Downlink Edit validation not successful'

UI-F669-Test8: Enable Interconnect Downlink Ports
    ${status}=    fusion_ui_sylvite_downlink_edit           @{TestData.Sylvite_interconnects_enable}
    run keyword if  '${status}'=='False'    Fail    'Interconnect Downlink Disable not successful'

UI-F669-Test9: Validate Downlink Port status and View after Downlink Port Enable
    ${status}=    fusion_ui_verify_interconnect_downlinkport_view_tbird         @{TestData.Sylvite_interconnects_enable}
    run keyword if  '${status}'=='False'    Fail    'Interconnect Downlink Edit validation not successful'

UI-F669-Test10: Verify connector Information
    ${status}=    Fusion UI Validate Interconnect Connector Info Tbird         @{TestData.TB_interconnect_FVT_2}
    run keyword if  '${status}'=='False'    Fail    'Interconnect Downlink Enable not successful'
    Fusion UI Logout of Appliance

UI-F669-Test41:Downgrade FW of LE--with force-Shared Infrastructure
    Log into Fusion appliance as Administrator
    Fusion UI Power Off Server Hardware   ${TestData.serverhardware[0]}
    Fusion UI Power Off Server Hardware   ${TestData.serverhardware1[0]}
    # UPDATE FIRMWARE
    ${Status}=  fusion_ui_update_tbird_logical_enclosure_firmware       ${TestData.firmware2}
    Run Keyword and Continue on Failure  Should Be Equal        '${Status}'     'True'      ${Status}

    #Log to Console ****** VERIFY LE FW UPDATE ACTIVITY ********
    ${Status}=  fusion_ui_validate_le_firmware_upgrade_activity_details    ${TestData.firmware2}
    Run Keyword and Continue on Failure  Should Contain    ${Status}    TEST PASSED    LE FW Update Test FAILED

    Log to Console  ****** VERIFY alerts at Interconnect Level ********

    ${Message_List_Downgrade_ICM1} =    Create list     ${Message_1_ICM1}           ${Message_2_ICM1}       ${Message_3_ICM1}       ${Message_4_ICM1}
    Log to Console          ${Message_List_Downgrade_ICM1}
    ${Status}=   fusion_ui_verify_interconnect_recent_activity      ${ICM_1}    ${Message_List_Downgrade_ICM1}
    Run Keyword and Continue on Failure    Should Be Equal  '${Status}'     'True'      IC Alerts as desired

    ${Message_List_Downgrade_ICM2} =    Create list     ${Message_1_ICM2}           ${Message_2_ICM2}       ${Message_3_ICM2}       ${Message_4_ICM2}
    Log to Console          ${Message_List_Downgrade_ICM2}
    ${Status}=   fusion_ui_verify_interconnect_recent_activity      ${ICM_2}    ${Message_List_Downgrade_ICM2}
    Run Keyword and Continue on Failure    Should Be Equal  '${Status}'     'True'      IC Alerts as desired

    Log to Console  ****** VERIFY STATE OF INTERCONNECT AFTER FW UPDATE********
    ${State}=   fusion_ui_get_interconnect_state       ${ICM_1}
    Log to Console          \nState of Interconnect '${ICM_1}' is '${State}'
    Run Keyword and Continue on Failure     Should Be Equal  '${State}'     'Monitored'     IC State Not as desired

    ${State}=   fusion_ui_get_interconnect_state       ${ICM_2}
    Log to Console          \nState of Interconnect '${ICM_2}' is '${State}'
    Run Keyword and Continue on Failure     Should Be Equal  '${State}'     'Monitored'     IC State Not as desired

    Fusion Api Login Appliance      ${APPLIANCE_IP}     ${admin_credentials}
    Validate Interconnect firmware version              ${ICM_1}                @{TestData.TB_interconnect_FVT_1}
    Validate Interconnect firmware version              ${ICM_2}                @{TestData.TB_interconnect_FVT_2}
    Fusion UI Logout of Appliance
    sleep   300s

UI-F669-Test38:Upgrade FW of LE-without force-Shared Infrastructure
    Log into Fusion appliance as Administrator
    # UPDATE FIRMWARE
    ${Status}=  fusion_ui_update_tbird_logical_enclosure_firmware       ${TestData.firmware1}
    Run Keyword and Continue on Failure  Should Be Equal        '${Status}'     'True'      ${Status}

    #Log to Console ****** VERIFY LE FW UPDATE ACTIVITY ********
    ${Status}=  fusion_ui_validate_le_firmware_upgrade_activity_details    ${TestData.firmware1}
    Run Keyword and Continue on Failure  Should Contain    ${Status}    TEST PASSED    LE FW Update Test FAILED

    Log to Console  ****** VERIFY alerts at Interconnect Level ********

    ${Message_List_Upgrade_ICM1} =      Create list     ${Message_1_ICM1_Upgrade}           ${Message_2_ICM1_Upgrade}       ${Message_3_ICM1_Upgrade}       ${Message_4_ICM1_Upgrade}
    Log to Console          ${Message_List_Upgrade_ICM1}
    ${Status}=   fusion_ui_verify_interconnect_recent_activity      ${ICM_1}    ${Message_List_Upgrade_ICM1}
    Run Keyword and Continue on Failure    Should Be Equal  '${Status}'     'True'      IC Alerts as desired

    ${Message_List_Upgrade_ICM2} =      Create list     ${Message_1_ICM2_Upgrade}           ${Message_2_ICM2_Upgrade}       ${Message_3_ICM2_Upgrade}       ${Message_4_ICM2_Upgrade}
    Log to Console          ${Message_List_Upgrade_ICM1}
    ${Status}=   fusion_ui_verify_interconnect_recent_activity      ${ICM_2}    ${Message_List_Upgrade_ICM2}
    Run Keyword and Continue on Failure    Should Be Equal  '${Status}'     'True'      IC Alerts as desired

    Log to Console  ****** VERIFY STATE OF INTERCONNECT AFTER FW UPDATE********
    ${State}=   fusion_ui_get_interconnect_state       ${ICM_1}
    Log to Console          \nState of Interconnect '${ICM_1}' is '${State}'
    Run Keyword and Continue on Failure     Should Be Equal  '${State}'     'Monitored'     IC State Not as desired

    ${State}=   fusion_ui_get_interconnect_state       ${ICM_2}
    Log to Console          \nState of Interconnect '${ICM_2}' is '${State}'
    Run Keyword and Continue on Failure     Should Be Equal  '${State}'     'Monitored'     IC State Not as desired
    Fusion Api Login Appliance      ${APPLIANCE_IP}     ${admin_credentials}
    Validate Interconnect firmware version              ${ICM_1}                @{TestData.TB_interconnect_FVT_1}
    Validate Interconnect firmware version              ${ICM_2}                @{TestData.TB_interconnect_FVT_2}
    Fusion UI Logout of Appliance
    sleep   60s

UI-F669-Test41:Downgrade FW of LE-Shared Infrastructure and Profile
    Log into Fusion appliance as Administrator
    Fusion UI Power Off Server Hardware   ${TestData.serverhardware[0]}
    # DOWNGRADE FIRMWARE
    ${Status}=  fusion_ui_update_tbird_logical_enclosure_firmware       ${TestData.firmware3}
    Run Keyword and Continue on Failure  Should Be Equal        '${Status}'     'True'      ${Status}

    #Log to Console ****** VERIFY LE FW UPDATE ACTIVITY ********
    ${Status}=  fusion_ui_validate_le_firmware_upgrade_activity_details    ${TestData.firmware3}
    Run Keyword and Continue on Failure  Should Contain    ${Status}    TEST PASSED    LE FW Update Test FAILED

    Log to Console  ****** VERIFY alerts at Interconnect Level ********

    ${Message_List_Downgrade_ICM1} =    Create list     ${Message_1_ICM1}           ${Message_2_ICM1}       ${Message_3_ICM1}       ${Message_4_ICM1}
    Log to Console          ${Message_List_Downgrade_ICM1}
    ${Status}=   fusion_ui_verify_interconnect_recent_activity      ${ICM_1}    ${Message_List_Downgrade_ICM1}
    Run Keyword and Continue on Failure    Should Be Equal  '${Status}'     'True'      IC Alerts as desired

    ${Message_List_Downgrade_ICM2} =    Create list     ${Message_1_ICM2}           ${Message_2_ICM2}       ${Message_3_ICM2}       ${Message_4_ICM2}
    Log to Console          ${Message_List_Downgrade_ICM2}
    ${Status}=   fusion_ui_verify_interconnect_recent_activity      ${ICM_2}    ${Message_List_Downgrade_ICM2}
    Run Keyword and Continue on Failure    Should Be Equal  '${Status}'     'True'      IC Alerts as desired

    Log to Console  ****** VERIFY STATE OF INTERCONNECT AFTER FW UPDATE********
    ${State}=   fusion_ui_get_interconnect_state       ${ICM_1}
    Log to Console          \nState of Interconnect '${ICM_1}' is '${State}'
    Run Keyword and Continue on Failure     Should Be Equal  '${State}'     'Monitored'     IC State Not as desired

    ${State}=   fusion_ui_get_interconnect_state       ${ICM_2}
    Log to Console          \nState of Interconnect '${ICM_2}' is '${State}'
    Run Keyword and Continue on Failure     Should Be Equal  '${State}'     'Monitored'     IC State Not as desired
    Fusion Api Login Appliance      ${APPLIANCE_IP}     ${admin_credentials}
    Validate Interconnect firmware version              ${ICM_1}                @{TestData.TB_interconnect_FVT_1}
    Validate Interconnect firmware version              ${ICM_2}                @{TestData.TB_interconnect_FVT_2}
    Fusion UI Logout of Appliance
    sleep   300s

UI-F669-Test40:Upgrade FW of LE-Enclosure Only
    Log into Fusion appliance as Administrator

    # UPGRADE FIRMWARE
    ${Status}=  fusion_ui_update_tbird_logical_enclosure_firmware       ${TestData.firmware4}
    Run Keyword and Continue on Failure  Should Be Equal        '${Status}'     'True'      ${Status}

    #Log to Console ****** VERIFY LE FW UPDATE ACTIVITY ********
    ${Status}=  fusion_ui_validate_le_firmware_upgrade_activity_details    ${TestData.firmware4}
    Run Keyword and Continue on Failure  Should Contain    ${Status}    No LI    LE FW Update Test PASSED
    Fusion Api Login Appliance      ${APPLIANCE_IP}     ${admin_credentials}
    Validate Interconnect firmware version              ${ICM_1}                @{TestData.TB_interconnect_FVT_1}
    Validate Interconnect firmware version              ${ICM_2}                @{TestData.TB_interconnect_FVT_2}
    Fusion UI Logout of Appliance

*** Keywords ***

Log into Fusion appliance as Administrator
    ${user} =  Get Data By Property  ${TestData.users}  name  Administrator
    Fusion UI Login to Appliance   ${user[0].name}

Get IC
    [Arguments]     ${ICM_NAME}
    ${resp} =   fusion api get interconnect
    Log     ${resp}
    ${ics} =     Get From Dictionary     ${resp}    members
    ${l} =  Get Length  ${ics}
    :FOR    ${x}    IN RANGE    0   ${l}
    \   ${ic} =     Get From List   ${ics}    ${x}
    \   Exit For Loop If    '${ic['name']}' == '${ICM_NAME}'
    [Return]    ${ic}
    Log     ${ic}

Validate Interconnect firmware version
    [Arguments]    ${ICM}               @{TestData.TB_interconnect_FVT}
    ${ic} =     Get IC          ${ICM}
    ${firmwareVersion} =     Get From IC    ${ic}   firmwareVersion
    Log to console and logfile          \nFirmwareVersion from ICM '${ICM}' is '${firmwareVersion}'
    # ${serialNumber} =     Get From IC    ${ic}   serialNumber
    ${EMreturn}=        tbird_fetch_icm_data_from_em            @{TestData.TB_interconnect_FVT}
    # Log           ${EMreturn}
    ${FirmwareVersion} =    Get From Dictionary         ${EMreturn}         FirmwareVersion
    Should be Equal as Strings    ${FirmwareVersion}     ${firmwareVersion}
    Run Keyword and Continue on Failure    Should Be Equal  '${FirmwareVersion}'        '${firmwareVersion}'    Part Number as desired
    Log to console and logfile          \n'${FirmwareVersion}' from EM matches '${firmwareVersion}' from Interconnect GET call
