***Settings ***
Documentation       Allow a network to be associated with a network set at creation time OVF6852

Library         json
Library         FusionLibrary
Library         RoboGalaxyLibrary
Variables       data.py
Resource        ../6853/resource.txt
Library         Collections
Library             ../../TBIRD/FVT/fvt_api.py
Resource            ../../../../resource/fusion_api_all_resource_files.txt
Resource            ../../TBIRD/FVT/fvt-keywords.txt
Resource           ../../TBIRD/FVT/Resources/fvt_resource.txt
Library             BuiltIn
Library             Collections
Library             SSHLibrary
Suite Setup    Cleanup
Suite Teardown   Cleanup
Library             OperatingSystem
Library             XML
Library             String
Library             Dialogs

***Test Cases***
Login
    [Documentation]    Login to Appliance
    Set Log Level    Trace
    Fusion Api Login Appliance      ${APPLIANCE_IP}     ${admin_credentials}

Suite Setup Tasks
    [Documentation]    Creating the Ethernet networks
    ${resp}          Add Network Sets from variable    ${Netset1}
    Run Keyword If  '${resp['status_code']}' != '202'  Fail    ELSE  log to console  \nEthernet Network got created successfully

1. TC1: Creating the Ethernet networks with empty NetworkSet
   [Documentation]    Creating the Ethernet networks with empty NetworkSet
   ${Response}    Create Bulk networks    ${bulk_ethernet_network}
   Log    ${Response}    console=True
   Run Keyword If  '${Response[0]['status_code']}' != '202'  Fail    ELSE  log to console  \n Network got created successfully with empty networkset

2. TC3: Creating the Ethernet networks with invalid NetworkSet
   [Documentation]    Creating the Ethernet networks with a NetworkSet that doesnt exist
   ${Response}    Create Bulk networks    ${bulk_ethernet_network1}
   Log    ${Response}    console=True
   Run Keyword If    ${Response[0]['status_code']} == 202    Fail
   Log    Ethernet Networks not created since Networkset is not valid    console=True

3. TC5: Creating the Ethernet networks with NetworkSet that already exists
   [Documentation]    Creating the Ethernet networks with a NetworkSet that has aldready been added
   ${Response}    Create Bulk networks    ${bulk_ethernet_network2}
   Log    ${Response}    console=True
   Run keyword if    ${Response[0]['status_code']} != 202    Fail    "Successfully created Netowrks with a NetworkSet that has already been added"
   ${task1} =   Wait For Task   ${Response[0]}  timeout=5m  interval=1s
   Verify Network In NetworkSets    ${bulk_ethernet_network2[0]['namePrefix']}  Netset1

4.Create a network with no networkset
   [Documentation]    Creating the Ethernet networks without a networkset
   ${Response}    Create Bulk Ethernet Networks    ${bulk_ethernet_network3}
   Log    ${Response}    console=True


5.Create a network and associate it with single networkset
    [Documentation]    Creating network with single networkset
    ${netset} = Create List Netset2
    Set to Dictionary   ${bulk_ethernet_network2[0]}    namePrefix  network_with_single_networkset
    Set to Dictionary   ${bulk_ethernet_network2[0]}    networkSetUris    ${netset}
    ${rep} =    Create Bulk networks    ${bulk_ethernet_network2}
    Run keyword if    ${rep[0]['status_code']} != 202   Fail    "Creating ${bulk_ethernet_network2} failed"
    ${resp} =   Fvt Api Get Ethernet Network By Name    network_with_single_networkset
    Log    ${resp['name']}   console=True
    Run keyword if  ${resp} == None Fail    "Network ${bulk_ethernet_network2[0]['namePrefix']} does not exist"
    Verify Network In NetworkSets   ${resp['name']} Netset2
    Log Network with single networkset created successfully    console=True


6. TC6: Create a network with netset and verify if it can be added with uplink sets and associated with profiles
    [Documentation]    Creating LIG through rest calls
    ${rep} =    Create Bulk networks    ${bulk_ethernet_network5}
    Run keyword if    ${rep[0]['status_code']} != 202   Fail    "Creating ${bulk_ethernet_network5} failed"
    Log    Creating LIG    console=True
    ${network} =  Fvt Api Get Network Set By Name    Netset7


    Add LIG from variable    ${ligs['lig1']}
    ${resp}    Add Enclosure Group from variable    ${eg_body1}

    Add Enclosures from variable    ${encs}
    ${LI_Uri}    Get LI URI    ${LI}
    ${NS} = Create List Netset7
    Set To Dictionary   ${uplinkset3}   networkSetUris    ${NS}
    Set To Dictionary   ${uplinkset3}   logicalInterconnectUri  ${LI}
    Log    ${uplinkset3}    console=True
    ${task2}    Adding Uplinksets from variable ${uplinkset3}   False
    Wait For Task   ${task2}    timeout=5m  interval=1s

    ${Response}    Add Server Profiles from variable    ${SP_NS}

    Power on server    ${SP_NS[0]['serverHardwareUri']}
    ${profiles} =   Fusion Api Get Server Profiles  param=?filter="'name'=='${SP_NS[0]['name']}'
    ${Server_net} =  Copy List    ${profiles['members'][0]['connectionSettings']['connections'][0]['networkUri']}
    List Should Contain Value   ${network['uri']}   ${Server_net}
    Log    verified if network is asscociated with profile


8.TC8: Create network to associate with multiple networksets
    [Documentation]    Creating network and associating with multiple networksets
    ${Response}    Create Bulk networks    ${bulk_ethernet_network4}
    Run Keyword If  '${Response[0]['status_code']}' != '202'  Fail    ELSE  log to console  \nSuccessfully created Netowrk with  multiple NetworkSets
    ${resp} =   Fvt Api Get Ethernet Network By Name    ${bulk_ethernet_network4[0]['namePrefix']}
    Run keyword if  ${resp} == None Fail    "Network ${bulk_ethernet_network4[0]['namePrefix']} does not exist"
    ${NS_names}    Get from Dictionary    ${bulk_ethernet_network4[0]}    networkSetUris
    Verify Network In NetworkSets   ${bulk_ethernet_network4[0]['namePrefix']}  Netset1
    Verify Network In NetworkSets   ${bulk_ethernet_network4[0]['namePrefix']}  Netset2
    Log Network with multiple networksets list created success    console=True

Create Bulk Ethernet Networks With Single NetworkSet List
    [Documentation]    Create Bulk Ethernet Networks With Single NetworkSet List
    Set To Dictionary   ${bulk_ethernet_network2[0]}    vlanIdRange 461-465
    Set to Dictionary   ${bulk_ethernet_network2[0]}    namePrefix  Net2
    ${netset} = Create List Netset3
    Set to Dictionary   ${bulk_ethernet_network2[0]}    networkSetUris  ${netset}
    ${task} =   Create Bulk networks    ${bulk_ethernet_network2}
    Run keyword if  ${task[0]['status_code']} != 202    Fail    "Creating bulk networks with single networkSet list failed"
    ${task1} =  Wait For Task   ${task[0]}  timeout=5m  interval=1s
     : FOR    ${i}    IN RANGE    461    465
    \    Log   ${i}    console=True
    \   Verify Network In NetworkSets   Net2_${i}   Netset3
    Log Bulk networks with single networkset list created successfully   console=True


Create Bulk Networks With Multiple NetworkSets List
    [Documentation]    Create Bulk Networks With Multiple NetworkSets List
    Set To Dictionary   ${bulk_ethernet_network2[0]}    vlanIdRange 466-467
    Set to Dictionary   ${bulk_ethernet_network2[0]}    namePrefix  Net2
    ${netset} = Create List Netset4 Netset5
    Set to Dictionary   ${bulk_ethernet_network2[0]}    networkSetUris  ${netset}
    ${task} =   Create Bulk networks    ${bulk_ethernet_network2}
    Run keyword if  ${task[0]['status_code']} != 202    Fail    "Creating bulk networks with multiple networkSets list failed"
    ${task} =   Wait For Task   ${task[0]}  timeout=5m  interval=1s
    : FOR    ${i}    IN RANGE    466    467
    \   Verify Network In NetworkSets   Net2_${i}   Netset5
    \   Verify Network In NetworkSets   Net2_${i}   Netset4
    Log Bulk networks with multiple networkSets list created successfully    console=True


Create Bulk Networks With No NetworkSets List
    [Documentation]    Creating Bulk Networks With No NetworkSets List
    Set To Dictionary   ${bulk_ethernet_network3[0]}    vlanIdRange 405-407
    ${task} =   Create Bulk Ethernet Networks   ${bulk_ethernet_network3}
    Log Bulk networks with no networkSets list created success    console=True


Create Bulk Networks With Empty NetworkSets List
    [Documentation]    Creating Bulk Networks With Empty NetworkSet List
    Set To Dictionary   ${bulk_ethernet_network[0]} vlanIdRange 436-438
    ${task} =   Create Bulk networks    ${bulk_ethernet_network}
    Run keyword if  ${task[0]['status_code']} != 202    Fail    "Creating bulk networks with empty networkSets list failed"
    ${task} =   Wait For Task   ${task[0]}  timeout=5m  interval=1s
    Log Bulk networks with empty networkNets created successfully    console=True

***Keywords***


Verify Network In NetworkSets
    [Documentation]     Verify Network Exists In NetworkSet
    [Arguments]    ${network}    ${networkset}
    ${network} =    FVT Api Get Ethernet Network By Name    ${network}
    ${networkset} = FVT Api Get Network Set By Name ${networkset}
    Log Successfully validated networks ${networkset['networkUris']}        console=True
    Log Successfully validated networks ${network['uri']}   console=True
    List Should Contain Value   ${networkset['networkUris']}    ${network['uri']}
    Log Successfully validated networks in networkset   console=True

