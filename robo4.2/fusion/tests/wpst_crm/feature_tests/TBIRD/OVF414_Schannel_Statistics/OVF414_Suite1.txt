*** Settings ***
Documentation   OVF414
Variables       data_variables.py
Library         json
Library         FusionLibrary
Library         RoboGalaxyLibrary
Library         Collections
Library         SSHLibrary
Library         String
Resource        ../../../../resource/fusion_api_all_resource_files.txt
Resource        OVF414_keywords.txt
Library         Telnet
Library         background_ping.py


*** Variables ***
${APPLIANCE_IP}     15.245.131.62

${stat}         statistics
${name}    sample.txt
${Ping_Lost}                 Lost

*** Test Cases ***

Login to Appliance
    [Documentation]    Login to Appliance
    [Tags]  add   POSITIVE
    Set Log Level    TRACE
    ${resp}    Fusion Api Login Appliance    ${APPLIANCE_IP}        ${admin_credentials}

Initial OV cleanup
    [Documentation]    Performs a initial cleanup
    [Tags]  cleanup    setup
    Set Log Level    TRACE
    Cleanup

Create ethernet network
    [Documentation]    Create ethernet Networks
    Log to console    \n-Creating Ethernet Networks
    ${resp}    Fusion Api Create Ethernet Network    ${ethernet_networks[0]}
    Run Keyword If  '${resp['status_code']}' != '202'  Fail    ELSE  log to console  \nEthernet Network created successfully
    ${uri} =    Get From Dictionary    ${resp['associatedResource']}    resourceUri
    Set Global Variable    ${enet_uri}    ${uri}

Create FC network
    [Documentation]    Create FC Networks
    Log to console    \n-Creating FC Networks
    ${resp}    Fusion Api Create FC Network    ${fc_network[0]}
    Run Keyword If  '${resp['status_code']}' != '202'  Fail    ELSE  log to console  \FC Network created successfully

Create FcoE network
    [Documentation]    Create FcoE Networks
    Log to console    \n-Creating FcoE Networks
    ${resp}    Fusion Api Create Fcoe Network   body=${fcoe_networks}
    Run Keyword If  '${resp['status_code']}' != '202'  Fail    ELSE  log to console  \FcoE Network created successfully

Creating LIG
    [Documentation]    Creating LIG through rest calls
    [Tags]  LIG    setup
    Set Log Level    TRACE

    Log to console and logfile  Creating LIG

    ${task}    Add LIG from variable    ${ligs[0]}    3min    10s
    Run Keyword If  '${task['taskState']}' !='Completed'    fail    msg=\nUnable to create LIG ${task['taskErrors'][0]['errorCode']}
    ...         ELSE    Log to Console    \nsuccessfully created LIG - ${ligs[0]['name']}

############################################################ Test case 1 ################################################################
TC_1_1_Verify sampling values are reflected properly in LIG
    [Documentation]    Verify sampling values are reflected properly in LIG
    [Tags]  VerifySamplingvaluesLIG
    Set Log Level    TRACE

    ${sCount}    ${sInterval}   Check Sampling value in LIG    ${ligs[0]['name']}
    Set Global Variable    ${sampleCount}    ${sCount}
    Set Global Variable    ${sampleInterval}    ${sInterval}
    Log to console    \n Verifying the sample count value is reflected properly in LIG
    ${sampleCount_lig}    Get From Dictionary    ${ligs[0]['telemetryConfiguration']}    sampleCount
    Should Be Equal    ${sampleCount}    ${sampleCount_lig}

    Log to console    \n Verifying the sample interval value is reflected properly in LIG
    ${sampleInterval_lig}    Get From Dictionary    ${ligs[0]['telemetryConfiguration']}    sampleInterval
    Should Be Equal    ${sampleInterval}    ${sampleInterval_lig}

Creating EG
    [Documentation]    Creating EG through rest calls
    [Tags]  EG    setup
    Set Log Level    TRACE

    Log to console and logfile  Creating EG
    ${resp} =    Add Enclosure Group from variable    ${enc_group['EG']}
    Run Keyword If  ${resp['status_code']} != 201    fail    msg=\nUnable to create EG
    ...         ELSE    Log to Console    \nsuccessfully created EG

Creating LE
    [Documentation]    Creating LE through rest calls
    [Tags]  LE    setup
    Set Log Level    TRACE

    ${Resp}    Add Logical Enclosure from variable    ${LE_Potash['LE']}
    Run Keyword If  '${Resp['taskState']}' !='Completed'    fail    msg=\nUnable to Create LE with Error Message
    ...         ELSE    Log to console and logfile  \n\Successfully Created LE !!

TC_1_4_Verifying Sampling values reflected properly in LI
    [Documentation]    Verifying Sampling values reflected properly in LI
    [Tags]  VerifySamplingvaluesLI
    Set Log Level    TRACE

    ${sampleCount_li}    ${sampleInterval_li}   Check Sampling value in LI    ${LI}

    Log to console    \n Verifying the sample count value is reflected properly in LI
    Should Be Equal    ${sampleCount_li}    ${sampleCount}

    Log to console    \n Verifying the sample interval value is reflected properly in LI
    Should Be Equal    ${sampleInterval_li}    ${sampleInterval}

TC_1_5_Creating Server Profile
    [Documentation]  Creating Server profile through rest calls
    [Tags]  ServerProfile    setup
    Set Log Level    TRACE

    Add Server Profiles from variable    ${SP_1}
    Log to console  \n Server profiles created successfully
    Power on server     ${SP_1[0]['serverHardwareUri']}
    Log to console    \n Power on servers
    Log to console    \n Waiting 10 minutes for the server to boot
    Sleep   10min

    ${IP}    ${gate_ip}    Get Server Ip Windows    ${ilo_details_enc2_bay1}
    Set Global Variable    ${server_ip}    ${IP[0]}
    Set Global Variable    ${gateway_ip}    ${gate_ip}

TC_1_6_Get gateway ip of the server and passing traffic
    [Documentation]    Get gateway ip of the server and passing traffic
    [Tags]  PassingTraffic
    Set Log Level    TRACE

    Get gateway ip of the server and passing traffic    ${gateway_ip}    ${server_ip}    ${ping_cmd1}    ${server_details}    ${name}

TC_1_7_Verifying S-Channel common and advanced statistics vaules
    [Documentation]    Verifying S-Channel common and advanced statistics vaules
    [Tags]  VerifyS-channelstatistics
    Set Log Level    TRACE

    Verifying Subport Common Statistics vaules    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${time_interval_2min}    ${min_octets}    ${min_pkts}    ${sub_port_number[0]}
    Wait Until Keyword Succeeds    12 min    10 sec    Verifying sample count in subport Advanced statistics    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${sub_port_number[0]}    ${ligs[0]['telemetryConfiguration']['sampleCount']}

################################################ Test case 2 - Disble/Enable sampling collection & Verify S-channel statistics  ##################################################
TC_2_1_Edit LIG to disable the sampling collection
    [Documentation]    Edit LIG to disable/enable the sampling collection and UFG to reflect the change in LI. Verify the s-channel statistics and historical data after passing IO traffic.
    [Tags]  Disablesamplingcollection
    Set Log Level    TRACE

    ${uri} =    Get LIG Uri     ${ligs[0]['name']}
    Set Global Variable    ${lig_uri}    ${uri}
    ${lig_member}    Get LIG member    ${ligs[0]['name']}
    Log to console    ${lig_member}
    Remove From Dictionary    ${lig_member["telemetryConfiguration"]}    enableTelemetry
    set to dictionary    ${lig_member["telemetryConfiguration"]}    enableTelemetry    false
    ${resp}    Fusion Api Edit LIG     ${lig_member}    ${lig_uri}
    ${task}    Wait For Task   ${resp}     200s    2s
    Log to console    LIG edited & Disabled the utilization sampling collection successfully

TC_2_2_Update from group in LI
    [Documentation]    Update from group in LI
    [Tags]  UFGLI
    Set Log Level    TRACE

    ${li_uri}    Get LI URI    ${LI}
    Perform an Update From Group LI    ${li_uri}    15 min    15 s
    Sleep    3min

TC_2_3_Verifying s-channel common and advanced statistics vaules after disabling utilization sampling collection
    [Documentation]    Verifying common and advanced statistics vaules after disabling utilization sampling collection
    [Tags]  VerifyS-channelStatistics    DisableSamplingCollection
    Set Log Level    TRACE

    ${subportStatistics}    ${subport_commonstat}    ${subport_advancedstat}    Get s-channel statistics    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${sub_port_number[0]}
    ${len} =   Get Length   ${subportCommon_stats_counters}
    :FOR     ${x}   IN RANGE   0   ${len}
    \    ${subport_commonstats}    Get From Dictionary    ${subport_commonstat}    ${subportCommon_stats_counters[${x}]}
    \    Run Keyword If  '${subport_commonstats}' != 'None'    Fail    ELSE    Log to console  \n ${subportCommon_stats_counters[${x}]} counter value is not present because utilization sampling collection is disabled

    Run Keyword If  '${subport_advancedstat}' != 'None'    Fail    ELSE    Log to console  \n Sample values are not present because utilization sampling collection is disabled

TC_2_4_Edit LIG - Enable the sampling collection
    [Documentation]    Edit LIG - Enable the sampling collection
    [Tags]  EnableSamplingCollection
    Set Log Level    TRACE

    ${lig_member}    Get LIG member    ${ligs[0]['name']}
    Remove From Dictionary    ${lig_member["telemetryConfiguration"]}    enableTelemetry
    set to dictionary    ${lig_member["telemetryConfiguration"]}    enableTelemetry    true
    ${resp}    Fusion Api Edit LIG     ${lig_member}    ${lig_uri}
    ${task}    Wait For Task   ${resp}     200s    2s
    Log to console    LIG edited & Enabled the utilization sampling collection successfully

TC_2_5_Update from group
    [Documentation]    Update from group
    [Tags]  UFGLI
    Set Log Level    TRACE

    ${li_uri}    Get LI URI    ${LI}
    Perform an Update From Group LI    ${li_uri}    15 min    15 s
    Sleep    3min

TC_2_6_Verifying s-channel common and advanced statistics after enabling utilization sampling collection
    [Documentation]    Verifying common and advanced statistics after enabling utilization sampling collection
    [Tags]  VerifyS-channelStatistic    EnableSamplingCollection
    Set Log Level    TRACE

    Verifying Subport Common Statistics vaules    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${time_interval_2min}    ${min_octets}    ${min_pkts}    ${sub_port_number[0]}
    Wait Until Keyword Succeeds    12 min    10 sec    Verifying sample count in subport Advanced statistics    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${sub_port_number[0]}    ${ligs[0]['telemetryConfiguration']['sampleCount']}

#################################### Test Case 3 - Disble/Enable sampling collection and reapply configuartion & Verify S-channel statistics ######################################
TC_3_1_Edit LIG - Disable the sampling collection
    [Documentation]    Verify s-channel statistics and historical data by disabling sample collection in LIG and UFG in LI followed by  "Reapply configuration" in LI.
    [Tags]  DisableSampleCollection
    Set Log Level    TRACE

    ${uri} =    Get LIG Uri     ${ligs[0]['name']}
    Set Global Variable    ${lig_uri}    ${uri}
    ${lig_member}    Get LIG member    ${ligs[0]['name']}
    Remove From Dictionary    ${lig_member["telemetryConfiguration"]}    enableTelemetry
    set to dictionary    ${lig_member["telemetryConfiguration"]}    enableTelemetry    false
    ${resp}    Fusion Api Edit LIG     ${lig_member}    ${lig_uri}
    ${task}    Wait For Task   ${resp}     200s    2s
    Log to console    LIG edited & Disabled the utilization sampling collection successfully

TC_3_2_Update from group - LI
    [Documentation]    Update from group - LI
    [Tags]  UpdateFromGroup    LI
    Set Log Level    TRACE

    ${li_uri}    Get LI URI    ${LI}
    Perform an Update From Group LI    ${li_uri}    15 min    15 s

TC_3_3_Reapply Configuration in LI
    [Documentation]    Reapply Configuration in LI
    [Tags]  ReapplyConfiguration    LI
    Set Log Level    TRACE

    Re-apply LI configuration    ${LE}-${ligs[0]['name']}

TC_3_4_Verifying s-channel common and advanced statistics after disabling utilization sampling collection
    [Documentation]    Verifying common and advanced statistics after disabling utilization sampling collection
    [Tags]  VerifyStatistics    Disable
    Set Log Level    TRACE

    ${subportStatistics}    ${subport_commonstat}    ${subport_advancedstat}    Get s-channel statistics    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${sub_port_number[0]}
    ${len} =   Get Length   ${subportCommon_stats_counters}
    :FOR     ${x}   IN RANGE   0   ${len}
    \    ${subport_commonstats}    Get From Dictionary    ${subport_commonstat}    ${subportCommon_stats_counters[${x}]}
    \    Run Keyword If  '${subport_commonstats}' != 'None'    Fail    ELSE    Log to console  \n ${subportCommon_stats_counters[${x}]} counter value is not present because utilization sampling collection is disabled

    Run Keyword If  '${subport_advancedstat}' != 'None'    Fail    ELSE    Log to console  \n Sample values are not present because utilization sampling collection is disabled

TC_3_5_Edit LIG & Enable the sampling collection
    [Documentation]    Edit LIG & Enable the sampling collection
    [Tags]  EnableSampleCollection    LIG
    Set Log Level    TRACE

    ${lig_member}    Get LIG member    ${ligs[0]['name']}
    Remove From Dictionary    ${lig_member["telemetryConfiguration"]}    enableTelemetry
    set to dictionary    ${lig_member["telemetryConfiguration"]}    enableTelemetry    true
    ${resp}    Fusion Api Edit LIG     ${lig_member}    ${lig_uri}
    ${task}    Wait For Task   ${resp}     200s    2s
    Log to console    LIG edited & Enabled the utilization sampling collection successfully

TC_3_6_LI Update from group
    [Documentation]    LI Update from group
    [Tags]  UpdateFromGroup    LI
    Set Log Level    TRACE

    ${li_uri}    Get LI URI    ${LI}
    Perform an Update From Group LI    ${li_uri}    15 min    15 s

TC_3_7_Reapply Configuration - LI
    [Documentation]    Reapply Configuration - LI
    [Tags]  ReapplyConfigurationLI
    Set Log Level    TRACE

    Re-apply LI configuration    ${LE}-${ligs[0]['name']}

TC_3_8_Verifying s-channel common statistics and advanced statistics after enabling utilization sampling collection
    [Documentation]    Verifying common statistics and advanced statistics after enabling utilization sampling collection
    [Tags]  VerifyStatistics    EnableSampleCollection
    Set Log Level    TRACE

    Verifying Subport Common Statistics vaules    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${time_interval_2min}    ${min_octets}    ${min_pkts}    ${sub_port_number[0]}
    Wait Until Keyword Succeeds    12 min    10 sec    Verifying sample count in subport Advanced statistics    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${sub_port_number[0]}    ${ligs[0]['telemetryConfiguration']['sampleCount']}

    ${out}    execute_traffic    ${server_ip}    ${server_details['username']}    ${server_details['password']}    ${kill_cmd}
    Clear Port Counters    ${IC[1]}

########################################### Test Case 4 - Edit LI with diff sampling interval & sample count-Verify S-channel statistics ###########################################
TC_4_Edit LI with diff sampling interval & sample count
    [Documentation]    Edit LI with different sampling interval (60-3600sec) and total number of samples (12-50).Verify the s-channel statistics and historic data for all samples by passing IO traffic
    [Tags]  EditLIDiffSampleCountAndSampleInterval
    Set Log Level    TRACE

    ${IP}    ${gateway_ip}    Get Server Ip Windows    ${ilo_details_enc2_bay1}
    Set Global Variable    ${server_ip}    ${IP[0]}
    Get gateway ip of the server and passing traffic    ${gateway_ip}    ${server_ip}    ${ping_cmd1}    ${server_details}    ${name}

    ${li_uri}    Get LI URI    ${LI}
    Log to console    ${li_uri}

    ${li_resp} =    Fusion Api Get Li   ${li_uri}
    Log to console    ${li_resp}
    ${telemetry_1_uri}    Get From Dictionary    ${li_resp['telemetryConfiguration']}    uri
    ${telemetry_1_name}    Get From Dictionary    ${li_resp['telemetryConfiguration']}    name
    Set To Dictionary     ${Li_body}     uri   ${telemetry_1_uri}
    Set To Dictionary     ${Li_body}   name    ${telemetry_1_name}
    set to dictionary    ${Li_body}    sampleCount    ${diff_sample_count[1]}
    set to dictionary    ${Li_body}    sampleInterval    ${diff_sample_interval[1]}
    ${resp}    Fusion Api Update LI Telemetry Configuration    ${Li_body}    ${telemetry_1_uri}
    ${task}    Wait For Task   ${resp}     200s    2s
    Log to console    Telemetry configuration edited in LI successfully

    Verifying Subport Common Statistics vaules    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${time_interval_5min}    ${min_octets}    ${min_pkts}    ${sub_port_number[0]}
    Wait Until Keyword Succeeds    80 min    5 min    Verifying sample count in subport Advanced statistics    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${sub_port_number[0]}    ${diff_sample_count[1]}
    ${out}    execute_traffic    ${server_ip}    ${server_details['username']}    ${server_details['password']}    ${kill_cmd}

    ${lig_uri}    Get LIG URI    ${ligs[0]['name']}
    ${body}    Build LIG body    ${ligs[0]}
    ${resp}    Fusion Api Edit LIG      body=${body}    uri=${lig_uri}
    Run Keyword If    ${resp['status_code']} != 202    Fail    ELSE    Log to Console    \nSuccessfully edited LIG

    ${li_uri}    Get LI URI    ${LI}
    Perform an Update From Group LI    ${li_uri}    15 min    15 s

##################################################### Test Case 5 - Backup & Restore & Verify S-channel statistics #######################################################
TC_5_1_Create Backup
    [Documentation]    Create Backup
    [Tags]  CreateBackup
    Set Log Level    TRACE

    Log to console and logfile    \n-Creating the backup in OV
    Power off ALL Servers
    ${resp}=    Fusion Api Create Backup
    Run Keyword If  ${resp['status_code']} !=202    fail    msg=\nBackup failed. \n ErrorCode:${resp['errorCode']}\n ${resp['message']}
    ${task} =   Wait For Task   ${resp}     10 min    20s
    Run Keyword If  '${task['taskState']}' !='Completed'   or   ${task['status_code']} !=200   fail    msg=\nBackup failed. \n ErrorCode:${task['taskErrors']}\n ${task['taskStatus']}
    ...         ELSE    Log to console and logfile  \n\nBackup Created Succesfully !! \n ${task['taskStatus']}

TC_5_2_Edit LIG with sampling interval 100 and Update from group in LI
    [Documentation]    Edit LIG with sampling interval 100 and Update from group in LI
    [Tags]  EditLIGInterval100UPGLI
    Set Log Level    TRACE

    ${uri} =    Get LIG Uri     ${ligs[0]['name']}
    Set Global Variable    ${lig_uri}    ${uri}
    ${lig_member}    Get LIG member    ${ligs[0]['name']}
    set to dictionary    ${lig_member["telemetryConfiguration"]}    sampleInterval    ${sample_interval_100}
    ${resp}    Fusion Api Edit LIG     ${lig_member}    ${lig_uri}
    ${task}    Wait For Task   ${resp}     200s    2s
    Log to console    Telemetry configuration edited in LIg successfully
    ${li_uri}    Get LI URI    ${LI}
    Perform an Update From Group LI    ${li_uri}    15 min    15 s

TC_5_3_Verifying the sampling interval value is reflected properly in LIG & LI
    [Documentation]    Verifying the sampling interval value is reflected properly in LIG & LI
    [Tags]  CheckSampleValuesInLIGAndLI
    Set Log Level    TRACE
    ${sampleCount}    ${sampleInterval}   Check Sampling value in LIG    ${ligs[0]['name']}
    Should Be Equal    '${sampleInterval}'    '${sample_interval_100}'

    ${sampleCount_li}    ${sampleInterval_li}   Check Sampling value in LI    ${LI}
    Should Be Equal    '${sampleInterval_li}'    '${sample_interval_100}'

TC_5_4_Restore From backup
    [Documentation]    Restore From backup
    [Tags]  RestoreFromBackup
    Set Log Level    TRACE

    Log to console and logfile     \n\nRestoring from the backup in the appliance
    Restore From Backup
    Sleep   5 min
    Fusion Api Login Appliance    ${APPLIANCE_IP}    ${admin_credentials}

TC_5_5_Verifying the sampling interval value in LIG & LI after backup
    [Documentation]    Verifying the sampling interval value is reflected properly in LIG & LI
    [Tags]  VerifySampleValues
    Set Log Level    TRACE

    ${sampleCount}    ${sampleInterval}   Check Sampling value in LIG    ${ligs[0]['name']}
    ${sampleInterval_lig}    Get From Dictionary    ${ligs[0]['telemetryConfiguration']}    sampleInterval
    Should Be Equal    ${sampleInterval}    ${sampleInterval_lig}

    ${sampleCount_li}    ${sampleInterval_li}   Check Sampling value in LI    ${LI}
    Should Be Equal    ${sampleInterval_li}    ${sampleInterval_lig}

    Power on server     ${SP_1[0]['serverHardwareUri']}
    Log to console    \n Power on servers
    Log to console    \n Waiting 10 minutes for the server to boot
    Sleep   10min
    ${IP}    ${gate_ip}    Get Server Ip Windows    ${ilo_details_enc2_bay1}
    Set Global Variable    ${server_ip}    ${IP[0]}
    Set Global Variable    ${gateway_ip}    ${gate_ip}

TC_5_6_Get gateway ip of server and passing traffic
    [Documentation]    Get gateway ip of server and passing traffic
    [Tags]  PassTraffic    AfterRestore
    Set Log Level    TRACE

    Get gateway ip of the server and passing traffic    ${gateway_ip}    ${server_ip}    ${ping_cmd1}    ${server_details}    ${name}

TC_5_7_Verifying s-channel common statistics and advanced statistics vaules after restore
    [Documentation]    Verifying common statistics and advanced statistics vaules after enabling utilization sampling collection
    [Tags]  VerifyS-channelStatistics    AfterRestore
    Set Log Level    TRACE

    Verifying Subport Common Statistics vaules    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${time_interval_2min}    ${min_octets}    ${min_pkts}    ${sub_port_number[0]}
    Wait Until Keyword Succeeds    12 min    10 sec    Verifying sample count in subport Advanced statistics    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${sub_port_number[0]}    ${ligs[0]['telemetryConfiguration']['sampleCount']}

    ${out}    execute_traffic    ${server_ip}    ${server_details['username']}    ${server_details['password']}    ${kill_cmd}
    Clear Port Counters    ${IC[0]}

####################################### Test Case 6 - Edit LIG with diff sampling interval & sample count-Verify S-channel statistics ##########################################

TC_6_Edit LIG with diff sampling interval & sample count
    [Documentation]    Edit LIG followed by LI update from group with different sampling interval (60-3600sec) and total number of samples (12-50).Verify the s-channel statistics and historic data for all samples by passing IO traffic
    [Tags]  EditLIGDiffSampleCountAndSampleInterval
    Set Log Level    TRACE

    ${IP}    ${gateway_ip}    Get Server Ip Windows    ${ilo_details_enc2_bay1}
    Set Global Variable    ${server_ip}    ${IP[0]}
    Get gateway ip of the server and passing traffic    ${gateway_ip}    ${server_ip}    ${ping_cmd1}    ${server_details}    ${name}
    ${uri}    Get LIG Uri     ${ligs[0]['name']}
    Set Global Variable    ${lig_uri}    ${uri}
    ${lig_member}    Get LIG member    ${ligs[0]['name']}
    set to dictionary    ${lig_member["telemetryConfiguration"]}    sampleCount    ${diff_sample_count[0]}
    set to dictionary    ${lig_member["telemetryConfiguration"]}    sampleInterval    ${diff_sample_interval[0]}
    ${resp}    Fusion Api Edit LIG     ${lig_member}    ${lig_uri}
    ${task}    Wait For Task   ${resp}     200s    2s
    Log to console    Telemetry configuration edited in LIg successfully
    ${li_uri}    Get LI URI    ${LI}
    Perform an Update From Group LI    ${li_uri}    15 min    15 s


    Verifying Subport Common Statistics vaules    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${time_interval_2min}    ${min_octets}    ${min_pkts}    ${sub_port_number[0]}
    Wait Until Keyword Succeeds    40 min    2 min     Verifying sample count in subport Advanced statistics    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${sub_port_number[0]}    ${diff_sample_count[0]}

    ${out}    execute_traffic    ${server_ip}    ${server_details['username']}    ${server_details['password']}    ${kill_cmd}
    Clear Port Counters    ${IC[1]}


######################################################### Test Case 7 - Happy Path & Verify S-channel statistics###################################################################
TC_7_1_Creating Server Profiles
    [Documentation]    Creating Server profiles through rest call
    [Tags]  ServerProfile
    Set Log Level    TRACE

    Power off ALL Servers
    Remove All Server Profiles
    Add Server Profiles from variable    ${SP_3}
    Log to console  \n Server profiles created successfully
    ${len}    Get Length    ${SP_3}
    :FOR    ${x}    IN RANGE    0   ${len}
    \    Power on server     ${SP_3[${x}]['serverHardwareUri']}
    \    Log to console    \n Power on servers
    \    Log to console    \n Waiting 10 minutes for the server to boot
    \    Sleep   10min

TC_7_2_Verifying s-channel statistics values for Ethernet connection with different packet size - Unicast Traffic
    [Documentation]    Verifying s-channel statistics values for Ethernet connection with different packet size - Unicast Traffic
    [Tags]  VerifyStatisticsEthernet    Unicast
    Set Log Level    TRACE

    ${IP}    ${gateway_ip}    Get Server Ip Windows    ${ilo_details_enc2_bay1}
    Set Global Variable    ${server_ip}    ${IP[0]}
    ${len}    Get Length    ${ping_cmds}
    :FOR    ${x}    IN RANGE    0   ${len}
    \    Clear Port Counters    ${IC[1]}
    \    Get gateway ip of the server and passing traffic    ${gateway_ip}    ${server_ip}    ${ping_cmds[${x}]}    ${server_details}    ${name}
    \    Verifying Subport Common Statistics vaules    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${time_interval_2min}    ${diff_octets[${x}]}    ${diff_pkts[0]}    ${sub_port_number[0]}
    \    Wait Until Keyword Succeeds    12 min    60 sec    Verifying sample count in subport Advanced statistics    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${sub_port_number[0]}    ${ligs[0]['telemetryConfiguration']['sampleCount']}
    \    execute_traffic    ${server_ip}    ${server_details['username']}    ${server_details['password']}    ${kill_cmd}

TC_7_3_Verifying s-channel statistics values for FC connection with different packet size - Unicast Traffic
    [Documentation]    Verifying s-channel statistics values for FC connection with different packet size - Unicast Traffic
    [Tags]  VerifyStatisticsFC    Unicast
    Set Log Level    TRACE

    ${len}    Get Length    ${diskspd_cmd}
    Log to console  \n length ${len}
    :FOR    ${x}    IN RANGE    0   ${len}

    \    Clear Port Counters    ${IC[1]}
    \    execute_traffic    ${server_ip}    ${server_details['username']}    ${server_details['password']}    ${diskspd_cmd[${x}]}
    \    Verifying common statistics and advanced statistics vaules    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${time_interval_2min}    ${sub_port_number[1]}
    \    execute_traffic    ${server_ip}    ${server_details['username']}    ${server_details['password']}    ${kill_diskspd}

TC_7_4_Verifying s-channel statistics values for FcoE connection with different packet size - Unicast Traffic
    [Documentation]    Verifying s-channel statistics values for FcoE connection with different packet size - Unicast Traffic
    [Tags]  VerifyStatisticsFcoE    Unicast
    Set Log Level    TRACE

    ${server_ip}    ${gateway_ip}    Get Server Ip Windows    ${ilo_details_enc1_bay6}
    ${len}    Get Length    ${diskspd_cmd}
    Log to console  \n length ${len}
    :FOR    ${x}    IN RANGE    0   ${len}

    \    Clear Port Counters    ${IC[1]}
    \    execute_traffic    ${server_ip[0]}    ${server_details['username']}    ${server_details['password']}    ${diskspd_cmd[${x}]}
    \    Verifying common statistics and advanced statistics vaules    ${IC[1]}    ${stat}    ${downlink_fcoe[0]}    ${time_interval_2min}    ${sub_port_number[1]}
    \    execute_traffic    ${server_ip[0]}    ${server_details['username']}    ${server_details['password']}    ${kill_diskspd}

TC_7_5_Verifying s-channel statistics values for Ethernet connection with different packet size - Broadcast Traffic
    [Documentation]    Verifying s-channel statistics values for Ethernet connection with different packet size - Broadcast Traffic
    [Tags]  VerifyStatisticsEthernet    Broadcast
    Set Log Level    TRACE

    ${server_ip}    ${gateway_ip}    Get Server Ip Windows    ${ilo_details_enc2_bay1}
    ${len}    Get Length    ${ping_cmds}
    :FOR    ${x}    IN RANGE    0   ${len}
    \    Clear Port Counters    ${IC[1]}
    \    ${ping_cmd}    Replace String Using Regexp    ${ping_cmds[${x}]}    'gateway_ip'      ${broadcast_ip}
    \    ${out}    execute_traffic    ${server_ip[0]}    ${server_details['username']}    ${server_details['password']}    ${ping_cmd}
    \    Verifying Subport Common Statistics vaules    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${time_interval_2min}    ${diff_octets_bc[${x}]}    ${diff_pkts_bc[0]}    ${sub_port_number[0]}
    \    Wait Until Keyword Succeeds    12 min    10 sec    Verifying sample count in subport Advanced statistics    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${sub_port_number[0]}    ${ligs[0]['telemetryConfiguration']['sampleCount']}
    \    execute_traffic    ${server_ip[0]}    ${server_details['username']}    ${server_details['password']}    ${kill_cmd}

################################################ Test Case 8 - Delete Server Profile and verify the statistics ###########################################################
TC_8_Remove Server Profile and verify the statistic and historical collection
    [Documentation]    Remove Server Profile and verify the statistic and historical collection
    [Tags]  RemoveProfile    Unicast
    Set Log Level    TRACE

    Power off ALL Servers
    Remove All Server Profiles
    Verify Deleted connection displays subport statistics    ${IC[1]}    ${stat}    ${downlink_ports[1]}    ${sub_port_number[1]}

#################################################### Test Case 9 - Negative Scenarios ############################################################
TC_9_1_Neg_Create LIG with Invalid Sample Values
    [Documentation]    Create LIG with Invalid sample values
    [Tags]    Negative    CreateLIGInvalidSampleValues
    Set Log Level    TRACE

    Log to console and logfile  Creating LIG

    :FOR    ${lig}    IN    @{ligs_negative}
    \    ${body}    Build LIG body    ${lig}
    \    ${resp}    Fusion Api Create Lig    ${body}
    \    Run Keyword If  ${resp['status_code']} != 400 or '${resp['errorCode']}' != 'CRM_INVALID_ARGUMENT'  Fail
    \    ...    ELSE    Log to Console    \nCould not Create LIG with Invalid sample values - ${resp['details']} \nError: ${resp['errorCode']} \n Error message : ${resp['message']}

TC_9_2_Neg_Edit LIG with Invalid Sample Count
    [Documentation]    Edit LIG with Invalid sample Count
    [Tags]    Negative    EditLIGInvalidSampleCount
    Set Log Level    TRACE

    ${lig_uri}    Get LIG URI    ${LIG}
    ${lig_edit}    Get LIG member    ${LIG}
    Set to Dictionary    ${lig_edit['telemetryConfiguration']}    sampleCount    400
    ${resp} =   Fusion Api Edit LIG     body=${lig_edit}    uri=${lig_uri}
    Run Keyword If  ${resp['status_code']} != 400 or '${resp['errorCode']}' != 'CRM_INVALID_ARGUMENT'  Fail
    ...    ELSE    Log to Console    \nCould not Edit LIG with Invalid sample count - ${resp['details']} \n Error: ${resp['errorCode']} \n Error message : ${resp['message']}

TC_9_3_Neg_Edit LIG with Invalid Sample Interval
    [Documentation]    Edit LIG with Invalid sample Interval
    [Tags]    Negative    EditLIGInvalidSampleInterval
    Set Log Level    TRACE

    ${lig_uri}    Get LIG URI    ${LIG}
    ${lig_edit}    Get LIG member    ${LIG}
    Set to Dictionary    ${lig_edit['telemetryConfiguration']}    sampleInterval    3700
    ${resp} =   Fusion Api Edit LIG     body=${lig_edit}    uri=${lig_uri}
    Run Keyword If  ${resp['status_code']} != 400 or '${resp['errorCode']}' != 'CRM_INVALID_ARGUMENT'  fail
    ...    ELSE    Log to Console    \nCould not Edit LIG with Invalid sample count - ${resp['details']} \n Error: ${resp['errorCode']} \n Error message : ${resp['message']}

TC_9_4_Neg_Edit LI with Invalid Sample Count
    [Documentation]    Edit LI with Invalid sample Count
    [Tags]    Negative    EditLIInvalidSampleCount
    Set Log Level    TRACE

    ${Telemetry_uri}    ${body}    Get LI Telemetry Configuration    ${LE}-${LIG}
    Set to Dictionary    ${body}    sampleCount    11
    ${resp}    fusion_api_update_li_telemetry_configuration    body=${body}    uri=${Telemetry_uri}
    Run Keyword If  ${resp['status_code']} != 400 or '${resp['errorCode']}' != 'CRM_INVALID_ARGUMENT'  fail
    ...    ELSE    Log to Console    \nCould not Edit LIG with Invalid sample count - ${resp['details']} \n Error: ${resp['errorCode']} \n Error message : ${resp['message']}

TC_9_5_Neg_Edit LI with Invalid Sample Interval
    [Documentation]    Edit LI with Invalid sample Interval
    [Tags]    Negative    EditLIInvalidSampleInterval
    Set Log Level    TRACE

    ${Telemetry_uri}    ${body}    Get LI Telemetry Configuration    ${LE}-${LIG}
    Set to Dictionary    ${body}    sampleInterval    59
    ${resp}    fusion_api_update_li_telemetry_configuration    body=${body}    uri=${Telemetry_uri}
    Run Keyword If  ${resp['status_code']} != 400 or '${resp['errorCode']}' != 'CRM_INVALID_ARGUMENT'  fail
    ...    ELSE    Log to Console    \nCould not Edit LIG with Invalid sample Interval - ${resp['details']} \n Error: ${resp['errorCode']} \n Error message : ${resp['message']}

TC_9_6_Neg_Adding different users and verifying authentication
    [Documentation]    Adding different users and verifying authentication
    [Tags]    AddUser
    Set Log Level    TRACE

    Remove ALL Users
    :FOR    ${user}    IN    @{users}
    \    ${resp} =  Fusion Api Add User     body=${user}
    \    Run Keyword If  ${resp['status_code']} != 200    Fail
    \    ...    ELSE    log to console    \n-Created ${user['userName']} user successfully

    ${resp}     Fusion Api Logout Appliance
    Run Keyword If    ${resp['status_code']} != 204    Fail    ELSE    log to console    \n-Logged out successfully

TC_9_7_Verify Only Network Users is authorized to Create LIG
    [Documentation]    Verify Only Network Users is authorized
    [Tags]    Negative    NetworkUserAuthorizedCreateLIG
    Set Log Level    TRACE

    ${Resp}    Fusion Api Login Appliance    ${appliance_ip}    ${usercred[0]}
    ${body}    Build LIG body    ${lig_neg[0]}
    ${resp}    Fusion Api Create Lig    ${body}
    Run Keyword If    ${resp['status_code']} != 202    Fail    ELSE    Log to Console    \nonly ${usercred[0]['userName']} can be able to create LIG

    ${len}    Get Length    ${users}
    :FOR    ${x}    IN RANGE    1    ${len}
    \    ${Resp}    Fusion Api Login Appliance    ${appliance_ip}    ${usercred[${x}]}
    \    ${body}    Build LIG body    ${lig_neg[0]}
    \    ${resp} =    Fusion Api Create Lig    ${body}
    \    Run Keyword If  ${resp['status_code']} != 403 or '${resp['errorCode']}' != 'ACTION_FORBIDDEN_BY_ROLE'    Fail    ELSE    Log to Console    \n ${usercred[${x}]['userName']} cannot create LIG \n Error: ${resp['errorCode']}

TC_9_8_Verify Only Network Users is authorized to Edit LIG
    [Documentation]    Verify Only Network Users is authorized
    [Tags]    Negative    NetworkUserAuthorizedEditLIG
    Set Log Level    TRACE

    ${Resp}    Fusion Api Login Appliance    ${appliance_ip}    ${usercred[0]}
    ${lig_uri}    Get LIG URI    ${lig_neg[1]['name']}
    ${lig_edit}    Get LIG member    ${lig_neg[1]['name']}
    ${resp} =   Fusion Api Edit LIG     body=${lig_edit}    uri=${lig_uri}
    Run Keyword If    ${resp['status_code']} != 202    Fail    ELSE    Log to Console    \nonly ${usercred[0]['userName']} can be able to edit LIG

    ${len}    Get Length    ${users}
    :FOR    ${x}    IN RANGE    1    ${len}
    \    ${Resp}    Fusion Api Login Appliance    ${appliance_ip}    ${usercred[${x}]}
    \    ${lig_uri}    Get LIG URI    ${lig_neg[1]['name']}
    \    ${lig_edit}    Get LIG member    ${lig_neg[1]['name']}
    \    ${resp} =  Fusion Api Edit LIG     body=${lig_edit}    uri=${lig_uri}
    \    Run Keyword If  ${resp['status_code']} != 403 or '${resp['errorCode']}' != 'ACTION_FORBIDDEN_BY_ROLE'    Fail    ELSE    Log to Console    \n ${usercred[${x}]['userName']} cannot edit LIG \n Error: ${resp['errorCode']}

Final OV cleanup
    [Documentation]    Performs a final cleanup
    [Tags]  cleanup    setup
    Set Log Level    TRACE
    Cleanup