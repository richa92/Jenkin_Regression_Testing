*** Settings ***
Documentation		Feature Test: SE F109 Test
Variables 		./data_variables.py	

Resource         ../../../../resource/fusion_api_all_resource_files.txt
Resource        ../FVT/fvt-keywords.txt
Resource        ../FVT/Resources/fvt_resource.txt

Library				FusionLibrary
Library				../FVT/fvt_api.py

*** Variables ***
${LIG}			Enc-LIG
${EG}			Enc-EG
${LE}			Enc-LE
${LI}			Enc-LE-Enc-LIG
${Uplink_Set}	uplink_set	
${profile1}     profile1
${profile2}     profile2

${LI_URI}	None
${ENC_URI}	None
${LIG_URI}	None
${networkuri}	None

*** Test Cases ***
Login In
 	Set Log Level	TRACE
	Fusion Api Login Appliance 		${APPLIANCE_IP}		${admin_credentials}

Create Ethernet Networks
	####Create Ethernet Networks
	#Pass Execution	"Skipped"
	
	Create Ethernet Networks	${ethernet_networks}
	
Create Logical Interconnect Groups
	##### Add Logical Interconnect Groups #####
	#Pass Execution	"Skipped"
	
	${resp} =	Add LIG from variable	${ligs['${LIG}']}
	Should Be Equal As Integers	${resp['status_code']}	202
	${resp}	Fvt Api Get Logical Interconnect Group By Name	${LIG}
	Should Be Equal As Strings	${resp['name']}	${LIG}

Create Enclosure Groups	
	##### Add Enclosure Groups #####
	
	#Pass Execution	"Skipped"
		
	${resp} =	Add Enclosure Group from variable	${enc_group['${EG}']}
	${resp}	fvt_api.Fvt Api Get Enclosure Group By Name	${EG}
	Should Be Equal As Strings	${resp['status']}	OK
	Should Be Equal As Strings	${resp['name']}	${EG}

Create Logical Enclosure
	##### Create Logical Enclosure and Validate consistencyStatus of LI ${les['${LE}']} #####
	#Pass Execution	"Skipped"
	
	Add Logical Enclosure from variable	${les['${LE}']}
	${resp}	Fvt Api Get Logical Enclosure By Name	${LE}
	Should Be Equal As Strings	${resp['name']}	${LE}
	Should Match Regexp	${resp['status']}	((?i)Warning|OK)
	Set Global Variable	${LE_URI}	${resp['uri']}
	
	${resp}	Fvt Api Get Logical Interconnect By Name	${LI}
	Run Keyword If	${resp} != None	Set Global Variable	${LI_URI}	${resp['uri']}
	Should Be Equal As Strings	${resp['consistencyStatus']}	CONSISTENT
	
Power Off
	#Pass Execution	"Skipped"
	Power off ALL servers

Create Profile1
	#Pass Execution	"Skipped"
	
	${resp}	fvt-keywords.Add Server Profile	${profiles[0]}
	Wait For Task	${resp}	timeout=600m	interval=1m
	Wait For Task	${resp}	timeout=600m	interval=1m
	${resp}	Fvt Api Get Server Profile By Name	${profiles[0]['name']}
	Should Be Equal As Strings	${resp['status']}	OK


LI Update From Group And Internal Networks
	#Pass Execution	"Skipped"
	
	Run Keyword and Ignore Error    Write To ciDebug Log
	
	${resp}	Fvt Api Get Logical Interconnect By Name	${LI}
	Run Keyword If	${resp} != None	Set Global Variable	${LI_URI}	${resp['uri']}
	
	${resp}	Fvt Api Get Enclosure By Name	${ENC1}
	
	${resp} =	Fvt Api_ Get Ethernet Network By Name	wpstnetwork1
	Run Keyword If	${resp} != None	Set Global Variable	${networkuri}	${resp['uri']}
	
	${us} =	Copy Dictionary	${LI_uplink_sets['uplinkset_2']}
	${body} =	Build US body	${us}	${LI_URI}
	
	${us} =	Fvt Api Get Uplink Set By Name	${LI_uplink_sets['uplinkset_2']['name']}
	
	${us_uri} =	Get From Dictionary	${us}	uri
	
	### remove one network from upkink set ###
	${resp} =	Fusion Api Edit Uplink Set	body=${body}	uri=${us_uri}
	${task} =	Wait For Task	${resp}	5 min	15s
	
	${valDict} =	Create Dictionary	status_code=${200}
	Validate Response	${task}	${valDict}
	
	### LI should become inconsistent ###
	${resp}	Fvt Api Get Logical Interconnect By Name	${LI}
	
	Run Keyword If	${resp} != None	Set Global Variable	${LI_URI}	${resp['uri']}
	Should Be Equal As Strings	${resp['consistencyStatus']}	NOT_CONSISTENT
	
	### but profile should remain in OK state ###
	${resp}	Fvt Api Get Server Profile By Name	${profiles[0]['name']}
	Should Be Equal As Strings	${resp['status']}	OK
	
	### now remove the network from internal network list ###
	${uris} =	Fvt Api Convert Resources To Uris	${updated_internal_network_list}
	${resp} =	Fvt Api Update Internal Networks	${uris}	${LI_URI}
	Sleep	5m
	
	### profile should go to Critical state ###
	${resp}	Fvt Api Get Server Profile By Name	${profiles[0]['name']}
	Should Be Equal As Strings	${resp['status']}	Critical
	
	Sleep	5m
	
	### perform update from group from LIG ###
	${resp} =	Fusion Api Update From Group	${LI_URI}
	Should Be Equal As Integers	${resp['status_code']}	202
	${task} =	Wait For Task	${resp}	10 min	15s
	Sleep	5m
	
	### Profile should be in OK state ###
	${resp}	Fvt Api Get Server Profile By Name	${profiles[0]['name']}
	Should Be Equal As Strings	${resp['status']}	OK
	
	### LI should be back in CONSISTENT state ###
	${resp}	Fvt Api Get Logical Interconnect By Name	${LI}
	Run Keyword If	${resp} != None	Set Global Variable	${LI_URI}	${resp['uri']}
	Should Be Equal As Strings	${resp['consistencyStatus']}	CONSISTENT
	

LIG Update From Group
	#Pass Execution	"Skipped"
	Run Keyword and Ignore Error    Write To ciDebug Log
	
	${resp}	Fvt Api Get Logical Interconnect Group By Name	${LIG}
	Run Keyword If	${resp} != None	Set Global Variable	${LIG_URI}	${resp['uri']}
	
	${resp}	Fvt Api Get Enclosure By Name	${ENC1}
	Run Keyword If	${resp} != None	Set Global Variable	${ENC_URI}	${resp['uri']}
	
	${us} =	Copy Dictionary	${ligs['Enc-LIG2']}
	${body} =	Build LIG body	${us}
	
	### Edit LI to remove wpstnetwork1 fom uplink set ###
	${resp} =	Fusion Api Edit Lig	body=${body}	uri=${LIG_URI}
	${task} =	Wait For Task	${resp}	5 min	15s
	
	### LI should become inconsistent ###
	${resp}	Fvt Api Get Logical Interconnect By Name	${LI}
	Run Keyword If	${resp} != None	Set Global Variable	${LI_URI}	${resp['uri']}
	Should Be Equal As Strings	${resp['consistencyStatus']}	NOT_CONSISTENT
	
	### Profile should be in OK state ###
	${resp}	Fvt Api Get Server Profile By Name	${profiles[0]['name']}
	Should Be Equal As Strings	${resp['status']}	OK
	
	### perform update from group from LIG ###
	${resp} =	Fusion Api Update From Group	${LI_URI}
	Should Be Equal As Integers	${resp['status_code']}	202
	${task} =	Wait For Task	${resp}	15 min	15s
	Sleep	5m
	
	### LI should become consistent ###
	${resp}	Fvt Api Get Logical Interconnect By Name	${LI}
	Run Keyword If	${resp} != None	Set Global Variable	${LI_URI}	${resp['uri']}
	Should Be Equal As Strings	${resp['consistencyStatus']}	CONSISTENT
	

Clean Up
	### Delete Profile ###
	#Pass Execution	"Skipped" 
	Fusion Api Delete Server Profile	${profiles[0]['name']}
	Sleep	10m
	
	### Delete Logical Enclosure ###
	${resp}	Fvt Api Get Logical Enclosure By Name	${LE}
	Should Be Equal As Strings	${resp['name']}	${LE}
	Should Match Regexp	${resp['status']}	((?i)Warning|OK)
	Set Global Variable	${LE_URI}	${resp['uri']}
	${resp}	Fusion Api Delete Logical Enclosure	uri=${LE_URI}
	Should Be Equal As Integers	${resp['status_code']}	202
	Wait For Task	${resp}	timeout=600m	interval=1m	
	${resp}	Fvt Api Get Logical Enclosure By Name	${LE}
	Should Be Equal As Strings	${resp}	None

	### Ensure Logical Interconnect is Deleted ###
	${resp}	Fvt Api Get Logical Interconnect BY Name	${LI}
	Should Be Equal As Strings	${resp}	None

	### Delete Enclosure Groups ###
	${resp}	Fusion Api Delete Enclosure Group	${EG}
	Should Be Equal As Integers	${resp['status_code']}	204
	${resp}	Fvt Api Get Enclosure Group BY Name	${EG}
	Should Be Equal As Strings	${resp}	None
	
	### Delete Logical Interconnect Groups ###
	${resp}	Fusion Api Delete LIG	${LIG}
	Should Be Equal As Integers	${resp['status_code']}	202
	Wait For Task	${resp}	timeout=5m	interval=1s	
	${resp}	Fvt Api Get Enclosure Group BY Name	${LIG}
	Should Be Equal As Strings	${resp}	None

	Delete Ethernet Networks By Payload     ${ethernet_networks}
	