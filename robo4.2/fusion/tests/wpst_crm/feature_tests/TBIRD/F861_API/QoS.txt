*** Settings ***
Documentation		TearDown using FusionLibrary API keywords
Variables		data_variables.py
Library			json
Library			FusionLibrary
Library			RoboGalaxyLibrary
Library			Collections
Library			SSHLibrary
Library			String
Resource		resource.txt
Suite Teardown	Suite Teardown

*** Variables ***
${APPLIANCE_IP}		15.245.131.222


*** Test Cases ***

1. Login to Appliance

	[Tags]  add   POSITIVE
	Set Log Level    TRACE
	Fusion Api Login Appliance    ${APPLIANCE_IP}        ${admin_credentials}


2. Create LiG with QoS type CustomwithFcoe 
  
    ${body} =   Build LIG body     ${LIGS_TB[0]}
	${qosConfiguration} =   Get From Dictionary   ${QoS_Fcoe}  qosConfiguration
	Set to dictionary	${body}     qosConfiguration    ${qosConfiguration}
	log to console		replaced body is:${body}
	${resp} = 	Fusion Api Create LIG	${body}
	${task} =   Wait For Task    ${resp} 	400s	2s
	log to console		response is:${resp}
	Run Keyword If	'${resp['status_code']}' != '202'	fail    ELSE    Log to Console  \n-LIG  created successfully
 
3. Create EG

    Log to console	\n Creating EG
	${Resp} =	Add Enclosure Group from variable		${enc_group}
	Run Keyword If  '${Resp['status_code']}' != '201'  Fail    ELSE  log to console   \n-created EG successfully

4. Creating LE

    Log to console	\n Creating LE
	${Resp} =	Add Logical Enclosure from variable     ${Logical_Enclosure[0]}
	Run Keyword If  '${Resp['status_code']}' != '202'  Fail    ELSE  log to console   \n-created LE successfully
    
5. verifying QoS values in LIG

    ${Resp} =	Fusion Api Get Lig     param=?filter="'name'=='${LIGS_TB[0]['name']}'"
	${Resp1} = 	Copy List	${Resp['members'][0]['qosConfiguration']['activeQosConfig']['qosTrafficClassifiers']}
	${Resp2} = 	Copy List	${QoS_Fcoe['qosConfiguration']['activeQosConfig']['qosTrafficClassifiers']}
    Run Keyword If		'${Resp['members'][0]['qosConfiguration']['activeQosConfig']['configType']}' != '${QoS_Fcoe['qosConfiguration']['activeQosConfig']['configType']}' or '${Resp['members'][0]['qosConfiguration']['activeQosConfig']['uplinkClassificationType']}' != '${QoS_Fcoe['qosConfiguration']['activeQosConfig']['uplinkClassificationType']}' or '${Resp['members'][0]['qosConfiguration']['activeQosConfig']['downlinkClassificationType']}' != '${QoS_Fcoe['qosConfiguration']['activeQosConfig']['downlinkClassificationType']}'  Fail    ELSE  log to console   \n-Successfully got the QoS details
	Check Qos values	${Resp1}	${Resp2}
 
6. Editing Li with QoS type CustomwithoutFcoe

    ${resp} =    Fusion Api Get Li   	    
	${uri} =     Get From Dictionary        ${resp['members'][0]}    uri
	${respl} =	Fusion Api Update qos aggregated configuration		body=${QoS_NoFcoe['qosConfiguration']}	uri=${uri}
    log to console	Editing Li with QoS ${respl}
	${task} =	Wait For Task 	${respl} 	900s	2s
    #Sleep	7 min
	Run Keyword If	'${respl['status_code']}' != '202'   Fail    ELSE    Log to Console  \n-LI  Edited successfully

7. verifying QoS values in LI
    ${Resp} =    Fusion Api Get Li   
	${Resp1} = 	Copy List	${Resp['members'][0]['qosConfiguration']['activeQosConfig']['qosTrafficClassifiers']}
	${Resp2} = 	Copy List	${QoS_NoFcoe['qosConfiguration']['activeQosConfig']['qosTrafficClassifiers']}
    Run Keyword If		'${Resp['members'][0]['qosConfiguration']['activeQosConfig']['configType']}' != '${QoS_NoFcoe['qosConfiguration']['activeQosConfig']['configType']}' or '${Resp['members'][0]['qosConfiguration']['activeQosConfig']['uplinkClassificationType']}' != '${QoS_NoFcoe['qosConfiguration']['activeQosConfig']['uplinkClassificationType']}' or '${Resp['members'][0]['qosConfiguration']['activeQosConfig']['downlinkClassificationType']}' != '${QoS_NoFcoe['qosConfiguration']['activeQosConfig']['downlinkClassificationType']}'  Fail    ELSE  log to console   \n-Successfully got the QoS details
	Check Qos values	${Resp1}	${Resp2}
    log to console	Successfully verified the QoS values

8. Editing Lig with QoS type CustomwithoutFcoe
    ${resp} =    Fusion Api Get Lig     param=?filter="'name'=='${LIGS_TB[0]['name']}'"
    ${uri} =     Get From Dictionary        ${resp['members'][0]}    uri
	${body} =   Build LIG body     ${LIGS_TB[0]}
	${lig} = 	    Get LIG Member      ${LIG1}
	${lig_uri} =    Get LIG Uri         ${LIG1}
	${qosConfiguration} =   Get From Dictionary   ${QoS_NoFcoe}  qosConfiguration
	Set to dictionary	${body}     qosConfiguration    ${qosConfiguration}
	${resp} = 	Fusion Api Edit LIG	body=${body}	uri=${lig_uri}
	${task} =	Wait For Task 	${resp} 	120s	2s
	Run Keyword If	'${resp['status_code']}' != '202'   fail    ELSE    Log to Console  \n-LIG  created successfully

9.verifying QoS values in LIG
    ${Resp} =	Fusion Api Get Lig     param=?filter="'name'=='${LIGS_TB[0]['name']}'"  
	${Resp1} = 	Copy List	${Resp['members'][0]['qosConfiguration']['activeQosConfig']['qosTrafficClassifiers']}
	${Resp2} = 	Copy List	${QoS_NoFcoe['qosConfiguration']['activeQosConfig']['qosTrafficClassifiers']}
    Run Keyword If		'${Resp['members'][0]['qosConfiguration']['activeQosConfig']['configType']}' != '${QoS_NoFcoe['qosConfiguration']['activeQosConfig']['configType']}' or '${Resp['members'][0]['qosConfiguration']['activeQosConfig']['uplinkClassificationType']}' != '${QoS_NoFcoe['qosConfiguration']['activeQosConfig']['uplinkClassificationType']}' or '${Resp['members'][0]['qosConfiguration']['activeQosConfig']['downlinkClassificationType']}' != '${QoS_NoFcoe['qosConfiguration']['activeQosConfig']['downlinkClassificationType']}'  Fail    ELSE  log to console   \n-Successfully got the QoS details
	Check Qos values	${Resp1}	${Resp2}
    log to console	Successfully verified the QoS values
  
  
10. Adding Different user

	${l} = 	Get Length	${users}
	:FOR	${x}	IN RANGE	0	${l}
	\   ${resp}		Fusion Api Add User		body=${users[${x}]} 
    \   Log to console	\nResponse of ${users[${x}]} is ${resp}
	\	Run Keyword If  '${resp['status_code']}' != '200'  Fail    ELSE  log to console   \n-Created ${users[${x}]['roles']} user successfully
	
	${resp}		Fusion Api Logout Appliance
	Run Keyword If  '${resp['status_code']}' != '204'  Fail    ELSE  log to console   \n-Logged out successfully
	Log to console	\n Logged out successfully response ${resp}    
   
11. Logging in as different user

	${l} = 	Get Length	${users}
	Log to console	\n ${l}
	:FOR	${x}	IN RANGE	0	${l}
	\   ${resp}		Fusion Api Login Appliance		${APPLIANCE_IP}		${usercred[${x}]} 
	\	Log to console	\n Logged in successfully as ${usercred[${x}]['userName']}
	\	${resp} =    Fusion Api Get Li 
	\	log to console	\nget li Li with QoS ${resp}
    \	${uri} =     Get From Dictionary        ${resp['members'][0]}    uri
	\   ${Resp} = 	Fusion Api Update qos aggregated configuration			body=${QoS_NoFcoe['qosConfiguration']}	uri=${uri}/qos-aggregated-configuration
	\	Run Keyword If		'${Resp['status_code']}' != '202'      log to console   \nThe ${usercred[${x}]['userName']} user is not authorized    ELSE		User Validation		${x}	${Resp}
	\   ${resp}		Fusion Api Logout Appliance
	\	Run Keyword If  '${resp['status_code']}' != '204'  Fail    ELSE  log to console   \n-Logged out successfully

12. Login to Appliance

	[Tags]  add   POSITIVE
	Set Log Level    TRACE
	Fusion Api Login Appliance    ${APPLIANCE_IP}        ${admin_credentials}

***Keywords***

User Validation

	[Arguments] 	${x}		${Resp}
	${task} =	Wait For Task 	${Resp} 	1200s	2s    
	${resp} =    Fusion Api Get Li
	Log to console	\nget li after editing ${resp} 
	Log to console	\nmembers ${resp['members'][0]['qosConfiguration']['activeQosConfig']['configType']}
    Run Keyword If      '${resp['members'][0]['qosConfiguration']['activeQosConfig']['configType']}' != '${QoS_NoFcoe['qosConfiguration']['activeQosConfig']['configType']}'  Fail    ELSE   log to console   \nThe ${usercred[${x}]['userName']} user is authorized