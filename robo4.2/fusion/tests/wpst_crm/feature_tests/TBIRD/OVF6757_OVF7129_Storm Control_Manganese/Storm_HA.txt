*** Settings ***
Documentation       OVF6757_OVF7129 Storm Control manganese feature testing with High Available configuration

Library         json
Library         FusionLibrary
Library         RoboGalaxyLibrary
Variables       data_variables.py
Resource        resource.txt
Library         Collections
Library         Dialogs
Library         ServerOperations

Resource        ../../../../../Resources/api/fusion_api_resource.txt

Suite Setup        Suite Setup Tasks
Suite Teardown Suite Teardown Tasks

*** Variables ***
@{ILO_IPS}
${LIG}  Enc${enc_count}-LIG_HA
${LE}   Enc${enc_count}-LE
${SP}    Enc${enc_count}_server_profiles_HA
${interconn}    Enc${enc_count}-interconnect
${module_file_path}    ${CURDIR}\\GetServerIPs.py

***Test Cases***

1 OVF7129_API_TC_HA - VERIFY STORM CONTROL IS DISABLED BY DEFAULT IN THE LIG
    [Documentation]     VERIFY STORM CONTROL IS DISABLED BY DEFAULT IN THE LIG

    ${resp}    Get LIG member    ${LIG}
    ${LIG_URI} =    Set Variable if    ${resp} != None    ${resp['uri']}    'LIG does not exist'
    log    ${resp}    console=True
    Should Be Equal    ${resp['ethernetSettings']['enableStormControl']}    ${ethernet_setting_disable_storm['enableStormControl']}

2 OVF7129_API_TC_HA - VERIFY STORM CONTROL IS DISABLED BY DEFAULT IN THE LI AFTER THE LE CREATION
    [Documentation]     VERIFY STORM CONTROL IS DISABLED BY DEFAULT IN THE LI AFTER THE LE CREATION

    ${resp}    Get LI member    ${les['${LE}']['name']}-${LIG}
    Run Keyword If  ${resp} != None    Set Global Variable    ${LI_URI}   ${resp['uri']}
    Should Be Equal As Strings    ${resp['consistencyStatus']}    CONSISTENT
    Should Be Equal    ${resp['ethernetSettings']['enableStormControl']}    ${ethernet_setting_disable_storm['enableStormControl']}
    Log    Storm control is verified as disabled!!!    console=True


3 OVF7129_API_TC_HA - VERIFY ENABLING/DISABLING STORM CONTROL AND STORM THERSHOLD in LI/LIG SHOW COMPLIANCE ALERT AND UFG WILL BE ENABLED
    [Documentation]     VERIFY ENABLING/DISABLING STORM CONTROL AND STORM THERSHOLD in LI/LIG SHOW COMPLIANCE ALERT AND UFG WILL BE ENABLED

    Set To Dictionary   ${ethernet_setting_enable_storm}    stormControlThreshold   ${threshold[0]}
    ${dict} =    Get From Dictionary     ${Edit_ligs1}     ${LIG}
    ${lig_body}=    Create List    ${dict}
    ${resp}    Fusion Api Get LIG
    ${dr_uri}    Get From Dictionary    ${resp['members'][0]['ethernetSettings']}    dependentResourceUri
    ${data1} =    Set to Dictionary       ${lig_body[0]['ethernetSettings']}    dependentResourceUri    ${dr_uri}
    ${data2} =    Set to Dictionary       ${lig_body[0]}    ethernetSettings    ${data1}
    ${resp}    Edit LIG    ${lig_body}
    sleep   120s
    Log    LIG edited successfully    console=True

    ${resp}    Get LI member    ${les['${LE}']['name']}-${LIG}
    Run Keyword If  ${resp} != None    Set Global Variable    ${LI_URI}   ${resp['uri']}
    Should Be Equal As Strings    ${resp['consistencyStatus']}    NOT_CONSISTENT

    ${li_name}     Create Dictionary   name=${les['${LE}']['name']}-${LIG}
    Update Logical Interconnect from Group    ${li_name}
    sleep    60s

    ${resp}    Get LI member    ${les['${LE}']['name']}-${LIG}
    Run Keyword If  ${resp} != None    Set Global Variable    ${LI_URI}   ${resp['uri']}
    Should Be Equal As Strings  ${resp['consistencyStatus']}    CONSISTENT
    sleep   30

    Log    \n Verifying Interconnects In LI ${les['${LE}']['name']}-${LIG}    console=True
    ${resp}    Get LI member    ${les['${LE}']['name']}-${LIG}
    :FOR    ${interconnect}    IN    @{resp['interconnects']}
    \   Log    ${interconnect}    console=True
    \   IC reached state    ${interconnect}   Configured


4 OVF7129_API_TC_HA - ENABLE STORM CONTROL in LIG with THRESHOLD VALUES (1 and 262143)
    [Documentation]     ENABLE STORM CONTROL in LIG with THRESHOLD VALUES (1 and 262143)

    :FOR    ${threshold}    IN    @{Threshold}
    \   Set To Dictionary   ${ethernet_setting_enable_storm}    stormControlThreshold   ${threshold}
    \   ${dict} =    Get From Dictionary     ${Edit_ligs1}     ${LIG}
    \   ${lig_body}=    Create List    ${dict}
    \   ${resp}    Fusion Api Get LIG
    \   ${dr_uri}    Get From Dictionary    ${resp['members'][0]['ethernetSettings']}    dependentResourceUri
    \   ${data1} =    Set to Dictionary       ${lig_body[0]['ethernetSettings']}    dependentResourceUri    ${dr_uri}
    \   ${data2} =    Set to Dictionary       ${lig_body[0]}    ethernetSettings    ${data1}
    \   ${resp}    Edit LIG    ${lig_body}
    \   ${task} =   Wait For Task   ${resp[0]}    5m    15s
    \   log    ${Edit_ligs1['${LIG}']}    console=True
    \   ${resp}    Get LIG member    ${LIG}
    \   ${LIG_URI} =    Set Variable if    ${resp} != None    ${resp['uri']}    'LIG does not exist'
    \   Should Be Equal    ${resp['ethernetSettings']['enableStormControl']}   ${ethernet_setting_enable_storm['enableStormControl']}
    \   Should Be Equal    ${resp['ethernetSettings']['stormControlThreshold']}    ${ethernet_setting_enable_storm['stormControlThreshold']}
    \   log    STORM CONTROL WITH THERSHOLD VALUE ${ethernet_setting_enable_storm['stormControlThreshold']} is verified successfully!!    console=True



5 OVF7129_API_TC_HA -PASS ALL THE NEGATIVE VLAN VALUES FOR THE STORM CONTROL IN LIG and VALIDATE ALL THE VALUES SHOULD BE REJECTED
    [Documentation]     PASS ALL THE NEGATIVE VLAN VALUES FOR THE STORM CONTROL IN LIG and VALIDATE ALL THE VALUES SHOULD BE REJECTED

    :FOR    ${neg_threshold}    IN  @{negative_storm_threshold}
    \   Set To Dictionary   ${ethernet_setting_enable_storm}    stormControlThreshold   ${neg_threshold}
    \   ${dict} =    Get From Dictionary     ${Edit_ligs1}     ${LIG}
    \   ${lig_body}=    Create List    ${dict}
    \   ${resp}    Fusion Api Get LIG
    \   ${dr_uri}    Get From Dictionary    ${resp['members'][0]['ethernetSettings']}    dependentResourceUri
    \   ${data1} =    Set to Dictionary       ${lig_body[0]['ethernetSettings']}    dependentResourceUri    ${dr_uri}
    \   ${data2} =    Set to Dictionary       ${lig_body[0]}    ethernetSettings    ${data1}
    \   ${resp}    Edit LIG    ${lig_body}
    \   Run Keyword If  '${resp[0]['status_code']}' != '400'    Verify Error state    ${resp[0]}    ${error_msg}
    \   ...    ELSE    Fail    msg=Invalid storm threshold value is rejected


6 OVF7129_API_TC_HA -PASS ALL THE NEGATIVE VLAN VALUES FOR THE STORM CONTROL IN LI and VALIDATE ALL THE VALUES SHOULD BE REJECTED
    [Documentation]     PASS ALL THE NEGATIVE VLAN VALUES FOR THE STORM CONTROL IN LI and VALIDATE ALL THE VALUES SHOULD BE REJECTED

    :FOR    ${neg_threshold}    IN    @{negative_storm_threshold}
    \   Set To Dictionary   ${ethernet_setting_enable_storm}    stormControlThreshold   ${neg_threshold}
    \   ${resp}    Get LI member    ${les['${LE}']['name']}-${LIG}
    \   ${LI_URI} =    Set Variable if    ${resp} != None    ${resp['uri']}    '/${LI} does not exist'
    \   ${resp}    Fusion Api Update Li Ethernet Settings      ${ethernet_setting_enable_storm}    ${LI_URI}
    \   Log    ${neg_threshold}    console=True
    \   Log    ${resp['status_code']}    console=True
    \   Should Be Equal As Integers    ${resp['status_code']}    400
    \   Log    Negative values are rejected!!!    console=True

7 OVF7129_API_TC_HA - VERIFY CHANGING STORM CONTROL THERSHOLD in LI/LIG SHOW COMPLIANCE ALERT AND UFG WILL BE ENABLED
    [Documentation]     VERIFY CHANGING STORM CONTROL THERSHOLD in LI/LIG SHOW COMPLIANCE ALERT AND UFG WILL BE ENABLED

    Set To Dictionary   ${ethernet_setting_enable_storm}    stormControlThreshold   ${threshold[1]}
    ${dict} =    Get From Dictionary     ${Edit_ligs1}     ${LIG}
    ${lig_body}=    Create List    ${dict}
    ${resp}    Fusion Api Get LIG
    ${dr_uri}    Get From Dictionary    ${resp['members'][0]['ethernetSettings']}    dependentResourceUri
    ${data1} =    Set to Dictionary       ${lig_body[0]['ethernetSettings']}    dependentResourceUri    ${dr_uri}
    ${data2} =    Set to Dictionary       ${lig_body[0]}    ethernetSettings    ${data1}
    ${resp}    Edit LIG    ${lig_body}
    Log    \nLIG Edited!!!    console=True
    Sleep    60

    ${resp}    Get LIG member    ${LIG}
    ${LIG_URI} =    Set Variable if    ${resp} != None    ${resp['uri']}    'LIG does not exist'
    log    ${resp}    console=True
    Should Be Equal    ${resp['ethernetSettings']['enableStormControl']}   ${ethernet_setting_enable_storm['enableStormControl']}
    Should Be Equal    ${resp['ethernetSettings']['stormControlThreshold']}    ${ethernet_setting_enable_storm['stormControlThreshold']}

    ${resp}    Get LI member    ${les['${LE}']['name']}-${LIG}
    Run Keyword If  ${resp} != None    Set Global Variable    ${LI_URI}    ${resp['uri']}
    Should Be Equal As Strings    ${resp['consistencyStatus']}    NOT_CONSISTENT

    ${li_name}     Create Dictionary   name=${les['${LE}']['name']}-${LIG}
    Update Logical Interconnect from Group    ${li_name}
    sleep   60

    ${resp}    Get LI member    ${les['${LE}']['name']}-${LIG}
    Run Keyword If  ${resp} != None    Set Global Variable    ${LI_URI}    ${resp['uri']}
    Should Be Equal As Strings  ${resp['consistencyStatus']}    CONSISTENT
    sleep   30
    Should Be Equal    ${resp['ethernetSettings']['enableStormControl']}   ${ethernet_setting_enable_storm['enableStormControl']}
    Should Be Equal    ${resp['ethernetSettings']['stormControlThreshold']}    ${ethernet_setting_enable_storm['stormControlThreshold']}

    Log    \n Verifying Interconnects In LI ${les['${LE}']['name']}-${LIG}    console=True
    ${resp}    Get LI member    ${les['${LE}']['name']}-${LIG}
    :FOR    ${interconnect}    IN    @{resp['interconnects']}
    \   Log    ${interconnect}    console=True
    \   IC reached state    ${interconnect}   Configured


8 OVF7129_API_TC_HA - ENABLE STORM CONTROL and SET THRESHOLD VALUE AS 3 in LIG and LI
    [Documentation]     ENABLE STORM CONTROL and SET THRESHOLD VALUE AS 3 in LIG and LI

    Set To Dictionary   ${ethernet_setting_enable_storm}    stormControlThreshold   ${threshold[3]}
    ${dict} =    Get From Dictionary     ${Edit_ligs1}     ${LIG}
    ${lig_body}=    Create List    ${dict}
    ${resp}    Fusion Api Get LIG
    ${dr_uri}    Get From Dictionary    ${resp['members'][0]['ethernetSettings']}    dependentResourceUri
    ${data1} =    Set to Dictionary       ${lig_body[0]['ethernetSettings']}    dependentResourceUri    ${dr_uri}
    ${data2} =    Set to Dictionary       ${lig_body[0]}    ethernetSettings    ${data1}
    ${resp}    Edit LIG    ${lig_body}
    Log    \nLIG Edited successfully    console=True
    sleep    60
    ${resp}    Get LIG member    ${LIG}
    ${LIG_URI} =    Set Variable if    ${resp} != None    ${resp['uri']}    'LIG does not exist'
    Log    ${resp}    console=True
    Should Be Equal    ${resp['ethernetSettings']['enableStormControl']}    ${ethernet_setting_enable_storm['enableStormControl']}
    Should Be Equal    ${resp['ethernetSettings']['stormControlThreshold']}    ${ethernet_setting_enable_storm['stormControlThreshold']}

    ${resp}    Get LI member    ${les['${LE}']['name']}-${LIG}
    Run Keyword If  ${resp} != None    Set Global Variable    ${LI_URI}    ${resp['uri']}
    Should Be Equal As Strings    ${resp['consistencyStatus']}    NOT_CONSISTENT

    ${li_name}     Create Dictionary   name=${les['${LE}']['name']}-${LIG}
    Update Logical Interconnect from Group    ${li_name}
    sleep   60
    ${resp}    Get LI member    ${les['${LE}']['name']}-${LIG}
    Run Keyword If  ${resp} != None    Set Global Variable    ${LI_URI}    ${resp['uri']}
    Should Be Equal As Strings    ${resp['consistencyStatus']}    CONSISTENT
    sleep   30
    Should Be Equal    ${resp['ethernetSettings']['enableStormControl']}   ${ethernet_setting_enable_storm['enableStormControl']}
    Should Be Equal    ${resp['ethernetSettings']['stormControlThreshold']}    ${ethernet_setting_enable_storm['stormControlThreshold']}

    Log    \n Verifying Interconnects In LI ${les['${LE}']['name']}-${LIG}    console=True
    ${resp}    Get LI member    ${les['${LE}']['name']}-${LIG}
    :FOR    ${interconnect}    IN    @{resp['interconnects']}
    \   Log    ${interconnect}    console=True
    \   IC reached state    ${interconnect}   Configured


9 OVF7129_API_TC_HA SEND BROADCAST TRAFFIC ON THE BLADE SERVER 1 AND VERIFY THE BROADCAST STORM IS DETECTED IN THE ALERT MESSAGE AND VERIFY THE DROP COUNTERS OF BROADCAST GET INCREASED IN DOWNLINK PORT
    [Documentation]     SEND BROADCAST TRAFFIC ON THE BLADE SERVER 1 AND VERIFY THE BROADCAST STORM IS DETECTED IN THE ALERT MESSAGE AND VERIFY THE DROP COUNTERS OF BROADCAST GET INCREASED IN DOWNLINK PORT

    log    "GET ILO IP ADDRESS OF THE SERVERS ..."    console=True

    :FOR    ${server}   IN  @{Server_profiles['${SP}']}
    \   ${iloip} =     Get Server Hardware iLO IP    ${server['serverHardwareUri']}
    \   log    ${iloip}    console=True
    \   Append to List    ${ILO_IPS}    ${iloip}

    log    "ILO IP DETAILS OF THE SERVER BLADES ARE AS FOLLOWS"    console=True
    log    ${ILO_IPS}    console=True

    # LOGIN TO THE ILO, GET THE VLAN-NETWORKS IP ADDRESS, LOGIN TO THE SERVER WITH VLAN-NETWORK IP AND LISTEN TO THE INTERFACE IS RECEIVING THE MULITCAST TRAFFIC

    :FOR    ${ilo_ip}   IN  @{ILO_IPS}
    \   Set To Dictionary    ${Ilo_details}    ilo_ip    ${ilo_ip}
    \   log    ${Ilo_details}    console=True
    \   ${index}=   Get Index From List    ${ILO_IPS}    ${ilo_ip}
    \   log    ${index}    console=True
    \   ${output}   ${IP}=      get_server_vlan_ip      ${linux_details}    ${Ilo_details}    ${module_file_path}     ${mcast_cmds['${index}']}   ${windows_server_cred}
    \   Set To Dictionary    ${Server_network_ips}    ${index+1}    ${IP}

    log    "THE BLADE SERVER NETWORKS IP'S ARE AS FOLLOWS:"    console=True
    log    ${Server_network_ips}    console=True

    log    "Broadcast Storm Control Drop counter value before Starting Broadcast Traffic"    console=True
    ${ic_uri} =    Get IC URI    ${Interconnects['${interconn}'][0]}
    log    ${ic_uri}    console=True
    ${resp} =    Wait Until Keyword Succeeds   5 min    10s    Fusion Api Get Interconnect Port Statistics    ${ic_uri}    ${bcast_blade_downlinkport}
    log    "Downlink port stormControlBCASTDropCounters value before starting the Bcast Traffic"    console=True
    log    ${resp['commonStatistics']['stormControlBCASTDropCounters']}    console=True
    ${old_bcast_storm_value}=   Set Variable    ${resp['commonStatistics']['stormControlBCASTDropCounters']}

    Set To Dictionary   ${windows_server}   win_ip    ${Server_network_ips[1][2]}

    ${output}=  start_traffic_in_blade    ${windows_server}    ${broadcast_command}
    log    ${output}    console=True
    sleep   500

    ${Alert_msg}=   Create List
    ${resp}=    Fusion API Get Alerts
    ${mem_resp}=    Get From Dictionary     ${resp}    members
    ${len}=     Get Length  ${mem_resp}
    :FOR    ${y}    IN Range    0   ${len}
    \   Run Keyword if  '${mem_resp[${y}]['physicalResourceType']}' !='server-profiles'     Continue For Loop
    \   Append to List      ${Alert_msg}    ${mem_resp[${y}]}
    sleep    200s
    ${len}=     Get Length  ${Alert_msg}
    :FOR    ${x}    IN Range    0   ${len}
    \   log    ${Alert_msg[${x}]['description']}    console=True
    \   ${out}=    Split String    ${Alert_msg[${x}]['description']}    port
    \   ${port}=    Split String    ${out[1]}
    \   log    ${port[0]}    console=True
    \   Run Keyword If  '${port[0]}' == '${bcast_blade_downlinkport}'       Exit For Loop
    Run Keyword If  '${port[0]}' != '${bcast_blade_downlinkport}'   Fail    msg="Activity message for storm Control for the port ${bcast_blade_downlinkport} is not available"
    Should Contain  ${Alert_msg[${x}]['description']}   A packet storm has been detected
    Should Contain  ${Alert_msg[${x}]['description']}   port ${bcast_blade_downlinkport}

    log    "Broadcast Storm Control Drop counter value After Broadcast Traffic"    console=True
    ${ic_uri} =    Get IC URI    ${Interconnects['${interconn}'][0]}
    ${resp} =    Wait Until Keyword Succeeds   5 min    10s    Fusion Api Get Interconnect Port Statistics    ${ic_uri}    ${bcast_blade_downlinkport}
    log    " Downlink port stormControlBCASTDropCounters value After the Bcast Traffic"    console=True
    log    ${resp['commonStatistics']['stormControlBCASTDropCounters']}    console=True
    Run Keyword If  ${resp['commonStatistics']['stormControlBCASTDropCounters']} <= ${old_bcast_storm_value}    fail    msg=Brodcast Storm Drop Counter is not increased after the Broadcast Storm traffic


10 OVF7129_API_TC_HA SEND BROADCAST TRAFFIC FROM DL SERVER AND VERIFY THE BROADCAST STORM IS DETECTED IN THE ALERT MESSAGE AND VERIFY THE DROP COUNTERS OF BROADCAST GET INCREASED IN UPNLINK PORT
    [Documentation]     SEND BROADCAST TRAFFIC FROM DL SERVER AND VERIFY THE BROADCAST STORM IS DETECTED IN THE ALERT MESSAGE AND VERIFY THE DROP COUNTERS OF BROADCAST GET INCREASED IN UPLINK PORT

    ${resp}    Fusion Api Delete Alert
    log    "Broadcast Storm Control Drop counter value before Starting Broadcast Traffic"    console=True
    ${ic_uri} =    Get IC URI    ${Interconnects['${interconn}'][0]}
    log      ${ic_uri}
    ${resp} =    Wait Until Keyword Succeeds   5 min    10s    Fusion Api Get Interconnect Port Statistics    ${ic_uri}    ${dlf_test_blade_uplinkport}
    log    " Uplink port stormControlBCASTDropCounters value before starting the Bcast Traffic"    console=True
    log    ${resp['commonStatistics']['stormControlBCASTDropCounters']}    console=True
    ${old_bcast_storm_value}=   Set Variable    ${resp['commonStatistics']['stormControlBCASTDropCounters']}

    # The below command is not executed in blade it is in DL server, re-using the same function
    execute_command_in_blade    ${broadcast_command}
    sleep   400

    ${resp} =    Fusion Api Get Alerts
    ${mem_resp} =   Get From Dictionary     ${resp}     members
    ${len} =    Get Length  ${mem_resp}
    ${Alert_msg} =  Create List
    :FOR    ${x}    IN RANGE    0   ${len}
    \   ${desc_alert} =     Get From Dictionary     ${mem_resp[${x}]}       description
    \   Log to console    ${desc_alert} is alert msg
    \   ${replaced_msg}    Replace String Using Regexp    ${Alert_Message_Port}    IC_uri    ${ic_uri}
    \   Run Keyword If    '${desc_alert}' == '${replaced_msg}'  Exit For Loop
    Append To List    ${Alert_msg}    ${desc_alert}
    ${len} =    Get Length    ${Alert_msg}
    Run Keyword If      ${len} != 0      Log to console and logfile   \n${Alert_Message_Port} is observed
    ...         ELSE    Log to console and logfile   \nNo Critical Alert Message Observed
    sleep    150s

    log    "Broadcast Storm Control Drop counter value After Broadcast Traffic"    console=True
    ${ic_uri} =    Get IC URI    ${Interconnects['${interconn}'][0]}
    ${resp} =    Wait Until Keyword Succeeds   5 min    10s    Fusion Api Get Interconnect Port Statistics    ${ic_uri}    ${dlf_test_blade_uplinkport}
    log    " Uplink port stormControlBCASTDropCounters value After the Bcast Traffic"    console=True
    log    ${resp['commonStatistics']['stormControlBCASTDropCounters']}    console=True
    Run Keyword If  ${resp['commonStatistics']['stormControlBCASTDropCounters']} <= ${old_bcast_storm_value}    fail    msg=Brodcast Storm Drop Counter is not increased after the Broadcast Storm traffic


11 OVF7129_API_TC_HA SEND MULITCAST TRAFFIC ON THE BLADE SERVER 1 AND VERIFY THE MULITCAST STORM IS DETECTED IN THE ALERT MESSAGE AND VERIFY THE DROP COUNTERS OF MULITCAST GET INCREASED IN DOWNLINK PORT
    [Documentation]     SEND MULITCAST TRAFFIC ON THE BLADE SERVER 1 AND VERIFY THE MULITCAST STORM IS DETECTED IN THE ALERT MESSAGE AND VERIFY THE DROP COUNTERS OF MULITCAST GET INCREASED IN DOWNLINK PORT

    ${resp}    Fusion Api Delete Alert
    log    ${Server_network_ips}    console=True
    log    "Multicast Storm Control Drop counter value before Starting Multicast Traffic"    console=True

    ${ic_uri} =    Get IC URI    ${Interconnects['${interconn}'][0]}
    log    ${ic_uri}    console=True
    ${resp} =    Wait Until Keyword Succeeds   5 min    10s    Fusion Api Get Interconnect Port Statistics    ${ic_uri}    ${bcast_blade_downlinkport}
    log    " Downlink port stormControlMCASTDropCounters value before starting the Mcast Traffic "    console=True
    log    ${resp['commonStatistics']['stormControlMCASTDropCounters']}    console=True
    ${old_mcast_storm_value}=   Set Variable    ${resp['commonStatistics']['stormControlMCASTDropCounters']}

    Set To Dictionary   ${windows_server}    win_ip    ${Server_network_ips[1][2]}

    ${output}=    start_traffic_in_blade    ${windows_server}   -s ${delete_route_command}

    ${output}=    start_traffic_in_blade    ${windows_server}    -s ${set_route_command}

    ${output}=    start_traffic_in_blade    ${windows_server}    ${multicast_command}
    log    ${output}    console=True
    sleep   500

    ${Alert_msg}=   Create List
    ${resp}=    Fusion API Get Alerts
    ${mem_resp}=    Get From Dictionary     ${resp}    members
    ${len}=     Get Length  ${mem_resp}
    :FOR    ${x}    IN Range    0   ${len}
    \   Run Keyword if  '${mem_resp[${x}]['physicalResourceType']}' !='server-profiles'     Continue For Loop
    \   Append to List      ${Alert_msg}    ${mem_resp[${x}]}
    Log    ${Alert_msg[0]['description']}    console=True
    Should Contain    ${Alert_msg[0]['description']}    A packet storm has been detected
    Should Contain    ${Alert_msg[0]['description']}    port ${bcast_blade_downlinkport}
    sleep    300s

    log    "Multicast Storm Control Drop counter value After Multicast Traffic"    console=True
    ${ic_uri} =    Get IC URI    ${Interconnects['${interconn}'][0]}
    ${resp} =    Wait Until Keyword Succeeds   5 min    10s    Fusion Api Get Interconnect Port Statistics    ${ic_uri}    ${bcast_blade_downlinkport}
    log    " Downlink port stormControlMCASTDropCounters value After the Mcast Traffic "    console=True
    log    ${resp['commonStatistics']['stormControlMCASTDropCounters']}    console=True
    Run Keyword If  ${resp['commonStatistics']['stormControlMCASTDropCounters']} <= ${old_mcast_storm_value}    fail    msg=Multicast Storm Drop Counter is not increased after the Multicast Storm traffic


12 OVF7129_API_TC_HA SEND MULITCAST TRAFFIC FROM DL SERVER AND VERIFY THE MULTICAST STORM IS DETECTED IN THE ALERT MESSAGE AND VERIFY THE DROP COUNTERS OF MULITCAST GET INCREASED IN UPLINK PORT
    [Documentation]     SEND MULITCAST TRAFFIC FROM DL SERVER AND VERIFY THE MULTICAST STORM IS DETECTED IN THE ALERT MESSAGE AND VERIFY THE DROP COUNTERS OF MULITCAST GET INCREASED IN UPLINK PORT

    ${resp}    Fusion Api Delete Alert
    log    "MULITCAST Storm Control Drop counter value before Starting MULITCAST Traffic"    console=True
    ${ic_uri} =    Get IC URI    ${Interconnects['${interconn}'][0]}
    log    ${ic_uri}    console=True
    ${resp} =    Wait Until Keyword Succeeds   5 min    10s    Fusion Api Get Interconnect Port Statistics    ${ic_uri}    ${dlf_test_blade_uplinkport}
    log    " Uplink port stormControlMCASTDropCounters value before starting the Mcast Traffic "    console=True
    log    ${resp['commonStatistics']['stormControlMCASTDropCounters']}    console=True
    ${old_mcast_storm_value}=   Set Variable    ${resp['commonStatistics']['stormControlMCASTDropCounters']}

    # The below command is not executed in blade it is in DL server, re-using the same function
    execute_command_in_blade    ${multicast_command}
    Sleep   400

    ${Alert_msg}=   Create List
    ${resp}=    Fusion API Get Alerts
    ${mem_resp}=    Get From Dictionary     ${resp}    members
    ${len}=     Get Length  ${mem_resp}
    :FOR    ${x}    IN Range    0   ${len}
    \   Run Keyword if  '${mem_resp[${x}]['physicalResourceType']}' !='logical-interconnects'       Continue For Loop
    \   Append to List      ${Alert_msg}    ${mem_resp[${x}]}
    \   ${desc_alert} =     Get From Dictionary     ${mem_resp[${x}]}       description
    \   Log to console    ${desc_alert} is alert msg
    \   ${replaced_msg}    Replace String Using Regexp    ${Alert_Message_Port}    IC_uri    ${ic_uri}
    \   Run Keyword If    '${desc_alert}' == '${replaced_msg}'  Exit For Loop
    Append To List    ${Alert_msg}    ${desc_alert}
    ${len} =    Get Length    ${Alert_msg}
    Run Keyword If      ${len} != 0      Log to console and logfile   \n${Alert_Message_Port} is observed
    ...         ELSE    Log to console and logfile   \nNo Critical Alert Message Observed
    sleep    200

    log    "MULITCAST Storm Control Drop counter value After MULITCAST Traffic"    console=True
    ${ic_uri} =    Get IC URI    ${Interconnects['${interconn}'][0]}
    ${resp} =    Wait Until Keyword Succeeds   5 min    10s    Fusion Api Get Interconnect Port Statistics    ${ic_uri}    ${dlf_test_blade_uplinkport}
    log    " Uplink port stormControlMCASTDropCounters value After the Mcast Traffic "    console=True
    log    ${resp['commonStatistics']['stormControlMCASTDropCounters']}    console=True
    Run Keyword If    ${resp['commonStatistics']['stormControlMCASTDropCounters']} <= ${old_mcast_storm_value}    Fail    msg=Multicast Storm Drop Counter is not increased after the MULITCAST Storm traffic


13 OVF7129_API_TC_HA SEND DLF TRAFFIC FROM THE BLADE SERVER AND VERIFY THE STORM IS DETECTED ON THE DOWNLINK PORT D8 AND VERIFY THE VALUES OF THE DLF STORM COUNTERS IN DOWNLINK PORT
    [Documentation]     SEND DLF TRAFFIC FROM THE BLADE SERVER AND VERIFY THE STORM IS DETECTED ON THE DOWNLINK PORT D8 AND VERIFY THE VALUES OF THE DLF STORM COUNTERS IN DOWNLINK PORT

    Log    "THE BLADE SERVER NETWORKS IP'S ARE AS FOLLOWS:"    console=True
    Log    ${Server_network_ips}    console=True

    log    "DLF Storm Control Drop counter value before Starting DLF Traffic"    console=True
    ${ic_uri} =    Get IC URI    ${Interconnects['${interconn}'][0]}
    log    ${ic_uri}    console=True
    ${resp} =    Wait Until Keyword Succeeds   5 min    10s    Fusion Api Get Interconnect Port Statistics    ${ic_uri}    ${dlf_test_blade_downlinkport1}
    log    "Downlink port StormControlDLFDropCounters value Before sending the DLF traffic"    console=True
    log    ${resp['commonStatistics']['stormControlDLFDropCounters']}    console=True
    ${old_dlf_storm_value}=    Set Variable    ${resp['commonStatistics']['stormControlDLFDropCounters']}

    Set To Dictionary    ${windows_server}    win_ip    ${Server_network_ips[1][2]}
    # Get the mac address of the blade server 1
    execute_command_in_blade    getmac /s ${windows_server['win_ip']} /u ${windows_server['username']} /p ${windows_server['password']} > mac_blade1.txt
    ${mac_output}=      extract_mac_address     mac_blade1.txt
    Log    ${mac_output}    console=True

    # Disable the Ethernet interface in the blade server 1
    start_traffic_in_blade    ${windows_server}    ${disable_interface}
    log    Wait for 6 Minutes to automatically delete the mac address of blade 1 in the hafnium    console=True
    sleep   360

    # Set the Static ARP entry for the diabled ethernet interface to verify DLF traffic
    Set To Dictionary    ${windows_server}    win_ip    ${Server_network_ips[3][1]}
    start_traffic_in_blade    ${windows_server}   -s arp -s ${Server_network_ips[1][2]} ${mac_output[0]}
    sleep   30

    # Start the DLF traffic from the blade server
    start_traffic_in_blade  ${windows_server}   "C:\\Program Files (x86)\\Nmap\\start_dlf_traffic_HA.bat"
    sleep   800

    ${Alert_msg}=   Create List
    ${resp}=    Fusion API Get Alerts
    ${mem_resp}=    Get From Dictionary     ${resp}    members
    ${len}=     Get Length  ${mem_resp}
    :FOR    ${y}    IN Range    0   ${len}
    \   Run Keyword if  '${mem_resp[${y}]['physicalResourceType']}' !='server-profiles'     Continue For Loop
    \   Append to List      ${Alert_msg}    ${mem_resp[${y}]}
    sleep    200s
    ${len}=     Get Length  ${Alert_msg}
    :FOR    ${x}    IN Range    0   ${len}
    \   log    ${Alert_msg[${x}]['description']}    console=True
    \   ${out}=    Split String    ${Alert_msg[${x}]['description']}   port
    \   ${port}=    Split String    ${out[1]}
    \   log  ${port[0]}
    \   Run Keyword If  '${port[0]}' == '${dlf_test_blade_downlinkport1}'        Exit For Loop
    Run Keyword If  '${port[0]}' != '${dlf_test_blade_downlinkport1}'    Fail    "Activity message for storm Control for the port D8 is not available"
    Should Contain    ${Alert_msg[${x}]['description']}    A packet storm has been detected
    Should Contain    ${Alert_msg[${x}]['description']}    port ${dlf_test_blade_downlinkport1}

    log    "DLF Storm Control Drop counter value After DLF Traffic"    console=True
    ${ic_uri} =    Get IC URI    ${Interconnects['${interconn}'][0]}
    ${resp} =    Wait Until Keyword Succeeds   5 min    10s    Fusion Api Get Interconnect Port Statistics    ${ic_uri}    ${dlf_test_blade_downlinkport1}
    log    "Downlink port StormControlDLFDropCounters value After the DLF traffic"    console=True
    log    ${resp['commonStatistics']['stormControlDLFDropCounters']}    console=True
    Run Keyword If  ${resp['commonStatistics']['stormControlDLFDropCounters']} <= ${old_dlf_storm_value}    fail    DLF Storm Drop Counter is not increased after the DLF Storm traffic

    # Remove the Static ARP entry for the diasbled ethernet interface to verify DLF traffic
    Set To Dictionary    ${windows_server}    win_ip    ${Server_network_ips[3][1]}
    start_traffic_in_blade    ${windows_server}   -s arp -d ${Server_network_ips[1][2]}


14 OVF7129_API_TC_HA SEND DLF TRAFFIC FROM DL SERVER AND VERIFY THE DLF STORM IS DETECTED IN THE ALERT MESSAGE AND VERIFY THE DROP COUNTERS OF DLF GET INCREASED IN UPNLINK PORT
    [Documentation]     SEND DLF TRAFFIC FROM DL SERVER AND VERIFY THE DLF STORM IS DETECTED IN THE ALERT MESSAGE AND VERIFY THE DROP COUNTERS OF DLF GET INCREASED IN UPNLINK PORT

    ${resp}    Fusion Api Delete Alert
    log    "THE BLADE SERVER NETWORKS IP'S ARE AS FOLLOWS:"    console=True

    log    ${Server_network_ips}    console=True

    log    "DLF Storm Control Drop counter value before Starting DLF Traffic"    console=True
    ${ic_uri} =    Get IC URI    ${Interconnects['${interconn}'][0]}

    ${resp} =    Wait Until Keyword Succeeds   5 min    10s    Fusion Api Get Interconnect Port Statistics    ${ic_uri}    ${dlf_test_blade_uplinkport}
    log    "Uplink port StormControlDLFDropCounters value before starting the DLF Traffic "    console=True
    log    ${resp['commonStatistics']['stormControlDLFDropCounters']}    console=True
    ${old_bcast_storm_value}=    Set Variable    ${resp['commonStatistics']['stormControlDLFDropCounters']}
    ${mac_details}=     extract_mac_address     mac_blade1.txt
    Set Suite Variable  ${mac_output}   ${mac_details}
    log      ${mac_output}    console=True
    # The below command is not executed in blade it is in DL server, re-using the same function

    execute_command_in_blade    arp -s ${Server_network_ips[1][2]} ${mac_output[0]}

    execute_command_in_blade    "C:\\Program Files (x86)\\Nmap\\start_dlf_traffic_HA.bat"

    # Sleep For 900 seconds  complete the DLF traffic to be trasmitted
    sleep   900s

    ${resp} =    Fusion Api Get Alerts
    ${mem_resp} =   Get From Dictionary     ${resp}     members
    ${len} =    Get Length  ${mem_resp}
    ${Alert_msg} =  Create List
    :FOR    ${x}    IN RANGE    0   ${len}
    \   ${desc_alert} =     Get From Dictionary     ${mem_resp[${x}]}       description
    \   Log to console    ${desc_alert} is alert msg
    \   ${replaced_msg}    Replace String Using Regexp    ${Alert_Message_Port}    IC_uri    ${ic_uri}
    \   Run Keyword If    '${desc_alert}' == '${replaced_msg}'  Exit For Loop
    Append To List    ${Alert_msg}    ${desc_alert}
    ${len} =    Get Length    ${Alert_msg}
    Run Keyword If      ${len} != 0      Log to console and logfile   \n${Alert_Message_Port} is observed
    ...         ELSE    Log to console and logfile   \nNo Critical Alert Message Observed
    sleep    100s
    log    "DLF Storm Control Drop counter value After DLF Traffic"    console=True
    ${ic_uri} =    Get IC URI    ${Interconnects['${interconn}'][0]}
    ${resp} =    Wait Until Keyword Succeeds   5 min    10s    Fusion Api Get Interconnect Port Statistics    ${ic_uri}    ${dlf_test_blade_uplinkport}
    log    " Uplink port StormControlDLFDropCounters value After the DLF Traffic "    console=True
    log    ${resp['commonStatistics']['stormControlDLFDropCounters']}    console=True
    Run Keyword If  ${resp['commonStatistics']['stormControlDLFDropCounters']} <= ${old_bcast_storm_value}    fail  DLF Storm Drop Counter is not increased after the DLF Storm traffic

    # Enable the ethernet interface on the blade server 1
    Set To Dictionary   ${windows_server}   win_ip    ${Server_network_ips[1][2]}
    start_traffic_in_blade    ${windows_server}   ${enable_interface}

    # Delete the Mac address from the DL server
    execute_command_in_blade    arp -d ${Server_network_ips[1][2]}

15 OVF7129_API_TC_HA_VERFY THE INTERCONNECT IS GOING INTO MAINTENANCE STATE AFTER THE INTERCONNECT IS POWERED OFF
    [Documentation]     VERIFY THE INTERCONNECT IS GOING INTO MAINTENANCE STATE AFTER THE INTERCONNECT IS POWERED OFF

    Set To Dictionary   ${ethernet_setting_enable_storm}    stormControlThreshold   ${threshold[2]}
    ${dict} =    Get From Dictionary     ${Edit_ligs1}     ${LIG}
    ${lig_body}=    Create List    ${dict}
    ${resp}    Fusion Api Get LIG
    ${dr_uri}    Get From Dictionary    ${resp['members'][0]['ethernetSettings']}    dependentResourceUri
    ${data1} =    Set to Dictionary       ${lig_body[0]['ethernetSettings']}    dependentResourceUri    ${dr_uri}
    ${data2} =    Set to Dictionary       ${lig_body[0]}    ethernetSettings    ${data1}
    ${resp}    Edit LIG    ${lig_body}
    ${task} =   Wait For Task   ${resp[0]}    5m    15s
    Log    \nLIG Edited successfully!!!    console=True

    ${resp}    Get LIG member    ${LIG}
    ${LIG_URI} =    Set Variable if    ${resp} != None    ${resp['uri']}    'LIG does not exist'
    log    ${resp}    console=True
    Should Be Equal    ${resp['ethernetSettings']['enableStormControl']}   ${ethernet_setting_enable_storm['enableStormControl']}
    Should Be Equal    ${resp['ethernetSettings']['stormControlThreshold']}    ${ethernet_setting_enable_storm['stormControlThreshold']}

    Set Global Variable    ${before_storm_enable_resp_lig}    ${resp['ethernetSettings']['enableStormControl']}
    Set Global Variable    ${before_storm_threshold_resp_lig}    ${resp['ethernetSettings']['stormControlThreshold']}

    ${resp}    Get LI member    ${les['${LE}']['name']}-${LIG}
    Run Keyword If  ${resp} != None    Set Global Variable    ${LI_URI}    ${resp['uri']}
    Should Be Equal As Strings    ${resp['consistencyStatus']}    NOT_CONSISTENT

    ${li_name}     Create Dictionary   name=${les['${LE}']['name']}-${LIG}
    Update Logical Interconnect from Group    ${li_name}
    sleep   60

    ${resp}    Get LI member    ${les['${LE}']['name']}-${LIG}
    Run Keyword If  ${resp} != None    Set Global Variable    ${LI_URI}    ${resp['uri']}
    Should Be Equal As Strings    ${resp['consistencyStatus']}    CONSISTENT
    sleep   30
    Should Be Equal    ${resp['ethernetSettings']['enableStormControl']}    ${ethernet_setting_enable_storm['enableStormControl']}
    Should Be Equal    ${resp['ethernetSettings']['stormControlThreshold']}    ${ethernet_setting_enable_storm['stormControlThreshold']}

    Set Global Variable    ${before_storm_enable_resp_li}   ${resp['ethernetSettings']['enableStormControl']}
    Set Global Variable    ${before_storm_threshold_resp_li}    ${resp['ethernetSettings']['stormControlThreshold']}

    Log    \n Verifying Interconnects In LI ${les['${LE}']['name']}-${LIG}    console=True
    ${resp}    Get LI member    ${les['${LE}']['name']}-${LIG}
    :FOR    ${interconnect}    IN    @{resp['interconnects']}
    \   Log    ${interconnect}    console=True
    \   IC reached state    ${interconnect}   Configured

    ##Poweroff the interconnect
    Patch Interconnect    ${dto[0]}    op=replace  path=/powerState  value=Off  timeout=60  interval=10
    ${ic_uri} =    Get IC URI    ${Interconnects['${interconn}'][0]}
    Wait Until Keyword Succeeds    5 min   15s     IC reached state    ${ic_uri}    Maintenance
    log    \n\nThe IC module ${Interconnects['${interconn}'][0]} is in Maintenance state    console=True

16 OVF7129_API_TC_HA_VERIFY STORM DROP COUNTERS VALUES ARE RESET TO 0 AFTER THE INTERCONNECT IS POWERED ON
    [Documentation]     VERIFY STORM DROP COUNTERS VALUES ARE RESET TO 0 AFTER THE INTERCONNECT IS POWERED ON

    ${resp}    Get LIG member    ${LIG}
    ${LIG_URI} =    Set Variable if    ${resp} != None    ${resp['uri']}    'LIG does not exist'
    log    ${resp}    console=True

    Set Global Variable    ${before_storm_enable_resp_lig}    ${resp['ethernetSettings']['enableStormControl']}
    Set Global Variable    ${before_storm_threshold_resp_lig}    ${resp['ethernetSettings']['stormControlThreshold']}

    ${resp}    Get LI member    ${les['${LE}']['name']}-${LIG}
    Run Keyword If  ${resp} != None    Set Global Variable    ${LI_URI}    ${resp['uri']}

    Set Global Variable    ${before_storm_enable_resp_li}    ${resp['ethernetSettings']['enableStormControl']}
    Set Global Variable    ${before_storm_threshold_resp_li}    ${resp['ethernetSettings']['stormControlThreshold']}

    ##Poweron the interconnect
    Patch Interconnect    ${dto[0]}    op=replace  path=/powerState  value=On  timeout=60  interval=10
    ${ic_uri} =    Get IC URI    ${Interconnects['${interconn}'][0]}
    Wait Until Keyword Succeeds    15 min   15s     IC reached state    ${ic_uri}    Configured
    log    \n\nThe IC module ${Interconnects['${interconn}'][0]} is in Configured state    console=True
    sleep   4min
    ${ic_resp} =    Get Interconnect    ${Interconnects['${interconn}'][0]}
    ${ports} =    Get from Dictionary    ${ic_resp}    ports
    ${len} =    Get Length    ${ports}
    :FOR    ${x}    IN RANGE    0  ${len}
    \     Exit For Loop If    '${ports[${x}]['portName']}' == '${dlf_test_blade_downlinkport}'
    log    ${ports[${x}]['portName']}    console=True
    log    ${ports[${x}]}    console=True
    ${resp} =    Wait Until Keyword Succeeds   5 min    10s    Fusion Api Get Interconnect Port Statistics    ${ic_uri}    ${ports[${x}]['portName']}

    log    ${resp['commonStatistics']['stormControlBCASTDropCounters']}    console=True
    log    ${resp['commonStatistics']['stormControlDLFDropCounters']}    console=True
    log    ${resp['commonStatistics']['stormControlMCASTDropCounters']}    console=True

    Wait Until Keyword Succeeds    10 min   15s     Run Keyword If  ${resp['commonStatistics']['stormControlBCASTDropCounters']} > ${counter_value}    fail    msg=BCast Drop counter got cleared which is not expected
    Wait Until Keyword Succeeds    10 min   15s     Run Keyword If  ${resp['commonStatistics']['stormControlDLFDropCounters']} > ${counter_value}    fail    msg=DLF Drop counter got cleared which is not expected
    Wait Until Keyword Succeeds    10 min   15s     Run Keyword If  ${resp['commonStatistics']['stormControlMCASTDropCounters']} > ${counter_value}    fail    msg=MCAST Drop counter got cleared which is not expected

    :FOR    ${x}    IN RANGE    0  ${len}
    \     Exit For Loop If    '${ports[${x}]['portName']}' == '${dlf_test_blade_uplinkport}'
    log    ${ports[${x}]['portName']}    console=True
    log    ${ports[${x}]}    console=True
    ${ic_uri} =    Get IC URI    ${Interconnects['${interconn}'][0]}
    ${resp} =    Wait Until Keyword Succeeds   5 min    10s    Fusion Api Get Interconnect Port Statistics    ${ic_uri}    ${ports[${x}]['portName']}

    log    ${resp['commonStatistics']['stormControlBCASTDropCounters']}    console=True
    log    ${resp['commonStatistics']['stormControlDLFDropCounters']}    console=True
    log    ${resp['commonStatistics']['stormControlMCASTDropCounters']}    console=True

    Wait Until Keyword Succeeds    5 min   15s     Run Keyword If  ${resp['commonStatistics']['stormControlBCASTDropCounters']} > ${counter_value}   fail    msg=BCast Drop counter got cleared which is not expected
    Wait Until Keyword Succeeds    5 min   15s     Run Keyword If  ${resp['commonStatistics']['stormControlDLFDropCounters']} > ${counter_value}    fail    msg=DLF Drop counter got cleared which is not expected
    Wait Until Keyword Succeeds    5 min   15s     Run Keyword If  ${resp['commonStatistics']['stormControlMCASTDropCounters']} > ${counter_value}    fail    msg=MCAST Drop counter got cleared which is not expected


17 OVF7129_API_TC_HA Verify ICM Clear Port counters clears Storm counter statistics
    [Documentation]     VERIFY ICM CLEAR PORT COUNTERS DOESN'T CLEARS STORM COUNTER STATISCTICS

    ${ic_uri} =    Get IC URI    ${Interconnects['${interconn}'][0]}
    ${body} =   Create Dictionary
    Log    \nResetting Interconnect Port Counters\n    console=True
    ${resp} =   Fusion Api clear Interconnect Ports    ${body}    ${ic_uri}
    Run Keyword If  ${resp['status_code']} != 202    fail    msg=Clearing Interconnect Ports of ${Interconnects['${interconn}'][0]} Failed
    ...         ELSE    Log    \n Interconnect Ports of ${Interconnects['${interconn}'][0]} cleared successfully    console=True
    sleep   120s
    ${ic_resp} =    Get Interconnect    ${Interconnects['${interconn}'][0]}
    ${ports} =    Get from Dictionary    ${ic_resp}    ports
    ${len} =    Get Length    ${ports}

    :FOR    ${x}    IN RANGE    0  ${len}
    \     Exit For Loop If    '${ports[${x}]['portName']}' == '${dlf_test_blade_downlinkport}'
    Log    ${ports[${x}]['portName']}    console=True
    Log    ${ports[${x}]}    console=True
    ${resp} =    Wait Until Keyword Succeeds   5 min    10s    Fusion Api Get Interconnect Port Statistics    ${ic_uri}    ${ports[${x}]['portName']}

    Log    ${resp['commonStatistics']['stormControlBCASTDropCounters']}    console=True
    Log    ${resp['commonStatistics']['stormControlDLFDropCounters']}    console=True
    Log    ${resp['commonStatistics']['stormControlMCASTDropCounters']}    console=True

    Run Keyword If  ${resp['commonStatistics']['stormControlBCASTDropCounters']} != 0    fail    msg=BCast Drop counter got cleared which is not expected
    Run Keyword If  ${resp['commonStatistics']['stormControlDLFDropCounters']} != 0    fail    msg=DLF Drop counter got cleared which is not expected
    Run Keyword If  ${resp['commonStatistics']['stormControlMCASTDropCounters']} != 0    fail    msg=MCAST Drop counter got cleared which is not expected

    :FOR    ${x}    IN RANGE    0  ${len}
    \     Exit For Loop If    '${ports[${x}]['portName']}' == '${dlf_test_blade_uplinkport}'
    Log    ${ports[${x}]['portName']}    console=True
    Log    ${ports[${x}]}    console=True
    ${resp} =    Wait Until Keyword Succeeds   5 min    10s    Fusion Api Get Interconnect Port Statistics    ${ic_uri}    ${ports[${x}]['portName']}

    Log    ${resp['commonStatistics']['stormControlBCASTDropCounters']}    console=True
    Log    ${resp['commonStatistics']['stormControlDLFDropCounters']}    console=True
    Log    ${resp['commonStatistics']['stormControlMCASTDropCounters']}    console=True

    Run Keyword If    ${resp['commonStatistics']['stormControlBCASTDropCounters']} != 0    fail    msg=BCast Drop counter got cleared which is not expected
    Run Keyword If    ${resp['commonStatistics']['stormControlDLFDropCounters']} != 0    fail    msg=DLF Drop counter got cleared which is not expected
    Run Keyword If    ${resp['commonStatistics']['stormControlMCASTDropCounters']} != 0    fail    msg=MCAST Drop counter got cleared which is not expected



****Keywords*****

Verify Error state
    [Documentation]    Verify Error state
    [Arguments]     ${resp}     ${error_msg}
    ${task} =   Wait For Task   ${resp}    5 min    15s
    Run Keyword If  '${task['taskState']}' == 'Error' and '${task['taskErrors'][0]['errorCode']}' == '${error_msg}'     log  Invalid storm threshold value is rejected
    ...    ELSE    Fail

Suite Teardown Tasks
    [Documentation]    Returns appliance to a 'clean' state by removing all resources\enclosures
    log    [TEARDOWN]    console=True
    Power off ALL servers
    Remove All Server Profiles    PressAndHold
    Remove All LEs
    Remove All Enclosure Groups
    Remove All LIGs
    Remove All Ethernet Networks
    Remove ALL FCoE Networks
    Remove All FC Networks
    Remove All Network Sets
    Remove All Users

Suite Setup tasks
    [Documentation]   This Suite contains the HA Configuration
    Set Log Level    TRACE

    ${Login_response} =    Fusion Api Login Appliance    ${appliance_ip}        ${admin_credentials}
    Run keyword unless  ${Login_response[0]['status_code']}== 200   Fail    "Unable to Login"
    ${start_in} =   Get Variable Value  ${enc_count}    1
    Set Suite Variable  ${enc_count}    ${start_in}
    log    ${enc_count}    console=True

    #Initial Cleanup
    Clean OV

    Set Suite Variable  ${interconn}    Enc${enc_count}-interconnect
    log    ${Interconnects['${interconn}']}    console=True

    #Create Ethernet Networks
    ${Response}     Add Ethernet Networks from variable    ${ethernet_network}
    Log    ${Response}    console=True
    Run keyword unless  ${Response[0]['status_code']}== 202    Fail    "Unable to Create Ethernet network"
    Log    Ethernet Networks created successfully!!    console=True

    Log    \nUpdating bandwidth of Ethernet Networks    console=True
    ${nets}    Fusion Api Get Ethernet Networks
    ${net}    Get From Dictionary    ${nets}    members
    ${l}    Get Length    ${net}
    :FOR    ${x}    IN RANGE    0   ${l}
    \    ${ct}    Fusion Api Get Connection Templates    ${net[${x}]['connectionTemplateUri']}
    \    ${bw}    Create Dictionary    maximumBandwidth=50000    typicalBandwidth=2500
    \    Set to Dictionary    ${ct}    bandwidth=${bw}
    \    Remove From Dictionary    ${ct}    status_code    headers
    \    ${resp}    Fusion Api Update Connection Template    ${ct}    ${net[${x}]['connectionTemplateUri']}

    log    ${ligs['${LIG}']}    console=True
    Add LIG from variable    ${ligs['${LIG}']}

    Set Suite Variable  ${EG}   Enc${enc_count}-EG
    log    ${EG}    console=True
    ${resp}    Add Enclosure Group from variable    ${enc_group['${EG}']}
    ${task} =   Wait For Task   ${resp}    5 min    15s
    Run Keyword If  '${task['taskState']}' != 'Completed'    FAIL    ELSE    Log    EG Created Successfully!!    console=True

    Set Suite Variable  ${eg}   EG:Enc${enc_count}-EG
    Set To Dictionary   ${les['${LE}']}    enclosureGroupUri   ${eg}
    Add Logical Enclosure from variable    ${les['${LE}']}
    Log    \n Verify Interconnects    console=True
    ${resp}    Get LI member    ${les['${LE}']['name']}-${LIG}
    :FOR    ${interconnect}    IN    @{resp['interconnects']}
    \   Log    ${interconnect}    console=True
    \   IC reached state    ${interconnect}   Configured

    Set Suite Variable    ${interconn}    Enc${enc_count}-interconnect
    log    ${Interconnects['${interconn}']}    console=True


    log    ${Server_profiles['${SP}']}    console=True
    ${resp}   Add Server Profiles from variable   ${Server_profiles['${SP}']}
    ${l} =  Get Length  ${resp}
    :FOR    ${x}    IN RANGE    0    ${l}
    \    Log    ${resp[${x}]}    console=True
    \    ${task} =   Wait For Task   ${resp[${x}]}    15 min    15s
    \    Run Keyword If  '${task['taskState']}' != 'Completed'    FAIL    ELSE    Log    Server profiles Created Successfully!!    console=True
    Log    "Powering on the Server bays"    console=True

    :FOR    ${server}   IN  @{Server_profiles['${SP}']}
    \   Log    ${server['serverHardwareUri']}    console=True
    \   Power on server     ${server['serverHardwareUri']}

    sleep   200    #Wait for the servers get powered on

Clean OV
    [Documentation]  Clean OV
    Power off ALL servers    PressAndHold
    Remove All Server Profiles
    Remove All LEs
    Remove All Enclosure Groups
    Remove All LIGs
    Remove All Ethernet Networks
    Remove ALL FCoE Networks
    Remove All FC Networks