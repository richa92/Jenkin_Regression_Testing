*** Settings ***
Documentation       OVF1816_Negative_Scenarios
#Variables       data_variables.py
Variables       data_variables_Nitro_Porting.py
Library         json
Library         FusionLibrary
Library         RoboGalaxyLibrary
Library         Collections
Library         SSHLibrary
Library         String
Resource        ../../../../../Resources/api/fusion_api_resource.txt
Library         data_variables
Library         Telnet
Library         backping.py
Library         Dialogs
Suite Teardown  Clean OV

*** Variables ***
${APPLIANCE_IP}     15.245.131.251
${number1}                   2
${number}                    5
${flag}                      Windows
${Port_status_trap_name}     Lost

${Ping_Lost}    Lost


*** Test Cases ***
Login to Appliance
    [Documentation]    Login to Appliance
    [Tags]  add   POSITIVE
    Set Log Level    TRACE
    ${Login_response} =    Fusion Api Login Appliance    ${APPLIANCE_IP}        ${admin_credentials}
    Run keyword unless  ${Login_response[0]['status_code']}== 200    Fail    "Unable to Login"

    Clean OV

Create Networks
    [Documentation]    Create ethernet Networks
    Log    \n-Creating Ethernet Networks    console=True
    ${resp}    Add Ethernet Networks from variable   ${ethnets}
    Wait For Task2    ${resp}    200
    Log    Ethernet Network got created successfully    console=True

Create Network Sets
    [Documentation]    Create Network Sets
    Add Network Sets from variable    ${network_sets}

Create LIG, EG and LE
    [Documentation]    Create LIG, EG and LE
    Log    \n Creating LIG    console=True
    Add LIG from variable   ${LIGS_TB[0]}

    Log      \n Creating EG    console=True
    ${Resp}    Add Enclosure Group from variable    ${enc_group}
    Wait For Task2    ${Resp}    200

    Log      \n Creating LE    console=True
    Add Logical Enclosure from variable     ${les}

Scenario_1:
    [Documentation]    Verify when trying to create/edit LAG , with both the connections having different requested bandwidth,Server profile create/edit should throw an error message

    Log        \n Creating server profile with LAG both the connections having different requested bandwidth    console=True
    ${resp}    Add Server Profiles from variable    ${sp_diff_bandwidth}
    ${task}    Wait For Task    ${resp[0]}    120
    Run Keyword If  '${task['taskErrors'][0]['errorCode']}' == 'MISMATCH_BANDWIDTH_LAG_VIOLATION_ERROR'    Log      \n Expected FAILure! \n\nError: ${task['taskErrors'][0]['errorCode']} \nDetails: ${task['taskErrors'][0]['message']}\n    console=True
    ...             ELSE    FAIL

    # Creating profile with two LAG connections
    ${task}    Add Server Profiles from variable    ${Server_profile1}
    Wait For Task2    ${task[0]}    300


    #Editing LAG with both the connections having different requested bandwidth
    ${resp}    Edit Server Profiles from variable    ${sp_diff_bandwidth}
    ${task}    Wait For Task    ${resp[0]}    120
    Run Keyword If  '${task['taskErrors'][0]['errorCode']}' == 'MISMATCH_BANDWIDTH_LAG_VIOLATION_ERROR'    Log      \n Expected FAILure! \n\nError: ${task['taskErrors'][0]['errorCode']} \nDetails: ${task['taskErrors'][0]['message']}\n    console=True
    ...             ELSE    FAIL

    Remove All Server Profiles


Scenario_2:
    [Documentation]    Verify when the connections in a LAG are on different adapters ,Server profile create/edit should  throw an error message

    Log        \n Creating server profile with LAG both the connections having different requested bandwidth    console=True
    ${resp}    Add Server Profiles from variable    ${sp_diff_adapters}
    ${task}    Wait For Task    ${resp[0]}    120
    Run Keyword If  '${task['taskErrors'][0]['errorCode']}' == 'MISMATCH_SUBPORT_LAG_VIOLATION_ERROR'    Log      \n Expected FAILure! \n\nError: ${task['taskErrors'][0]['errorCode']} \nDetails: ${task['taskErrors'][0]['message']}\n    console=True
    ...             ELSE    FAIL


    # Creating profile with two LAG connections
    ${task}    Add Server Profiles from variable   ${Server_profile1}
    ${Resp}    Wait For Task2    ${task}    300


    #Editing LAG with  both the connections having different requested bandwidth
    ${resp}    Edit Server Profiles from variable    ${sp_diff_adapters}
    ${task}    Wait For Task    ${resp[0]}    120
    Run Keyword If  '${task['taskErrors'][0]['errorCode']}' == 'MISMATCH_SUBPORT_LAG_VIOLATION_ERROR'    Log      \n Expected FAILure! \n\nError: ${task['taskErrors'][0]['errorCode']} \nDetails: ${task['taskErrors'][0]['message']}\n    console=True
    ...             ELSE    FAIL

    Remove All Server Profiles

Scenario_3_1:
    [Documentation]    Verify  when different network are used in the same LAG by POST/PUT method, Server profile create/edit should throw an error message

    Log        \n Creating server profile with LAG both the connections having different requested bandwidth    console=True
    ${resp}    Add Server Profiles from variable    ${sp_diff_networks}
    ${task}    Wait For Task    ${resp[0]}    120
    Run Keyword If  '${task['taskErrors'][0]['errorCode']}' == 'MISMATCH_NETWORK_LAG_VIOLATION_ERROR'    Log      \n Expected FAILure! \n\nError: ${task['taskErrors'][0]['errorCode']} \nDetails: ${task['taskErrors'][0]['message']}\n    console=True
    ...             ELSE    FAIL


    # Creating profile with two LAG connections
    ${task}    Add Server Profiles from variable    ${Server_profile1}
    ${Resp}    Wait For Task2    ${task}    300


    #Editing LAG with  both the connections having different requested bandwidth
    ${resp}    Edit Server Profiles from variable    ${sp_diff_networks}
    ${task}    Wait For Task    ${resp[0]}    120
    Run Keyword If  '${task['taskErrors'][0]['errorCode']}' == 'MISMATCH_NETWORK_LAG_VIOLATION_ERROR'    Log      \n Expected FAILure! \n\nError: ${task['taskErrors'][0]['errorCode']} \nDetails: ${task['taskErrors'][0]['message']}\n    console=True
    ...             ELSE    FAIL

    Remove All Server Profiles

Scenario_3_2:
    [Documentation]    Verify  when different network sets are used in the same LAG by POST/PUT method, Server profile create/edit should throw an error message

    Log        \n Creating server profile with LAG both the connections having different requested bandwidth    console=True
    ${resp}    Add Server Profiles from variable    ${sp_diff_networks_sets[0]}
    ${task}    Wait For Task    ${resp[0]}    120
    Run Keyword If  '${task['taskErrors'][0]['errorCode']}' == 'MISMATCH_NETWORK_LAG_VIOLATION_ERROR'    Log      \n Expected FAILure! \n\nError: ${task['taskErrors'][0]['errorCode']} \nDetails: ${task['taskErrors'][0]['message']}\n    console=True
    ...             ELSE    FAIL


    # Creating profile with two LAG connections
    ${task}    Add Server Profiles from variable    ${sp_diff_networks_sets[1]}
    ${Resp}    Wait For Task2    ${task}    300


    #Editing LAG with  both the connections having different requested bandwidth
    ${resp}    Edit Server Profiles from variable    ${sp_diff_networks_sets[0]}
    ${task}    Wait For Task    ${resp[0]}    120
    Run Keyword If  '${task['taskErrors'][0]['errorCode']}' == 'MISMATCH_NETWORK_LAG_VIOLATION_ERROR'    Log      \n Expected FAILure! \n\nError: ${task['taskErrors'][0]['errorCode']} \nDetails: ${task['taskErrors'][0]['message']}\n    console=True
    ...             ELSE    FAIL

    Remove All Server Profiles

Scenario_4:
    [Documentation]    Verify when only one connection is used in a LAG by POST method, Server profile create should throw an error message

    #Creating server profile with only one connection in a LAG
    ${resp}    Add Server Profiles from variable    ${sp_one_lag}
    ${task}    Wait For Task    ${resp[0]}    120
    Run Keyword If  '${task['taskErrors'][0]['errorCode']}' == 'CONNECTIONS_PER_LAG_VIOLATION_ERROR'    Log      \n Expected FAILure! \n\nError: ${task['taskErrors'][0]['errorCode']} \nDetails: ${task['taskErrors'][0]['message']}\n    console=True
    ...             ELSE    FAIL

Scenario_5:
    [Documentation]    Verify when server profile is edited and only one connection is used in a LAG by PUT method,Server profile Edit should throw an error message

    # Creating profile with two LAG connections
    ${task}    Add Server Profiles from variable    ${Server_profile1}
    ${Resp}    Wait For Task2    ${task}    300


    #Editing server profile with one lag
    ${resp}    Edit Server Profiles from variable    ${sp_one_lag}
    ${task}    Wait For Task    ${resp[0]}    120
    Run Keyword If  '${task['taskErrors'][0]['errorCode']}' == 'CONNECTIONS_PER_LAG_VIOLATION_ERROR'    Log      \n Expected FAILure! \n\nError: ${task['taskErrors'][0]['errorCode']} \nDetails: ${task['taskErrors'][0]['message']}\n    console=True
    ...             ELSE    FAIL


Scenario_6:
    [Documentation]    Verify creating a LAG using uplinkports from 2 different LIGs by POST/PUT method
    Clean OV
    Log        \n-Creating Ethernet Networks    console=True
    ${resp}    Add Ethernet Networks from variable   ${ethnets}
    Wait For Task2    ${resp}    200

    :FOR   ${LIGs}   IN   @{LIGS_Aside_Bside}
    \   Log      \n Creating LIG    console=True
    \   ${lig_resp}    Add LIG from variable   ${LIGs}

    Log      \n Creating EG    console=True
    ${Resp}    Add Enclosure Group from variable        ${enc_group1}
    Log      \n Creating LE ${Resp}    console=True

    Log      \n Creating LE    console=True
    ${Resp}    Add Logical Enclosure from variable     ${LE}
    #Run Keyword If  '${Resp['status_code']}' != '200'  Fail    ELSE  Log       \n-created LE successfully    console=True

    #Creating server profile using uplinkports from 2 different LIGs  by POST method
    ${resp}    Add Server Profiles from variable    ${Server_profile1}
    ${task}    Wait For Task    ${resp[0]}    120
    Run Keyword If  '${task['taskErrors'][0]['errorCode']}' == 'NOT_SAME_LOGICAL_INTERCONNECT_LAG_VIOLATION_ERROR'    Log      \n Expected FAILure! \n\nError: ${task['taskErrors'][0]['errorCode']} \nDetails: ${task['taskErrors'][0]['message']}\n    console=True
    ...             ELSE    FAIL

    # Creating profile with two LAG connections
    ${resp}    Add Server Profiles from variable    ${sp_1}
    Wait For Task2    ${resp}    200

    #Editing server profile using uplinkports from 2 different LIGs by POST method
    ${resp}    Edit Server Profiles from variable    ${Server_profile1}
    ${task}    Wait For Task    ${resp[0]}    120
    Run Keyword If  '${task['taskErrors'][0]['errorCode']}' == 'NOT_SAME_LOGICAL_INTERCONNECT_LAG_VIOLATION_ERROR'    Log      \n Expected FAILure! \n\nError: ${task['taskErrors'][0]['errorCode']} \nDetails: ${task['taskErrors'][0]['message']}\n    console=True
    ...             ELSE    FAIL

    Remove All Server Profiles


***Keywords***
Clean OV
    [Documentation]    Cleans the appliance
    Log    \nCleaning the OV    console=True
    Power off ALL Servers
    Remove All Server Profiles
    Remove All LEs
    Remove ALL Enclosure Groups
    Remove ALL LIGs
    Remove ALL Ethernet Networks
    Remove ALL FC Networks
    Remove ALL FCoE Networks
    Remove ALL Network Sets
    Remove ALL Users
