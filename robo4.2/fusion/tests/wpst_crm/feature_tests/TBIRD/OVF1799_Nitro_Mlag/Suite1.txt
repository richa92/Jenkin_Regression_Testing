*** Settings ***
Documentation   OVF1799_Suite1
Variables       data_variables_NITRO_RIG.py
Library         json
Library         FusionLibrary
Library         RoboGalaxyLibrary
Library         Collections
Library         SSHLibrary
Library         String
Resource        ../../../../resource/fusion_api_all_resource_files.txt
Resource        Keywords.txt
Library         Telnet
Library         data_variables_NITRO_RIG
Library         backping.py
Library         Dialogs
Library         stats
Suite Setup     Clean up for Suite
Suite Teardown  Clean up for Suite

*** Variables ***
${flag}     Windows
${team0}    ping_teamip0.txt

***Test Cases***

TC_1 Create ethernet network
    [Documentation]    Creating ethernet network
    Add ethernet Networks       @{ethnets}

TC_1-1 Create LIG
    [Documentation]    Creating LIG
    :FOR    ${LIG}    IN    @{LIGS_TB}
    \    ${lig_resp}    Add LIG from variable    ${LIG}
    \    Run Keyword If  '${lig_resp['status_code']}' != '200'   fail    ELSE    Log to Console  \n-Created LIG successfully

TC_1-2 Create EG
    [Documentation]    Creating EG
    ${Resp}    Add Enclosure Group from variable        ${enc_group}
    Run Keyword If  '${Resp['status_code']}' != '201'  Fail    ELSE  log to console   \n-created EG successfully

TC_1-3 Create LE
    [Documentation]    Creating LE
    ${Resp}    Add Logical Enclosure from variable     ${les}
    Run Keyword If  '${Resp['status_code']}' != '200'  Fail    ELSE  log to console   \n-created LE successfully

TC_2 Create server Profiles
    [Documentation]    Creating server Profiles
    Add Server Profiles from variable    ${Server_profile1}
    Log to console  \n Server profiles created successfully

TC_2-1 Power On Server
    [Documentation]    Powering on Server and waiting for it to boot
    Power on server     ${Server_profile1[0]['serverHardwareUri']}
    Log to console    \n Powering on servers and waiting 8 minutes for the server to boot...
    Sleep   8min

TC_2-2 Get server IPs, team the adapters and check if the team IPs are pinging
    [Documentation]    Getting server ips, teaming the adapters and checking if IP's are pinging
    Get MAC Address of the server and team    ${ilo_details_enc1_bay11}    ${server_details_enc1_bay11}
    Ping Test    ${ilo_details_enc1_bay11}    ${server_details_enc1_bay11}    30

TC_2-3 Verify alert message on server profile page after teaming
    [Documentation]    Verifying alert message on server profile after teaming
    ${Alert_msg}    Get Server profile Alerts
    ${Count}    Get Length    ${Alert_msg}
    Run Keyword If  '${Count}' != '0'  Fail    ELSE  log to console   \n-Verified the alerts msg of server profiles

TC_3 Update telemetry configuration
    [Documentation]    Updating telemetry configuration in LI
    Update LI telemetry    ${LI}    60
    Sleep   3min

TC_3-1 Verify common and advanced statistics values
    [Documentation]    Verifying the statistics values
    :FOR    ${x}    IN RANGE    0    2
    \    Wait Until Keyword Succeeds    20 min   15s    Validate Common and Advanced Statistics    ${Linked_ports[${x}]}    ${stats_flag[${x}]}    ${stats_lag_flag[${x}]}    common    ${subport_no[${x}]}
    \    Wait Until Keyword Succeeds    20 min   15s    Validate Common and Advanced Statistics    ${Linked_ports[${x}]}    ${stats_flag[${x}]}    ${stats_lag_flag[${x}]}    advanced    ${subport_no[${x}]}

TC_4 Verify common and advanced statistics values after passing traffic for 15 minutes
    [Documentation]    Verifying the statistics values after passing traffic for 15 minutes
    Ping Test    ${ilo_details_enc1_bay11}    ${server_details_enc1_bay11}    900

    :FOR    ${x}    IN RANGE    0    2
    \    Wait Until Keyword Succeeds    20 min   15s    Validate Common and Advanced Statistics    ${Linked_ports[${x}]}    ${stats_flag[${x}]}    ${stats_lag_flag[${x}]}    common    ${subport_no[${x}]}
    \    Wait Until Keyword Succeeds    20 min   15s    Validate Common and Advanced Statistics    ${Linked_ports[${x}]}    ${stats_flag[${x}]}    ${stats_lag_flag[${x}]}    advanced    ${subport_no[${x}]}

TC_5 Clear Port Counters and verify the statistics for reduced values
    [Documentation]    Clearing the port counters and verifying the statistics values
    :FOR    ${x}    IN RANGE    0    2
    \    Log to console and logfile    \nVerifying Common Port Statistics
    \    Wait Until Keyword Succeeds    20 min   15s    Clear Port counter and verify for reduced values    ${Linked_ports[${x}]}    ${stats_flag[${x}]}    common    ${subport_no[${x}]}
    \    Log to console and logfile   Verifying Common Lag Port Statistics...
    \    Wait Until Keyword Succeeds    20 min   15s    Clear Port counter and verify for reduced values    ${Linked_ports[${x}]}    ${stats_lag_flag[${x}]}    common    ${subport_no[${x}]}
    \    Log to console and logfile    \nVerifying Advanced Port Statistics
    \    Wait Until Keyword Succeeds    20 min   15s    Clear Port counter and verify for reduced values    ${Linked_ports[${x}]}    ${stats_flag[${x}]}    advanced    ${subport_no[${x}]}
    \    Log to console and logfile   \nVerifying Advanced Lag Port Statistics...
    \    Wait Until Keyword Succeeds    20 min   15s    Clear Port counter and verify for reduced values    ${Linked_ports[${x}]}    ${stats_lag_flag[${x}]}    advanced    ${subport_no[${x}]}

TC_6 Verify common and advanced statistics values after passing traffic
    [Documentation]    Passing traffic and verifying the statistics values
    Ping Test    ${ilo_details_enc1_bay11}    ${server_details_enc1_bay11}    120
    :FOR    ${x}    IN RANGE    0    2
    \    Wait Until Keyword Succeeds    20 min   15s    Validate Common and Advanced Statistics    ${Linked_ports[${x}]}    ${stats_flag[${x}]}    ${stats_lag_flag[${x}]}    common    ${subport_no[${x}]}
    \    Wait Until Keyword Succeeds    20 min   15s    Validate Common and Advanced Statistics    ${Linked_ports[${x}]}    ${stats_flag[${x}]}    ${stats_lag_flag[${x}]}    advanced    ${subport_no[${x}]}

TC_7 Verifying common and advanced statistics values with no connections in the Server profile
    [Documentation]    Verifying common and advanced statistics values with no connections in the Server profile
    ${Initial_Commstat}    Create List
    ${Initial_Advstat}    Create List
    ${Final_Commstat}    Create List
    ${Final_Advstat}    Create List

    ${Initial_Commstat}    Wait Until Keyword Succeeds    20 min   15s    Fetch Interconnect Statistics    ${Linked_ports[1]}    ${stats_flag[1]}    ${stats_lag_flag[1]}    common    ${subport_no[1]}

    ${Initial_Advstat}    Wait Until Keyword Succeeds    20 min   15s    Fetch Interconnect Statistics    ${Linked_ports[1]}    ${stats_flag[1]}    ${stats_lag_flag[1]}    advanced    ${subport_no[1]}

    Edit Server profile    ${sp_lag}
    Sleep    15min

    ${Final_Commstat}    Wait Until Keyword Succeeds    20 min   15s    Fetch Interconnect Statistics    ${Linked_ports[1]}    ${stats_flag[1]}    ${stats_lag_flag[1]}    common    ${subport_no[1]}

    ${Final_Advstat}    Wait Until Keyword Succeeds    20 min   15s    Fetch Interconnect Statistics    ${Linked_ports[1]}    ${stats_flag[1]}    ${stats_lag_flag[1]}    advanced    ${subport_no[1]}

    ${len}    Get Length    ${Initial_Commstat}
    :FOR    ${y}    IN RANGE    0    ${len}
    \    Verify Reduced statistics    ${Initial_Commstat[${y}]}    ${Final_Commstat[${y}]}    common

    ${len}    Get Length    ${Final_Advstat}
    :FOR    ${y}    IN RANGE    0    ${len}
    \    Verify Reduced statistics    ${Initial_Advstat[${y}]}    ${Final_Advstat[${y}]}    advanced

TC_8 Edit server profile with connections
    [Documentation]    Verifying if existing non-LAG'd connections can be edited by PUT method to LAG the connections
    Power off ALL Servers
    ${task}    Edit Server Profiles from variable    ${Server_profile1}
    Run Keyword If  '${task['status_code']}' == '200'    Log to console  \n Server profile updated successfully \nStatus Code: ${task['status_code']}    ELSE    FAIL

TC_8-1 Poweron Server and pass traffic
    [Documentation]    Powering on Server and passing traffic
    Power on server     ${Server_profile1[0]['serverHardwareUri']}
    Sleep    8min
    Ping Test    ${ilo_details_enc1_bay11}    ${server_details_enc1_bay11}    30

TC_9 Update the sample interval in LI and verify the statistics values
    [Documentation]    Updating the sampling interval in LI and verifying the statistics values
    Update LI telemetry    ${LI}    61
    Sleep    2min
    :FOR    ${x}    IN RANGE    0    2
    \    Wait Until Keyword Succeeds    20 min   15s    Validate Common and Advanced Statistics    ${Linked_ports[${x}]}    ${stats_flag[${x}]}    ${stats_lag_flag[${x}]}    common    ${subport_no[${x}]}
    \    Wait Until Keyword Succeeds    20 min   15s    Validate Common and Advanced Statistics    ${Linked_ports[${x}]}    ${stats_flag[${x}]}    ${stats_lag_flag[${x}]}    advanced    ${subport_no[${x}]}

TC_10 Verify the statistics values when traffic flow is resumed after adding connections back
    [Documentation]    Verifying the statistics values after traffic is resumed by adding connections back
    Ping Test    ${ilo_details_enc1_bay11}    ${server_details_enc1_bay11}    120
    :FOR    ${x}    IN RANGE    0    2
    \    Wait Until Keyword Succeeds    20 min   15s    Validate Common and Advanced Statistics    ${Linked_ports[${x}]}    ${stats_flag[${x}]}    ${stats_lag_flag[${x}]}    common    ${subport_no[${x}]}
    \    Wait Until Keyword Succeeds    20 min   15s    Validate Common and Advanced Statistics    ${Linked_ports[${x}]}    ${stats_flag[${x}]}    ${stats_lag_flag[${x}]}    advanced    ${subport_no[${x}]}
    Update LI telemetry    ${LI}    300
    Remove Teaming