*** Settings ***
Documentation		Feature Test: F108 Internal Networks Tests
Variables 			../data_common.py
Resource            ../../../../../../Resources/api/fusion_api_resource.txt
Resource            ../../FVT/fvt-keywords.txt
Resource			../../FVT/Resources/fvt_resource.txt	

Library				FusionLibrary
Library				../../FVT/fvt_api.py

*** Test Cases ***
Login In User
    [Documentation]    Common login and setting variables keyword for test cases
	Set Log Level	TRACE
	Fusion Api Login Appliance	${appliance_ip}	${admin_credentials}
	Set Suite Variable	${LIG}	Enc${frame}-LIG
	Set Suite Variable	${EG}	Enc${frame}-EG
	Set Suite Variable	${LE}	Enc${frame}-LE
	Set Suite Variable	${LI}	${LE}-${LIG}
	Pass Execution	Finished Login User
	
Create Ethernet Networks
    [Documentation]    Create Ethernet Networks for test cases
	#Pass Execution	Skip Create Ethernet Networks
	Create Ethernet Networks	${ethernet_networks}
	Pass Execution	Finished Create Ethernet Networks

Create Network Sets
    [Documentation]    Create Ethernet Network Sets for test cases
	#Pass Execution	Skip Add Network Sets
	Create Network Set	${ns1}	timeout=5m	interval=1s
	Create Network Set	${ns2}	timeout=5m	interval=1s
	Pass Execution	Finished Create Network Sets
	
Create Logical Enclosure
    [Documentation]    Create LIG, EG and LE
	#Pass Execution	Skip Fvt Create Logical Enclosure
	Add Logical Interconnect Group	${ligs['${LIG}']}	timeout=10m	interval=1s	
	FVT Add Enclosure Group	${enc_group['${EG}']}
	Add Logical Enclosure	${les['${LE}']}	timeout=90m	interval=1m
	${resp}	Fvt Api Get Logical Enclosure By Name	${LE}
	Should Be Equal As Strings	${resp['status']}	OK
	Should Be Equal As Strings	${resp['state']}	Consistent
	${resp}	Fvt Api Get Logical Interconnect BY Name	${LI}
	Should Be Equal As Strings	${resp['consistencyStatus']}	CONSISTENT
	FVT Verify Interconnects	Enc${frame}Map
	Pass Execution	Finished Fvt Create Logical Enclosure
	
Remove Network From Internal Network List
    [Documentation]    Remove Network from Internal Networks list
	#Pass Execution	Skip Fvt Remove Network From Internal Network List
	Set to Dictionary	${profiles['Profile1']}	enclosureGroupUri	${EG}
	FVT Add Server Profile	${profiles['Profile1']}	timeout=20m	interval=1s  
	${resp}	Fvt Api Get Logical Interconnect By Name	${LI}
	${body} =	Create List
	${task}	Fusion Api Update Li Internal Networks	uri=${resp['uri']}	body=${body}
	Should Be Equal As Integers	${task['status_code']}	202
	Wait For Task	${task}	timeout=20 m	interval=1 s
	${resp}	Fvt Api Get Server Profile By Name	Profile1
	Should Be Equal As Strings	${resp['status']}	Critical
	${resp}	Fvt Api Get Logical Interconnect By Name	${LI}
	Should Be Equal As Strings	${resp['consistencyStatus']}	NOT_CONSISTENT
	${task}	Fusion Api Update From Group	uri=${resp['uri']}
	Should Be Equal As Integers	${task['status_code']}	202
	Wait For Task	${task}	timeout=30 m	interval=2 s
	${resp}	Fvt Api Get Logical Interconnect By Name	${LI}
	Should Be Equal As Strings	${resp['consistencyStatus']}	CONSISTENT
	Sleep	1m
	${resp}	Fvt Api Get Server Profile By Name	Profile1
	Should Be Equal As Strings	${resp['status']}	OK
	${task}	Fusion Api Delete Server Profile	name=Profile1	param=?force=true
	Should Be Equal As Integers	${task['status_code']}	202
	${task} =	Wait For Task	${task}	timeout=10m	interval=2s	
	${resp}	Fvt Api Get Server Profile By Name	Profile1
	Should Be Equal As Strings	${resp}	None
	Pass Execution	Finished Fvt Remove Network From Internal Network List

Remove Network From Uplink Set On LI
    [Documentation]    Remove Network from LI uplink set
	#Pass Execution	Skip Fvt Remove Network From Uplink Set On LI
	Set to Dictionary	${profiles['Profile2']}	enclosureGroupUri	${EG}
	FVT Add Server Profile	${profiles['Profile2']}	timeout=20m	interval=1s  
	Set To Dictionary	${us_delete__network}	logicalInterconnectUri	${LI}
	Edit Uplink Set	${us_delete_network}	timeout=20m	interval=1s
	${resp}	Fvt Api Get Server Profile By Name	Profile2
	Should Be Equal As Strings	${resp['status']}	OK
	${resp}	Fvt Api Get Logical Interconnect By Name	${LI}
	Should Be Equal As Strings	${resp['consistencyStatus']}	NOT_CONSISTENT
	${network}	Fvt Api Get Ethernet Network By Name	wpstnetwork1
	Should Contain	${resp['internalNetworkUris']}	${network['uri']}
	${task}	Fusion Api Update From Group	uri=${resp['uri']}
	Should Be Equal As Integers	${task['status_code']}	202
	Wait For Task	${task}	timeout=30 m	interval=2 s
	Sleep	1m
	${resp}	Fvt Api Get Server Profile By Name	Profile2
	Should Be Equal As Strings	${resp['status']}	OK
	${resp}	Fvt Api Get Logical Interconnect By Name	${LI}
	Should Be Equal As Strings	${resp['consistencyStatus']}	CONSISTENT
	${task}	Fusion Api Delete Server Profile	name=Profile2	param=?force=true
	Should Be Equal As Integers	${task['status_code']}	202
	${task} =	Wait For Task	${task}	timeout=10m	interval=2s	
	${resp}	Fvt Api Get Server Profile By Name	Profile2
	Should Be Equal As Strings	${resp}	None
	Pass Execution	Finished Fvt Remove Network From Uplink Set On LI
	
Remove All Networks In Network Set From Internal Network List On LI
    [Documentation]    Remove all Networks of a network set from LI Internal network list
	#Pass Execution	Skip Remove All Networks In Network Set From Internal Network List On LI
	${li_resp}	Fvt Api Get Logical Interconnect By Name	${LI}
	${netlist} =	Get Ethernet Network Uris	${ns2['networkUris']}	
	${task}	Fusion Api Update Li Internal Networks	uri=${li_resp['uri']}	body=${netlist}
	Should Be Equal As Integers	${task['status_code']}	202
	Wait For Task	${task}	timeout=20 m	interval=1 s	
	Set to Dictionary	${profiles['Profile3']}	enclosureGroupUri	${EG}
	FVT Add Server Profile	${profiles['Profile3']}	timeout=20m	interval=1s  
	${body} =	Create List
	${task}	Fusion Api Update Li Internal Networks	uri=${li_resp['uri']}	body=${body}
	Should Be Equal As Integers	${task['status_code']}	202
	Wait For Task	${task}	timeout=20 m	interval=1 s
	Sleep	30s
	${resp}	Fvt Api Get Server Profile By Name	Profile3
	Should Be Equal As Strings	${resp['status']}	Critical
	${task}	Fusion Api Update Li Internal Networks	uri=${li_resp['uri']}	body=${netlist}
	Should Be Equal As Integers	${task['status_code']}	202
	Wait For Task	${task}	timeout=20 m	interval=1 s	
	Sleep	1m
	${resp}	Fvt Api Get Server Profile By Name	Profile3
	Should Be Equal As Strings	${resp['status']}	OK	
	Pass Execution	Remove All Networks In Network Set From Internal Network List On LI
	
Add Network To Network Set
    [Documentation]    Add Network to Network set
	#Pass Execution	Skip Add Network To Network Set
	${task} =	Edit Network Set	${ns1_add_network}	timeout=5m	interval=1s
	Should Be Equal As Integers	${task['status_code']}	200
	${network} =	Fvt Api Get Ethernet Network By Name	wpstnetwork6
	${networkset} =	Fvt Api Get Network Set By Name	NS1
	Should Contain	${networkset['networkUris']}	${network['uri']}
	${task} =	Edit Network Set	${ns2_add_network}
	Should Be Equal As Integers	${task['status_code']}	400
	Should Be Equal As Strings	${task['errorCode']}	CRM_NETWORK_SET_NETWORK_NOT_IN_LI
	${task}	Fusion Api Delete Server Profile	name=Profile3	param=?force=true
	Should Be Equal As Integers	${task['status_code']}	202
	${task} =	Wait For Task	${task}	timeout=10m	interval=2s	
	${resp}	Fvt Api Get Server Profile By Name	Profile3
	Should Be Equal As Strings	${resp}	None
	Pass Execution	Finished Add Network To Network Set
	
Add Internal Network To Uplink Set On LI
    [Documentation]    Add Internal network to LI uplink set
	#Pass Execution	Skip Add Internal Network To Uplink Set On LI
	${resp}	Fvt Api Get Logical Interconnect By Name	${LI}
	${task}	Fusion Api Update From Group	uri=${resp['uri']}
	Should Be Equal As Integers	${task['status_code']}	202
	Wait For Task	${task}	timeout=30 m	interval=2 s
	Set To Dictionary	${us_add_network}	logicalInterconnectUri	${LI}
	Edit Uplink Set	${us_add_network}	timeout=20m	interval=1s
	${li_resp}	Fvt Api Get Logical Interconnect BY Name	${LI}
	${net_resp}	Fvt Api Get Ethernet Network By Name	wpstnetwork10
	Should Not Contain	${li_resp['internalNetworkUris']}	${net_resp['uri']}
	Pass Execution	Finished Add Internal Network To Uplink Set On LI

Delete Network From Appliance
    [Documentation]    Delete network from CIC appliance
	#Pass Execution	Skip Delete Network From Appliance
	${net_resp} =	Fvt Api Get Ethernet Network By Name	wpstDefaultnetwork
	${li_resp} =	Fvt Api Get Logical Interconnect By Name	${LI}
	${lig_resp} =	Fvt Api Get Logical Interconnect Group By Name	${LIG}
	Should Contain	${li_resp['internalNetworkUris']}	${net_resp['uri']}
	Should Contain	${lig_resp['internalNetworkUris']}	${net_resp['uri']}
	${task}	Fusion Api Delete Ethernet Network 	name=wpstDefaultnetwork
	Should Be Equal As Integers	${task['status_code']}	202
	Wait For Task	${task}	timeout=10 m	interval=1 s
	${li_resp} =	Fvt Api Get Logical Interconnect By Name	${LI}
	${lig_resp} =	Fvt Api Get Logical Interconnect Group By Name	${LIG}
	Should Not Contain	${li_resp['internalNetworkUris']}	${net_resp['uri']}
	Should Not Contain	${lig_resp['internalNetworkUris']}	${net_resp['uri']}
	Pass Execution	Finished Delete Network From Appliance
	
Add Network To Internal Network List And Uplink Set On LI
    [Documentation]    Add network to LI Internal Network List and uplink set
	#Pass Execution	Skip Add Network To Internal Network List And Uplink Set On LI
	Append To List	${us_add_network['networkUris']}	wpstnetwork3
	Set To Dictionary	${us_add_network}	logicalInterconnectUri	${LI}
	Edit Uplink Set	${us_add_network}	timeout=20m	interval=1s
	${network} =	Create List	wpstnetwork3
	${netlist} =	Get Ethernet Network Uris	${network}	
	${resp}	Fvt Api Get Logical Interconnect By Name	${LI}
	${task}	Fusion Api Update Li Internal Networks	uri=${resp['uri']}	body=${netlist}
	Should Be Equal As Integers	${task['status_code']}	400
	Pass Execution	Finished Add Network To Internal Network List And Uplink Set On LI

Delete Netowrk From Logical Interconnect Group
    [Documentation]    Delete network from an LIG
	#Pass Execution	Skip Delete Netowrk From LIG
	${resp}	Fvt Api Get Logical Interconnect By Name	${LI}
	${task}	Fusion Api Update From Group	uri=${resp['uri']}
	Should Be Equal As Integers	${task['status_code']}	202
	Wait For Task	${task}	timeout=30 m	interval=2 s
	${encindexes} =	Create List
	:For	${x}	in range	1	${frame}+1
	\	Append To List	${encindexes}	${x}
	${variables} =	Get Variables	no_decoration=Yes
	${icmap} =	Set Variable	${variables['Enc${frame}Map']}	
	Set To Dictionary	${lig_delete_network}	name	${LIG}
	Set To Dictionary	${lig_delete_network}	interconnectMapTemplate	${icmap}
	Set To Dictionary	${lig_delete_network}	enclosureIndexes	${encindexes}
	Edit Logical Interconnect Group	${lig_delete_network}	timeout=10m	interval=1s
	${task}	Fusion Api Update From Group	uri=${resp['uri']}
	Should Be Equal As Integers	${task['status_code']}	202
	Wait For Task	${task}	timeout=30 m	interval=2 s
	${net_resp} =	Fvt Api Get Ethernet Network By Name	wpstnetwork1
	${li_resp} =	Fvt Api Get Logical Interconnect By Name	${LI}
	Should Not Contain	${li_resp['internalNetworkUris']}	${net_resp['uri']}
	Pass Execution	Finished Delete Netowrk From LIG
	
Clean Up
    [Documentation]    Clean up test setup
	#Pass Execution	Skip Clean Up
	
	### Delete Network Sets ###
	${task}	Fusion Api Delete Network Set	name=${ns1['name']}
	Should Be Equal As Integers	${task['status_code']}	202
	Wait For Task	${task}	timeout=5 m	interval=1 s
	${resp}	Fvt Api Get Network Set BY Name	name=${ns1['name']}
	Should Be Equal As Strings	${resp}	None
	${task}	Fusion Api Delete Network Set	name=${ns2['name']}
	Should Be Equal As Integers	${task['status_code']}	202
	Wait For Task	${task}	timeout=5 m	interval=1 s
	${resp}	Fvt Api Get Network Set BY Name	name=${ns2['name']}
	Should Be Equal As Strings	${resp}	None

	### Delete Logical Enclosure ###
	Fvt Delete Logical Enclosure	${LE}	timeout=60m	interval=1m
	${resp}	Fvt Api Get Logical Enclosure BY Name	name=${LE}
	Should Be Equal As Strings	${resp}	None
	${resp}	Fvt Api Get Logical Interconnect BY Name	name=${LI}
	Should Be Equal As Strings	${resp}	None
	
	### Delete Enclosure Groups ###
	FVT Delete Enclosure Group	${EG}
	${resp}	Fvt Api Get Enclosure Group BY Name	name=${EG}
	Should Be Equal As Strings	${resp}	None

	### Delete Logical Interconnect Groups ###
	FVT Delete Logical Interconnect Group	${LIG}
	${resp}	Fvt Api Get Logical Interconnect Group BY Name	name=${LIG}
	Should Be Equal As Strings	${resp}	None

	### Delete networks ###
	Remove ALL Ethernet Networks
	Remove ALL FCoE Networks
	Remove ALL Users
	Pass Execution	Finished Compliance Testing
