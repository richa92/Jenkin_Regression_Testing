
*** Settings ***
Documentation		Negative Scenarios using FusionLibrary API keywords
Variables		data_variables.py
Library			json
Library			FusionLibrary
Library			RoboGalaxyLibrary
Library         Collections
Library         SSHLibrary
Resource        resource.txt
#Suite Teardown		Suite Teardown

*** Variables ***
${APPLIANCE_IP}	15.245.131.62
${scopename}    Scope1
${scopeuri}     /rest/scopes/c0246b64-e83c-4240-a2b8-5d01f64a930
${etag}     2016-01-29T06:12:38.695Z/2016-01-29T06:12:38.6

*** Test Cases ***

Login to Appliance

	[Tags]  add   POSITIVE
	Set Log Level    TRACE
	${resp}     Fusion Api Login Appliance    ${APPLIANCE_IP}        ${admin_credentials_TB}
    ${resp} =   Remove All Scopes

Duplicate Scope
    [Documentation]     NEGATIVE SCENARIO WITH DUPLICATE SCOPE NAME
        ${scope} =  Get Variable value  ${scopes[0]}
        Creating a scope at initial stage
        ${resp}     Fusion Api Create Scope  ${scope}
        Trying to create a scope with same name which is already exist
        ${resp}     Fusion Api Create Scope  ${scope}
        Run Keyword If  '${resp['status_code']}' == '409'    Log to console  \n Expected Failure! \nStatus Code: ${resp['status_code']}
        ...             ELSE    FAIL
        Run Keyword If  '${resp['errorCode']}' == 'DUPLICATE_SCOPE_NAME_ERROR'    Log to console  \n Expected Failure! \n\nError: ${resp['errorCode']} \nDetails: ${resp['message']}\n
        ...             ELSE    FAIL

Create with Invalid Scope
    ${scope} =  Get Variable value  ${scopes[0]}
    Set to Dictionary   ${scope}    name=scope_test

    ${resp}     Fusion Api Create Scope     ${scope}

    Run Keyword If  '${resp['status_code']}' == '400'    Log to console  \n Expected Failure! \nStatus Code: ${resp['status_code']}
    ...             ELSE    FAIL    Log to console  \nUnexpected Behaviour! scope created.

    Run Keyword If  '${resp['errorCode']}' == 'INVALID_SCOPE_NAME_ERROR'   Log to console  \n Expected Failure! \n\nError: ${resp['errorCode']} \nDetails: ${resp['message']}\n
    ...             ELSE    FAIL

Presetup for delete and edit

    ${resp} =   Remove All Scopes
    ${scope} =  Get Variable value  ${scopes[0]}
    ${resp}     Fusion Api Create Scope  ${scope}

Delete Scope with invalid URI

    ${scopes} =     Fusion Api Get Scope
    ${headers}  Get From Dictionary     ${scopes}   headers
    ${temp_headers}   Copy Dictionary   ${headers}
    :FOR	${scope}	IN	@{scopes['members']}
	\		Log to console	\nRemoving ${scope['name']}
    \       ${eTag}    Get From Dictionary     ${scope}  eTag
	\       ${headers_new}    Set To Dictionary	${temp_headers}	If-Match=${eTag}
    \		${resp} =   Fusion Api Delete Scope     uri=${scopeuri}     headers=${headers_new}

    Run Keyword If  '${resp['status_code']}' == '404'    Log to console  \nExpected failure! \nStatus Code: ${resp['status_code']}
    ...             ELSE    FAIL    Log to console  \nUnexpected Behaviour! scope created.
    Run Keyword If  '${resp['errorCode']}' == 'RESOURCE_NOT_FOUND'   Log to console  \n Expected Failure! \n\nError: ${resp['errorCode']} \nDetails: ${resp['details']}\n
    ...             ELSE    FAIL

Delete with Invalid eTag
    [Documentation]     Negative Scenario
    ${scopes} =     Fusion Api Get Scope
    ${headers}  Get From Dictionary     ${scopes}  headers
    ${temp_headers}   Copy Dictionary   ${headers}
    :FOR	${scope}	IN	@{scopes['members']}
	\		Log to console	\nRemoving ${scope['name']}
    \       ${headers_new}    Set To Dictionary	${temp_headers}	If-Match=${etag}
    \		${resp} =   Fusion Api Delete Scope     uri=${scope['uri']}     headers=${headers_new}

    Run Keyword If  '${resp['status_code']}' == '412'    Log to console  \nExpected failure! \nStatus Code: ${resp['status_code']}
    ...             ELSE    FAIL    Log to console  \nUnexpected Behaviour! scope edited.

    Run Keyword If  '${resp['errorCode']}' == 'ETAG_MISMATCH'   Log to console  \n Expected Failure! \n\nError: ${resp['errorCode']} \nDetails: ${resp['message']}\n
    ...             ELSE    FAIL


Delete without eTag

    ${scopes} =     Fusion Api Get Scope
    ${headers}  Get From Dictionary     ${scopes}  headers
    :FOR	${scope}	IN	@{scopes['members']}
	\		Log to console	\nRemoving ${scope['name']}
	\		${resp} =   Fusion Api Delete Scope     uri=${scope['uri']}     headers=${headers}

    Run Keyword If  '${resp['status_code']}' == '400'    Log to console  \nExpected failure! \nStatus Code: ${resp['status_code']}
    ...             ELSE    FAIL    Log to console  \nUnexpected Behaviour! scope edited.
    Run Keyword If  '${resp['errorCode']}' == 'SERVLET_REQUEST_BINDING_ERROR'   Log to console  \n Expected Failure! \n\nError: ${resp['errorCode']} \nDetails: ${resp['details']}\n
    ...             ELSE    FAIL


Edit Scope
    [Documentation]     Negative scenario with invalid scope
    ${scopes} =     Fusion Api Get Scope
    ${headers}  Get From Dictionary     ${scopes}  headers
    ${temp_headers}   Copy Dictionary   ${headers}

    ${body} =  Get Scope Member     ${scopename}
    ${eTag}    Get From Dictionary     ${body}  eTag
    log to console  \n eTag is :${eTag}
    ${headers_new}    Set To Dictionary	${temp_headers}	If-Match=${eTag}
    Set to Dictionary   ${body}    name=Scope_1
    ${resp}     Fusion Api Edit Scope   body=${body}    uri=${body['uri']}  headers=${headers_new}

    Run Keyword If  '${resp['status_code']}' == '400'    Log to console  \nExpected failure! \nStatus Code: ${resp['status_code']}
    ...             ELSE    FAIL    Log to console  \nUnexpected Behaviour! scope created.

    Run Keyword If  '${resp['errorCode']}' == 'INVALID_SCOPE_NAME_ERROR'   Log to console  \n Expected Failure! \n\nError: ${resp['errorCode']} \nDetails: ${resp['message']}\n
    ...             ELSE    FAIL



Edit with Invalid eTag
    [Documentation]     Negative Scenario
    ${scopes} =     Fusion Api Get Scope
    ${headers}  Get From Dictionary     ${scopes}  headers
    ${temp_headers}   Copy Dictionary   ${headers}

    ${body} =  Get Scope Member	${scopename}
    ${headers_new}    Set To Dictionary	${temp_headers}	If-Match=${etag}
    Set to Dictionary   ${body}     description=editing the scope
    ${resp}     fusion_api_edit_scope   body=${body}    uri=${body['uri']}  headers=${headers_new}


    Run Keyword If  '${resp['status_code']}' == '412'    Log to console  \nExpected failure! \nStatus Code: ${resp['status_code']}
    ...             ELSE    FAIL    Log to console  \nUnexpected Behaviour! scope edited.

    Run Keyword If  '${resp['errorCode']}' == 'ETAG_MISMATCH'   Log to console  \n Expected Failure! \n\nError: ${resp['errorCode']} \nDetails: ${resp['message']}\n
    ...             ELSE    FAIL


Edit without eTag
    [Documentation]     Negative Scenario
    ${scopes} =     Fusion Api Get Scope
    ${headers}  Get From Dictionary     ${scopes}  headers
    ${body} =  Get Scope Member     ${scopename}
    Set to Dictionary   ${body}     description=editing the scope
    ${resp}     Fusion Api Edit Scope   body=${body}    uri=${body['uri']}  headers=${headers}

    Run Keyword If  '${resp['status_code']}' == '400'    Log to console  \nExpected failure! \nStatus Code: ${resp['status_code']}
    ...             ELSE    FAIL    Log to console  \nUnexpected Behaviour! scope edited.
    Run Keyword If  '${resp['errorCode']}' == 'SERVLET_REQUEST_BINDING_ERROR'   Log to console  \n Expected Failure! \n\nError: ${resp['errorCode']} \nDetails: ${resp['details']}\n
    ...             ELSE    FAIL

Get Invalid Scope
    [Documentation]     NEGATIVE SCENARIO WITH INVALID SCOPE Uri
    ${resp}    Fusion Api Get Scope    uri=${scopeuri}

    Run Keyword If  '${resp['status_code']}' == '404'    Log to console  \nExpected failure! \nStatus Code: ${resp['status_code']}
    ...             ELSE    FAIL    Log to console  \nUnexpected Behaviour! scope created.
    Run Keyword If  '${resp['errorCode']}' == 'RESOURCE_NOT_FOUND'   Log to console  \n Expected Failure! \n\nError: ${resp['errorCode']} \nDetails: ${resp['details']}\n
    ...             ELSE    FAIL


Creating Users
	
	Remove All Users
    
	:FOR	${i}	IN	@{users}
	\	${resp}     Fusion Api Add User    ${i}
	${resp}		Fusion Api Logout Appliance
	
Logging in as Server admin and trying to create a scope

	${scope} =  Get Variable value  ${scopes[0]}
	${resp}     Fusion Api Login Appliance    ${APPLIANCE_IP}        ${serveradmin_credentials}
	${resp}     Fusion Api Create Scope  ${scope}
	
	Run Keyword If  '${resp['status_code']}' == '401'    Log to console  \n Expected Failure! \nStatus Code: ${resp['status_code']}
	...             ELSE    FAIL
	Run Keyword If  '${resp['errorCode']}' == 'AUTHORIZATION'    Log to console  \n Expected Failure! \n\nError: ${resp['errorCode']} \nDetails: ${resp['message']}\n
	...             ELSE    FAIL
	${resp}		Fusion Api Logout Appliance

Logging in as Network admin and trying to create a scope

	${scope} =  Get Variable value  ${scopes[0]}
	${resp}     Fusion Api Login Appliance    ${APPLIANCE_IP}        ${network_admin}
	${resp}     Fusion Api Create Scope  ${scope}
	
	Run Keyword If  '${resp['status_code']}' == '401'    Log to console  \n Expected Failure! \nStatus Code: ${resp['status_code']}
	...             ELSE    FAIL
	Run Keyword If  '${resp['errorCode']}' == 'AUTHORIZATION'    Log to console  \n Expected Failure! \n\nError: ${resp['errorCode']} \nDetails: ${resp['message']}\n
	...             ELSE    FAIL
	${resp}		Fusion Api Logout Appliance
	
Logging in as Backup admin and trying to create a scope

	${scope} =  Get Variable value  ${scopes[0]}
	${resp}     Fusion Api Login Appliance    ${APPLIANCE_IP}        ${backup_admin}
	${resp}     Fusion Api Create Scope  ${scope}
	
	Run Keyword If  '${resp['status_code']}' == '401'    Log to console  \n Expected Failure! \nStatus Code: ${resp['status_code']}
	...             ELSE    FAIL
	Run Keyword If  '${resp['errorCode']}' == 'AUTHORIZATION'    Log to console  \n Expected Failure! \n\nError: ${resp['errorCode']} \nDetails: ${resp['message']}\n
	...             ELSE    FAIL
	${resp}		Fusion Api Logout Appliance
	
Logging in as Read only user and trying to create a scope

	${scope} =  Get Variable value  ${scopes[0]}
	${resp}     Fusion Api Login Appliance    ${APPLIANCE_IP}        ${readonly_user}
	${resp}     Fusion Api Create Scope  ${scope}
	
	Run Keyword If  '${resp['status_code']}' == '401'    Log to console  \n Expected Failure! \nStatus Code: ${resp['status_code']}
	...             ELSE    FAIL
	Run Keyword If  '${resp['errorCode']}' == 'AUTHORIZATION'    Log to console  \n Expected Failure! \n\nError: ${resp['errorCode']} \nDetails: ${resp['message']}\n
	...             ELSE    FAIL
	${resp}		Fusion Api Logout Appliance
	
Removing All the Users

	Fusion Api Login Appliance    ${APPLIANCE_IP}        ${admin_credentials_TB}
    Remove All Users
	
*** Keywords ***

Get Scope Member
    [Documentation]     Negative Scenario
    [Arguments]     ${scopename}
    ${resp1}    Fusion Api Get Scope
    ${l} =     Get Length    ${resp1['members']}
    :FOR    ${x}    IN RANGE    0    ${l}
    \   ${scope} =  copy Dictionary        ${resp1['members'][${x}]}
    \   Run Keyword If     '${scope['name']}' == '${scopename}'     Exit For Loop
    [Return]	${scope}