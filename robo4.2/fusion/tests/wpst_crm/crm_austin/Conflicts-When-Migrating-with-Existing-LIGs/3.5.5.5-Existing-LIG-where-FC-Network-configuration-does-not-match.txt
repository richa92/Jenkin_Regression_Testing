*** Settings ***
Documentation     
...    Covers the following testcase:
...              :3.5.5.5 Existing LIG where FC Network configuration does not match
    
Library           RoboGalaxyLibrary
Library           FusionLibrary
Library           ../lib/WPSTUtil.py

Variables                       ../resources/defaults.py
Variables                       ../resources/credentials_wpst.py   Austin4
Force Tags                      Austin4
Resource                        ../resources/keywords.txt
Suite Setup                     Suite Setup Tasks
Test Setup                      Test Setup Tasks

*** Variables ***
${vc_config_file_1}     config/3.5.5.5-Existing-LIG-where-FC-Network-configuration-does-not-match_1.txt
${vc_config_file_2}     config/3.5.5.5-Existing-LIG-where-FC-Network-configuration-does-not-match_2.txt
${uniqueValidationKey}   message
@{bayNumbers}            3   4

*** Test Cases ***
Create-OV-LIG--Test Compatibility
    [Documentation]     Cleaning the OV and VC, later importing a common configuration file 
    ...                 that can be used for all the existing LIG cases.
    CleanOV.CleanVC
    Import.ConfigVC    ${vc_config_file_1}
    Report.Write.Compare

Create-OV-LIG--Migrate
   [Documentation]     Cleaning the OV and VC, later importing a common configuration file 
   ...                 that can be used for all the existing LIG cases.
   Migrate
   GetOVResources.Write.Compare

FCNetwork-config-mismatch-verification-OV300
    [Tags]   OV300
    [Documentation]     US30765 VC Migrate: Base Features, Existing LIG, Networks and Fabrics
    ...                 US33536 Validate and Translate fabrics where existing OneView FC Networks or limits may collide
    ...                 Verify if FC Network already exists, a critical issue raised for each of its attributes do not match:
    ...                 Type
    ...                 Uplink Ports (same as already defined in existing Uplink Set)
    ...                 Uplink Port Speed  (same as already defined in existing Uplink Set)
    ...                 Login Redistribution
    Remove All Server Profiles
    Remove All Enclosures
    Import.ConfigVC    ${vc_config_file_2}
    @{commands_on}     Create List    add fabric FC1 Type=FabricAttach Bay=3 Ports=1 Speed=2Gb LinkDist=Manual
    ...                               add fc-connection Profile1 Fabric=FC1 Speed=Auto
    @{commands_off}     Create List   remove fc-connection Profile1
    ...                               remove fabric FC1
    ...                               add fabric FC1 Type=FabricAttach Bay=3 Ports=1 Speed=Auto LinkDist=Manual
    ...                               add fc-connection Profile1 Fabric=FC1 Speed=Auto
    ${validation_fc1}   Create Dictionary   errorCode=FAIL_TO_MATCH_CONFIGURATION
    ...                                  level=Critical
    ...                                  message=The selected enclosure's Virtual Connect configuration does not match logical interconnect group \"LIG_2S1409P9XR_1\". The following element(s) are inconsistent: UplinkSet FC1 attribute(s) do not match: FC speed.
    Run CLI In Interconnect From List    ${commands_on}
    ${resp}  ${resp_state}     ReportDetail against Existing EG     EG_2S1409P9XR
    Validate Existing Detail Report with Existing EG If General Issues Exists       ${resp}    allMigrationIssues    ${uniqueValidationKey}   ${validation_fc1}
    Run CLI In Interconnect From List    ${commands_off}
    ${resp}  ${resp_state}     ReportDetail against Existing EG     EG_2S1409P9XR
    Validate Existing Detail Report If General Issues Removed       ${resp}    allMigrationIssues    ${validation_fc1}
 
    @{commands_on}     Create List    add fabric FC2 Type=FabricAttach Bay=4 Ports=1,2,3 Speed=Auto LinkDist=Manual
    ...                               add fc-connection Profile1 Fabric=FC2 Speed=Auto
    @{commands_off}     Create List   remove fc-connection Profile1
    ...                               remove fabric FC2
    ...                               add fabric FC2 Type=FabricAttach Bay=4 Ports=1 Speed=Auto LinkDist=Manual
    ...                               add fc-connection Profile1 Fabric=FC2 Speed=Auto
    ${validation_fc2}   Create Dictionary   errorCode=FAIL_TO_MATCH_CONFIGURATION
    ...                                  level=Critical
    ...                                  message=The selected enclosure's Virtual Connect configuration does not match logical interconnect group \"LIG_2S1409P9XR_1\". The following element(s) are inconsistent: UplinkSet FC2 attribute(s) do not match: Port not found Enclosure 1, Bay 4, Port 3,Port not found Enclosure 1, Bay 4, Port 2.
    Run CLI In Interconnect From List    ${commands_on}
    ${resp}  ${resp_state}     ReportDetail against Existing EG     EG_2S1409P9XR
    Validate Existing Detail Report with Existing EG If General Issues Exists       ${resp}    allMigrationIssues    ${uniqueValidationKey}   ${validation_fc2}
    Run CLI In Interconnect From List    ${commands_off}
    ${resp}  ${resp_state}     ReportDetail against Existing EG     EG_2S1409P9XR
    Validate Existing Detail Report If General Issues Removed       ${resp}    allMigrationIssues    ${validation_fc2}
    
    @{commands_on}     Create List    add fabric FCOE1 Type=FabricAttach Bay=1 Ports=4 Speed=4Gb LinkDist=Manual
    ...                               add fcoe-connection Profile1 Fabric=FCOE1 SpeedType=Preferred
    ...                               add fcoe-connection Profile1 Fabric=Unassigned SpeedType=Preferred
    @{commands_off}     Create List    remove fcoe-connection Profile1
    ...                                remove fcoe-connection Profile1
    ...                                remove fabric FCOE1
    ${validation_fcoe1}   Create Dictionary   errorCode=FAIL_TO_MATCH_CONFIGURATION
    ...                                  level=Critical
    ...                                  message=The selected enclosure's Virtual Connect configuration does not match logical interconnect group \"LIG_2S1409P9XR_1\". The following element(s) are inconsistent: UplinkSet FCOE1 attribute(s) do not match: Port different Enclosure 1, Bay 1, Port X3,Port not found Enclosure 1, Bay 1, Port X4.
    ${validation_unassigned_fcoe1}   Create Dictionary   errorCode=FEATURE_ISSUE_UNASSIGNED_PROFILE_FCOE_CONNECTIONS
    ...                                 level=High
    ...                                 key=unassigned_profile_fcoe_connections
    ...                                 message=FCoE connection 2 does not have an assigned FCoE network or SAN fabric. This connection will not be migrated because OneView does not allow server profile connections without an assigned FCoE network.
    ${validation_fcoe1_mac_wwn}   Create Dictionary   errorCode=FEATURE_ISSUE_FCOE_CONNECTION_SWAP_MAC_AND_WWN
    ...                                 level=High
    ...                                 message=The WWNs for FC connection 1 of profile \"Profile1\" will change to \"user-specified\" to maintain connectivity and retain the currently assigned WWNs.
    Run CLI In Interconnect From List    ${commands_on}
    ${resp}  ${resp_state}     ReportDetail against Existing EG     EG_2S1409P9XR
    Validate Existing Detail Report with Existing EG If General Issues Exists       ${resp}    allMigrationIssues   ${uniqueValidationKey}   ${validation_fcoe1}
    Validate Existing Detail Report with Existing EG If General Issues Exists       ${resp}    allMigrationIssues    ${uniqueValidationKey}   ${validation_unassigned_fcoe1}
    Validate Existing Detail Report with Existing EG If General Issues Exists       ${resp}    allMigrationIssues    ${uniqueValidationKey}   ${validation_fcoe1_mac_wwn}
    Run CLI In Interconnect From List    ${commands_off}
    ${resp}  ${resp_state}     ReportDetail against Existing EG     EG_2S1409P9XR
    Validate Existing Detail Report If General Issues Removed       ${resp}    allMigrationIssues    ${validation_fcoe1}
    Validate Existing Detail Report If General Issues Removed       ${resp}    allMigrationIssues    ${validation_unassigned_fcoe1}
    Validate Existing Detail Report If General Issues Removed       ${resp}    allMigrationIssues    ${validation_fcoe1_mac_wwn}

FCNetwork-config-mismatch-verification-OnlyOV200
    [Tags]   OnlyOV200
    [Documentation]     US30765 VC Migrate: Base Features, Existing LIG, Networks and Fabrics
    ...                 US33536 Validate and Translate fabrics where existing OneView FC Networks or limits may collide
    ...                 Verify if FC Network already exists, a critical issue raised for each of its attributes do not match:
    ...                 Type
    ...                 Uplink Ports (same as already defined in existing Uplink Set)
    ...                 Uplink Port Speed  (same as already defined in existing Uplink Set)
    ...                 Login Redistribution
    Remove All Server Profiles
    Remove All Enclosures
    Import.ConfigVC    ${vc_config_file_2}
    @{commands_on}     Create List    add fabric FC1 Type=FabricAttach Bay=3 Ports=1 Speed=2Gb LinkDist=Manual
    ...                               add fc-connection Profile1 Fabric=FC1 Speed=Auto
    @{commands_off}     Create List   remove fc-connection Profile1
    ...                               remove fabric FC1
    ...                               add fabric FC1 Type=FabricAttach Bay=3 Ports=1 Speed=Auto LinkDist=Manual
    ...                               add fc-connection Profile1 Fabric=FC1 Speed=Auto
    ${validation_fc1}   Create Dictionary   errorCode=FAIL_TO_MATCH_CONFIGURATION
    ...                                  level=Critical
    ...                                  message=The selected enclosure's Virtual Connect configuration does not match the selected OneView logical interconnect group \"LIG_2S1409P9XR\". The following element(s) are inconsistent: UplinkSet FC1 attribute(s) do not match: FC speed.
    Run CLI In Interconnect From List    ${commands_on}
    ${resp}  ${resp_state}     ReportDetail against Existing EG     EG_2S1409P9XR
    Validate Existing Detail Report with Existing EG If General Issues Exists       ${resp}    allMigrationIssues    ${uniqueValidationKey}   ${validation_fc1}
    Run CLI In Interconnect From List    ${commands_off}
    ${resp}  ${resp_state}     ReportDetail against Existing EG     EG_2S1409P9XR
    Validate Existing Detail Report If General Issues Removed       ${resp}    allMigrationIssues    ${validation_fc1}
 
    @{commands_on}     Create List    add fabric FC2 Type=FabricAttach Bay=4 Ports=1,2,3 Speed=Auto LinkDist=Manual
    ...                               add fc-connection Profile1 Fabric=FC2 Speed=Auto
    @{commands_off}     Create List   remove fc-connection Profile1
    ...                               remove fabric FC2
    ...                               add fabric FC2 Type=FabricAttach Bay=4 Ports=1 Speed=Auto LinkDist=Manual
    ...                               add fc-connection Profile1 Fabric=FC2 Speed=Auto
    ${validation_fc2}   Create Dictionary   errorCode=FAIL_TO_MATCH_CONFIGURATION
    ...                                  level=Critical
    ...                                  message=The selected enclosure's Virtual Connect configuration does not match the selected OneView logical interconnect group \"LIG_2S1409P9XR\". The following element(s) are inconsistent: UplinkSet FC2 attribute(s) do not match: Port not found Enclosure 1, Bay 4, Port 3,Port not found Enclosure 1, Bay 4, Port 2.
    Run CLI In Interconnect From List    ${commands_on}
    ${resp}  ${resp_state}     ReportDetail against Existing EG     EG_2S1409P9XR
    Validate Existing Detail Report with Existing EG If General Issues Exists       ${resp}    allMigrationIssues    ${uniqueValidationKey}   ${validation_fc2}
    Run CLI In Interconnect From List    ${commands_off}
    ${resp}  ${resp_state}     ReportDetail against Existing EG     EG_2S1409P9XR
    Validate Existing Detail Report If General Issues Removed       ${resp}    allMigrationIssues    ${validation_fc2}
    
    @{commands_on}     Create List    add fabric FCOE1 Type=FabricAttach Bay=1 Ports=4 Speed=4Gb LinkDist=Manual
    ...                               add fcoe-connection Profile1 Fabric=FCOE1 SpeedType=Preferred
    ...                               add fcoe-connection Profile1 Fabric=Unassigned SpeedType=Preferred
    @{commands_off}     Create List    remove fcoe-connection Profile1
    ...                                remove fcoe-connection Profile1
    ...                                remove fabric FCOE1
    ${validation_fcoe1}   Create Dictionary   errorCode=FAIL_TO_MATCH_CONFIGURATION
    ...                                  level=Critical
    ...                                  message=The selected enclosure's Virtual Connect configuration does not match the selected OneView logical interconnect group \"LIG_2S1409P9XR\". The following element(s) are inconsistent: UplinkSet FCOE1 attribute(s) do not match: Port different Enclosure 1, Bay 1, Port X3,Port not found Enclosure 1, Bay 1, Port X4.
    ${validation_unassigned_fcoe1}   Create Dictionary   errorCode=FEATURE_ISSUE_UNASSIGNED_PROFILE_FCOE_CONNECTIONS
    ...                                 level=High
    ...                                 key=unassigned_profile_fcoe_connections
    ...                                 message=Profile \"Profile1\" FCoE connection 2 does not have an associated fabric. This connection will not be migrated because OneView does not allow server profile connections without an assigned network.
    ${validation_fcoe1_mac_wwn}   Create Dictionary   errorCode=FEATURE_ISSUE_FCOE_CONNECTION_FACTORY_MAC_AND_WWN
    ...                                 level=High
    ...                                 message=Profile \"Profile1\" FCoE connection 1 is configured for factory MAC and a factory WWN of 10:00:40:A8:F0:2B:03:A1. The WWN for this connection may change after migration to OneView.
    Run CLI In Interconnect From List    ${commands_on}
    ${resp}  ${resp_state}     ReportDetail against Existing EG     EG_2S1409P9XR
    Validate Existing Detail Report with Existing EG If General Issues Exists       ${resp}    allMigrationIssues   ${uniqueValidationKey}   ${validation_fcoe1}
    Validate Existing Detail Report with Existing EG If General Issues Exists       ${resp}    allMigrationIssues    ${uniqueValidationKey}   ${validation_unassigned_fcoe1}
    Validate Existing Detail Report with Existing EG If General Issues Exists       ${resp}    allMigrationIssues    ${uniqueValidationKey}   ${validation_fcoe1_mac_wwn}
    Run CLI In Interconnect From List    ${commands_off}
    ${resp}  ${resp_state}     ReportDetail against Existing EG     EG_2S1409P9XR
    Validate Existing Detail Report If General Issues Removed       ${resp}    allMigrationIssues    ${validation_fcoe1}
    Validate Existing Detail Report If General Issues Removed       ${resp}    allMigrationIssues    ${validation_unassigned_fcoe1}
    Validate Existing Detail Report If General Issues Removed       ${resp}    allMigrationIssues    ${validation_fcoe1_mac_wwn}

FCNetwork-config-mismatch-verification-OnlyOV120
    [Tags]   OnlyOV120
    [Documentation]     US30765 VC Migrate: Base Features, Existing LIG, Networks and Fabrics
    ...                 US33536 Validate and Translate fabrics where existing OneView FC Networks or limits may collide
    ...                 Verify if FC Network already exists, a critical issue raised for each of its attributes do not match:
    ...                 Type
    ...                 Uplink Ports (same as already defined in existing Uplink Set)
    ...                 Uplink Port Speed  (same as already defined in existing Uplink Set)
    ...                 Login Redistribution
    Remove All Server Profiles
    Remove All Enclosures
    Import VC
    # Detect, reset and sleep to workaround QXCR1001467844: Utah module in No Comm state after import enclosure
    Check Interconnect In No Comm And Recover If Needed   ${bayNumbers}
    ConfigVC    ${vc_config_file_2}
    @{commands_on}     Create List    add fabric FC1 Type=FabricAttach Bay=3 Ports=1 Speed=2Gb LinkDist=Manual
    ...                               add fc-connection Profile1 Fabric=FC1 Speed=Auto
    ...                               add fabric FC2 Type=FabricAttach Bay=4 Ports=1,2,3 Speed=Auto LinkDist=Manual
    ...                               add fc-connection Profile1 Fabric=FC2 Speed=Auto
    ...                               add fabric FCOE1 Type=FabricAttach Bay=1 Ports=4 Speed=4Gb LinkDist=Manual
    ...                               add fcoe-connection Profile1 Fabric=FCOE1 SpeedType=Preferred
    ...                               add fcoe-connection Profile1 Fabric=Unassigned SpeedType=Preferred
    @{commands_off}     Create List   remove fc-connection Profile1
    ...                               remove fabric FC1
    ...                               add fabric FC1 Type=FabricAttach Bay=3 Ports=1 Speed=Auto LinkDist=Manual
    ...                               add fc-connection Profile1 Fabric=FC1 Speed=Auto
    ...                               remove fc-connection Profile1
    ...                               remove fabric FC2
    ...                               add fabric FC2 Type=FabricAttach Bay=4 Ports=1 Speed=Auto LinkDist=Manual
    ...                               add fc-connection Profile1 Fabric=FC2 Speed=Auto
    ...                               remove fcoe-connection Profile1
    ...                               remove fcoe-connection Profile1
    ...                               remove fabric FCOE1
# NOTE: Failure to detect FC speed mismatch and incorrect blocker generated in test compatibility(QXCR1001467233)
#    ${validation_fc1}   Create Dictionary   errorCode=FAIL_TO_MATCH_CONFIGURATION
#    ...                                  level=Critical
#    ...                                  message=The selected enclosure\u0019s Virtual Connect configuration does not match the selected OneView logical interconnect group LIG_2S1409P9XR. The following element(s) are inconsistent: UplinkSet FC1 attribute(s) do not match: FC speed.
    # Detect, reset and sleep to workaround QXCR1001467844: Utah module in No Comm state after import enclosure
    Check Interconnect In No Comm And Recover If Needed   ${bayNumbers}
    Run CLI In Interconnect From List    ${commands_on}
    ${resp}  ${resp_state}     ReportDetail against Existing EG     EG_2S1409P9XR
# NOTE: Failure to detect FC speed mismatch and incorrect blocker generated in test compatibility(QXCR1001467233)
#    Validate Existing Detail Report with Existing EG If General Issues Exists       ${resp}    oneViewResourceCompatibility/logicalInterconnectGroup/issues   ${uniqueValidationKey}   ${validation_fc1}
    ${validation_fc2}   Create Dictionary   errorCode=FAIL_TO_MATCH_CONFIGURATION
    ...                                  level=Critical
    ...                                  message=The selected enclosure\u0019s Virtual Connect configuration does not match the selected OneView logical interconnect group LIG_2S1409P9XR. The following element(s) are inconsistent: UplinkSet FC2 attribute(s) do not match: Port not found Enclosure 1, Bay 4, Port 3,Port not found Enclosure 1, Bay 4, Port 2.
    Validate Existing Detail Report with Existing EG If General Issues Exists       ${resp}    oneViewResourceCompatibility/logicalInterconnectGroup/issues    ${uniqueValidationKey}   ${validation_fc2}
    ${validation_fcoe1}   Create Dictionary   errorCode=FAIL_TO_MATCH_CONFIGURATION
    ...                                  level=Critical
    ...                                  message=The selected enclosure\u0019s Virtual Connect configuration does not match the selected OneView logical interconnect group LIG_2S1409P9XR. The following element(s) are inconsistent: UplinkSet FCOE1 attribute(s) do not match: Port different Enclosure 1, Bay 1, Port X3,Port not found Enclosure 1, Bay 1, Port X4.
    ${validation_unassigned_fcoe1}   Create Dictionary   errorCode=FEATURE_ISSUE_UNASSIGNED_PROFILE_CONNECTIONS
    ...                                 level=High
    ...                                 key=unassigned_profile_connections
# NOTE: Not comparing the message due to more than 1 space present in the string that RG will flag as an issue.
#    ...                                 message=Profile Profile1 FCoE connection 2 does not have an associated network.  This connection will not be migrated because OneView does not allow server profile connections without an assigned network.
    ${Profile1-filter}       Create Dictionary       name=Profile1
# TODO: Add support for multiple error validation in a single filter
#    ${validation_fcoe1_mac_wwn}   Create Dictionary   errorCode=FEATURE_ISSUE_FCOE_CONNECTION_FACTORY_MAC_AND_WWN
#    ...                                 level=High
#    ...                                 message=Profile Profile1 FCoE connection 1 is configured for factory MAC and a factory WWN of 10:00:40:A8:F0:2B:03:A1. The WWN for this connection may change after migration to OneView.
    Validate Existing Detail Report with Existing EG If General Issues Exists       ${resp}    oneViewResourceCompatibility/logicalInterconnectGroup/issues    ${uniqueValidationKey}   ${validation_fcoe1}
    Validate Existing Detail Report If Issues Exists with Filter   ${resp}   oneViewResourceCompatibility/profiles/serverProfiles   ${validation_unassigned_fcoe1}   ${Profile1-filter}
# TODO: Add support for multiple error validation in a single filter
#    Validate Existing Detail Report If Issues Exists with Filter   ${resp}   oneViewResourceCompatibility/profiles/serverProfiles   ${validation_fcoe1_mac_wwn}   ${Profile1-filter}
# TODO: Fix issue with config and make this commands_off happy to proceed
# removed issue validations
#    Run CLI In Interconnect From List    ${commands_off}
#    ${resp}  ${resp_state}     ReportDetail against Existing EG     EG_2S1409P9XR
#    Validate Existing Detail Report If General Issues Removed       ${resp}    oneViewResourceCompatibility/logicalInterconnectGroup/issues    ${validation_fc1}
#    Validate Existing Detail Report If General Issues Removed       ${resp}    oneViewResourceCompatibility/logicalInterconnectGroup/issues    ${validation_fc2}
#    Validate Existing Detail Report If General Issues Removed       ${resp}    oneViewResourceCompatibility/logicalInterconnectGroup/issues    ${validation_fcoe1}
#    Validate Existing Detail Report If Issues Removed with Filter   ${resp}    oneViewResourceCompatibility/profiles/serverProfiles   ${validation_unassigned_fcoe1}   ${Profile1-filter}
#    Validate Existing Detail Report If Issues Removed with Filter   ${resp}    oneViewResourceCompatibility/profiles/serverProfiles   ${validation_fcoe1_mac_wwn}   ${Profile1-filter}

