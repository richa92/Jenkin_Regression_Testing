*** Settings ***
Documentation   Test the CLI in 2 parallel sessions with the CLI Stress Model
...             = Usage =
...             | pybot | -L DEBUG | cli_stress_model.txt
...             = Variables =
...             | ENCLOSURE     | Required; Enclosure name to run on (dcs, tesla, etc) |
...             = Preconditions =
...             - Claimed EM is requierd.
...             - Populated ICM bays are required.

Variables       ../resources/variables.py	${ENCLOSURE}

Library         RoboGalaxyLibrary		# DVTs Robot Framework extensions
Library         FusionLibrary               	# DVTs Robot Framework extensions
Resource        ../resources/defaults.txt   	# AM-DVT default variables
Resource        ../resources/fusion_cli.txt     # AM-DVT fusion CLI library
Resource        ../resources/system_info.txt    # AM-DVT fusion CLI library

Force Tags      HW

#Suite Setup     Run Keywords
#Suite Teardown  Run Keywords


*** Variables ***
${LOGINOUTDELAY}	10

*** Test Cases ***

Run CLI Model
    # ${SessionA}=        Login to Fusion CLI	TIMEOUT=15
    # ${SessionN}=        Login to Fusion CLI	TIMEOUT=15
    # Set Suite Variable  ${SessionA}
    # Set Suite Variable  ${SessionB}
    # Set Suite Variable  ${PROMPT_A}	${CLI_MAIN_PROMPT}
    # Set Suite Variable  ${PROMPT_B}	${CLI_MAIN_PROMPT}
    Run Random Model    model=cli_stress_model.xml   transitions=100


*** Keywords ***
#-----------------------------------------------------------------------
# MODEL BASED STATE KEYWORDS
#-----------------------------------------------------------------------

A Not Started
    Log		In A_Not_Started	console=yes

A Started
    Log		In A_Started		console=yes
    
A Main View
    Switch Connection		${SessionA}
    Execute CLI Command		${SPACE}	${PROMPT_A}
    Log		In A_Main_View		console=yes

A Console View
    Switch Connection		${SessionA}
    Execute CLI Command		${SPACE}	${PROMPT_A}
    Log		In A_Console_View	console=yes

A Connection
    Log		In A_Connection		console=yes

B Not Started
    Log		In B_Not_Started	console=yes

B Started
    Log		In B_Started		console=yes

B Main View
    Switch Connection		${SessionB}
    Execute CLI Command		${SPACE}	${PROMPT_B}
    Log		In B_Main_View		console=yes

B Console View
    Switch Connection		${SessionB}
    Execute CLI Command		${SPACE}	${PROMPT_B}
    Log		In B_Console_View	console=yes

B Connection
    Log		In B_Connection		console=yes

#-----------------------------------------------------------------------
# MODEL BASED TRANSITION KEYWORDS
#-----------------------------------------------------------------------

Start A
    Log		=> Starting Session A...	console=yes
    ${SessionA}=        Login to Fusion CLI	TIMEOUT=15
    Set Suite Variable	        ${SessionA}
    Set Suite Variable		${PROMPT_A}	${CLI_MAIN_PROMPT}

Main Command A
    ${CMD}=	Set Variable	help
    Log		=> Run Main A ${CMD}...		console=yes
    Switch Connection		${SessionA}
    Execute CLI Command		help		${PROMPT_A}

Console View A
    Log		=> Enter Console View A...	console=yes
    Switch Connection		${SessionA}
    Enter CLI Console View
    Set Suite Variable		${PROMPT_A}	${CLI_PROMPT}

View Command A
    ${CMD}=	Create Random ConsoleView Command
    Log		=> Run View A ${CMD}...		console=yes
    Switch Connection		${SessionA}
    Execute CLI Command		${CMD}		${PROMPT_A}

Kill B
    Log		=> Killing Connection B...	console=yes
    Log To Console	WORKAROUND: no kill because of QXCR1001420953.

Connect ICM A
#    Switch Connection		${SessionA}
#    Connect Interconnect Command	${ENC_SERIAL_NUMBER}	1
    Log		=> Connect to ICM A...		console=yes
    Log To Console	WORKAROUND: no connection because of QXCR1001420953

Connect A Force
#    Switch Connection		${SessionA}
#    Connect Interconnect Command	${ENC_SERIAL_NUMBER}	1
    Log		=> Force connect to ICM A...	console=yes
    Log To Console	WORKAROUND: no connection because of QXCR1001420953

Quit Connection A
#    Switch Connection		${SessionA}
#    Disconnect Interconnect Command
    Log		=> Quit Connection A...		console=yes
    Log To Console	WORKAROUND: no disconnection because of QXCR1001420953

Quit Console View A
    Log		=> Quit Console View A...	console=yes
    Switch Connection		${SessionA}
    Quit CLI View
    Set Suite Variable		${PROMPT_A}	${CLI_PROMPT}

Exit A
    Log		=> Exiting Session A...	console=yes
    Switch Connection		${SessionA}
    Logout of Fusion CLI
    Sleep      ${LOGINOUTDELAY}

Start B
    Log		=> Starting Session B...	console=yes
    ${SessionB}=        Login to Fusion CLI	TIMEOUT=15
    Set Suite Variable	        ${SessionB}
    Set Suite Variable		${PROMPT_B}	${CLI_MAIN_PROMPT}

Main Command B
    ${CMD}=	Set Variable	help
    Log		=> Run Main B ${CMD}...		console=yes
    Switch Connection		${SessionB}
    Execute CLI Command		help		${PROMPT_B}

Console View B
    Log		=> Enter Console View B...	console=yes
    Switch Connection		${SessionB}
    Enter CLI Console View
    Set Suite Variable		${PROMPT_B}	${CLI_PROMPT}

View Command B
    ${CMD}=	Create Random ConsoleView Command
    Log		=> Run View B ${CMD}...		console=yes
    Switch Connection		${SessionB}
    Execute CLI Command		${CMD}		${PROMPT_B}

Kill A
    Log		=> Killing Connection A...	console=yes
    Log To Console	WORKAROUND: no kill because of QXCR1001420953

Connect ICM B
#    Switch Connection		${SessionB}
#    Connect Interconnect Command	${ENC_SERIAL_NUMBER}	1
    Log		=> Connect to ICM B...		console=yes
    Log To Console	WORKAROUND: no connection because of QXCR1001420953

Connect B Force
#    Switch Connection		${SessionB}
#    Connect Interconnect Command	${ENC_SERIAL_NUMBER}	1
    Log		=> Force connect to ICM B...	console=yes
    Log To Console	WORKAROUND: no connection because of QXCR1001420953

Quit Connection B
#    Switch Connection		${SessionB}
#    Disconnect Interconnect Command
    Log		=> Quit Connection B...		console=yes
    Log To Console	WORKAROUND: no disconnection because of QXCR1001420953

Quit Console View B
    Log		=> Quit Console View B...	console=yes
    Switch Connection		${SessionB}
    Quit CLI View
    Set Suite Variable		${PROMPT_B}	${CLI_PROMPT}

Exit B
    Log		=> Exiting Session B...		console=yes
    Switch Connection		${SessionB}
    Logout of Fusion CLI
    Sleep      ${LOGINOUTDELAY}

#==============================

Create Random ConsoleView Command
    ${VCMDS}=     Create List   show   help
    ${VCMD}=      Select Random Element from List   ${VCMDS}
    ${Args}=      Run Keyword If      "${VCMD}"=="show"
    ...  Create Random Show Args
    ...	 ELSE
    ...	 Set Variable	${SPACE}
    [return]	${VCMD} ${ARGS}    
    

Create Random Show Args
    ${ARGS}=    Create List	 enclosure sessions     interconnect sessions    interconnect list
    ${ARGS}=	Select Random Element from List    ${ARGS}
    [return]    ${ARGS}
