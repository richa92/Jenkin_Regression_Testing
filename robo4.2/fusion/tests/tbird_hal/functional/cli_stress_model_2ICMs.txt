*** Settings ***
Documentation   Test the CLI in 2 parallel sessions with the CLI Stress Model
...             = Usage =
...             | pybot | -L DEBUG | cli_stress_model.txt
...             = Variables =
...             | ENCLOSURE     | Required; Enclosure name to run on (dcs, tesla, etc) |
...             = Preconditions =
...             - Claimed EM is requierd.
...             - Populated ICM bays are required.

Variables       ../resources/variables.py	${ENCLOSURE}

Library         RoboGalaxyLibrary		# DVTs Robot Framework extensions
Library         FusionLibrary               	# DVTs Robot Framework extensions
Resource        ../resources/defaults.txt   	# AM-DVT default variables
Resource        ../resources/fusion_cli.txt     # AM-DVT fusion CLI library
Resource        ../resources/system_info.txt    # AM-DVT fusion CLI library

Force Tags      HW
#Suite Setup


*** Variables ***
${LOGINOUTDELAY}	10
${PROMPT_A_1}		0
${PROMPT_A_2}		0
${PROMPT_B_1}		0
${PROMPT_B_2}		0


*** Test Cases ***
Find ICM Bays
    Login to Fusion CLI	 TIMEOUT=15
    Enter CLI Console View
    ${List}= 	         Execute CLI Command		show interconnect list
    ${ICMs}=             Parse Device List Output     ${List}
    Log 		 ${ICMs[0]}

    ${NoICMs}=	 Get Length      ${ICMS}
    Run Keyword If   ${NoICMs} < 2
    ...	  Fatal Error     msg=This test requires at least 2 ICMS.

    Set Suite Variable  ${ICMs}
    Log 	 ICM 1 is in Enclosure ${ICMs[0]['Enc']}, Bay ${ICMs[0]['Bay']}
    Log 	 ICM 2 is in Enclosure ${ICMs[1]['Enc']}, Bay ${ICMs[1]['Bay']}

Run CLI Model
    Run Random Model    model=cli_stress_model_2ICMs.xml   transitions=100


*** Keywords ***
#-----------------------------------------------------------------------
# MODEL BASED STATE KEYWORDS
#-----------------------------------------------------------------------

A 1 Not Started
    Log		In A_1_Not_Started	console=yes

A 1 Started
    Log		In A_1_Started		console=yes
    
A 1 Main View
    Switch Connection		${SessionA1}
    Execute CLI Command		${SPACE}	${PROMPT_A_1}
    Log		In A_1_Main_View		console=yes

A 1 Console View
    Switch Connection		${SessionA1}
    Execute CLI Command		${SPACE}	${PROMPT_A_1}
    Log		In A_1_Console_View	console=yes

A 1 Connection
    Switch Connection		${SessionA1}
    Execute CLI Command		${SPACE}	${PROMPT_A_1}
    Log		In A_1_Connection		console=yes

A 2 Not Started
    Log		In A_2_Not_Started	console=yes

A 2 Started
    Log		In A_2_Started		console=yes
    
A 2 Main View
    Switch Connection		${SessionA2}
    Execute CLI Command		${SPACE}	${PROMPT_A_2}
    Log		In A_2_Main_View		console=yes

A 2 Console View
    Switch Connection		${SessionA2}
    Execute CLI Command		${SPACE}	${PROMPT_A_2}
    Log		In A_2_Console_View		console=yes

A 2 Connection
    Switch Connection		${SessionA2}
    Execute CLI Command		${SPACE}	${PROMPT_A_2}
    Log		In A_2_Connection		console=yes

B 1 Not Started
    Log		In B_1_Not_Started	console=yes

B 1 Started
    Log		In B_1_Started		console=yes

B 1 Main View
    Switch Connection		${SessionB1}
    Execute CLI Command		${SPACE}	${PROMPT_B_1}
    Log		In B_1_Main_View		console=yes

B 1 Console View
    Switch Connection		${SessionB1}
    Execute CLI Command		${SPACE}	${PROMPT_B_1}
    Log		In B_1_Console_View		console=yes

B 1 Connection
    Switch Connection		${SessionB1}
    Execute CLI Command		${SPACE}	${PROMPT_B_1}
    Log		In B_1_Connection		console=yes

B 2 Not Started
    Log		In B_2_Not_Started	console=yes

B 2 Started
    Log		In B_2_Started		console=yes

B 2 Main View
    Switch Connection		${SessionB2}
    Execute CLI Command		${SPACE}	${PROMPT_B_2}
    Log		In B_2_Main_View		console=yes

B 2 Console View
    Switch Connection		${SessionB2}
    Execute CLI Command		${SPACE}	${PROMPT_B_2}
    Log		In B_2_Console_View		console=yes

B 2 Connection
    Switch Connection		${SessionB2}
    Execute CLI Command		${SPACE}	${PROMPT_B_2}
    Log		In B_2_Connection		console=yes

#-----------------------------------------------------------------------
# MODEL BASED TRANSITION KEYWORDS
#-----------------------------------------------------------------------

Start A 1
    Log		=> Starting Session A 1...	console=yes
    ${SessionA1}=        Login to Fusion CLI	TIMEOUT=15
    Set Suite Variable	        ${SessionA1}
    Set Suite Variable		${PROMPT_A_1}	${CLI_MAIN_PROMPT}

Main Command A 1
    ${CMD}=	Set Variable	help
    Log		=> Run Main A 1 ${CMD}...	console=yes
    Switch Connection		${SessionA1}
    Execute CLI Command		help		${PROMPT_A_1}

Console View A 1
    Log		=> Enter Console View A 1...	console=yes
    Switch Connection		${SessionA1}
    Enter CLI Console View
    Set Suite Variable		${PROMPT_A_1}	${CLI_CONSOLE_PROMPT}

View Command A 1
    ${CMD}=	Create Random ConsoleView Command
    Log		=> Run View A 1 ${CMD}...	console=yes
    Switch Connection		${SessionA1}
    Execute CLI Command		${CMD}		${PROMPT_A_1}

Kill B 1
    Log		=> Killing Connection B 1...	console=yes
    Switch Connection		${SessionA1}
    Execute CLI Command		kill interconnect ${ICMs[0]['Enc']} ${ICMs[0]['Bay']} 1		${PROMPT_A_1}
    Set Suite Variable		${PROMPT_B_1}	${CLI_CONSOLE_PROMPT}

Connect ICM A 1
    Switch Connection		${SessionA1}
    Connect Interconnect Command		${ICMs[0]['Enc']}	${ICMs[0]['Bay']}
    Log		=> Connect to ICM A 1...	console=yes
    Set Suite Variable		${PROMPT_A_1}	(<HP>)|(<OneView>)

Connect A 1 Force
    Switch Connection		${SessionA1}
    Connect Interconnect Command		${ICMs[0]['Enc']}	${ICMs[0]['Bay']}     force
    Log		=> Force connect to ICM A 1...	console=yes
    Run Keyword If	 	'<HP>' in '${PROMPT_B_1}'
    ...   Set Suite Variable 	${PROMPT_B_1}	${CLI_CONSOLE_PROMPT}
    Set Suite Variable		${PROMPT_A_1}	(<HP>)|(<OneView>)

Quit Connection A 1
    Switch Connection		${SessionA1}
    Disconnect Interconnect Command
    Log		=> Quit Connection A 1...	console=yes
    Set Suite Variable		${PROMPT_A_1}	${CLI_CONSOLE_PROMPT}

Quit Console View A 1
    Switch Connection		${SessionA1}
    Quit CLI View
    Log		=> Quit Console View A 1...	console=yes
    Set Suite Variable		${PROMPT_A_1}	${CLI_MAIN_PROMPT}

Exit A 1
    Log		=> Exiting Session A 1...	console=yes
    Switch Connection		${SessionA1}
    Logout of Fusion CLI
    Sleep      ${LOGINOUTDELAY}

Start A 2
    Log		=> Starting Session A 2...	console=yes
    ${SessionA2}=        Login to Fusion CLI	TIMEOUT=15
    Set Suite Variable	        ${SessionA2}
    Set Suite Variable		${PROMPT_A_2}	${CLI_MAIN_PROMPT}

Main Command A 2
    ${CMD}=	Set Variable	help
    Log		=> Run Main A 2 ${CMD}...	console=yes
    Switch Connection		${SessionA2}
    Execute CLI Command		help		${PROMPT_A_2}

Console View A 2
    Log		=> Enter Console View A 2...	console=yes
    Switch Connection		${SessionA2}
    Enter CLI Console View
    Set Suite Variable		${PROMPT_A_2}	${CLI_CONSOLE_PROMPT}

View Command A 2
    ${CMD}=	Create Random ConsoleView Command
    Log		=> Run View A 2 ${CMD}...	console=yes
    Switch Connection		${SessionA2}
    Execute CLI Command		${CMD}		${PROMPT_A_2}

Kill B 2
    Log		=> Killing Connection B 2...	console=yes
    Switch Connection		${SessionA2}
    Execute CLI Command		kill interconnect ${ICMs[1]['Enc']} ${ICMs[1]['Bay']} 1		${PROMPT_A_2}
    Set Suite Variable		${PROMPT_B_2}	${CLI_CONSOLE_PROMPT}

Connect ICM A 2
    Switch Connection		${SessionA2}
    Connect Interconnect Command		${ICMs[1]['Enc']}	${ICMs[1]['Bay']}
    Log		=> Connect to ICM A 2...		console=yes
    Set Suite Variable		${PROMPT_A_2}	(<HP>)|(<OneView>)

Connect A 2 Force
    Switch Connection		${SessionA2}
    Connect Interconnect Command		${ICMs[1]['Enc']}	${ICMs[1]['Bay']}     force
    Log		=> Force connect to ICM A 2...	console=yes
    Run Keyword If	 	'<HP>' in '${PROMPT_B_2}'
    ...   Set Suite Variable 	${PROMPT_B_2}	${CLI_CONSOLE_PROMPT}
    Set Suite Variable		${PROMPT_A_2}	(<HP>)|(<OneView>)

Quit Connection A 2
    Switch Connection		${SessionA2}
    Disconnect Interconnect Command
    Log		=> Quit Connection A 2...	console=yes
    Set Suite Variable		${PROMPT_A_2}	${CLI_CONSOLE_PROMPT}

Quit Console View A 2
    Switch Connection		${SessionA2}
    Quit CLI View
    Log		=> Quit Console View A 2...	console=yes
    Set Suite Variable		${PROMPT_A_2}	${CLI_MAIN_PROMPT}

Exit A 2
    Log		=> Exiting Session A 2...	console=yes
    Switch Connection		${SessionA2}
    Logout of Fusion CLI
    Sleep      ${LOGINOUTDELAY}

Start B 1
    Log		=> Starting Session B 1...	console=yes
    ${SessionB1}=        Login to Fusion CLI	TIMEOUT=15
    Set Suite Variable	        ${SessionB1}
    Set Suite Variable		${PROMPT_B_1}	${CLI_MAIN_PROMPT}

Main Command B 1
    ${CMD}=	Set Variable	help
    Log		=> Run Main B 1 ${CMD}...	console=yes
    Switch Connection		${SessionB1}
    Execute CLI Command		help		${PROMPT_B_1}

Console View B 1
    Log		=> Enter Console View B 1...	console=yes
    Switch Connection		${SessionB1}
    Enter CLI Console View
    Set Suite Variable		${PROMPT_B_1}	${CLI_CONSOLE_PROMPT}

View Command B 1
    ${CMD}=	Create Random ConsoleView Command
    Log		=> Run View B 1 ${CMD}...		console=yes
    Switch Connection		${SessionB1}
    Execute CLI Command		${CMD}		${PROMPT_B_1}

Kill A 1
    Log		=> Killing Connection A 1...	console=yes
    Switch Connection		${SessionB1}
    Execute CLI Command		kill interconnect ${ICMs[0]['Enc']} ${ICMs[0]['Bay']} 1		${PROMPT_B_1}
    Set Suite Variable		${PROMPT_A_1}	${CLI_CONSOLE_PROMPT}

Connect ICM B 1
    Switch Connection		${SessionB1}
    Connect Interconnect Command		${ICMs[0]['Enc']}	${ICMs[0]['Bay']}
    Log		=> Connect to ICM B 1...		console=yes
    Set Suite Variable		${PROMPT_B_1}	(<HP>)|(<OneView>)

Connect B 1 Force
    Switch Connection		${SessionB1}
    Connect Interconnect Command		${ICMs[0]['Enc']}	${ICMs[0]['Bay']}	force
    Log		=> Force connect to ICM B 1...	console=yes
    Run Keyword If 	 	'<HP>' in '${PROMPT_A_1}'
    ...   Set Suite Variable	${PROMPT_A_1}	${CLI_CONSOLE_PROMPT}
    Set Suite Variable		${PROMPT_B_1}	(<HP>)|(<OneView>)

Quit Connection B 1
    Switch Connection		${SessionB1}
    Disconnect Interconnect Command
    Log		=> Quit Connection B 1...	console=yes
    Set Suite Variable		${PROMPT_B_1}	${CLI_CONSOLE_PROMPT}

Quit Console View B 1
    Switch Connection		${SessionB1}
    Quit CLI View
    Log		=> Quit Console View B 1...	console=yes
    Set Suite Variable		${PROMPT_B_1}	${CLI_MAIN_PROMPT}

Exit B 1
    Log		=> Exiting Session B 1...	console=yes
    Switch Connection		${SessionB1}
    Logout of Fusion CLI
    Sleep      ${LOGINOUTDELAY}

Start B 2
    Log		=> Starting Session B 2...	console=yes
    ${SessionB2}=        Login to Fusion CLI	TIMEOUT=15
    Set Suite Variable	        ${SessionB2}
    Set Suite Variable		${PROMPT_B_2}	${CLI_MAIN_PROMPT}

Main Command B 2
    ${CMD}=	Set Variable	help
    Log		=> Run Main B 2 ${CMD}...	console=yes
    Switch Connection		${SessionB2}
    Execute CLI Command		help		${PROMPT_B_2}

Console View B 2
    Log		=> Enter Console View B 2...	console=yes
    Switch Connection		${SessionB2}
    Enter CLI Console View
    Set Suite Variable		${PROMPT_B_2}	${CLI_CONSOLE_PROMPT}

View Command B 2
    ${CMD}=	Create Random ConsoleView Command
    Log		=> Run View B 2 ${CMD}...	console=yes
    Switch Connection		${SessionB2}
    Execute CLI Command		${CMD}		${PROMPT_B_2}

Kill A 2
    Log		=> Killing Connection A...	console=yes
    Switch Connection		${SessionB2}
    Execute CLI Command		kill interconnect ${ICMs[1]['Enc']} ${ICMs[1]['Bay']} 1		${PROMPT_B_2}
    Set Suite Variable		${PROMPT_A_2}	${CLI_CONSOLE_PROMPT}

Connect ICM B 2
    Switch Connection		${SessionB2}
    Connect Interconnect Command		${ICMs[1]['Enc']}	${ICMs[1]['Bay']}
    Log		=> Connect to ICM B 2...	console=yes
    Set Suite Variable		${PROMPT_B_2}	(<HP>)|(<OneView>)

Connect B 2 Force
    Switch Connection		${SessionB2}
    Connect Interconnect Command		${ICMs[1]['Enc']}	${ICMs[1]['Bay']}	force
    Log		=> Force connect to ICM B 2...	console=yes
    Run Keyword If 	 	'<HP>' in '${PROMPT_A_2}'
    ...	  Set Suite Variable    ${PROMPT_A_2}	${CLI_CONSOLE_PROMPT}
    Set Suite Variable		${PROMPT_B_2}	(<HP>)|(<OneView>)

Quit Connection B 2
    Switch Connection		${SessionB2}
    Disconnect Interconnect Command
    Log		=> Quit Connection B 2...	console=yes
    Set Suite Variable		${PROMPT_B_2}	${CLI_CONSOLE_PROMPT}

Quit Console View B 2
    Switch Connection		${SessionB2}
    Quit CLI View
    Log		=> Quit Console View B 2...	console=yes
    Set Suite Variable		${PROMPT_B_2}	${CLI_MAIN_PROMPT}

Exit B 2
    Log		=> Exiting Session B 2...	console=yes
    Switch Connection		${SessionB2}
    Logout of Fusion CLI
    Sleep      ${LOGINOUTDELAY}

#==============================

Create Random ConsoleView Command
    ${VCMDS}=     Create List   show   help
    ${VCMD}=      Select Random Element from List   ${VCMDS}
    ${Args}=      Run Keyword If      "${VCMD}"=="show"
    ...  Create Random Show Args
    ...	 ELSE
    ...	 Set Variable	${SPACE}
    [return]	${VCMD} ${ARGS}    
    

Create Random Show Args
    ${ARGS}=    Create List	 enclosure sessions     interconnect sessions    interconnect list
    ${ARGS}=	Select Random Element from List    ${ARGS}
    [return]    ${ARGS}
