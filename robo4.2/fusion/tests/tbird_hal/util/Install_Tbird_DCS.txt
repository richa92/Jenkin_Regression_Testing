*** Settings ***
Documentation     Install Thunderbird DCS
...    = USAGE =
...    | pybot | -v FUSION_IP:<IP> | Install_Tbird_DCS.txt |
...    = Variables =
...    | FUSION_IP | Fusion IP Address |

Library           Collections
Library           String
Library           RoboGalaxyLibrary            # DVTs Robot Framework extensions
Library           FusionLibrary                # DVTs Fusion extensions
Library           robot.api.logger
Library           OperatingSystem
Resource          ../resources/fusion_cli.txt
Resource          ../resources/defaults.txt
Force Tags        DCS

*** Variables ***
${TBIRD_DCS_URL}       http://15.213.239.235/rpms/sprints
${TIMEOUT_MIN}         15*2

*** Keywords ***
# -----------------------------------------------------------------------------
# NONE
# -----------------------------------------------------------------------------

*** Test Cases ***
Install Tbird DCS
    [Documentation]    Install the Thunderbird DCS packages
    Login to Fusion via SSH

    # Stop DCS in case DCS is running.  DCS needs to be stopped prior to installation if running.
    ${DCS Installed}=    Is DCS Installed
    Run Keyword If       ${DCS Installed}==${True}    Stop DCS

    # Clean up any existing DCS installations
    ${stdout}    ${stderr}    ${rc}=    Execute Command    /bin/rpm -e --allmatches dcs    return_stderr=True    return_rc=True
    Log    ${stdout}
    Log    ${stderr}
    ${stdout}    ${stderr}    ${rc}=    Execute Command    yum -y erase 'dcs*'    return_stderr=True    return_rc=True
    Should Be Equal As Integers 	      ${rc}	0	msg=Failed to yum erase DCS
    Log    ${stdout}
    Log    ${stderr}



    ${stdout}    ${stderr}    ${rc}=    Execute Command    grep Fusion/master/DCS /etc/yum.repos.d/fusion200.repo || echo -e '[dcs]\nname=DCS 2.0 repository\nbaseurl=http://ci-nexus.vse.adapps.hp.com/Fusion/master/DCS\nfailovermethod=priority\nenabled=1\ngpgcheck=0\ngpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-fusion' >> /etc/yum.repos.d/fusion200.repo   return_stderr=True    return_rc=True
    ${stdout}    ${stderr}    ${rc}=    Execute Command     yum-config-manager --disableplugin=cic-yum-hook --enable dcs       return_stderr=True    return_rc=True
    Should Be Equal As Integers 	      ${rc}	0	msg=Failed to update fusion200.repo
    Set Client Configuration 		timeout=240 seconds
    ${stdout}    ${stderr}    ${rc}=    Execute Command     yum --disableplugin=cic-yum-hook install -y dcs       return_stderr=True    return_rc=True
    Should Be Equal As Integers	      ${rc}	0	msg=Failed to yum install DCS
    Log    ${stderr}
    Log    ${stdout}

    # Now Sleep 20 seconds and restart
    Sleep    20
    Set Default Configuration	timeout=500
    Start Tbird DCS    ${TBIRD_SCHEMATIC}

    # Validate DCS Status
    ${schematic}=    Get DCS Schematic
    Should Match Regexp    ${schematic}    ${TBIRD_SCHEMATIC}

    Logout of Fusion Via SSH
