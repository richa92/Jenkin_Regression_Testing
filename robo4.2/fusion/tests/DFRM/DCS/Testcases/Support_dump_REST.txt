*** Settings ***
Documentation     Create and download the support dump for logical enclosure and check for the files present in it  
Suite Setup 		Login to Fusion Via REST
Library			../UserInputs/functions.py
Resource		../Resources/resources.txt
Variables		../UserInputs/variables.py

***variables***
${LEuri} 	 /rest/logical-enclosures/
${file}		${CURDIR}/../support_dump/ci_dfrm_supportdump.sdmp
${decyrpt_file}		${CURDIR}/../support_dump/Decrypted/ci_dfrm_decrypted_supportdump.sdmp
${dump_file_path}		${CURDIR}/../support_dump
${decryptor_path}		${CURDIR}/../Resources/Decryptor

*** Test Cases ***

  
Downloading and validating encrypted support dump
		[Documentation] 	Create an encrypted support dump, decrypt it, extract and validate for the existence of files  
		[Tags]				F742	Smoke
		[setup]				Run Keywords

		Create Directory 	 ${dump_file_path}
		${LEResp}=    Fusion Api Get Resource			uri=${LEuri}
		logger		LE response : ${LEResp}		DEBUG
		Run Keyword If		'${LEResp['count']}' == '0'		Pass With Warnings		msg=Since LE is not available support dump is not created and test case is skipped 
		${LE_id} =	Get from dictionary		${LEResp['members'][0]}	uri
		${LE_id} =	Split String From Right		${LE_id}	/	1
		logger		Le id is : ${LE_id[-1]}		 
		${payload} = 	Build support dump payload		Mydump		${true}
		${resp}		Fusion Api Get Logical Enclosure Support Dump		${payload}		${LE_id[-1]}		
		Logger		LE support dump response : ${resp}		DEBUG
		${task_resp} =	Wait Until Keyword Succeeds		10 min	10 sec		Validate the response		${resp}		
   		${uri}=     Get From Dictionary		${task_resp['associatedResource']}		resourceUri
   		Logger		The downloadable dump file ${uri}
   		Empty Directory 	${dump_file_path}
    	${resp}=    Fusion Api Download Support Dump    uri=${uri}          localfile=${file}	
		Decrypt and extract the dump file		${dump_file_path}		${decryptor_path}
    	Validating LE Dump Files		${dump_file_path}	


***Comment***

Downloading and validating decrypted support dump
		[Documentation] 	Create an encrypted support dump, decrypt it, extract and validate for the existence of files  
		[Tags]				F742	Regression
		[setup]				Run Keywords
		
		${dump_file_path} = 	Catenate	SEPARATOR=/		${dump_file_path}		Decrypted
		${decryptor_path} =		Set Variable 			#Making the path as null since encryption not required
		logger		\n Location of Dump files : ${dump_file_path}		
		Create Directory 	 ${dump_file_path}
		${LEResp}=    Fusion Api Get Resource			uri=${LEuri}
		logger		LE response : ${LEResp}		DEBUG
		Run Keyword If		'${LEResp['count']}' == '0'		Pass With Warnings		msg=Since LE is not available support dump is not created and test case is skipped
		${LE_id} =	Get from dictionary		${LEResp['members'][0]}	uri
		${LE_id} =	Split String From Right		${LE_id}	/	1
		logger		Le id is : ${LE_id[-1]}		 
		${payload} = 	Build support dump payload		Mydump		${false}
		${resp}		Fusion Api Get Logical Enclosure Support Dump		${payload}		${LE_id[-1]}		
		Logger		LE support dump response : ${resp}		DEBUG
		${task_resp} =	Wait Until Keyword Succeeds		10 min	10 sec		Validate the response		${resp}
   		${uri}=     Get From Dictionary		${task_resp['associatedResource']}		resourceUri
   		Logger		The downloadable dump file ${uri}
   		Empty Directory 	${dump_file_path}
    	${resp}=    Fusion Api Download Support Dump    uri=${uri}          localfile=${decyrpt_file}	
		Decrypt and extract the dump file		${dump_file_path}		${decryptor_path}
    	Validating LE Dump Files		${dump_file_path}	

    	
***keywords***

Build support dump payload
	[Arguments]		${name}		${encrypt}
	${payload_dict}=   Create Dictionary  errorCode=${name}
    ...									  encrypt=${encrypt}
    ...									  excludeApplianceDump=false
   	Logger		The support dump payload is : ${payload_dict}		DEBUG
    [return]	${payload_dict}
	

	
	
	
			
		
	