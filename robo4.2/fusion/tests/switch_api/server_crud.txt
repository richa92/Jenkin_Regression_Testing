*** Settings ***
Documentation     Add a DL360 server to Fusion
...    = Usage =
...    | pybot | -v FUSION_IP:<Your-IP> | -v XML_FILE:<XML_FILE> | server_crud.txt
...    = Variables =
...    | FUSION IP | Required; IP address of the FusionVM to use | 
...    | XML_FILE | Required; File containing Server Hardware data in XML format |
 
Library           Collections
Library           SSHLibrary
Library           RoboGalaxyLibrary           # DVTs Robot Framework extensions
Resource          resources/server.txt        # Comet-DVT keyword extensions for fusion

*** Variables ***
${ServerName}    udrogono-ilo
${ILO_PROMPT}     hpiLO->
${ILO_TIMEOUT}    30


*** Keywords ***
Add Server Hardware
    Load Test Data     ${XML_FILE}
    Fusion UI Add Server Hardware    @{TestData.serverhardware}
    Capture Page Screenshot
	
Remove Server Hardware
    Load Test Data     ${XML_FILE}
    Fusion UI Remove Server Hardware    @{TestData.serverhardware}
    Capture Page Screenshot
	
Power Off Server
    ${Response}=       Fusion UI Power Off Server    ${ServerName}
	
Power On Server
    ${Response}=       Fusion UI Power On Server    ${ServerName}
	
Check iLO Power On Status
    Load Test Data     ${XML_FILE}
	Set Default Configuration    prompt=hpiLO-> 
	${Server} =  Get Data By Property  ${TestData.serverhardware}    name    ${ServerName}
    Log Many    ${Server[0].iloIP}    ${Server[0].iloUserName}    ${Server[0].iloPassword}
	${Id}=    Open Connection    ${Server[0].iloIP}
    ${Output}=    Login    ${Server[0].iloUserName}    ${Server[0].iloPassword}
    Should contain    ${Output}    Server Power: On
	Close Connection
	
Check iLO Power Off Status
    Load Test Data    ${XML_FILE}
    Set Default Configuration    prompt=hpiLO->
	${Server} =  Get Data By Property  ${TestData.serverhardware}    name    ${ServerName}
    Log Many    ${Server[0].iloIP}    ${Server[0].iloUserName}    ${Server[0].iloPassword}
    Open Connection    ${Server[0].iloIP}
    ${Output}=    Login    ${Server[0].iloUserName}    ${Server[0].iloPassword}
    Should contain    ${Output}    Server Power: Off
	Close Connection
	
Check Fusion DL Claimed
    Load Test Data    ${XML_FILE}
    Log Many    ${IP}    ${BROWSER}    ${DELAY}    ${USERNAME}    ${PASSWORD}
    Open Browser    https://${Server[0].iloIP}    ${BROWSER}
    # Click 'Continue to this website' link allowing test case to continue (for IE only).
    Run Keyword If  "${BROWSER}" == "IE"   Go To  javascript:document.getElementById('overridelink').click()
    Set Selenium Speed    ${DELAY}

Fusion DL Claimed
    [Documentation]    Verify DL is claimed by Fusion
    Log    Verifying DL is Claimed by Fusion
	# TODO:  Add verification step here from iLo GUI.  For now, the keyword that does the 
	# claim validates the claim in Fusion.  But we need to also validate the claim from iLo
	# for completeness.  So, for now, just sleep.
    Sleep    5 seconds

Fusion DL Not Claimed
    [Documentation]    Verify DL is not claimed by Fusion
    Log    Verifying DL is not Claimed by Fusion
	# TODO:  Add verification step here from iLo GUI.  For now, the keyword that does the 
	# unclaim validates the operation in Fusion.  But we need to also validate from iLo
	# for completeness.  So, for now, just sleep.
    Sleep    5 seconds
	
	
*** Test Cases ***
Login 
    Load Test Data     ${XML_FILE}
	Open Browser    http://${FUSION_IP}    FF
	Set Selenium Speed    3
	${user} =  Get data by property  ${TestData.users}  name  Administrator
	Fusion UI login to appliance   ${user[0].name}

CrUD
    Run Random Model    model=server_crud.xml    minutes=15

