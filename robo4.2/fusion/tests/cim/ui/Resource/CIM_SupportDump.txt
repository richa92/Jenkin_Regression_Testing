*** Support Dump ***
Library		RoboGalaxyLibrary
Library		String
Resource	CIM_CommonResource.txt
Variables	../../../../FusionLibrary/ui/business_logic/general/base_elements.py
Variables	../../../../FusionLibrary/ui/settings/settings_elements.py

*** Keywords ***

Create support dump in appliance page
	[Arguments]	${Enable_or_Disable_Encryption}
	${Content_In_BackupStagingFolder_BeforeCreateSD}=	List backup staging folder contents
	#Navigate to Appliance page if it is not already displayed
	${Current_URL}=	Get Location
	${Is_AppliancePage_Displayed}	${error_message}=	Run Keyword and Ignore Error	Should Contain	${Current_URL}	appliance
	Run Keyword If	'${Is_AppliancePage_Displayed}'=='FAIL'	Navigate to	Settings	Appliance
	#Open support dump dialog
	wait for element and click	${FusionSettingsPage.ID_MENU_ACTION_MAIN_BTN}	10
	wait for element and click	${FusionSettingsPage.ID_MENU_ACTION_CREATE_SUPPORT_DUMP}	10
	#Enable or Disable encryption
	Run Keyword If	'${Enable_or_Disable_Encryption}'=='ENABLE' or '${Enable_or_Disable_Encryption}'=='DISABLE'	Wait Until Element Is Visible	${FusionSettingsPage.ID_CHECKBOX_ENABLE_SUPPORT_DUMP_ENCRYPTION}	10
	Run Keyword If	'${Enable_or_Disable_Encryption}'=='ENABLE'	Select Checkbox	${FusionSettingsPage.ID_CHECKBOX_ENABLE_SUPPORT_DUMP_ENCRYPTION}
	Run Keyword If	'${Enable_or_Disable_Encryption}'=='DISABLE'	Unselect Checkbox	${FusionSettingsPage.ID_CHECKBOX_ENABLE_SUPPORT_DUMP_ENCRYPTION}
	wait for element and click	${FusionSettingsPage.ID_BTN_YES_CREATE_SUPPORT_DUMP}
	Wait Until Element Is Visible	${FusionSettingsPage.ID_CREATESUPPORTDUMP_INFOBAR}	10
	Wait Until Element Is Not Visible	${FusionSettingsPage.ID_CREATESUPPORTDUMP_INFOBAR}	120
	${Is_Ok_Status_Displayed}	${error_or_return_value}=	Run Keyword And Ignore Error	Wait Until Element Is Visible	//*[@class='hp-notification-summary']//*[contains(@class, 'hp-status-ok')]	60
	Run Keyword If	'${Is_Ok_Status_Displayed}'=='PASS'	Log	Support dump was created successfully!	WARN
	...	ELSE	Fail	Create support dump failed!
	${Content_In_BackupStagingFolder_AfterCreateSD}=	List backup staging folder contents
	${SupportDump_Filename}=	Set Variable If	'${Content_In_BackupStagingFolder_BeforeCreateSD}'!='${Content_In_BackupStagingFolder_AfterCreateSD}'	${Content_In_BackupStagingFolder_AfterCreateSD}	${EMPTY}
	${File_Location}=	Set Variable	${DownloadPath}/${SupportDump_Filename}
	${Does_File_Exist}=	Verify file or directory exists	${File_Location}	3min
	Run Keyword If	'${Does_File_Exist}'=='YES'	Log	Support dump file downloaded successfully	WARN
	...	ELSE	Fail	Support dump file download failed

List backup staging folder contents
	[Documentation]	Returns the filename of the support dump or backup file in backup staging folder
	[Return]	${Filename}
	${ip}=	Get appliance ip from url
	${username}=	Set Variable	${TestData.RootUserCredentials[0].username}
	${password}=	Set Variable	${TestData.RootUserCredentials[0].password}
	Log	uname:${username}	WARN
	Log	pwd:${password}	WARN
	${command_to_list_backupstagingfolder_contents}=	Set Variable	cd /;cd backup_staging;ls
	${output}=	Execute Command on Remote VM	${ip}	${username}	${password}	${command_to_list_backupstagingfolder_contents}
	${backup_filename}=	Get Lines Containing String	${output}	.bkp
	${command_to_list_supportdumpfolder_contents}=	Set Variable	cd /;cd backup_staging;cd support-dumps;ls
	${output}=	Execute Command on Remote VM	${ip}	${username}	${password}	${command_to_list_supportdumpfolder_contents}
	${supportdump_filename}=	Get Lines Containing String	${output}	.sdmp
	${Filename}=	Set Variable	${backup_filename}${supportdump_filename}

Create support dump in error page
	[Arguments]	${Default_Administrator_Username}	${Default_Administrator_Password}
	#Enter credentials to create support dump
	${Content_In_BackupStagingFolder_BeforeCreateSD}=	List backup staging folder contents
	Wait Until Element Is Visible	${FusionSettingsPage.ID_LINK_CREATESUPPORTDUMP}
	Click Element	${FusionSettingsPage.ID_LINK_CREATESUPPORTDUMP}
	Wait Until Element Is Visible	${FusionSettingsPage.ID_INPUT_CREATESUPPORTDUMP_USERNAME}
	Input Text	${FusionSettingsPage.ID_INPUT_CREATESUPPORTDUMP_USERNAME}	${Default_Administrator_Username}
	Wait Until Element Is Visible	${FusionSettingsPage.ID_INPUT_CREATESUPPORTDUMP_PASSWORD}
	Input Text	${FusionSettingsPage.ID_INPUT_CREATESUPPORTDUMP_PASSWORD}	${Default_Administrator_Password}
	Wait Until Element Is Visible	${FusionSettingsPage.ID_BTN_CREATESUPPORTDUMP_OK}
	Click Element	${FusionSettingsPage.ID_BTN_CREATESUPPORTDUMP_OK}
	Wait Until Element Is Visible	${FusionSettingsPage.ID_LABEL_SUPPORTDUMP_PROGRESS_NOTIFICATION}	10
	Wait Until Element Is Not Visible	${FusionSettingsPage.ID_LABEL_SUPPORTDUMP_PROGRESS_NOTIFICATION}	120
	${Is_Ok_Status_Displayed}	${error_or_return_value}=	Run Keyword And Ignore Error	Wait Until Element Is Visible	//*[contains(@class, 'hp-status-ok')]	10
	Run Keyword If	'${Is_Ok_Status_Displayed}'=='PASS'	Log	Support dump was created successfully!	WARN
	...	ELSE	Fail	Create support dump failed!
	${Content_In_BackupStagingFolder_AfterCreateSD}=	List backup staging folder contents
	${SupportDump_Filename}=	Set Variable If	'${Content_In_BackupStagingFolder_BeforeCreateSD}'!='${Content_In_BackupStagingFolder_AfterCreateSD}'	${Content_In_BackupStagingFolder_AfterCreateSD}	${EMPTY}
	${File_Location}=	Set Variable	${DownloadPath}/${SupportDump_Filename}
	${Does_File_Exist}=	Verify file or directory exists	${File_Location}	3min
	Run Keyword If	'${Does_File_Exist}'=='YES'	Log	Support dump file downloaded successfully	WARN
	...	ELSE	Fail	Support dump file download failed
