*** Settings ***
Library         RoboGalaxyLibrary
Library         BuiltIn
Library         String
Library         Collections
Library         XML
Variables       ../../../../FusionLibrary/ui/business_logic/general/base_elements.py
Variables       ../../../../FusionLibrary/ui/business_logic/general/activity_elements.py

*** Keywords ***
Navigate to Activity page
    Open Fusion Main Menu
    wait for element visible    ${FusionBasePage.ID_MENU_ACTIVITY}
    wait for element and click  ${FusionBasePage.ID_MENU_ACTIVITY}
    ${status}   ${value}=   Run Keyword And Ignore Error    wait for element visible    ${FusionActivityPage.ID_PAGE_LABEL} 10
    Run Keyword If    '${status}'== 'PASS'    Log    Successfully navigated to Activity page
    Run Keyword Unless  '${status}'== 'PASS'    Fail    Failed while navigating to Activity page.

Verify Activity Existence in Activity Page
    [Arguments]    ${activityname}    ${resource}    ${activitystate}    ${activityowner}
    Navigate to Activity page
    wait for element visible    //*[@id='hp-activities']/tbody/tr[1]/td/a[1] 10

    # There could be more than 1 Activity page and if that happens the page displays Load more, hence the logic below is
    # to check for that before walking through the Activity tasks for a particular test
    ${text} =   Get Text    //*[@id='hp-activities']/tbody/tr[1]/td/a[1]
    ${count}=    Run Keyword If    '${text}' == 'Load more'    Get Matching XPath Count    //*[@id='hp-activities']/tbody//tr[2][//span[text()='${activityname}'] and td/a[text()='${resource}'] and td/span[text()='${activitystate}'] and td/div[text()='${activityowner}']]
    ${count}=    Run Keyword If    '${text}' != 'Load more'    Get Matching XPath Count   //*[@id='hp-activities']/tbody//tr[1][//span[text()='${activityname}'] and td/a[text()='${resource}'] and td/span[text()='${activitystate}'] and td/div[text()='${activityowner}']]
    Run Keyword If    ${count} == ${activityCount}    Log    Given alert '${activityname}' with state'${activitystate}' is present in the activity page
    Run Keyword Unless    ${count} == ${activityCount}    Fail    Given alert '${activityname}' with state '${activitystate}' is not present in the activity page

Verify Alert Filter Activity Exist In Activity Page
    [Documentation]    Validate Activity Page and check if activity of alert creation is listed in activity table
    [Arguments]    ${file}    ${attribute}
    Navigate to Activity page
    wait for element visible    ${FusionActivityPage.ID_ACTIVITY_TABLE} 10
    ${dataele}=   XML.Get Elements    ${DATAFILE}    ${file}/${attribute}
    ${datacount}=   Get Length  ${dataele}
    :FOR    ${filter}    IN RANGE    0    ${datacount}
    \   ${count}=   Get Matching XPath Count    //*[@id='hp-activities']/tbody//tr[${datacount}][//span[text()='Update notifications'] and td/a[text()='Notifications'] and td/span[text()='Completed']]
    \   Run Keyword If  ${count} == 1   Log    Update notifications is listed in activity page
    \   Run Keyword Unless  ${count} == 1   Fail    Update notifications is not listed in activity page
    \   ${datacount}=   Evaluate    ${datacount}-${count}

Validate Appliance Activity In Activity Page
    [Documentation]    Validate that activity is generated for the action performed
    [Arguments]   ${activity_name}
    Navigate to Activity page
    Log  ${activity_name}
    wait for element visible    ${FusionActivityPage.ID_ACTIVITY_TABLE} 20
    :FOR   ${index}    IN RANGE    1    5
    \    ${locator} =    Set Variable    //*[@id='hp-activities']/tbody//tr[${index}][//span[text()='${activityname}'] and td/a[text()='Appliance'] and td/span[text()='Completed']]
    \    wait for element visible    ${locator}
    \    ${count}=   Get Matching XPath Count    //*[@id='hp-activities']/tbody//tr[${index}][td//span[contains(text(),'${activityname}')]]
    \    ${data_count}=    Evaluate    ${data_count}+${count}
    Run Keyword If  ${data_count} >= 1   Log    Given alert is listed in activity page
    Run Keyword Unless  ${data_count} >= 1   Fail    Given alert is not present in the activity page

Verify Locked Backup alert in activity page
    [Documentation]    This keyword verifies Backup alert in activity page
    [Arguments]    ${AlertName}    ${AlertResource}    ${AlertState}    ${AlertOwner}
    Navigate to page    Activity
    :FOR   ${index}    IN RANGE    1    20
    \	${count}=    Get Matching XPath Count    //*[@id='hp-activities']/tbody/tr[${index}][td/p/span[contains(text(), '${AlertName}')] and td/a[text()='${AlertResource}'] and td[text()='${AlertState}'] and td//div[text()='${AlertOwner}']]
    \	Run Keyword If    ${count} == 1    Log    Backup alert with Locked state is present in the activity page
    \	Exit For Loop If	${count} == 1
    Run Keyword Unless    ${count} == 1    Fail    Backup alert with Locked state is not present in the activity page

Verify Cleared Backup alert in activity page
    [Documentation]    This keyword verifies Backup alert in activity page
    [Arguments]    ${AlertName}    ${AlertResource}    ${AlertState}    ${AlertOwner}
    Navigate to page    Activity
    :FOR   ${index}    IN RANGE    1    20
    \	${count}=    Get Matching XPath Count    //*[@id='hp-activities']/tbody//tr[${index}][td/p/span[contains(text(), '${AlertName}')] and td/a[text()='${AlertResource}'] and td//div[text()='${AlertState}'] and td//div[text()='${AlertOwner}']]
    \	Run Keyword If    ${count} == 1    Log    Backup alert with Cleared state is present in the activity page
    \	Exit For Loop If	${count} == 1
    Run Keyword Unless    ${count} == 1    Fail    Backup alert with Cleared state is not present in the activity page
