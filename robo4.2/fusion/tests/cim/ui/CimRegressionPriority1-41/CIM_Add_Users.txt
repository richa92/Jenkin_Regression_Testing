*** Settings ***
Documentation        Add users to Fusion as Administrator
Resource            ../Resource/CIM_CommonResource.txt
Resource            ../Resource-41/CIM_UsersAndGroups.txt
Resource            ../Resource/CIM_Activity.txt
Test Setup            Load Test Data and Open Browser
Test Teardown        Logout and close all browsers
Variables            ../../../../FusionLibrary/ui/business_logic/general/activity_elements.py

*** Variables ***
${status}            None

*** Test Cases ***
As an Administrator I want to add Users with different Roles to Fusion
    [Documentation]    Add users with different roles
    Log into Fusion appliance as Administrator
    Verify user logged in    ${TestData.users[0].name}    ${TestData.users[0].role}

    #create users
    Fusion UI Create User    @{TestData.users}

    # Page validation for all the users, verify user data by Name
    Fusion UI verify Userdata    @{TestData.users}

    #Verify the Add User Activity in Activity Page.
    Log into Fusion appliance as Administrator
    Navigate to Activity page
    wait for element visible    ${FusionActivityPage.ID_ACTIVITY_TABLE} 10
    :FOR    ${user}    IN    @{TestData.users}
    \    ${value} =    get variable value    ${user.name}
    \    Run Keyword If    '${value.upper()}' == 'ADMINISTRATOR'    Continue For Loop
    \    ${count}=    Get Matching XPath Count    //*[@id='hp-activities']/tbody//tr[//span[text()='Add'] and td/a[text()='${value}']]
    \    Run Keyword If    ${count} >= 1    Log    Given alert "Add -- ${value}" is listed in activity page
    \    Run Keyword Unless    ${count} >= 1    Fail    Given alert "Add -- ${value}" is not present in the activity page

    #Verify entry in auditlog file validation-not validating due to product issue.
    ${filepath}=    Download and unzip Audit log file    ${DownloadPath}
    :FOR    ${user}    IN    @{TestData.users}
    \    ${value} =        get variable value    ${user.name}
    \    Run Keyword If    '${value.upper()}' == 'ADMINISTRATOR'    Continue For Loop
    \    ${searchtext} =    Set Variable    Added user with name: ${user.name}
    \    ${bln_logentry_exists} =    file_contains    ${filepath}    ${searchtext}
    \    Should Be Equal As Strings    ${bln_logentry_exists}    ${blnExpected}    msg=Entry ${searchtext} not available in log file.

    #verify user and roles
    :FOR    ${user}    IN    @{TestData.users}
    \    ${value} =    get variable value    ${user.domainName}
    \    Fusion UI login to appliance    ${user.name}
    \    ${user.role} =    Set Variable If    '${user.role}' == 'Full'    Infrastructure administrator    ${user.role}
    \    Run keyword if    '${value}' == '${status}'    Verify user logged in    ${user.name}    ${user.role}
    \    Log out of Fusion appliance
