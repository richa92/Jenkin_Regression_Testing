*** Settings ***
Documentation		Alert is generated if Backup is not downloaded for more than 3 days
Resource			../Resource/CIM_CommonResource.txt
Resource			../Resource/CIM_Settings.txt
Resource			../Resource/CIM_Activity.txt
Test Setup			Load Test Data and Open Browser
Test Teardown		Logout and close all browsers
Library				DateTime

*** Variables ***
${Command1}			date --date="-3 days 1 hour ago" --utc "+%FT%T.%N"
${Command2}			sed -r 's/[[:digit:]]{6}$/Z/'
${FileName}			/ci/data/backup-restore/localConfig/downloadedOrSavedBackup.properties
${FileEntry}		lastBackupDownloaded
${AlertStatus}		warning
${AlertName}		The backup has not been taken and downloaded for
${AlertResource}	Backup
${AlertState}		Locked
${AlertOwner}		unassigned

*** Test Cases ***
Verify Alert is generated if Backup is not Downloaded for more than 3 days
	Log into Fusion appliance as Administrator

	#Get Appliance IP
	${ApplianceIP} =	Get appliance ip from url

	#Create Backup
	Create BackUp

	#Modify the current system date to 3 days and 1 hour ago and update downloadedOrSavedBackup.properties file
	Update downloadedOrSavedBackup file	${ApplianceIP}	${TestData.RootUserCredentials[0].username}	${TestData.RootUserCredentials[0].password}
	...	${Command1}	${Command2}
	...	${FileName}	${FileEntry}

	#Restart appliance for the Alert to be generated
	Navigate to page	Settings
	Fusion UI Restart

	#Verify Alert in Backup page
	Navigate to	Settings	Backup
	Verify notification bar	${AlertStatus}	${AlertName}	${AlertState}	5

	#Verify Alert in Activity page
	Verify Locked Backup alert in activity page	${AlertName}	${AlertResource}	${AlertState}	${AlertOwner}

*** Keywords ***
Update downloadedOrSavedBackup file
	[Documentation]	This keyword updates downloadedOrSavedBackup file
	[Arguments]	${ApplianceIP}	${UserName}	${Password}	${Command1}	${Command2}	${FileName}	${FileEntry}
	Open Connection	${ApplianceIP}
	Login	${UserName}	${Password}
	${Date} =	Execute Command	${Command1}| ${Command2}
	${NewDate} =	Replace String Using Regexp	${Date}	:	\\:	-1
	${Command3} ==	Set Variable	sed -i "s%${FileEntry}=.*%${FileEntry}=${NewDate}%g" ${FileName}
	Execute Command	${Command3}
	Close All Connections
