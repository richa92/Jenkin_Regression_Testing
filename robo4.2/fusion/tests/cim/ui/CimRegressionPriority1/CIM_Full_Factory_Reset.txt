*** Settings ***
Documentation		Initiate and verify Full-Factory-Reset
Resource			../Resource/CIM_CommonResource.txt
Resource			../Resource/CIM_Settings.txt
Test Setup			Load Test Data and Open Browser
Test Teardown		Logout and close all browsers
Variables			../../../../FusionLibrary/ui/settings/settings_elements.py
Variables			../../../../FusionLibrary/ui/business_logic/settings/networking_elements.py
Variables			../../../../FusionLibrary/ui/general/login_elements.py

*** Variables ***
${HTTPS}			https://

*** Test Cases ***
As an administrator I want to initiate and verify Full Factory Reset
	Log into Fusion appliance as Administrator
	Fusion UI Navigate To Settings Page
	Navigate To Edit Networking Page
	${Address_Assignment_Before_Factory_Reset}=	Get Address Assignment Type
	Close Edit Networking Page

#Initiate Full Factory Reset
	wait for element and click	${FusionSettingsPage.ID_SETTINGS_TEMP_LINK}
	${IP_Before_Factory_Reset}=	Get Appliance IP	${TestData.FullFactoryReset[0].name}	${TestData.FullFactoryReset[0].username}	${TestData.FullFactoryReset[0].password}	${TestData.FullFactoryReset[0].vmname}
	Log	${IP_Before_Factory_Reset}	WARN
	Navigate to panel	Appliance
	Initiate Full Factory Reset

#Wait for appliance to be assigned a different IP
	Run Keyword And Ignore Error	Wait until appliance is assigned a new IP	${IP_Before_Factory_Reset}	10 min

#Navigate to the new appliance IP
	${IP_After_Factory_Reset}=	Get Appliance IP	${TestData.FullFactoryReset[0].name}	${TestData.FullFactoryReset[0].username}	${TestData.FullFactoryReset[0].password}	${TestData.FullFactoryReset[0].vmname}
	Log	${IP_After_Factory_Reset}	WARN
	${URL}=	Catenate	SEPARATOR=	${HTTPS}	${IP_After_Factory_Reset}
	Go To	${URL}

#Wait for factory reset to complete and EULA page to display
	wait for element visible	${FusionLoginPage.ID_BTN_EULA_AGREE}	1200

#FTS
	Complete FTS	${IP_Before_Factory_Reset}

#Wait for initial network settings to be applied
	wait for element visible	${C7000_EditNetworkingElements.ID_PROGRESS_BAR_APPLYING_NETWORK_SETTINGS}
	wait for element not visible	${C7000_EditNetworkingElements.ID_PROGRESS_BAR_APPLYING_NETWORK_SETTINGS}	180

As an administrator I want to verify whether the entry is present in Audit Logs
	wait for element and input text	${FusionLoginPage.ID_INPUT_LOGIN_USER}	${TestData.FullFactoryReset[0].vmusername}
	wait for element and input text	${FusionLoginPage.ID_INPUT_LOGIN_PASSWORD}	${TestData.FullFactoryReset[0].vmnewpassword}
	wait for element and click	${FusionLoginPage.ID_BTN_LOGIN_BUTTON}

*** Keywords ***
Initiate Full Factory Reset
	wait for element and click	${FusionSettingsPage.ID_MENU_ACTION_MAIN_BTN}
	wait for element and click	${FusionSettingsPage.ID_ELEMENT_FACTORY_RESET}
	wait for element visible	${FusionSettingsPage.ID_CHECKBOX_PREVENT_NEWORK_SETTINGS}
	Unselect Checkbox	${FusionSettingsPage.ID_CHECKBOX_PREVENT_NEWORK_SETTINGS}
	wait for element and click	${FusionSettingsPage.ID_BTN_START_FACTORY_RESET}
	wait for element visible	${FusionSettingsPage.ID_CHECKBOX_CONFIRM_FACTORY_RESET}
	Select Checkbox	${FusionSettingsPage.ID_CHECKBOX_CONFIRM_FACTORY_RESET}
	wait for element and click	${FusionSettingsPage.ID_BTN_CONFIRM_FACTORY_RESET}

Wait until appliance is assigned a new IP
	[Arguments]	${IP_Before_Factory_Reset}	${Time_Out}	${Retry_Interval}
	Wait Until Keyword Succeeds	${Time_Out}	${Retry_Interval}	Check if new IP is assigned to appliance	${IP_Before_Factory_Reset}

Check if new IP is assigned to appliance
	[Arguments]	${IP_Before_Factory_Reset}
	[Return]	${Is_New_IP_Assigned}
	${Is_New_IP_Assigned}=	Set Variable	False
	${Current_IP}=	Get Appliance IP	${TestData.FullFactoryReset[0].name}	${TestData.FullFactoryReset[0].username}	${TestData.FullFactoryReset[0].password}	${TestData.FullFactoryReset[0].vmname}
	Run Keyword And Return If	'${Current_IP}'=='${IP_Before_Factory_Reset}'	Fail	"New IP not assigned"
	${Is_New_IP_Assigned}=	Set Variable	True
