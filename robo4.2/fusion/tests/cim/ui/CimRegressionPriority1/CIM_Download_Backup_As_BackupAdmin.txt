*** Settings ***
Documentation        Download BackUp
Resource            ../Resource/CIM_CommonResource.txt
Resource            ../Resource/CIM_Activity.txt
Resource            ../Resource/CIM_Settings.txt
Test Teardown        Logout and close all browsers
Variables			../TestData/data_file.py

Suite Setup  	Run Keywords	   Load Test Data and Open Browser
...          	AND                As an BackupAdminUser I want to get URI of Backup

*** Variables ***
${searchtext}        A backup download was initiated
${activityname}        Download backup
${resource}            Backup
${activitystate}    Completed
${activityowner}    BackupAdminUser


*** Test Cases ***
As an BackAdmin I want to Download a Backup
	#Log into Fusion appliance as BackupAdminUser
	${user} =	Get data by property	${TestData.users}	name	BackupAdminUser
	Fusion UI Login To Appliance	${user[0].name}
    Create Folder If not Exists    ${DownloadPath}
	# Navigate to settings page and download backup
    wait for element and click    ${FusionSettingsPage.ID_SETTINGS_LABEL}
    Fusion UI Download Backup    ${DownloadPath}
    Log    Download Backup is completed and check for BackUp File in tmp folder

    ${bkpfiles} =    OperatingSystem.List Files In Directory    ${DownloadPath}    *.bkp
    ${downloadedbkpfile} =    Get From List    ${bkpfiles}    0
    Log    ${downloadedbkpfile}
    Log		backup file is ${bkpfile}
    #Check if downloaded file is the same as the created file
    Should Be Equal As Strings    ${bkpfile}    ${downloadedbkpfile.strip()}    msg=Created ${bkpfile} is not same as downloaded ${downloadedbkpfile}
    #Verify Download Backup activity in Activity Page
    Verify Activity Existence in Activity Page    ${activityname}    ${resource}    ${activitystate}    ${activityowner}

	#Logout and Login as Administrator to Download Audit Logs
	Logout and close all browsers

	# Login to appliance as Administrator
	Open Browser	${ApplianceUrl}	${Browser}
	Log into Fusion appliance as Administrator
    #Verify entry in Auditlog file
    Download and verify entry in Audit log file    ${DownloadPath}    ${searchtext}
*** Keywords ***
As an BackupAdminUser I want to get URI of Backup
	${App_IP_Add}=	Fetch From Right	${ApplianceUrl}	//
	#Log into Fusion appliance as BackupAdminUser
	${user} =	Get data by property	${TestData.users}	name	BackupAdminUser
	# Login as BackupAdmin using REST API
	Fusion Api Login Appliance	${App_IP_Add}	${admin_credentials}
	#Extract the backup URI for further processing using REST API
    ${bkp_resp} =    Fusion Api Get Backup
	${bkp_uristring} =	Get from dictionary		${bkp_resp['members'][0]}	saveUri
	@{temp}=    Split String From Right    ${bkp_uristring}    separator=/
	Set Suite Variable    ${bkp_uri}    @{temp}[-1]
	Convert To String	${bkp_uri}
	${bkpfile} =	Catenate	SEPARATOR=.	${bkp_uri}	bkp
	Set Suite Variable		${bkpfile}
	Log Variables
