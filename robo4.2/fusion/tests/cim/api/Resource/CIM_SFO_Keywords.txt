*** Settings ***
Library    json
Library     RoboGalaxyLibrary
Library     FusionLibrary
Library     OperatingSystem
Library     BuiltIn
Library     Collections
Library     XML
Library     SSHLibrary
Library     String
Library     robot.api.logger
Resource    ../Resource/CIM_Common_Resource.txt
Resource    ../Resource/CIM_User_Keywords.txt
Resource     ../../../../Resources/api/servers/server_profile.txt
Resource            ../../../../Resources/api/fusion_api_resource.txt

***Variables***
${expectedstate}    Edited server profile: EMPTY_SP2.
${state}            Created server profile: EMPTY_SP2.

*** Keywords ***


####################################################################################################################
##  Edit Server Profile As Server Firmware Operator ##
#####################################################################################################################

Edit Server Profile SFO
    [Documentation]    Edit Server Profile
    [Arguments]    ${profile}    ${headers}=${None}    ${api}=${None}
    ${name} =    Get from Dictionary    ${profile}    name
    Log to console and logfile    \nEditing Server Profile ${name}
    ${payload} =  Create Server Profile PUT Payload    ${profile}
    ${profile_dto} =    Get Resource  SP:${name}
    Log    ${profile_dto}
    ${profile_uuid} =    Get From Dictionary    ${profile_dto}    uuid
    ${profile_created} =    Get From Dictionary    ${profile_dto}    created
    ${profile_modified} =    Get From Dictionary    ${profile_dto}    modified
    ${profile_serialno} =    Get From Dictionary    ${profile_dto}    serialNumber
    ${profile_hwtype} =    Get From Dictionary    ${profile_dto}    serverHardwareTypeUri
    ${profile_encgroup} =    Get From Dictionary    ${profile_dto}    enclosureGroupUri
    ${profile_isciname} =    Get From Dictionary    ${profile_dto}    iscsiInitiatorName
    ${profile_iscitype} =    Get From Dictionary    ${profile_dto}    iscsiInitiatorNameType
    ${profile_disc} =    Get From Dictionary    ${profile_dto}    description
    ${sanStorage} =    Get From Dictionary    ${profile_dto}    sanStorage
    ${profile_etag} =    Get From Dictionary    ${profile_dto}    eTag
    ${profile_uri} =  Get From Dictionary    ${profile_dto}  uri
    ${profile_status} =  Get From Dictionary    ${profile_dto}  status
    Set to Dictionary    ${payload}    uri    ${profile_uri}
    Set to Dictionary    ${payload}    uuid    ${profile_uuid}
    Set to Dictionary    ${payload}    created    ${profile_created}
    Set to Dictionary    ${payload}    modified    ${profile_modified}
    Set to Dictionary    ${payload}    serialNumber    ${profile_serialno}
    Set to Dictionary    ${payload}    serverHardwareTypeUri    ${profile_hwtype}
    Set to Dictionary    ${payload}    enclosureGroupUri    ${profile_encgroup}
    Set to Dictionary    ${payload}    iscsiInitiatorName    ${profile_isciname}
    Set to Dictionary    ${payload}    iscsiInitiatorNameType    ${profile_iscitype}
    Set to Dictionary    ${payload}    description    ${profile_disc}
    Set to Dictionary    ${payload}    sanStorage    ${sanStorage}
    Set to Dictionary    ${payload}    status    ${profile_status}
    Set to Dictionary    ${payload}    eTag    ${profile_etag}
    Log    ${payload}
    ${resp} =    Fusion Api Edit Server Profile    body=${payload}    uri=${profile_uri}    headers=${headers}  api=${api}
    Log    ${resp}
    Wait Until Keyword Succeeds    3 min    5 sec    Validate Edit Profile    ${resp}
    [return]  ${resp}

Validate Edit Profile
    [Documentation]    Validate profile is edited
    [Arguments]    ${resp}
    ${test_uri} =    Get From Dictionary    ${resp}  uri
    ${new-res} =    Fusion API Get Resource  ${test_uri}
    Log    ${new-res}
    ${actualValue}=    Get From Dictionary    ${new-res}   taskStatus
    Run Keyword If    '${actualValue}'=='${expectedstate}'   Console     Assert: taskStatus is ${actualValue} as expected.
    Run Keyword Unless   '${actualValue}'=='${expectedstate}'    Fail    Status is not as expected

Validate Create Profile
    [Documentation]    Validate Profile is created
    [Arguments]    ${resp}
    ${response}=    Convert to Dictionary    @{resp}
    ${test_uri} =    Get From Dictionary    ${response}    uri
    ${new-res} =    Fusion API Get Resource  ${test_uri}
    Log    ${new-res}
    ${actualValue}=    Get From Dictionary    ${new-res}   taskStatus
    Run Keyword If    '${actualValue}'=='${state}'   Console     Assert: taskStatus is ${actualValue} as expected.
    Run Keyword Unless   '${actualValue}'=='${state}'    Fail    Status is not as expected

Edit Server Profiles from variable SFO
    [Documentation]    Edit Server Profiles from a variable which contains a list of dicts with the entire payload
    [Arguments]    ${profiles}    ${api}=${None}
    Log to console and logfile    Editing SERVER PROFILES
    ${resplist} =    Create List
    :FOR    ${profile}    IN    @{profiles}
    \    ${resp} =  Edit Server Profile SFO  ${profile}  api=${api}
    \    append to list    ${resplist}    ${resp}
    [return]    ${resplist}

Get Server Profile Server Hardwares details and Edit Server Profile
    [Documentation]    Get HW details and edit profile
    [Arguments]    ${cred}    ${editSP}
    Login    ${cred}
    ${resp}=    Fusion Api Get Server Profiles    uri=/rest/server-profiles
    Log    ${resp}
    Should Be Equal    '${resp['status_code']}'    '200'    msg=Unable to get server profile data
    #Validate if SFO can access hardware data
    ${resp}=    Fusion Api Get Server Hardware    uri=/rest/server-hardware
    Should Be Equal    '${resp['status_code']}'    '200'    msg=Unable to get server hardware data
    Edit Server Profiles from variable SFO    ${editSP}

Create Server Profile for test
    [Documentation]    Create SP
    Login    ${admin_credentials}
    ${resp} =    Add Server Profiles from variable    ${emptyProfile}
    Log    ${resp}
    Wait Until Keyword Succeeds    3 min    5 sec    Validate Create Profile    ${resp}

Remove ServerProfile for cleanup
    [Documentation]    Remove SP as cleanup
    Login    ${admin_credentials}
    Remove Server Profiles from variable    ${emptyProfile}    force=${True}
    Logout

Power Off Server To Create Server Profile
    [Documentation]    Power off Server Hardware
    Power off Server    ${SH1}
    Power off Server    ${SH2}
    Power off Server    ${SH3}
