*** Settings ***
Documentation     Adding License to One View


Library           RoboGalaxyLibrary
Library           FusionLibrary
Library           SSHLibrary
Library           OperatingSystem
Library           String
Library           Collections
Library           XML
Resource          ../Resource/CIM_Common_Resource.txt
Resource             ../Resource1-42/CIM_Common_Resource.txt

Variables     ../TestData/TestData420.py

***Keywords***

Apply Licenses to Node
    [Documentation]     Apply license to Node
    ${length} =    Get Length    ${NODELIST}
    :FOR   ${item}    IN RANGE    0   ${length}
    \    ${node} =    Get From List    ${NODELIST}   ${item}
    \    Log   ${node}
    \    ${body}=    Update Dictionary Subset    ${NODEID}    ${node} 
    \    Log    ${body}
    \    ${JSON}=    json.dumps   ${body}   json
    \    Log   ${JSON}
    \    ${data}=    json.dumps   ${NODEID}   json
    \    Log   ${data}
    \    ${Response}=    Post Request    licenses/<*>/nodes    ${data}    None
    \    Should be Equal    ${Response.status_code}    ${201}    msg=Operation failed ${Response.content}

Unassign License from Node and verify count
    [Documentation]     Unassign applied license from the node
    ${length} =    Get Length    ${NODELIST}
    ${licenses}=   Get All Licenses
    ${licenses}=    Convert to Dictionary    @{licenses}
    ${nodes} =    Get From Dictionary    ${licenses}    nodes
    ${NODEID} =    Get From Dictionary    ${nodes[0]}   nodeId
    ${Response}=    Delete Request     licenses/*/nodes/${nodeId}
    Should be Equal    ${Response.status_code}    ${204}    msg=Operation failed ${Response.content}

Add License and Verify that License is added
    [Documentation]     Add license
    [Arguments]    ${licenses}    ${type}
    Log    ${type}
    :FOR    ${ovLic}  IN  @{licenses}
    \    ${resp}=     Fusion Api Add License     ${ovLic['key']}    ${type}
    \    Run Keyword If    ${resp['status_code']}==400     Run Keyword If    '${resp['errorCode']}'=='EXPIRED_LICENSE_KEY'       Fail    License Key expired
    \    Run Keyword If    ${resp['status_code']}==400     Run Keyword If    '${resp['errorCode']}'=='INVALID_LICENSE_KEY'       Fail    Invalid License Key
    \    Run Keyword If    ${resp['status_code']}==412     Run Keyword If    '${resp['errorCode']}'=='LICENSE_ALREADY_EXISTS'       Fail    License Already exists
    \    Run Keyword If    ${resp['status_code']}==400     Run Keyword And Continue On Failure	 Fail    Failed to add License Key ${ovLic['key']}
    \    Should Be Equal    '${resp['status_code']}'    '201'    msg=Failed to Add License.
    \    Log to console and logfile    License is added to appliance
    \    ${lic-res} =    Get All OV Licenses
    \    ${response}=    Convert to Dictionary    @{lic-res}[0]
    \    ${key} =    Get From Dictionary    ${response}    key
    \    Log    ${key}
    \    Should Contain    ${ovLic['key']}    ${key}    msg=not added
    \    Log to console and logfile    "Verification on Adding a License into HP OneView has PASSED"

Get All License Capacity
    [Documentation]    Get all licenses information from the appliance. Fails if licenses doesn't exists in appliance.
    ${availCap} =   Set Variable    0
    ${li_type} =   Set Variable    '${NODEID['product']}'
    ${resp} =  Get All Licenses
    :FOR    ${li}    IN    @{resp}
    \    Continue For Loop If  '${li['product']}' != ${li_type}
    \    ${availCap} =  Run Keyword if  '${li['product']}' == ${li_type}  Get From Dictionary    ${li}    availableCapacity
    Log		${availCap}
    [RETURN]    ${availCap}

