*** Settings ***
Documentation     EM RIS keywords
...               = Usage =
...               | Library | ../resources/em_api.txt |
...
...       -- EM Factory Reset
...       -- Get Fusion IP Claim Through EM RIS
...
Library           Collections
Library           String
Library           RoboGalaxyLibrary            # DVTs Robot Framework extensions
Library           FusionLibrary                # DVTs Robot Framework extensions
Library           OperatingSystem
Library           SSHLibrary
Resource          ../resources/defaults.txt
Resource          ../resources/fusion_api.txt  # DVT fusion API extensions


*** Keywords ***

EM Factory Reset
    [Documentation]    Perform a "Factory Reset" Action in RIS. Resetting the EM to
    ...                default settings and thereby releasing the enclosure claim.

    # Release the Kraken!
    Login to Fusion via SSH
    ${Output}    ${rc}=    Execute Command
    ...    /ci/bin/tbird/appliance-hal.sh factory-reset-enclosures    return_rc=True
    Run Keyword If    ${rc}!=0
    ...    Log    Failed to factory-reset-enclosures using appliance-hal.sh    level=WARN
    Sleep    900

Get Enclosure Manager Credentials
    [Documentation]
    ...    Fetches the Enclosure Manager Credentials for each Enclosure manager listed.

    Login to Fusion Via SSH

    # If Enclosure Credentials already exist, use it. Otherwise create from scratch
    ${Exists}    Run Keyword and Return Status
    ...    Variable Should Exist    ${Enclosure_Credentials}    msg=Enclosure credentials are present
    Run Keyword If    ${Exists}==${True}    Return from Keyword    ${Enclosure_Credentials}

    # Get the list of enclosure managers
    ${Output}    ${rc}=    Execute Command
    ...    /ci/bin/tbird/appliance-hal.sh list-enclosures    return_rc=True
    Run Keyword If    ${rc}!=0    Log    Failed to get enclosure list from appliance-hal.sh

    # Create a dictionary of dictionaries; One for each Enclosure listed
    @{Lines}    Split To Lines    ${Output}
    ${Enclosure_Credentials}    Create Dictionary
    :FOR    ${EnclosureSN}    IN    @{Lines}
    \    # Create another (empty) dictionary using the name of the enclosure
    \    ${Tmp}=    Create Dictionary
    \    Set To Dictionary    ${Enclosure_Credentials}    ${EnclosureSN}    ${Tmp}

    # Fetch the IP address, username and password for each enclosure
    ${Keys}    Get Dictionary Keys    ${Enclosure_Credentials}
    :FOR    ${EnclosureSN}    IN    @{Keys}
    \    ${Output}    ${rc}=    Execute Command
    \    ...    /ci/bin/tbird/appliance-hal.sh get-enclosure-credentials -s ${EnclosureSN} -o ipaddress
    \    ...    return_rc=True
    \    Run Keyword If    ${rc}!=0    Log    Failed to get IP address from appliance-hal.sh
    \    ${Enclosure}    Get From Dictionary    ${Enclosure_Credentials}    ${EnclosureSN}
    \    Set to Dictionary    ${Enclosure}    IP    ${Output}
    \
    \    ${Output}    ${rc}=    Execute Command
    \    ...    /ci/bin/tbird/appliance-hal.sh get-enclosure-credentials -s ${EnclosureSN} -o user
    \    ...    return_rc=True
    \    Run Keyword If    ${rc}!=0    Log    Failed to get username from appliance-hal.sh
    \    Set to Dictionary    ${Enclosure}    username    ${Output}
    \
    \    ${Output}    ${rc}=    Execute Command
    \    ...    /ci/bin/tbird/appliance-hal.sh get-enclosure-credentials -s ${EnclosureSN} -o password
    \    ...    return_rc=True
    \    Run Keyword If    ${rc}!=0    Log    Failed to get password from appliance-hal.sh
    \    Set to Dictionary    ${Enclosure}    password    ${Output}
    Set Global Variable    ${Enclosure_Credentials}
    [Return]    ${Enclosure_Credentials}
