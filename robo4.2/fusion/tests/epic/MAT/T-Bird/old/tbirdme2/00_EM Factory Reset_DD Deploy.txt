*** Settings ***
Documentation    Deploy Fusion ISO onto CIM using Atlas USB Key
...    = Usage =
...    pybot |-v ENCLOSURE:tesla |-v ISO_URL:<Fusion ISO Image> Deploy_CIM_Fusion.txt
...    = Variables =
...    | ENCLOSURE | (required) Name of the enclosure to Deploy upon. (values from variables.py) |
...    | ISO_URL | (optional) URL of Fusion ISO Image To Install (defaulted) |
...
...     --Prepare for Firmware Update [Get Firmware Versions and Get Enclosure Manager Credentials]
...     --Stop cluster service on Standby and Active CIM
...     --Reset all EM's in the ring
...     --Deploy Firmware Updates [Initiate DD Image Update, Wait For Fusion Install and Startup and Assign Administrator Password]

Resource          ./resource_dd.txt
#Resource          ../../../../Resources/api/fusion_api_resource.txt
Variables         ./variables_tbird.py    ${ENCLSOURE}
#Resource          ./resource_tbird.txt
#Variables         ./data_variables_tbird.py

*** Variables ***


*** Test Cases ***
Prepare for DD Image
    [Tags]    Pre-Deploy
    Log Variables
    Set Log Level   TRACE
    #Console    \nDeploying from: ${DD_URL} onto: ${ENCLOSURE}
    Get Firmware Versions

Get the enclosure(For multi-enclosure environments)credentials
    [Tags]  GETENCCREDENTIALS
    ${Enclosure_Credentials}    Get Enclosure Manager Credentials
    Run Keyword and Ignore Error
    ...    Verify Claimed Enclosure

Reset all EM's in the ring
    [Tags]    Factory Reset EM
    Set Log Level   TRACE
    EM Factory Reset

Deploy DD Image
    [Tags]    Deploy DD Image
    Initiate DD Image Update
    Wait For Fusion Install and Startup
    Assign Administrator Password

Setup Fusion after Deploy
    [Tags]    Post-Deploy
    Appliance Login
    Set Fusion Version Metadata
    # Write Fusion Properties
    Get Firmware Versions
    # This should be "Run Keyword and Continue on Failure" to fail the Test case if enclosure is not claimed.
    Run Keyword and Ignore Error
    ...    Verify Claimed Enclosure
    #Prevent CIM iLo Reset From Fusion Factory Reset
    Generate Fusion Dump and Log After Network Initialization

Refresh Enclosure
    [Tags]      REFRESH
    ${responses}=  Refresh Enclosure Async   ${encs_monitor}
    Run Keyword for List with kwargs  ${responses}  Wait For Task2  timeout=1000    interval=20


*** Keywords ***
Set Fusion Version Metadata
    Set Suite Metadata     Deployed URL    ${DD_URL}    top=True
    Set Suite Metadata     Fusion URL:       https://${FUSION_IP}    top=True
    Login to Fusion via REST    ${FUSION_IP}    ${FUSION_USERNAME}    ${FUSION_PASSWORD}
    ${Response}=    Fusion Api Get Appliance Version
    Logout of Fusion Via REST
    Log    ${Response}
    ${softwareVersion}    Get from Dictionary    ${Response}    softwareVersion
    Set Suite Variable    ${Fusion_Version}    ${softwareVersion}
    Set Suite Metadata    Fusion Version    ${Fusion_Version}       top=True
