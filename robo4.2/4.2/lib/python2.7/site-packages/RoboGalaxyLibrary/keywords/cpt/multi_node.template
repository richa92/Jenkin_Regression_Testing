<CONFIGS>
  {%- for c in os -%}
    {%- set cfg = namespace(entry=0) -%}
    {%- for n in nodes -%}
      {%- if c.os_name == n.os_profile -%}
        {%- if cfg.entry == 0 -%}
          {%- set cfg.entry = 1 -%}
          <CONFIG>
              <OS>{{ c.os_name }}</OS>
              <OS_PATH>{{ c.os_repo }}</OS_PATH>
          <NODES>
        {%- endif -%}
            <NODE>
              {% if n.ilo -%}
                <ILO>
                    <IP>{{ n.ilo.ip }}</IP>
                    <USER>{{ n.ilo.user }}</USER>
                    <PWD>{{ n.ilo.password }}</PWD>
                </ILO>
              {%- endif %}
              {% if n.host -%}
                  <HOSTNAME>{{ n.host.name }}</HOSTNAME>
                  <SYSTEM_PASSWORD>{{ n.host.password }}</SYSTEM_PASSWORD>
              {%- endif %}
              {%- if n.network -%}
                  <MACADDR>{{ n.network.mac }}</MACADDR>
                  <NIC_ID>{{ n.network.pos }}</NIC_ID>
              {%- endif %}
              <NIC_DD_PATH>{{ c.network_driver }}</NIC_DD_PATH>
              <STG_DD_PATH>{{ c.storage_driver }}</STG_DD_PATH>
              {% if n.storage -%}
                <LUN_ID>{{ n.storage.lun_id }}</LUN_ID>
                {% if n.storage.multipath -%}
                    <MULTIPATH>yes</MULTIPATH>
                {% else -%}
                    <MULTIPATH>no</MULTIPATH>
                {%- endif %}
                {% if n.storage.fcoe -%}
                  {% if n.storage.fcoe.enabled -%}
                    <FCOE>
                        <INSTALL>yes</INSTALL>
                        <MAC1>{{ n.storage.fcoe.mac1 }}</MAC1>
                        <MAC2>{{ n.storage.fcoe.mac2 }}</MAC2>
                    </FCOE>
                  {%- endif %}
                {%- endif %}
              {%- endif %}
              {% if n['iSCSI'] -%}
                <ISCSI>
                    <INSTALL>yes</INSTALL>
                </ISCSI>
              {%- endif %}
              <BOOTMODE>{{ n.boot_mode }}</BOOTMODE>
              <TEAM>csi-other</TEAM>
              <KICKSTART>{{ c.kickstart }}</KICKSTART>
              <CUSTOM_SCRIPT>{{ c.custom_script }}</CUSTOM_SCRIPT>
              <KISO_PATH />
              <SYSBUILDER>
                   <INSTALL>no</INSTALL>
                   <SITE_LOCATION />
                   <CORP_NIC_ID />
              </SYSBUILDER>
              <SPP>
                  <FLASH_FIRMWARE>no</FLASH_FIRMWARE>
                  {% if c.spp -%}
                    <INSTALL>yes</INSTALL>
                    <ISO_PATH>{{ c.spp }}</ISO_PATH>
                  {% else %}
                    <INSTALL>no</INSTALL>
                    <ISO_PATH />
                  {%- endif %}
              </SPP>
            </NODE>
      {%- endif %}
    {%- endfor %}
    {%- if cfg.entry == 1 %}
        </NODES>
      </CONFIG>
    {%- endif %}
  {%- endfor %}
</CONFIGS>